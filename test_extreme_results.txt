[dotenv@17.2.3] injecting env (12) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

================================================================================
[1müî• INICIANDO TESTS EXTREMOS DEL SISTEMA[0m
================================================================================

[35müìã [16:34:07][0m GRUPO 1: Conversaciones Muy Largas y Complejas
[36müß™ [16:34:07][0m üî• EXTREME: Extremo - Conversaci√≥n Muy Larga (15 pasos)
[2025-11-19T16:34:07.769Z] [INFO] CONFIG_LOADED {
  "maxPersonasMesa": 20,
  "minPersonas": 1,
  "horario1Inicio": "08:00",
  "horario1Fin": "11:00",
  "horario2Inicio": "13:00",
  "horario2Fin": "15:00",
  "horario3Inicio": "19:00",
  "horario3Fin": "23:00",
  "minAntelacionHoras": 2,
  "fullConfig": {
    "capacidadMaxima": 100,
    "bufferCapacidad": 10,
    "duracionReservaMinutos": 120,
    "horario1Inicio": "08:00",
    "horario1Fin": "11:00",
    "horario2Inicio": "13:00",
    "horario2Fin": "15:00",
    "horario3Inicio": "19:00",
    "horario3Fin": "23:00",
    "horarioApertura": "13:00",
    "horarioCierre": "23:00",
    "lunchStart": "13:00",
    "lunchEnd": "15:00",
    "dinnerStart": "19:00",
    "dinnerEnd": "23:00",
    "minAntelacionHoras": 2,
    "maxPersonasMesa": 20,
    "minPersonas": 1,
    "ventanaSolapamiento": 30
  },
  "loadTimeMs": 621
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:07.771Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:07.773Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:08.893Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: greeting, Input: "Hola, buenos d√≠as", Processing: false
[2025-11-19T16:34:08.894Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 17,
  "inputPreview": "Hola, buenos d√≠as",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Hola, buenos d√≠as", Processing: false
[2025-11-19T16:34:08.897Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Hola, buenos d√≠as",
  "inputLength": 17,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:08.898Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola, buenos d√≠as",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:34:08.898Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola, buenos d√≠as",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Hola, buenos d√≠as\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:34:08.900Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570047148,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 622,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Hola, buenos d√≠as",
  "inputLength": 17,
  "context": {
    "step": "greeting",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Hola, buenos d√≠as\""
}
[2025-11-19T16:34:08.901Z] [INFO] ‚úÖ [Gemini] Cliente de Vertex AI inicializado {
  "projectId": "cronosai-473114",
  "location": "us-central1",
  "clientEmail": "vertex-ai-service-account@cronosai-473114.iam.gserviceaccount.com",
  "reasoning": "Cliente de Vertex AI inicializado correctamente para Gemini. Proyecto: cronosai-473114, Regi√≥n: us-central1"
}
[2025-11-19T16:34:09.470Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570047148,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1189,
    "menuLoadTime": 567,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 567,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:09.471Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570047148,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1189,
    "menuLoadTime": 567,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8390,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8390 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:11.147Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570047148,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1189,
    "menuLoadTime": 567,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1675,
  "reasoning": "Respuesta recibida de Gemini en 1675ms. Extrayendo JSON..."
}
[2025-11-19T16:34:11.148Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570047148,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1189,
    "menuLoadTime": 567,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 2248,
  "apiCallTimeMs": 1675,
  "dataLoadTimeMs": 567,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:11.149Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:34:11.150Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:34:11.175Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 2279
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_people, Time: 2279ms, Response: "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?"
[2025-11-19T16:34:11.176Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 2279,
  "responseMessage": "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?",
  "reasoning": "Paso procesado en 2279ms. Respuesta: \"¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?...\""
}
[2025-11-19T16:34:11.176Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, ¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:11.182Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 4034,
  "geminiTimeMs": 2248,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1189,
  "menuLoadTimeMs": 567,
  "dbTimeMs": 0,
  "processStepTimeMs": 2279,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:11.241Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:11.242Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:11.242Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_people, Input: "Quiero hacer una reserva", Processing: false
[2025-11-19T16:34:11.244Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 24,
  "inputPreview": "Quiero hacer una reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Quiero hacer una reserva", Processing: false
[2025-11-19T16:34:11.245Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Quiero hacer una reserva",
  "inputLength": 24,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:11.246Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570051240,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Quiero hacer una reserva",
  "inputLength": 24,
  "context": {
    "step": "ask_people",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Quiero hacer una reserva\""
}
[2025-11-19T16:34:11.248Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570051240,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:11.248Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570051240,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8397,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8397 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:12.249Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570051240,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1000,
  "reasoning": "Respuesta recibida de Gemini en 1000ms. Extrayendo JSON..."
}
[2025-11-19T16:34:12.250Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570051240,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1004,
  "apiCallTimeMs": 1000,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:12.251Z] [INFO] PEOPLE_EXTRACTED_WORD {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 1
}
[2025-11-19T16:34:12.252Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "1",
    "comensales_confidence": "100%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Quiero hacer una reserva",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 1 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:12.253Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 1,
  "credibilidad": "100%"
}
[2025-11-19T16:34:12.254Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:34:12.255Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1011
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_date, Time: 1011ms, Response: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:34:12.256Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1011,
  "responseMessage": "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1011ms. Respuesta: \"Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:34:12.257Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:12.261Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1021,
  "geminiTimeMs": 1004,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1011,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:12.316Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:12.316Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:12.317Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_date, Input: "Para 4 personas", Processing: false
[2025-11-19T16:34:12.318Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 15,
  "inputPreview": "Para 4 personas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Para 4 personas", Processing: false
[2025-11-19T16:34:12.319Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Para 4 personas",
  "inputLength": 15,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:12.320Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:12.321Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570052315,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Para 4 personas",
  "inputLength": 15,
  "context": {
    "step": "ask_date",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Para 4 personas\""
}
[2025-11-19T16:34:12.321Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570052315,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:12.322Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570052315,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8388,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8388 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:13.357Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570052315,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 699,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_",
  "apiCallTimeMs": 1035,
  "reasoning": "Respuesta recibida de Gemini en 1035ms. Extrayendo JSON..."
}
[2025-11-19T16:34:13.358Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570052315,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1037,
  "apiCallTimeMs": 1035,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Para 4 personas"
üîç [DEBUG] Texto en min√∫sculas: "para 4 personas"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:13.398Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Para 4 personas",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:13.400Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "peopleCount": 4,
  "peopleAnterior": 1,
  "credibilidad": "100%"
}
[2025-11-19T16:34:13.401Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 4
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_date, Time: 1083ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:34:13.402Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1083,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 1083ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:34:13.403Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les con..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:13.407Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1092,
  "geminiTimeMs": 1037,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1083,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:13.474Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:13.475Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:13.475Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_date, Input: "Espera, mejor para 6", Processing: false
[2025-11-19T16:34:13.476Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 20,
  "inputPreview": "Espera, mejor para 6",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Espera, mejor para 6", Processing: false
[2025-11-19T16:34:13.478Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Espera, mejor para 6",
  "inputLength": 20,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:13.478Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:13.479Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570053473,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Espera, mejor para 6",
  "inputLength": 20,
  "context": {
    "step": "ask_date",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Espera, mejor para 6\""
}
[2025-11-19T16:34:13.480Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570053473,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:13.481Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570053473,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8393,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8393 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:14.502Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570053473,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 694,
  "responsePreview": "```json\n{\n  \"intencion\": \"modify\",\n  \"comensales\": \"6\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porce",
  "apiCallTimeMs": 1020,
  "reasoning": "Respuesta recibida de Gemini en 1020ms. Extrayendo JSON..."
}
[2025-11-19T16:34:14.502Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570053473,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1023,
  "apiCallTimeMs": 1020,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "modify",
    "comensales": "6",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: modify, Idioma: es. Extra√≠dos: 6 personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Espera, mejor para 6"
üîç [DEBUG] Texto en min√∫sculas: "espera, mejor para 6"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:14.529Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "modify",
    "comensales": "6",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4
  },
  "currentLanguage": "es",
  "originalText": "Espera, mejor para 6",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4}. An√°lisis contiene: 6 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:14.531Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "peopleCount": 6,
  "peopleAnterior": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:34:14.531Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 4
  },
  "stateAfter": {
    "NumeroReserva": 6
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_date, Time: 1055ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:34:14.533Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1055,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1055ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:34:14.533Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 6
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 1ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:14.537Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1064,
  "geminiTimeMs": 1023,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1055,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:14.595Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:14.595Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:14.596Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 6
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_date, Input: "No, mejor 5", Processing: false
[2025-11-19T16:34:14.597Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "No, mejor 5",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "No, mejor 5", Processing: false
[2025-11-19T16:34:14.598Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "No, mejor 5",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 6,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:14.599Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:14.599Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570054594,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "No, mejor 5",
  "inputLength": 11,
  "context": {
    "step": "ask_date",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"No, mejor 5\""
}
[2025-11-19T16:34:14.600Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570054594,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:14.601Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570054594,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:15.668Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570054594,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 695,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": \"5\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porc",
  "apiCallTimeMs": 1067,
  "reasoning": "Respuesta recibida de Gemini en 1067ms. Extrayendo JSON..."
}
[2025-11-19T16:34:15.669Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570054594,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1070,
  "apiCallTimeMs": 1067,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": "5",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: 5 personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "No, mejor 5"
üîç [DEBUG] Texto en min√∫sculas: "no, mejor 5"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:15.676Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": "5",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 6
  },
  "currentLanguage": "es",
  "originalText": "No, mejor 5",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":6}. An√°lisis contiene: 5 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:15.676Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "peopleCount": 5,
  "peopleAnterior": 6,
  "credibilidad": "100%"
}
[2025-11-19T16:34:15.677Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 6
  },
  "stateAfter": {
    "NumeroReserva": 5
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_date, Time: 1079ms, Response: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:34:15.679Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1079,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1079ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...\""
}
[2025-11-19T16:34:15.679Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a des..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:15.683Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1089,
  "geminiTimeMs": 1070,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1079,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:15.735Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:15.736Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:15.736Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5
  },
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_date, Input: "Ma√±ana", Processing: false
[2025-11-19T16:34:15.737Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 6,
  "inputPreview": "Ma√±ana",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Ma√±ana", Processing: false
[2025-11-19T16:34:15.739Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Ma√±ana",
  "inputLength": 6,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:15.739Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:15.740Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570055734,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Ma√±ana",
  "inputLength": 6,
  "context": {
    "step": "ask_date",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Ma√±ana\""
}
[2025-11-19T16:34:15.740Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570055734,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:15.741Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570055734,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8379,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8379 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:16.710Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570055734,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"ho",
  "apiCallTimeMs": 969,
  "reasoning": "Respuesta recibida de Gemini en 969ms. Extrayendo JSON..."
}
[2025-11-19T16:34:16.711Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570055734,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 971,
  "apiCallTimeMs": 969,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:34:16.712Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "extractedValue": "2025-11-20",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (2025-11-20). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:34:16.712Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5
  },
  "currentLanguage": "es",
  "originalText": "Ma√±ana",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5}. An√°lisis contiene: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:34:16.713Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:34:16.713Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 5
  },
  "stateAfter": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": true,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:34:16.715Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "ask_date",
  "to": "ask_time",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 977
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_time, Time: 977ms, Response: "Perfecto, mesa para 5 personas, el d√≠a 20 de noviembre. ¬øA qu√© hora les gustar√≠a venir?"
[2025-11-19T16:34:16.716Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 977,
  "responseMessage": "Perfecto, mesa para 5 personas, el d√≠a 20 de noviembre. ¬øA qu√© hora les gustar√≠a venir?",
  "reasoning": "Paso procesado en 977ms. Respuesta: \"Perfecto, mesa para 5 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:34:16.716Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 5 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_time
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, Perfecto, mesa para 5 personas, el d√≠a 20 de nov..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:16.721Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "totalTimeMs": 987,
  "geminiTimeMs": 971,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 977,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:16.779Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:16.779Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:16.780Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20"
  },
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_time, Input: "No, mejor pasado ma√±ana", Processing: false
[2025-11-19T16:34:16.782Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasInput": true,
  "inputLength": 23,
  "inputPreview": "No, mejor pasado ma√±ana",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_time, Input: "No, mejor pasado ma√±ana", Processing: false
[2025-11-19T16:34:16.784Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "currentStep": "ask_time",
  "userInput": "No, mejor pasado ma√±ana",
  "inputLength": 23,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-20",
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:16.784Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "hora"
}
[2025-11-19T16:34:16.785Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570056778,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "No, mejor pasado ma√±ana",
  "inputLength": 23,
  "context": {
    "step": "ask_time",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"No, mejor pasado ma√±ana\""
}
[2025-11-19T16:34:16.785Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570056778,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:16.786Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570056778,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8396,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8396 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:17.802Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570056778,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 701,
  "responsePreview": "```json\n{\n  \"intencion\": \"modify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-21\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hor",
  "apiCallTimeMs": 1015,
  "reasoning": "Respuesta recibida de Gemini en 1015ms. Extrayendo JSON..."
}
[2025-11-19T16:34:17.803Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570056778,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1018,
  "apiCallTimeMs": 1015,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "modify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-21",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: modify, Idioma: es. Extra√≠dos: sin personas, fecha 2025-11-21, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "No, mejor pasado ma√±ana"
üîç [DEBUG] Texto en min√∫sculas: "no, mejor pasado ma√±ana"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:17.812Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "analysis": {
    "intencion": "modify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-21",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20"
  },
  "currentLanguage": "es",
  "originalText": "No, mejor pasado ma√±ana",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5,\"FechaReserva\":\"2025-11-20\"}. An√°lisis contiene: sin personas, fecha 2025-11-21, sin hora, sin nombre"
}
[2025-11-19T16:34:17.812Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "fecha": "2025-11-21",
  "fechaAnterior": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:34:17.813Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20"
  },
  "stateAfter": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": true,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_time, Time: 1030ms, Response: "¬øA qu√© hora les gustar√≠a venir? Pueden decir, por ejemplo: las ocho, las ocho y media..."
[2025-11-19T16:34:17.814Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 1030,
  "responseMessage": "¬øA qu√© hora les gustar√≠a venir? Pueden decir, por ejemplo: las ocho, las ocho y media...",
  "reasoning": "Paso procesado en 1030ms. Respuesta: \"¬øA qu√© hora les gustar√≠a venir? Pueden decir, por ...\""
}
[2025-11-19T16:34:17.815Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øA qu√© hora les gustar√≠a venir? Pueden decir, por ...", UseAlgieba: true, NaturalFlow: true, Step: ask_time
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, ¬øA qu√© hora les gustar√≠a venir? Pueden decir, por eje..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:17.819Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "totalTimeMs": 1041,
  "geminiTimeMs": 1018,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1030,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:17.883Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:17.883Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:17.884Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21"
  },
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_time, Input: "A las 8 de la noche", Processing: false
[2025-11-19T16:34:17.886Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasInput": true,
  "inputLength": 19,
  "inputPreview": "A las 8 de la noche",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_time, Input: "A las 8 de la noche", Processing: false
[2025-11-19T16:34:17.888Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "currentStep": "ask_time",
  "userInput": "A las 8 de la noche",
  "inputLength": 19,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-21",
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:17.889Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "hora"
}
[2025-11-19T16:34:17.889Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570057882,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 8 de la noche",
  "inputLength": 19,
  "context": {
    "step": "ask_time",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 8 de la noche\""
}
[2025-11-19T16:34:17.891Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570057882,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:17.892Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570057882,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8392,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8392 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:18.990Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570057882,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 703,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"20:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\": null,\n  \"hor",
  "apiCallTimeMs": 1097,
  "reasoning": "Respuesta recibida de Gemini en 1097ms. Extrayendo JSON..."
}
[2025-11-19T16:34:18.991Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570057882,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1102,
  "apiCallTimeMs": 1097,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "20:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 20:00, sin nombre"
}
[2025-11-19T16:34:18.992Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "extractedValue": "20:00",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (20:00). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:34:18.992Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "analysis": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "20:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21"
  },
  "currentLanguage": "es",
  "originalText": "A las 8 de la noche",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5,\"FechaReserva\":\"2025-11-21\"}. An√°lisis contiene: sin personas, sin fecha, hora 20:00, sin nombre"
}
[2025-11-19T16:34:18.993Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hora": "20:00",
  "credibilidad": "100%"
}
[2025-11-19T16:34:18.994Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21"
  },
  "stateAfter": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "20:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:34:18.995Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "ask_time",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 1108
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_name, Time: 1108ms, Response: "Perfecto, mesa para 5 personas, el d√≠a 21 de noviembre, a las 8 de la noche. ¬øA nombre de qui√©n ser√°"
[2025-11-19T16:34:18.996Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1108,
  "responseMessage": "Perfecto, mesa para 5 personas, el d√≠a 21 de noviembre, a las 8 de la noche. ¬øA nombre de qui√©n ser√°",
  "reasoning": "Paso procesado en 1108ms. Respuesta: \"Perfecto, mesa para 5 personas, el d√≠a 21 de novie...\""
}
[2025-11-19T16:34:18.996Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "20:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 5 personas, el d√≠a 21 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 5 personas, el d√≠a 21 de noviembre, a la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:19.001Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1119,
  "geminiTimeMs": 1102,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1108,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:19.055Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:19.055Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:19.056Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "20:00"
  },
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_name, Input: "Espera, mejor a las 9", Processing: false
[2025-11-19T16:34:19.057Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 21,
  "inputPreview": "Espera, mejor a las 9",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Espera, mejor a las 9", Processing: false
[2025-11-19T16:34:19.059Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Espera, mejor a las 9",
  "inputLength": 21,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-21",
    "hora": "20:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:19.059Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:34:19.060Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570059054,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Espera, mejor a las 9",
  "inputLength": 21,
  "context": {
    "step": "ask_name",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Espera, mejor a las 9\""
}
[2025-11-19T16:34:19.061Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570059054,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:19.061Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570059054,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8394,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8394 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:20.126Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570059054,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 710,
  "responsePreview": "```json\n{\n  \"intencion\": \"modify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"09:00\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_horario\",",
  "apiCallTimeMs": 1064,
  "reasoning": "Respuesta recibida de Gemini en 1064ms. Extrayendo JSON..."
}
[2025-11-19T16:34:20.127Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570059054,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1067,
  "apiCallTimeMs": 1064,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "modify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "09:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: modify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 09:00, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Espera, mejor a las 9"
üîç [DEBUG] Texto en min√∫sculas: "espera, mejor a las 9"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:20.134Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "modify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "09:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "20:00"
  },
  "currentLanguage": "es",
  "originalText": "Espera, mejor a las 9",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5,\"FechaReserva\":\"2025-11-21\",\"HoraReserva\":\"20:00\"}. An√°lisis contiene: sin personas, sin fecha, hora 09:00, sin nombre"
}
[2025-11-19T16:34:20.167Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hora": "09:00",
  "error": "fuera_horario"
}
[2025-11-19T16:34:20.167Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "20:00"
  },
  "stateAfter": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_name, Time: 1110ms, Response: "Disculpe, ¬øpodr√≠a repetir su nombre? No lo he entendido bien."
[2025-11-19T16:34:20.169Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1110,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir su nombre? No lo he entendido bien.",
  "reasoning": "Paso procesado en 1110ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir su nombre? No lo he ente...\""
}
[2025-11-19T16:34:20.169Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir su nombre? No lo he ente...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, ¬øpodr√≠a repetir su nombre? No lo he entendido bien..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:20.173Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1119,
  "geminiTimeMs": 1067,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1110,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:20.236Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:20.237Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:20.238Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  },
  "conversationHistoryLength": 18
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: ask_name, Input: "Mi nombre es Juan Carlos P√©rez Garc√≠a", Processing: false
[2025-11-19T16:34:20.239Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Mi nombre es Juan Carlos P√©rez Garc√≠a",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Mi nombre es Juan Carlos P√©rez Garc√≠a", Processing: false
[2025-11-19T16:34:20.240Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Mi nombre es Juan Carlos P√©rez Garc√≠a",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 19,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:20.240Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:34:20.241Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570060235,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Mi nombre es Juan Carlos P√©rez Garc√≠a",
  "inputLength": 37,
  "context": {
    "step": "ask_name",
    "callSid": "CA_very_long_1763570047147"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Mi nombre es Juan Carlos P√©rez Garc√≠a\""
}
[2025-11-19T16:34:20.242Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570060235,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:20.242Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570060235,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:21.261Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570060235,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1018,
  "reasoning": "Respuesta recibida de Gemini en 1018ms. Extrayendo JSON..."
}
[2025-11-19T16:34:21.262Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570060235,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1021,
  "apiCallTimeMs": 1018,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan Carlos P√©rez Garc√≠a"
}
[2025-11-19T16:34:21.263Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "extractedValue": "Juan Carlos P√©rez Garc√≠a",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (Juan Carlos P√©rez Garc√≠a). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:34:21.263Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  },
  "currentLanguage": "es",
  "originalText": "Mi nombre es Juan Carlos P√©rez Garc√≠a",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5,\"FechaReserva\":\"2025-11-21\",\"HoraReserva\":\"09:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan Carlos P√©rez Garc√≠a"
}
[2025-11-19T16:34:21.264Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "nombre": "Juan Carlos P√©rez Garc√≠a",
  "credibilidad": "100%"
}
[2025-11-19T16:34:21.265Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  },
  "stateAfter": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
‚úÖ Usando mensajes en es para tipo name
[2025-11-19T16:34:21.267Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "ask_name",
  "to": "confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1027
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: confirm, Time: 1027ms, Response: "Muy bien, Juan Carlos P√©rez Garc√≠a. Perfecto, 5 personas, el d√≠a 21 de noviembre a las 09:00, a nomb"
[2025-11-19T16:34:21.268Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 1027,
  "responseMessage": "Muy bien, Juan Carlos P√©rez Garc√≠a. Perfecto, 5 personas, el d√≠a 21 de noviembre a las 09:00, a nomb",
  "reasoning": "Paso procesado en 1027ms. Respuesta: \"Muy bien, Juan Carlos P√©rez Garc√≠a. Perfecto, 5 pe...\""
}
[2025-11-19T16:34:21.268Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Muy bien, Juan Carlos P√©rez Garc√≠a. Perfecto, 5 pe...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Muy bien, Juan Carlos P√©rez Garc√≠a. Perfecto, 5 personas, el..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:34:21.789Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 1554,
  "geminiTimeMs": 1021,
  "stateSaveTimeMs": 515,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1027,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:21.847Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:21.847Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:21.848Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 20
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: confirm, Input: "Mi tel√©fono es 666123456", Processing: false
[2025-11-19T16:34:21.849Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 24,
  "inputPreview": "Mi tel√©fono es 666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "Mi tel√©fono es 666123456", Processing: false
[2025-11-19T16:34:21.850Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "Mi tel√©fono es 666123456",
  "inputLength": 24,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 21,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Mi tel√©fono es 666123456"
üîç [DEBUG] Texto en min√∫sculas: "mi tel√©fono es 666123456"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: confirm, Time: 11ms, Response: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi"
[2025-11-19T16:34:21.861Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 11,
  "responseMessage": "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi",
  "reasoning": "Paso procesado en 11ms. Respuesta: \"Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...\""
}
[2025-11-19T16:34:21.862Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar pers..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:34:22.367Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 521,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 501,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 11,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:22.424Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:22.424Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:22.425Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 22
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: confirm, Input: "Espera, el tel√©fono es 612345678", Processing: false
[2025-11-19T16:34:22.426Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 32,
  "inputPreview": "Espera, el tel√©fono es 612345678",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "Espera, el tel√©fono es 612345678", Processing: false
[2025-11-19T16:34:22.427Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "Espera, el tel√©fono es 612345678",
  "inputLength": 32,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 23,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Espera, el tel√©fono es 612345678"
üîç [DEBUG] Texto en min√∫sculas: "espera, el tel√©fono es 612345678"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: confirm, Time: 9ms, Response: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi"
[2025-11-19T16:34:22.435Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 9,
  "responseMessage": "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...\""
}
[2025-11-19T16:34:22.436Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambia..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:34:22.943Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 520,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 501,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:22.998Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:22.998Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:22.999Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 24
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: confirm, Input: "S√≠, confirmo", Processing: false
[2025-11-19T16:34:23.001Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 12,
  "inputPreview": "S√≠, confirmo",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "S√≠, confirmo", Processing: false
[2025-11-19T16:34:23.002Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "S√≠, confirmo",
  "inputLength": 12,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 25,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:23.002Z] [INFO] ‚úÖ CRITICAL_CONFIRMATION_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "action": "confirm",
  "reasoning": "Confirmaci√≥n v√°lida detectada. Saltando verificaci√≥n de cancelaci√≥n."
}
[2025-11-19T16:34:23.007Z] [INFO] üîç CHECKING_AVAILABILITY_BEFORE_CONFIRM {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 5,
  "fecha": "2025-11-21",
  "hora": "09:00",
  "reasoning": "Usuario confirm√≥ la reserva. Verificando disponibilidad antes de finalizar..."
}
[2025-11-19T16:34:23.008Z] [CAPACITY] üîç AVAILABILITY_CHECK_START {
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 5,
  "cacheKey": "2025-11-21 09:00:00:5",
  "reasoning": "Iniciando verificaci√≥n de disponibilidad para 5 personas el 2025-11-21 09:00:00"
}
[2025-11-19T16:34:23.008Z] [CAPACITY] üîÑ AVAILABILITY_CHECKING_DB {
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 5,
  "reasoning": "No hay resultado en cache. Consultando base de datos para verificar disponibilidad..."
}
[2025-11-19T16:34:23.602Z] [CAPACITY] Verificando disponibilidad {
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 5,
  "personasOcupadas": 0,
  "capacidadMaxima": 100,
  "capacidadDisponible": 100,
  "capacidadConBuffer": 90
}
[2025-11-19T16:34:23.603Z] [CAPACITY] ‚úÖ AVAILABILITY_CHECKED {
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 5,
  "disponible": true,
  "capacidadDisponible": null,
  "capacidadTotal": null,
  "reservasExistentes": null,
  "timeMs": 595,
  "reasoning": "Verificaci√≥n completada en 595ms. Disponible: true. Capacidad disponible: N/A"
}
‚úÖ Usando mensajes en es para tipo confirm
[2025-11-19T16:34:23.605Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "confirm",
  "to": "complete",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 604
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: complete, Time: 604ms, Response: "¬°Perfecto! Todo confirmado. Les esperamos con los brazos abiertos. ¬°Que disfruten mucho!"
[2025-11-19T16:34:23.606Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "processStepTimeMs": 604,
  "responseMessage": "¬°Perfecto! Todo confirmado. Les esperamos con los brazos abiertos. ¬°Que disfruten mucho!",
  "reasoning": "Paso procesado en 604ms. Respuesta: \"¬°Perfecto! Todo confirmado. Les esperamos con los ...\""
}
[2025-11-19T16:34:23.606Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  }
}
[2025-11-19T16:34:24.115Z] [RESERVATION] Guardando reserva en base de datos... {
  "data": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "horaError": "fuera_horario",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a",
    "TelefonReserva": "+34600123456"
  }
}
[2025-11-19T16:34:24.115Z] [RESERVATION] üîç VALIDATION_START {
  "data": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "horaError": "fuera_horario",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n de datos de la reserva antes de guardar en base de datos"
}
[2025-11-19T16:34:24.116Z] [RESERVATION] ‚úÖ BASIC_VALIDATION_PASSED {
  "data": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "horaError": "fuera_horario",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Validaci√≥n b√°sica pas√≥. Procediendo con validaci√≥n completa..."
}
[2025-11-19T16:34:24.117Z] [RESERVATION] üîç FULL_VALIDATION_START {
  "data": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "horaError": "fuera_horario",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n completa (horarios, antelaci√≥n, disponibilidad, etc.)"
}
[2025-11-19T16:34:24.119Z] [RESERVATION] ‚úÖ FULL_VALIDATION_COMPLETED {
  "validationTimeMs": 3,
  "errores": [
    "El restaurante est√° abierto de 13:00 a 23:00"
  ],
  "advertencias": [],
  "reasoning": "Validaci√≥n completa completada en 3ms. V√°lida: undefined"
}
[2025-11-19T16:34:24.120Z] [INFO] RESERVATION_SAVE_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "saved": false,
  "timeMs": 6
}
[2025-11-19T16:34:24.689Z] [INFO] RESERVATION_COMPLETED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete"
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Perfecto! Todo confirmado. Les esperamos con los ...", UseAlgieba: true, NaturalFlow: true, Step: complete
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, ¬°Perfecto! Todo confirmado. Les esperamos con los braz..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 1ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
[2025-11-19T16:34:24.693Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "totalTimeMs": 1696,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 507,
  "availabilityTimeMs": 595,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 604,
  "saveReservationTimeMs": 6,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:24.757Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:24.758Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:25.330Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 26
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: complete, Input: "Espera, mejor cancelo", Processing: false
[2025-11-19T16:34:25.332Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "hasInput": true,
  "inputLength": 21,
  "inputPreview": "Espera, mejor cancelo",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: complete, Input: "Espera, mejor cancelo", Processing: false
[2025-11-19T16:34:25.333Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "currentStep": "complete",
  "userInput": "Espera, mejor cancelo",
  "inputLength": 21,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 27,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Espera, mejor cancelo"
üîç [DEBUG] Texto en min√∫sculas: "espera, mejor cancelo"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: true
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: true
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: true
üîç [DEBUG] Resultado final isCancellationRequest: true
üîç [DEBUG] - Palabras: true
üîç [DEBUG] - Patrones simples: true
üîç [DEBUG] - Patrones complejos: true
[2025-11-19T16:34:25.340Z] [INFO] üö´ CANCELLATION_REQUEST_DETECTED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "userInput": "Espera, mejor cancelo",
  "currentStep": "complete",
  "reasoning": "El usuario expres√≥ intenci√≥n de cancelar. Input: \"Espera, mejor cancelo\""
}
[2025-11-19T16:34:25.341Z] [INFO] üö´ STARTING_CANCELLATION_PROCESS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "reasoning": "Iniciando proceso de cancelaci√≥n de reserva."
}
üö´ [CANCELACI√ìN] Iniciando proceso de cancelaci√≥n de reserva existente
üö´ [DEBUG] Usando tel√©fono de la llamada: +34600123456
üîç [DEBUG] Buscando reservas para el tel√©fono: "+34600123456" (versi√≥n actualizada)
üîç [DEBUG] Tipo de dato del tel√©fono: string
üîç [DEBUG] Longitud del tel√©fono: 12
üîç [DEBUG] Tel√©fono normalizado (solo d√≠gitos): "34600123456"
üîç [DEBUG] Patr√≥n de b√∫squeda 1 (completo): "%34600123456%"
üîç [DEBUG] Patr√≥n de b√∫squeda 2 (√∫ltimos 8 d√≠gitos): "%00123456%"
üîç [DEBUG] Ejecutando consulta SQL: 
          SELECT id_reserva, data_reserva, num_persones, nom_persona_reserva, observacions, telefon
          FROM RESERVA 
          WHERE (telefon LIKE ? OR telefon LIKE ?)
          AND data_reserva >= NOW() 
          AND observacions NOT LIKE '%CANCELADA%'
          ORDER BY data_reserva ASC
        
üîç [DEBUG] Par√°metros: [ '%34600123456%', '%00123456%' ]
üìã [DEBUG] Resultado de la consulta: []
üìã [DEBUG] N√∫mero de filas encontradas: 0
üîç [DEBUG] TODAS las reservas (incluyendo pasadas): [
  {
    id_reserva: 18,
    data_reserva: 2025-10-09T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 19,
    data_reserva: 2025-10-10T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 98678,
    data_reserva: 2025-11-19T19:00:00.000Z,
    num_persones: 6,
    nom_persona_reserva: 'gerard',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959466,
    data_reserva: 2025-11-11T09:39:49.000Z,
    num_persones: 5,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959467,
    data_reserva: 2025-11-13T11:46:20.000Z,
    num_persones: 6,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959490,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959491,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  }
]
‚úÖ Usando mensajes en es para tipo cancel_no_reservations
[2025-11-19T16:34:26.154Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "complete",
  "to": "cancel_no_reservations",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "processStepTimeMs": 822
}
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: cancel_no_reservations, Time: 822ms, Response: "No encontr√© reservas con ese tel√©fono. ¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:34:26.155Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 822,
  "responseMessage": "No encontr√© reservas con ese tel√©fono. ¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 822ms. Respuesta: \"No encontr√© reservas con ese tel√©fono. ¬øQuiere hac...\""
}
[2025-11-19T16:34:26.155Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No encontr√© reservas con ese tel√©fono. ¬øQuiere hac...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "No encontr√© reservas con ese tel√©fono. ¬øQuiere hacer una nue..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:26.159Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 1403,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 822,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:26.219Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:26.220Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:26.220Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 28
}
[BEFORE_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: cancel_no_reservations, Input: "No, mejor s√≠ confirmo", Processing: false
[2025-11-19T16:34:26.221Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 21,
  "inputPreview": "No, mejor s√≠ confirmo",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "No, mejor s√≠ confirmo", Processing: false
[2025-11-19T16:34:26.223Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "No, mejor s√≠ confirmo",
  "inputLength": 21,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 29,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "No, mejor s√≠ confirmo"
üîç [DEBUG] Texto en min√∫sculas: "no, mejor s√≠ confirmo"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [CANCELACI√ìN] No hay reservas - ofreciendo nueva reserva
‚úÖ Usando mensajes en es para tipo cancel_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_very_long_1763570047147, Step: cancel_no_reservations, Time: 12ms, Response: "¬øDesea reservar una mesa?"
[2025-11-19T16:34:26.235Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 12,
  "responseMessage": "¬øDesea reservar una mesa?",
  "reasoning": "Paso procesado en 12ms. Respuesta: \"¬øDesea reservar una mesa?...\""
}
[2025-11-19T16:34:26.236Z] [INFO] STATE_PERSIST {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øDesea reservar una mesa?...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, ¬øDesea reservar una mesa?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:26.240Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_very_long_1763570047147",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 23,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 12,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:34:26][0m PASSED: Extremo - Conversaci√≥n Muy Larga (15 pasos) (19149ms)
[36müß™ [16:34:26][0m üî• EXTREME: Extremo - M√∫ltiples Cambios de Intenci√≥n
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:26.298Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:26.299Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:26.892Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: greeting, Input: "Quiero hacer una reserva", Processing: false
[2025-11-19T16:34:26.894Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 24,
  "inputPreview": "Quiero hacer una reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Quiero hacer una reserva", Processing: false
[2025-11-19T16:34:26.895Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Quiero hacer una reserva",
  "inputLength": 24,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:26.896Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Quiero hacer una reserva",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:34:26.896Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Quiero hacer una reserva",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Quiero hacer una reserva\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:34:26.897Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "1",
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:34:26.897Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:34:26.899Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 5
}
[AFTER_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: ask_people, Time: 5ms, Response: "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:34:26.901Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 5,
  "responseMessage": "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 5ms. Respuesta: \"¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu...\""
}
[2025-11-19T16:34:26.901Z] [INFO] STATE_PERSIST {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, ¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°nta..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:26.906Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 608,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 5,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:26.968Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:26.969Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:26.969Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: ask_people, Input: "Para 4 personas", Processing: false
[2025-11-19T16:34:26.971Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 15,
  "inputPreview": "Para 4 personas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Para 4 personas", Processing: false
[2025-11-19T16:34:26.972Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Para 4 personas",
  "inputLength": 15,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:26.973Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Para 4 personas",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:26.973Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:34:26.974Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:34:26.975Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 4
}
[AFTER_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: ask_date, Time: 4ms, Response: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:34:26.976Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 4,
  "responseMessage": "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 4ms. Respuesta: \"Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...\""
}
[2025-11-19T16:34:26.977Z] [INFO] STATE_PERSIST {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a de..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:26.981Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 14,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 4,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:27.045Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:27.046Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:27.046Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: ask_date, Input: "Espera, mejor quiero cancelar una", Processing: false
[2025-11-19T16:34:27.047Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 33,
  "inputPreview": "Espera, mejor quiero cancelar una",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Espera, mejor quiero cancelar una", Processing: false
[2025-11-19T16:34:27.048Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Espera, mejor quiero cancelar una",
  "inputLength": 33,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:27.049Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:27.050Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_intent_changes_1763570066298",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570067044,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Espera, mejor quiero cancelar una",
  "inputLength": 33,
  "context": {
    "step": "ask_date",
    "callSid": "CA_intent_changes_1763570066298"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Espera, mejor quiero cancelar una\""
}
[2025-11-19T16:34:27.050Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570067044,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:27.051Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_intent_changes_1763570066298",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570067044,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8406,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8406 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:28.636Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_intent_changes_1763570066298",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570067044,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 691,
  "responsePreview": "```json\n{\n  \"intencion\": \"cancel\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcenta",
  "apiCallTimeMs": 1585,
  "reasoning": "Respuesta recibida de Gemini en 1585ms. Extrayendo JSON..."
}
[2025-11-19T16:34:28.637Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_intent_changes_1763570066298",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570067044,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1587,
  "apiCallTimeMs": 1585,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "cancel",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: cancel, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Espera, mejor quiero cancelar una"
üîç [DEBUG] Texto en min√∫sculas: "espera, mejor quiero cancelar una"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: true
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: true
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: true
üîç [DEBUG] Resultado final isCancellationRequest: true
üîç [DEBUG] - Palabras: true
üîç [DEBUG] - Patrones simples: true
üîç [DEBUG] - Patrones complejos: true
[2025-11-19T16:34:28.643Z] [INFO] üö´ CANCELLATION_REQUEST_DETECTED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "userInput": "Espera, mejor quiero cancelar una",
  "currentStep": "ask_date",
  "reasoning": "El usuario expres√≥ intenci√≥n de cancelar. Input: \"Espera, mejor quiero cancelar una\""
}
[2025-11-19T16:34:28.644Z] [INFO] üö´ STARTING_CANCELLATION_PROCESS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Iniciando proceso de cancelaci√≥n de reserva."
}
üö´ [CANCELACI√ìN] Iniciando proceso de cancelaci√≥n de reserva existente
üö´ [DEBUG] Usando tel√©fono de la llamada: +34600123456
üîç [DEBUG] Buscando reservas para el tel√©fono: "+34600123456" (versi√≥n actualizada)
üîç [DEBUG] Tipo de dato del tel√©fono: string
üîç [DEBUG] Longitud del tel√©fono: 12
üîç [DEBUG] Tel√©fono normalizado (solo d√≠gitos): "34600123456"
üîç [DEBUG] Patr√≥n de b√∫squeda 1 (completo): "%34600123456%"
üîç [DEBUG] Patr√≥n de b√∫squeda 2 (√∫ltimos 8 d√≠gitos): "%00123456%"
üîç [DEBUG] Ejecutando consulta SQL: 
          SELECT id_reserva, data_reserva, num_persones, nom_persona_reserva, observacions, telefon
          FROM RESERVA 
          WHERE (telefon LIKE ? OR telefon LIKE ?)
          AND data_reserva >= NOW() 
          AND observacions NOT LIKE '%CANCELADA%'
          ORDER BY data_reserva ASC
        
üîç [DEBUG] Par√°metros: [ '%34600123456%', '%00123456%' ]
üìã [DEBUG] Resultado de la consulta: []
üìã [DEBUG] N√∫mero de filas encontradas: 0
üîç [DEBUG] TODAS las reservas (incluyendo pasadas): [
  {
    id_reserva: 18,
    data_reserva: 2025-10-09T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 19,
    data_reserva: 2025-10-10T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 98678,
    data_reserva: 2025-11-19T19:00:00.000Z,
    num_persones: 6,
    nom_persona_reserva: 'gerard',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959466,
    data_reserva: 2025-11-11T09:39:49.000Z,
    num_persones: 5,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959467,
    data_reserva: 2025-11-13T11:46:20.000Z,
    num_persones: 6,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959490,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959491,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  }
]
‚úÖ Usando mensajes en es para tipo cancel_no_reservations
[2025-11-19T16:34:29.496Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "ask_date",
  "to": "cancel_no_reservations",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 2448
}
[AFTER_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Time: 2448ms, Response: "No he encontrado ninguna reserva activa con ese n√∫mero. ¬øLe gustar√≠a hacer una nueva reserva?"
[2025-11-19T16:34:29.497Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 2448,
  "responseMessage": "No he encontrado ninguna reserva activa con ese n√∫mero. ¬øLe gustar√≠a hacer una nueva reserva?",
  "reasoning": "Paso procesado en 2448ms. Respuesta: \"No he encontrado ninguna reserva activa con ese n√∫...\""
}
[2025-11-19T16:34:29.498Z] [INFO] STATE_PERSIST {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he encontrado ninguna reserva activa con ese n√∫...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, No he encontrado ninguna reserva activa con ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:29.501Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 2457,
  "geminiTimeMs": 1587,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 2448,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:29.567Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:29.567Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:29.568Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Input: "666123456", Processing: false
[2025-11-19T16:34:29.569Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "666123456", Processing: false
[2025-11-19T16:34:29.570Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "666123456",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "666123456"
üîç [DEBUG] Texto en min√∫sculas: "666123456"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [CANCELACI√ìN] No hay reservas - ofreciendo nueva reserva
‚úÖ Usando mensajes en es para tipo cancel_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Time: 11ms, Response: "¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:34:29.582Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 11,
  "responseMessage": "¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 11ms. Respuesta: \"¬øQuiere hacer una nueva reserva?...\""
}
[2025-11-19T16:34:29.582Z] [INFO] STATE_PERSIST {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øQuiere hacer una nueva reserva?...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øQuiere hacer una nueva reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:29.587Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 21,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 11,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:29.646Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:29.646Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:29.647Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Input: "No, mejor s√≠ quiero hacer la reserva", Processing: false
[2025-11-19T16:34:29.648Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 36,
  "inputPreview": "No, mejor s√≠ quiero hacer la reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "No, mejor s√≠ quiero hacer la reserva", Processing: false
[2025-11-19T16:34:29.649Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "No, mejor s√≠ quiero hacer la reserva",
  "inputLength": 36,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "No, mejor s√≠ quiero hacer la reserva"
üîç [DEBUG] Texto en min√∫sculas: "no, mejor s√≠ quiero hacer la reserva"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [CANCELACI√ìN] No hay reservas - ofreciendo nueva reserva
‚úÖ Usando mensajes en es para tipo cancel_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Time: 10ms, Response: "¬øLe gustar√≠a hacer una reserva?"
[2025-11-19T16:34:29.659Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 10,
  "responseMessage": "¬øLe gustar√≠a hacer una reserva?",
  "reasoning": "Paso procesado en 10ms. Respuesta: \"¬øLe gustar√≠a hacer una reserva?...\""
}
[2025-11-19T16:34:29.659Z] [INFO] STATE_PERSIST {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øLe gustar√≠a hacer una reserva?...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, ¬øLe gustar√≠a hacer una reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 13ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:29.673Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 28,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 10,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:29.731Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:29.732Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:29.732Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Input: "Ma√±ana a las 8", Processing: false
[2025-11-19T16:34:29.733Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 14,
  "inputPreview": "Ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "Ma√±ana a las 8", Processing: false
[2025-11-19T16:34:29.735Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "Ma√±ana a las 8",
  "inputLength": 14,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Ma√±ana a las 8"
üîç [DEBUG] Texto en min√∫sculas: "ma√±ana a las 8"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [CANCELACI√ìN] No hay reservas - ofreciendo nueva reserva
‚úÖ Usando mensajes en es para tipo cancel_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Time: 9ms, Response: "¬øLe gustar√≠a hacer una reserva?"
[2025-11-19T16:34:29.744Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 9,
  "responseMessage": "¬øLe gustar√≠a hacer una reserva?",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"¬øLe gustar√≠a hacer una reserva?...\""
}
[2025-11-19T16:34:29.744Z] [INFO] STATE_PERSIST {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øLe gustar√≠a hacer una reserva?...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øLe gustar√≠a hacer una reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:29.749Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 19,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:29.802Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:29.802Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:29.803Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Input: "Juan", Processing: false
[2025-11-19T16:34:29.804Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Juan",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "Juan", Processing: false
[2025-11-19T16:34:29.805Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "Juan",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Juan"
üîç [DEBUG] Texto en min√∫sculas: "juan"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [CANCELACI√ìN] No hay reservas - ofreciendo nueva reserva
‚úÖ Usando mensajes en es para tipo cancel_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Time: 9ms, Response: "¬øLe gustar√≠a hacer una reserva?"
[2025-11-19T16:34:29.814Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 9,
  "responseMessage": "¬øLe gustar√≠a hacer una reserva?",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"¬øLe gustar√≠a hacer una reserva?...\""
}
[2025-11-19T16:34:29.815Z] [INFO] STATE_PERSIST {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øLe gustar√≠a hacer una reserva?...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øLe gustar√≠a hacer una reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:29.818Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 17,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:29.871Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:29.872Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:29.872Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Input: "Espera, mejor quiero modificar una reserva", Processing: false
[2025-11-19T16:34:29.874Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 42,
  "inputPreview": "Espera, mejor quiero modificar una reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "Espera, mejor quiero modificar una reserva", Processing: false
[2025-11-19T16:34:29.875Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "Espera, mejor quiero modificar una reserva",
  "inputLength": 42,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Espera, mejor quiero modificar una reserva"
üîç [DEBUG] Texto en min√∫sculas: "espera, mejor quiero modificar una reserva"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [CANCELACI√ìN] No hay reservas - ofreciendo nueva reserva
‚úÖ Usando mensajes en es para tipo cancel_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Time: 9ms, Response: "¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:34:29.884Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 9,
  "responseMessage": "¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"¬øQuiere hacer una nueva reserva?...\""
}
[2025-11-19T16:34:29.884Z] [INFO] STATE_PERSIST {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øQuiere hacer una nueva reserva?...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, ¬øQuiere hacer una nueva reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:29.889Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 19,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:29.942Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:29.943Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:29.944Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Input: "666123456", Processing: false
[2025-11-19T16:34:29.945Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "666123456", Processing: false
[2025-11-19T16:34:29.946Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "666123456",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "666123456"
üîç [DEBUG] Texto en min√∫sculas: "666123456"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [CANCELACI√ìN] No hay reservas - ofreciendo nueva reserva
‚úÖ Usando mensajes en es para tipo cancel_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_intent_changes_1763570066298, Step: cancel_no_reservations, Time: 11ms, Response: "¬øLe gustar√≠a hacer una reserva?"
[2025-11-19T16:34:29.956Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 11,
  "responseMessage": "¬øLe gustar√≠a hacer una reserva?",
  "reasoning": "Paso procesado en 11ms. Respuesta: \"¬øLe gustar√≠a hacer una reserva?...\""
}
[2025-11-19T16:34:29.957Z] [INFO] STATE_PERSIST {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øLe gustar√≠a hacer una reserva?...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, ¬øLe gustar√≠a hacer una reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:29.960Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_intent_changes_1763570066298",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 19,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 11,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:34:30][0m PASSED: Extremo - M√∫ltiples Cambios de Intenci√≥n (3721ms)
[36müß™ [16:34:30][0m üî• EXTREME: Extremo - Muchas Correcciones
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:30.021Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:30.021Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:30.612Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: greeting, Input: "Reserva", Processing: false
[2025-11-19T16:34:30.614Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva", Processing: false
[2025-11-19T16:34:30.615Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:30.616Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:34:30.616Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:34:30.617Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570070020,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva",
  "inputLength": 7,
  "context": {
    "step": "greeting",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva\""
}
[2025-11-19T16:34:30.617Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570070020,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:30.618Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570070020,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:31.569Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570070020,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 950,
  "reasoning": "Respuesta recibida de Gemini en 950ms. Extrayendo JSON..."
}
[2025-11-19T16:34:31.570Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570070020,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 953,
  "apiCallTimeMs": 950,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:31.571Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:34:31.572Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:34:31.573Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 959
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_people, Time: 959ms, Response: "¬°Claro! ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:34:31.575Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 959,
  "responseMessage": "¬°Claro! ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 959ms. Respuesta: \"¬°Claro! ¬øCu√°ntas personas ser√°n?...\""
}
[2025-11-19T16:34:31.575Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Claro! ¬øCu√°ntas personas ser√°n?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, ¬°Claro! ¬øCu√°ntas personas ser√°n?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:31.578Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1558,
  "geminiTimeMs": 953,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 959,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:31.634Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:31.634Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:31.635Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_people, Input: "Para 2", Processing: false
[2025-11-19T16:34:31.636Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 6,
  "inputPreview": "Para 2",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Para 2", Processing: false
[2025-11-19T16:34:31.637Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Para 2",
  "inputLength": 6,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:31.640Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570071633,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Para 2",
  "inputLength": 6,
  "context": {
    "step": "ask_people",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Para 2\""
}
[2025-11-19T16:34:31.640Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570071633,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:31.641Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570071633,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8379,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8379 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:32.781Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570071633,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 699,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"2\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_",
  "apiCallTimeMs": 1139,
  "reasoning": "Respuesta recibida de Gemini en 1139ms. Extrayendo JSON..."
}
[2025-11-19T16:34:32.782Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570071633,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1142,
  "apiCallTimeMs": 1139,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "2",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 2 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:32.783Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "reservation",
    "comensales": "2",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Para 2",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 2 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:32.784Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 2,
  "credibilidad": "100%"
}
[2025-11-19T16:34:32.784Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:34:32.785Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1148
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_date, Time: 1148ms, Response: "Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:34:32.786Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1148,
  "responseMessage": "Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1148ms. Respuesta: \"Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a dese...\""
}
[2025-11-19T16:34:32.787Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a dese...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a desean hacer l..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:32.790Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1157,
  "geminiTimeMs": 1142,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1148,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:32.847Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:32.848Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:32.848Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_date, Input: "No, 3", Processing: false
[2025-11-19T16:34:32.849Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 5,
  "inputPreview": "No, 3",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "No, 3", Processing: false
[2025-11-19T16:34:32.851Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "No, 3",
  "inputLength": 5,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:32.851Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:32.852Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570072844,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "No, 3",
  "inputLength": 5,
  "context": {
    "step": "ask_date",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"No, 3\""
}
[2025-11-19T16:34:32.852Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570072844,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:32.853Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570072844,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8378,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8378 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:33.921Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570072844,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 695,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": \"3\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porc",
  "apiCallTimeMs": 1067,
  "reasoning": "Respuesta recibida de Gemini en 1067ms. Extrayendo JSON..."
}
[2025-11-19T16:34:33.922Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570072844,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1070,
  "apiCallTimeMs": 1067,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": "3",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: 3 personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "No, 3"
üîç [DEBUG] Texto en min√∫sculas: "no, 3"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:33.928Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": "3",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "No, 3",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: 3 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:33.928Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "peopleCount": 3,
  "peopleAnterior": 2,
  "credibilidad": "100%"
}
[2025-11-19T16:34:33.929Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 3
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_date, Time: 1080ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:34:33.931Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1080,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1080ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:34:33.932Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 3
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:33.935Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1091,
  "geminiTimeMs": 1070,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1080,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:33.995Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:33.995Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:33.996Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 3
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_date, Input: "Espera, 4", Processing: false
[2025-11-19T16:34:33.997Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "Espera, 4",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Espera, 4", Processing: false
[2025-11-19T16:34:33.998Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Espera, 4",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 3,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:33.999Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:33.999Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570073994,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Espera, 4",
  "inputLength": 9,
  "context": {
    "step": "ask_date",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Espera, 4\""
}
[2025-11-19T16:34:34.000Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570073994,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:34.001Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570073994,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8382,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8382 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:35.077Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570073994,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 695,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porc",
  "apiCallTimeMs": 1076,
  "reasoning": "Respuesta recibida de Gemini en 1076ms. Extrayendo JSON..."
}
[2025-11-19T16:34:35.078Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570073994,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1079,
  "apiCallTimeMs": 1076,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: 4 personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Espera, 4"
üîç [DEBUG] Texto en min√∫sculas: "espera, 4"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:35.084Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 3
  },
  "currentLanguage": "es",
  "originalText": "Espera, 4",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":3}. An√°lisis contiene: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:35.084Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "peopleCount": 4,
  "peopleAnterior": 3,
  "credibilidad": "100%"
}
[2025-11-19T16:34:35.085Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 3
  },
  "stateAfter": {
    "NumeroReserva": 4
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_date, Time: 1088ms, Response: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:34:35.087Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1088,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1088ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...\""
}
[2025-11-19T16:34:35.088Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a dese..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:35.091Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1097,
  "geminiTimeMs": 1079,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1088,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:35.144Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:35.145Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:35.146Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_date, Input: "Mejor 5", Processing: false
[2025-11-19T16:34:35.147Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Mejor 5",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Mejor 5", Processing: false
[2025-11-19T16:34:35.148Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Mejor 5",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:35.149Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:35.149Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570075144,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Mejor 5",
  "inputLength": 7,
  "context": {
    "step": "ask_date",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Mejor 5\""
}
[2025-11-19T16:34:35.150Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570075144,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:35.150Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570075144,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:36.170Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570075144,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 695,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": \"5\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porc",
  "apiCallTimeMs": 1018,
  "reasoning": "Respuesta recibida de Gemini en 1018ms. Extrayendo JSON..."
}
[2025-11-19T16:34:36.171Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570075144,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1022,
  "apiCallTimeMs": 1018,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": "5",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: 5 personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Mejor 5"
üîç [DEBUG] Texto en min√∫sculas: "mejor 5"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:36.177Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": "5",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4
  },
  "currentLanguage": "es",
  "originalText": "Mejor 5",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4}. An√°lisis contiene: 5 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:36.177Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "peopleCount": 5,
  "peopleAnterior": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:34:36.178Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 4
  },
  "stateAfter": {
    "NumeroReserva": 5
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_date, Time: 1032ms, Response: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:34:36.180Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1032,
  "responseMessage": "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1032ms. Respuesta: \"¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:34:36.181Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Aja, ¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:36.186Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1042,
  "geminiTimeMs": 1022,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1032,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:36.248Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:36.248Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:36.249Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5
  },
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_date, Input: "Hoy", Processing: false
[2025-11-19T16:34:36.250Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 3,
  "inputPreview": "Hoy",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Hoy", Processing: false
[2025-11-19T16:34:36.251Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Hoy",
  "inputLength": 3,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:36.252Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:36.252Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570076247,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Hoy",
  "inputLength": 3,
  "context": {
    "step": "ask_date",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Hoy\""
}
[2025-11-19T16:34:36.253Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570076247,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:36.254Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570076247,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8376,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8376 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:37.265Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570076247,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 721,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-19\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"16:34\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuer",
  "apiCallTimeMs": 1011,
  "reasoning": "Respuesta recibida de Gemini en 1011ms. Extrayendo JSON..."
}
[2025-11-19T16:34:37.266Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570076247,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1014,
  "apiCallTimeMs": 1011,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-19",
    "fecha_confidence": "100%",
    "hora": "16:34",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, fecha 2025-11-19, hora 16:34, sin nombre"
}
[2025-11-19T16:34:37.266Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "extractedValue": "2025-11-19",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (2025-11-19). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:34:37.267Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-19",
    "fecha_confidence": "100%",
    "hora": "16:34",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5
  },
  "currentLanguage": "es",
  "originalText": "Hoy",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5}. An√°lisis contiene: sin personas, fecha 2025-11-19, hora 16:34, sin nombre"
}
[2025-11-19T16:34:37.267Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "fecha": "2025-11-19",
  "credibilidad": "100%"
}
[2025-11-19T16:34:37.268Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hora": "16:34",
  "error": "fuera_horario"
}
[2025-11-19T16:34:37.269Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 5
  },
  "stateAfter": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-19",
    "HoraReserva": "16:34"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:34:37.270Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "ask_date",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1020
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Time: 1020ms, Response: "Perfecto, mesa para 5 personas, el d√≠a 19 de noviembre, a las 4 y 34 de la tarde. ¬øA nombre de qui√©n"
[2025-11-19T16:34:37.271Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1020,
  "responseMessage": "Perfecto, mesa para 5 personas, el d√≠a 19 de noviembre, a las 4 y 34 de la tarde. ¬øA nombre de qui√©n",
  "reasoning": "Paso procesado en 1020ms. Respuesta: \"Perfecto, mesa para 5 personas, el d√≠a 19 de novie...\""
}
[2025-11-19T16:34:37.271Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-19",
    "HoraReserva": "16:34"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 5 personas, el d√≠a 19 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, Perfecto, mesa para 5 personas, el d√≠a 19 de noviembre..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:34:37.276Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1029,
  "geminiTimeMs": 1014,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1020,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:37.337Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:37.338Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:37.339Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-19",
    "HoraReserva": "16:34"
  },
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Input: "No, ma√±ana", Processing: false
[2025-11-19T16:34:37.340Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "No, ma√±ana",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "No, ma√±ana", Processing: false
[2025-11-19T16:34:37.341Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "No, ma√±ana",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-19",
    "hora": "16:34",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:37.341Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:34:37.342Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570077337,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "No, ma√±ana",
  "inputLength": 10,
  "context": {
    "step": "ask_name",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"No, ma√±ana\""
}
[2025-11-19T16:34:37.343Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570077337,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 1,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:37.343Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570077337,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:38.340Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570077337,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"ho",
  "apiCallTimeMs": 996,
  "reasoning": "Respuesta recibida de Gemini en 996ms. Extrayendo JSON..."
}
[2025-11-19T16:34:38.341Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570077337,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 999,
  "apiCallTimeMs": 996,
  "dataLoadTimeMs": 1,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "No, ma√±ana"
üîç [DEBUG] Texto en min√∫sculas: "no, ma√±ana"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:38.348Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-19",
    "HoraReserva": "16:34"
  },
  "currentLanguage": "es",
  "originalText": "No, ma√±ana",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5,\"FechaReserva\":\"2025-11-19\",\"HoraReserva\":\"16:34\"}. An√°lisis contiene: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:34:38.348Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "fecha": "2025-11-20",
  "fechaAnterior": "2025-11-19",
  "credibilidad": "100%"
}
[2025-11-19T16:34:38.349Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-19",
    "HoraReserva": "16:34"
  },
  "stateAfter": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "16:34"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": true,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Time: 1011ms, Response: "Disculpe, ¬øc√≥mo se llama para la reserva?"
[2025-11-19T16:34:38.352Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1011,
  "responseMessage": "Disculpe, ¬øc√≥mo se llama para la reserva?",
  "reasoning": "Paso procesado en 1011ms. Respuesta: \"Disculpe, ¬øc√≥mo se llama para la reserva?...\""
}
[2025-11-19T16:34:38.352Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "16:34"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øc√≥mo se llama para la reserva?...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, Disculpe, ¬øc√≥mo se llama para la reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:38.356Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1019,
  "geminiTimeMs": 999,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 1,
  "dbTimeMs": 0,
  "processStepTimeMs": 1011,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:38.414Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:38.415Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:38.416Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "16:34"
  },
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Input: "A las 7", Processing: false
[2025-11-19T16:34:38.417Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "A las 7",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "A las 7", Processing: false
[2025-11-19T16:34:38.418Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "A las 7",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-20",
    "hora": "16:34",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:38.419Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:34:38.419Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570078413,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 7",
  "inputLength": 7,
  "context": {
    "step": "ask_name",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 7\""
}
[2025-11-19T16:34:38.420Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570078413,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:38.421Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570078413,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:39.377Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570078413,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 699,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"19:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\": null,\n  \"hora_po",
  "apiCallTimeMs": 956,
  "reasoning": "Respuesta recibida de Gemini en 956ms. Extrayendo JSON..."
}
[2025-11-19T16:34:39.378Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570078413,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 959,
  "apiCallTimeMs": 956,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "19:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 19:00, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "A las 7"
üîç [DEBUG] Texto en min√∫sculas: "a las 7"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:39.385Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "19:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "16:34"
  },
  "currentLanguage": "es",
  "originalText": "A las 7",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"16:34\"}. An√°lisis contiene: sin personas, sin fecha, hora 19:00, sin nombre"
}
[2025-11-19T16:34:39.386Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hora": "19:00",
  "horaAnterior": "16:34",
  "credibilidad": "100%"
}
[2025-11-19T16:34:39.386Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "16:34"
  },
  "stateAfter": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Time: 970ms, Response: "No he entendido bien. ¬øMe puede decir su nombre, por favor?"
[2025-11-19T16:34:39.388Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 970,
  "responseMessage": "No he entendido bien. ¬øMe puede decir su nombre, por favor?",
  "reasoning": "Paso procesado en 970ms. Respuesta: \"No he entendido bien. ¬øMe puede decir su nombre, p...\""
}
[2025-11-19T16:34:39.389Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir su nombre, p...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No he entendido bien. ¬øMe puede decir su nombre, por favor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:39.392Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 979,
  "geminiTimeMs": 959,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 970,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:39.458Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:39.459Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:39.459Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Input: "No, 8", Processing: false
[2025-11-19T16:34:39.461Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 5,
  "inputPreview": "No, 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "No, 8", Processing: false
[2025-11-19T16:34:39.462Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "No, 8",
  "inputLength": 5,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-20",
    "hora": "19:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:39.462Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:34:39.463Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570079457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "No, 8",
  "inputLength": 5,
  "context": {
    "step": "ask_name",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"No, 8\""
}
[2025-11-19T16:34:39.464Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570079457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 1,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:39.464Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570079457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8378,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8378 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:40.786Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570079457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 816,
  "responsePreview": "```json\n{\n  \"intencion\": \"order\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcentaj",
  "apiCallTimeMs": 1321,
  "reasoning": "Respuesta recibida de Gemini en 1321ms. Extrayendo JSON..."
}
[2025-11-19T16:34:40.787Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570079457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1324,
  "apiCallTimeMs": 1321,
  "dataLoadTimeMs": 1,
  "extractedData": {
    "intencion": "order",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 1
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: order, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "No, 8"
üîç [DEBUG] Texto en min√∫sculas: "no, 8"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:40.793Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "order",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "currentLanguage": "es",
  "originalText": "No, 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"19:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:40.794Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "stateAfter": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Time: 1333ms, Response: "Disculpe, ¬øpodr√≠a repetir su nombre? No lo he entendido bien."
[2025-11-19T16:34:40.795Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1333,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir su nombre? No lo he entendido bien.",
  "reasoning": "Paso procesado en 1333ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir su nombre? No lo he ente...\""
}
[2025-11-19T16:34:40.796Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir su nombre? No lo he ente...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, ¬øpodr√≠a repetir su nombre? No lo he entendido bien..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:40.801Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1344,
  "geminiTimeMs": 1324,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 1,
  "dbTimeMs": 0,
  "processStepTimeMs": 1333,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:40.862Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:40.863Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:40.865Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "conversationHistoryLength": 18
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Input: "Mejor 9", Processing: false
[2025-11-19T16:34:40.866Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Mejor 9",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Mejor 9", Processing: false
[2025-11-19T16:34:40.867Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Mejor 9",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 5,
    "fecha": "2025-11-20",
    "hora": "19:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 19,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:40.868Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:34:40.868Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570080861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Mejor 9",
  "inputLength": 7,
  "context": {
    "step": "ask_name",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Mejor 9\""
}
[2025-11-19T16:34:40.869Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570080861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:40.869Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570080861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:41.831Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570080861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 695,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": \"9\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porc",
  "apiCallTimeMs": 961,
  "reasoning": "Respuesta recibida de Gemini en 961ms. Extrayendo JSON..."
}
[2025-11-19T16:34:41.832Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570080861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 964,
  "apiCallTimeMs": 961,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": "9",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: 9 personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Mejor 9"
üîç [DEBUG] Texto en min√∫sculas: "mejor 9"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:41.839Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": "9",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "currentLanguage": "es",
  "originalText": "Mejor 9",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":5,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"19:00\"}. An√°lisis contiene: 9 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:41.839Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "peopleCount": 9,
  "peopleAnterior": 5,
  "credibilidad": "100%"
}
[2025-11-19T16:34:41.840Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 5,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "stateAfter": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Time: 973ms, Response: "Lo siento, no he o√≠do bien su nombre. ¬øC√≥mo se llama?"
[2025-11-19T16:34:41.842Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 973,
  "responseMessage": "Lo siento, no he o√≠do bien su nombre. ¬øC√≥mo se llama?",
  "reasoning": "Paso procesado en 973ms. Respuesta: \"Lo siento, no he o√≠do bien su nombre. ¬øC√≥mo se lla...\""
}
[2025-11-19T16:34:41.843Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he o√≠do bien su nombre. ¬øC√≥mo se lla...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Lo siento, no he o√≠do bien su nombre. ¬øC√≥mo se llama?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:41.846Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 985,
  "geminiTimeMs": 964,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 973,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:41.902Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:41.902Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:41.903Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "conversationHistoryLength": 20
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: ask_name, Input: "Pedro", Processing: false
[2025-11-19T16:34:41.904Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 5,
  "inputPreview": "Pedro",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Pedro", Processing: false
[2025-11-19T16:34:41.905Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Pedro",
  "inputLength": 5,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 9,
    "fecha": "2025-11-20",
    "hora": "19:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 21,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:41.906Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:34:41.906Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570081901,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Pedro",
  "inputLength": 5,
  "context": {
    "step": "ask_name",
    "callSid": "CA_many_corrections_1763570070020"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Pedro\""
}
[2025-11-19T16:34:41.907Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570081901,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:41.907Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570081901,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8378,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8378 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:42.969Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570081901,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 697,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1061,
  "reasoning": "Respuesta recibida de Gemini en 1061ms. Extrayendo JSON..."
}
[2025-11-19T16:34:42.970Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_many_corrections_1763570070020",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570081901,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1064,
  "apiCallTimeMs": 1061,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Pedro",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Pedro"
}
[2025-11-19T16:34:42.970Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "extractedValue": "Pedro",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (Pedro). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:34:42.971Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Pedro",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "currentLanguage": "es",
  "originalText": "Pedro",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":9,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"19:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Pedro"
}
[2025-11-19T16:34:42.972Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "nombre": "Pedro",
  "credibilidad": "100%"
}
[2025-11-19T16:34:42.972Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00"
  },
  "stateAfter": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00",
    "NomReserva": "Pedro"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
‚úÖ Usando mensajes en es para tipo name
[2025-11-19T16:34:42.974Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "ask_name",
  "to": "confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1070
}
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: confirm, Time: 1070ms, Response: "¬°Vale! Pedro. Perfecto, 9 personas, el d√≠a 20 de noviembre a las 19:00, a nombre de Pedro, tel√©fono "
[2025-11-19T16:34:42.975Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 1070,
  "responseMessage": "¬°Vale! Pedro. Perfecto, 9 personas, el d√≠a 20 de noviembre a las 19:00, a nombre de Pedro, tel√©fono ",
  "reasoning": "Paso procesado en 1070ms. Respuesta: \"¬°Vale! Pedro. Perfecto, 9 personas, el d√≠a 20 de n...\""
}
[2025-11-19T16:34:42.975Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00",
    "NomReserva": "Pedro"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Vale! Pedro. Perfecto, 9 personas, el d√≠a 20 de n...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, ¬°Vale! Pedro. Perfecto, 9 personas, el d√≠a 20 de novie..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:34:43.491Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 1590,
  "geminiTimeMs": 1064,
  "stateSaveTimeMs": 511,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1070,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:43.552Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:43.552Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:43.553Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00",
    "NomReserva": "Pedro",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 22
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: confirm, Input: "No, Juan", Processing: false
[2025-11-19T16:34:43.554Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "No, Juan",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "No, Juan", Processing: false
[2025-11-19T16:34:43.555Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "No, Juan",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 9,
    "fecha": "2025-11-20",
    "hora": "19:00",
    "nombre": "Pedro",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 23,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "No, Juan"
üîç [DEBUG] Texto en min√∫sculas: "no, juan"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: confirm, Time: 8ms, Response: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi"
[2025-11-19T16:34:43.563Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 8,
  "responseMessage": "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi",
  "reasoning": "Paso procesado en 8ms. Respuesta: \"Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...\""
}
[2025-11-19T16:34:43.563Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00",
    "NomReserva": "Pedro"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar pers..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:34:44.071Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 520,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 503,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 8,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:44.127Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:44.128Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:44.128Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00",
    "NomReserva": "Pedro",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 24
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: confirm, Input: "666111222", Processing: false
[2025-11-19T16:34:44.130Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666111222",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "666111222", Processing: false
[2025-11-19T16:34:44.131Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "666111222",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 9,
    "fecha": "2025-11-20",
    "hora": "19:00",
    "nombre": "Pedro",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 25,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "666111222"
üîç [DEBUG] Texto en min√∫sculas: "666111222"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: confirm, Time: 8ms, Response: "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi"
[2025-11-19T16:34:44.139Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 8,
  "responseMessage": "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi",
  "reasoning": "Paso procesado en 8ms. Respuesta: \"¬øEs correcto? Puede decir s√≠ para confirmar, no pa...\""
}
[2025-11-19T16:34:44.139Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00",
    "NomReserva": "Pedro"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øEs correcto? Puede decir s√≠ para confirmar, no pa...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:44.645Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 519,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 502,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 8,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:44.699Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:44.699Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:44.700Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00",
    "NomReserva": "Pedro",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 26
}
[BEFORE_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: confirm, Input: "No, 666999888", Processing: false
[2025-11-19T16:34:44.701Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 13,
  "inputPreview": "No, 666999888",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "No, 666999888", Processing: false
[2025-11-19T16:34:44.703Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "No, 666999888",
  "inputLength": 13,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 9,
    "fecha": "2025-11-20",
    "hora": "19:00",
    "nombre": "Pedro",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 27,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "No, 666999888"
üîç [DEBUG] Texto en min√∫sculas: "no, 666999888"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_many_corrections_1763570070020, Step: confirm, Time: 8ms, Response: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi"
[2025-11-19T16:34:44.711Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 8,
  "responseMessage": "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi",
  "reasoning": "Paso procesado en 8ms. Respuesta: \"Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...\""
}
[2025-11-19T16:34:44.711Z] [INFO] STATE_PERSIST {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 9,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "19:00",
    "NomReserva": "Pedro"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambi..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:34:45.221Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_many_corrections_1763570070020",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 523,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 505,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 8,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:34:45][0m PASSED: Extremo - Muchas Correcciones (15259ms)
[35müìã [16:34:45][0m GRUPO 2: Inputs Maliciosos o Inesperados
[36müß™ [16:34:45][0m üî• EXTREME: Seguridad - Intento SQL Injection
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:45.284Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:45.285Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:45.849Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: greeting, Input: "'; DROP TABLE RESERVA; --", Processing: false
[2025-11-19T16:34:45.850Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 25,
  "inputPreview": "'; DROP TABLE RESERVA; --",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "'; DROP TABLE RESERVA; --", Processing: false
[2025-11-19T16:34:45.852Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "'; DROP TABLE RESERVA; --",
  "inputLength": 25,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:45.852Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "'; DROP TABLE RESERVA; --",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:34:45.853Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "'; DROP TABLE RESERVA; --",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"'; DROP TABLE RESERVA; --\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:34:45.853Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570085282,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "'; DROP TABLE RESERVA; --",
  "inputLength": 25,
  "context": {
    "step": "greeting",
    "callSid": "CA_sql_injection_1763570085282"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"'; DROP TABLE RESERVA; --\""
}
[2025-11-19T16:34:45.854Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570085282,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:45.854Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570085282,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8398,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8398 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:46.831Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570085282,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 976,
  "reasoning": "Respuesta recibida de Gemini en 976ms. Extrayendo JSON..."
}
[2025-11-19T16:34:46.832Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570085282,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 979,
  "apiCallTimeMs": 976,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:46.833Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:34:46.834Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:34:46.835Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 984
}
[AFTER_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: ask_people, Time: 984ms, Response: "¬°Perfecto! ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:34:46.836Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 984,
  "responseMessage": "¬°Perfecto! ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 984ms. Respuesta: \"¬°Perfecto! ¬øCu√°ntas personas van a venir?...\""
}
[2025-11-19T16:34:46.837Z] [INFO] STATE_PERSIST {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Perfecto! ¬øCu√°ntas personas van a venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, ¬°Perfecto! ¬øCu√°ntas personas van a venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:46.840Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1558,
  "geminiTimeMs": 979,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 984,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:46.898Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:46.899Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:46.899Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: ask_people, Input: "1' OR '1'='1", Processing: false
[2025-11-19T16:34:46.900Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 12,
  "inputPreview": "1' OR '1'='1",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "1' OR '1'='1", Processing: false
[2025-11-19T16:34:46.902Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "1' OR '1'='1",
  "inputLength": 12,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:46.902Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570086897,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "1' OR '1'='1",
  "inputLength": 12,
  "context": {
    "step": "ask_people",
    "callSid": "CA_sql_injection_1763570085282"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"1' OR '1'='1\""
}
[2025-11-19T16:34:46.903Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570086897,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:46.903Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570086897,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8385,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8385 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:47.956Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570086897,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1052,
  "reasoning": "Respuesta recibida de Gemini en 1052ms. Extrayendo JSON..."
}
[2025-11-19T16:34:47.957Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570086897,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1055,
  "apiCallTimeMs": 1052,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:47.958Z] [INFO] PEOPLE_EXTRACTED_ANY_NUMBER {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 1
}
[2025-11-19T16:34:47.959Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "1",
    "comensales_confidence": "90%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "1' OR '1'='1",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 1 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:47.960Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 1,
  "credibilidad": "90%"
}
[2025-11-19T16:34:47.960Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:34:47.961Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1060
}
[AFTER_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: ask_date, Time: 1060ms, Response: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:34:47.962Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1060,
  "responseMessage": "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1060ms. Respuesta: \"Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:34:47.963Z] [INFO] STATE_PERSIST {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:47.967Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1070,
  "geminiTimeMs": 1055,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1060,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:48.022Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:48.022Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:48.023Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: ask_date, Input: "'; DELETE FROM RESERVA WHERE '1'='1'; --", Processing: false
[2025-11-19T16:34:48.024Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 40,
  "inputPreview": "'; DELETE FROM RESERVA WHERE '1'='1'; --",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "'; DELETE FROM RESERVA WHERE '1'='1'; --", Processing: false
[2025-11-19T16:34:48.025Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "'; DELETE FROM RESERVA WHERE '1'='1'; --",
  "inputLength": 40,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:48.026Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:48.027Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570088021,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "'; DELETE FROM RESERVA WHERE '1'='1'; --",
  "inputLength": 40,
  "context": {
    "step": "ask_date",
    "callSid": "CA_sql_injection_1763570085282"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"'; DELETE FROM RESERVA WHERE '1'='1'; --\""
}
[2025-11-19T16:34:48.027Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570088021,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:48.028Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570088021,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8413,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8413 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:49.059Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570088021,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1031,
  "reasoning": "Respuesta recibida de Gemini en 1031ms. Extrayendo JSON..."
}
[2025-11-19T16:34:49.060Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570088021,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1033,
  "apiCallTimeMs": 1031,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "'; DELETE FROM RESERVA WHERE '1'='1'; --"
üîç [DEBUG] Texto en min√∫sculas: "'; delete from reserva where '1'='1'; --"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:49.066Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "'; DELETE FROM RESERVA WHERE '1'='1'; --",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:49.067Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: ask_date, Time: 1043ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:34:49.068Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1043,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1043ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:34:49.070Z] [INFO] STATE_PERSIST {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:49.073Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1052,
  "geminiTimeMs": 1033,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1043,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:49.128Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:49.128Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:49.129Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: ask_date, Input: "admin'--", Processing: false
[2025-11-19T16:34:49.130Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "admin'--",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "admin'--", Processing: false
[2025-11-19T16:34:49.131Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "admin'--",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:49.132Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:49.132Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570089127,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "admin'--",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_sql_injection_1763570085282"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"admin'--\""
}
[2025-11-19T16:34:49.133Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570089127,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:49.133Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570089127,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:50.153Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570089127,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1019,
  "reasoning": "Respuesta recibida de Gemini en 1019ms. Extrayendo JSON..."
}
[2025-11-19T16:34:50.154Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570089127,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1022,
  "apiCallTimeMs": 1019,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "admin'--"
üîç [DEBUG] Texto en min√∫sculas: "admin'--"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:50.161Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "admin'--",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:50.161Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: ask_date, Time: 1031ms, Response: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:34:50.163Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1031,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1031ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...\""
}
[2025-11-19T16:34:50.164Z] [INFO] STATE_PERSIST {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:50.170Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1043,
  "geminiTimeMs": 1022,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1031,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:50.229Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:50.229Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:50.231Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: ask_date, Input: "1' UNION SELECT * FROM RESERVA--", Processing: false
[2025-11-19T16:34:50.232Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 32,
  "inputPreview": "1' UNION SELECT * FROM RESERVA--",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "1' UNION SELECT * FROM RESERVA--", Processing: false
[2025-11-19T16:34:50.233Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "1' UNION SELECT * FROM RESERVA--",
  "inputLength": 32,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:50.234Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:34:50.234Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570090228,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "1' UNION SELECT * FROM RESERVA--",
  "inputLength": 32,
  "context": {
    "step": "ask_date",
    "callSid": "CA_sql_injection_1763570085282"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"1' UNION SELECT * FROM RESERVA--\""
}
[2025-11-19T16:34:50.235Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570090228,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:50.235Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570090228,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8405,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8405 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:51.285Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570090228,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1049,
  "reasoning": "Respuesta recibida de Gemini en 1049ms. Extrayendo JSON..."
}
[2025-11-19T16:34:51.286Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_sql_injection_1763570085282",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570090228,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1052,
  "apiCallTimeMs": 1049,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "1' UNION SELECT * FROM RESERVA--"
üîç [DEBUG] Texto en min√∫sculas: "1' union select * from reserva--"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:34:51.292Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "1' UNION SELECT * FROM RESERVA--",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:51.293Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_sql_injection_1763570085282, Step: ask_date, Time: 1062ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:34:51.295Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1062,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1062ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:34:51.296Z] [INFO] STATE_PERSIST {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:51.299Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_sql_injection_1763570085282",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1071,
  "geminiTimeMs": 1052,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1062,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:34:51][0m PASSED: Seguridad - Intento SQL Injection (6071ms)
[36müß™ [16:34:51][0m üî• EXTREME: Seguridad - Intento XSS
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:51.355Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:51.356Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:51.934Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: greeting, Input: "<script>alert('XSS')</script>", Processing: false
[2025-11-19T16:34:51.935Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 29,
  "inputPreview": "<script>alert('XSS')</script>",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "<script>alert('XSS')</script>", Processing: false
[2025-11-19T16:34:51.936Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "<script>alert('XSS')</script>",
  "inputLength": 29,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:51.937Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "<script>alert('XSS')</script>",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:34:51.938Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "<script>alert('XSS')</script>",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"<script>alert('XSS')</script>\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:34:51.938Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_xss_1763570091354",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570091354,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "<script>alert('XSS')</script>",
  "inputLength": 29,
  "context": {
    "step": "greeting",
    "callSid": "CA_xss_1763570091354"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"<script>alert('XSS')</script>\""
}
[2025-11-19T16:34:51.939Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_xss_1763570091354",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570091354,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:51.939Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_xss_1763570091354",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570091354,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8402,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8402 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:52.990Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_xss_1763570091354",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570091354,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1050,
  "reasoning": "Respuesta recibida de Gemini en 1050ms. Extrayendo JSON..."
}
[2025-11-19T16:34:52.991Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_xss_1763570091354",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570091354,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1053,
  "apiCallTimeMs": 1050,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:52.992Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:34:52.992Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:34:52.994Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1058
}
[AFTER_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: ask_people, Time: 1058ms, Response: "¬°Genial! ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:34:52.995Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1058,
  "responseMessage": "¬°Genial! ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 1058ms. Respuesta: \"¬°Genial! ¬øCu√°ntas personas van a venir?...\""
}
[2025-11-19T16:34:52.996Z] [INFO] STATE_PERSIST {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Genial! ¬øCu√°ntas personas van a venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, ¬°Genial! ¬øCu√°ntas personas van a venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:52.999Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1645,
  "geminiTimeMs": 1053,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1058,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:53.056Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:53.057Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:53.057Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: ask_people, Input: "<img src=x onerror=alert('XSS')>", Processing: false
[2025-11-19T16:34:53.059Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 32,
  "inputPreview": "<img src=x onerror=alert('XSS')>",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "<img src=x onerror=alert('XSS')>", Processing: false
[2025-11-19T16:34:53.060Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "<img src=x onerror=alert('XSS')>",
  "inputLength": 32,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:53.060Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570093055,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "<img src=x onerror=alert('XSS')>",
  "inputLength": 32,
  "context": {
    "step": "ask_people",
    "callSid": "CA_xss_1763570091354"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"<img src=x onerror=alert('XSS')>\""
}
[2025-11-19T16:34:53.061Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570093055,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:53.061Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570093055,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8405,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8405 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:54.113Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570093055,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1051,
  "reasoning": "Respuesta recibida de Gemini en 1051ms. Extrayendo JSON..."
}
[2025-11-19T16:34:54.114Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570093055,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1054,
  "apiCallTimeMs": 1051,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:54.117Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "<img src=x onerror=alert('XSS')>",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:54.118Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: ask_people, Time: 1060ms, Response: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?"
[2025-11-19T16:34:54.119Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1060,
  "responseMessage": "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?",
  "reasoning": "Paso procesado en 1060ms. Respuesta: \"Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...\""
}
[2025-11-19T16:34:54.120Z] [INFO] STATE_PERSIST {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:54.124Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1069,
  "geminiTimeMs": 1054,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1060,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:54.183Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:54.183Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:54.185Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: ask_people, Input: "javascript:alert('XSS')", Processing: false
[2025-11-19T16:34:54.187Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 23,
  "inputPreview": "javascript:alert('XSS')",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "javascript:alert('XSS')", Processing: false
[2025-11-19T16:34:54.188Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "javascript:alert('XSS')",
  "inputLength": 23,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:54.189Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570094182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "javascript:alert('XSS')",
  "inputLength": 23,
  "context": {
    "step": "ask_people",
    "callSid": "CA_xss_1763570091354"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"javascript:alert('XSS')\""
}
[2025-11-19T16:34:54.189Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570094182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:54.190Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570094182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8396,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8396 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:55.248Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570094182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1056,
  "reasoning": "Respuesta recibida de Gemini en 1056ms. Extrayendo JSON..."
}
[2025-11-19T16:34:55.249Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570094182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1060,
  "apiCallTimeMs": 1056,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:55.251Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "javascript:alert('XSS')",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:55.252Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: ask_people, Time: 1066ms, Response: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor."
[2025-11-19T16:34:55.253Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1066,
  "responseMessage": "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor.",
  "reasoning": "Paso procesado en 1066ms. Respuesta: \"¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...\""
}
[2025-11-19T16:34:55.254Z] [INFO] STATE_PERSIST {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, ¬øPara cu√°ntas personas ser√° la reserva? D√≠game u..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:55.257Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1075,
  "geminiTimeMs": 1060,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1066,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:55.314Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:55.314Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:55.315Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: ask_people, Input: "<svg onload=alert('XSS')>", Processing: false
[2025-11-19T16:34:55.316Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 25,
  "inputPreview": "<svg onload=alert('XSS')>",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "<svg onload=alert('XSS')>", Processing: false
[2025-11-19T16:34:55.317Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "<svg onload=alert('XSS')>",
  "inputLength": 25,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:55.318Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570095313,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "<svg onload=alert('XSS')>",
  "inputLength": 25,
  "context": {
    "step": "ask_people",
    "callSid": "CA_xss_1763570091354"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"<svg onload=alert('XSS')>\""
}
[2025-11-19T16:34:55.318Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570095313,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:55.319Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570095313,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8398,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8398 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:56.273Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570095313,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 954,
  "reasoning": "Respuesta recibida de Gemini en 954ms. Extrayendo JSON..."
}
[2025-11-19T16:34:56.274Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570095313,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 956,
  "apiCallTimeMs": 954,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:56.275Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "<svg onload=alert('XSS')>",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:56.275Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: ask_people, Time: 959ms, Response: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?"
[2025-11-19T16:34:56.276Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 959,
  "responseMessage": "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 959ms. Respuesta: \"No he entendido bien. ¬øMe puede decir cu√°ntas pers...\""
}
[2025-11-19T16:34:56.277Z] [INFO] STATE_PERSIST {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:56.280Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 967,
  "geminiTimeMs": 956,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 959,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:56.340Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:56.340Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:56.341Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: ask_people, Input: "';alert('XSS');//", Processing: false
[2025-11-19T16:34:56.342Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 17,
  "inputPreview": "';alert('XSS');//",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "';alert('XSS');//", Processing: false
[2025-11-19T16:34:56.343Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "';alert('XSS');//",
  "inputLength": 17,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:56.344Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570096339,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "';alert('XSS');//",
  "inputLength": 17,
  "context": {
    "step": "ask_people",
    "callSid": "CA_xss_1763570091354"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"';alert('XSS');//\""
}
[2025-11-19T16:34:56.344Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570096339,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:56.345Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570096339,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8390,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8390 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:57.429Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570096339,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 799,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1083,
  "reasoning": "Respuesta recibida de Gemini en 1083ms. Extrayendo JSON..."
}
[2025-11-19T16:34:57.430Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_xss_1763570091354",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570096339,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1086,
  "apiCallTimeMs": 1083,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 1
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:57.431Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "';alert('XSS');//",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:57.431Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_xss_1763570091354, Step: ask_people, Time: 1089ms, Response: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?"
[2025-11-19T16:34:57.433Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1089,
  "responseMessage": "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 1089ms. Respuesta: \"No he entendido bien. ¬øMe puede decir cu√°ntas pers...\""
}
[2025-11-19T16:34:57.433Z] [INFO] STATE_PERSIST {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:57.436Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_xss_1763570091354",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1097,
  "geminiTimeMs": 1086,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1089,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:34:57][0m PASSED: Seguridad - Intento XSS (6138ms)
[36müß™ [16:34:57][0m üî• EXTREME: Extremo - Bombardeo de Caracteres Especiales
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:57.494Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:57.495Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:58.068Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: greeting, Input: "!@#$%^&*()_+-=[]{}|;':",./<>?", Processing: false
[2025-11-19T16:34:58.069Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 29,
  "inputPreview": "!@#$%^&*()_+-=[]{}|;':\",./<>?",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "!@#$%^&*()_+-=[]{}|;':",./<>?", Processing: false
[2025-11-19T16:34:58.070Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "!@#$%^&*()_+-=[]{}|;':\",./<>?",
  "inputLength": 29,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:58.071Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "!@#$%^&*()_+-=[]{}|;':\",./<>?",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:34:58.071Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "!@#$%^&*()_+-=[]{}|;':\",./<>?",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"!@#$%^&*()_+-=[]{}|;':\",./<>?\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:34:58.072Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_special_chars_1763570097493",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570097494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "!@#$%^&*()_+-=[]{}|;':\",./<>?",
  "inputLength": 29,
  "context": {
    "step": "greeting",
    "callSid": "CA_special_chars_1763570097493"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"!@#$%^&*()_+-=[]{}|;':\",./<>?\""
}
[2025-11-19T16:34:58.072Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570097494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:58.073Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_special_chars_1763570097493",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570097494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8402,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8402 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:34:59.227Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570097494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1153,
  "reasoning": "Respuesta recibida de Gemini en 1153ms. Extrayendo JSON..."
}
[2025-11-19T16:34:59.228Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570097494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1156,
  "apiCallTimeMs": 1153,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:34:59.229Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:34:59.229Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:34:59.231Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1162
}
[AFTER_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Time: 1162ms, Response: "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?"
[2025-11-19T16:34:59.232Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1162,
  "responseMessage": "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?",
  "reasoning": "Paso procesado en 1162ms. Respuesta: \"¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?...\""
}
[2025-11-19T16:34:59.233Z] [INFO] STATE_PERSIST {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:34:59.238Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1744,
  "geminiTimeMs": 1156,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1162,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:34:59.302Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:34:59.303Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:34:59.304Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Input: "√±√°√©√≠√≥√∫√ë√Å√â√ç√ì√ö", Processing: false
[2025-11-19T16:34:59.306Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 12,
  "inputPreview": "√±√°√©√≠√≥√∫√ë√Å√â√ç√ì√ö",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "√±√°√©√≠√≥√∫√ë√Å√â√ç√ì√ö", Processing: false
[2025-11-19T16:34:59.307Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "√±√°√©√≠√≥√∫√ë√Å√â√ç√ì√ö",
  "inputLength": 12,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:34:59.308Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570099301,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "√±√°√©√≠√≥√∫√ë√Å√â√ç√ì√ö",
  "inputLength": 12,
  "context": {
    "step": "ask_people",
    "callSid": "CA_special_chars_1763570097493"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"√±√°√©√≠√≥√∫√ë√Å√â√ç√ì√ö\""
}
[2025-11-19T16:34:59.311Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570099301,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:34:59.311Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570099301,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8385,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8385 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:00.376Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570099301,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1064,
  "reasoning": "Respuesta recibida de Gemini en 1064ms. Extrayendo JSON..."
}
[2025-11-19T16:35:00.377Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570099301,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1069,
  "apiCallTimeMs": 1064,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:00.378Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "√±√°√©√≠√≥√∫√ë√Å√â√ç√ì√ö",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:00.379Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Time: 1073ms, Response: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?"
[2025-11-19T16:35:00.380Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1073,
  "responseMessage": "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 1073ms. Respuesta: \"No he entendido bien. ¬øMe puede decir cu√°ntas pers...\""
}
[2025-11-19T16:35:00.381Z] [INFO] STATE_PERSIST {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:00.385Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1083,
  "geminiTimeMs": 1069,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1073,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:00.444Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:00.446Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:00.447Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Input: "‰∏≠ÊñáÊó•Êú¨Ë™ûÌïúÍµ≠Ïñ¥", Processing: false
[2025-11-19T16:35:00.449Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "‰∏≠ÊñáÊó•Êú¨Ë™ûÌïúÍµ≠Ïñ¥",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "‰∏≠ÊñáÊó•Êú¨Ë™ûÌïúÍµ≠Ïñ¥", Processing: false
[2025-11-19T16:35:00.451Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "‰∏≠ÊñáÊó•Êú¨Ë™ûÌïúÍµ≠Ïñ¥",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:00.452Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570100444,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "‰∏≠ÊñáÊó•Êú¨Ë™ûÌïúÍµ≠Ïñ¥",
  "inputLength": 8,
  "context": {
    "step": "ask_people",
    "callSid": "CA_special_chars_1763570097493"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"‰∏≠ÊñáÊó•Êú¨Ë™ûÌïúÍµ≠Ïñ¥\""
}
[2025-11-19T16:35:00.453Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570100444,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:00.454Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570100444,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:01.424Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570100444,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 970,
  "reasoning": "Respuesta recibida de Gemini en 970ms. Extrayendo JSON..."
}
[2025-11-19T16:35:01.424Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570100444,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 972,
  "apiCallTimeMs": 970,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:01.427Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "‰∏≠ÊñáÊó•Êú¨Ë™ûÌïúÍµ≠Ïñ¥",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:01.428Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Time: 980ms, Response: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:35:01.429Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 980,
  "responseMessage": "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 980ms. Respuesta: \"Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...\""
}
[2025-11-19T16:35:01.430Z] [INFO] STATE_PERSIST {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:01.434Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 990,
  "geminiTimeMs": 972,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 980,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:01.495Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:01.495Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:01.496Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Input: "üöÄüéâüíØüî•‚≠ê", Processing: false
[2025-11-19T16:35:01.497Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "üöÄüéâüíØüî•‚≠ê",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "üöÄüéâüíØüî•‚≠ê", Processing: false
[2025-11-19T16:35:01.498Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "üöÄüéâüíØüî•‚≠ê",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:01.499Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570101494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "üöÄüéâüíØüî•‚≠ê",
  "inputLength": 9,
  "context": {
    "step": "ask_people",
    "callSid": "CA_special_chars_1763570097493"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"üöÄüéâüíØüî•‚≠ê\""
}
[2025-11-19T16:35:01.499Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570101494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:01.500Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570101494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8382,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8382 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:02.486Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570101494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 985,
  "reasoning": "Respuesta recibida de Gemini en 985ms. Extrayendo JSON..."
}
[2025-11-19T16:35:02.486Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570101494,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 987,
  "apiCallTimeMs": 985,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:02.487Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "üöÄüéâüíØüî•‚≠ê",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:02.488Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Time: 990ms, Response: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?"
[2025-11-19T16:35:02.489Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 990,
  "responseMessage": "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?",
  "reasoning": "Paso procesado en 990ms. Respuesta: \"Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...\""
}
[2025-11-19T16:35:02.490Z] [INFO] STATE_PERSIST {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:02.493Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 999,
  "geminiTimeMs": 987,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 990,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:02.550Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:02.550Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:02.551Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Input: "null undefined NaN Infinity", Processing: false
[2025-11-19T16:35:02.552Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 27,
  "inputPreview": "null undefined NaN Infinity",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "null undefined NaN Infinity", Processing: false
[2025-11-19T16:35:02.553Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "null undefined NaN Infinity",
  "inputLength": 27,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:02.554Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570102549,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "null undefined NaN Infinity",
  "inputLength": 27,
  "context": {
    "step": "ask_people",
    "callSid": "CA_special_chars_1763570097493"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"null undefined NaN Infinity\""
}
[2025-11-19T16:35:02.555Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570102549,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:02.555Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570102549,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8400,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8400 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:03.514Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570102549,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 958,
  "reasoning": "Respuesta recibida de Gemini en 958ms. Extrayendo JSON..."
}
[2025-11-19T16:35:03.515Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570102549,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 961,
  "apiCallTimeMs": 958,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:03.516Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "null undefined NaN Infinity",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:03.516Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Time: 964ms, Response: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:35:03.518Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 964,
  "responseMessage": "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 964ms. Respuesta: \"Disculpe, no he entendido bien. ¬øCu√°ntas personas ...\""
}
[2025-11-19T16:35:03.518Z] [INFO] STATE_PERSIST {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:03.521Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 972,
  "geminiTimeMs": 961,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 964,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:03.576Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:03.577Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:03.577Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Input: "\n\r\t\b\f", Processing: false
[2025-11-19T16:35:03.579Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "\\n\\r\\t\\b\\f",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "\n\r\t\b\f", Processing: false
[2025-11-19T16:35:03.580Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "\\n\\r\\t\\b\\f",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:03.580Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570103575,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "\\n\\r\\t\\b\\f",
  "inputLength": 10,
  "context": {
    "step": "ask_people",
    "callSid": "CA_special_chars_1763570097493"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"\\n\\r\\t\\b\\f\""
}
[2025-11-19T16:35:03.581Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570103575,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:03.582Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570103575,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:04.679Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570103575,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1097,
  "reasoning": "Respuesta recibida de Gemini en 1097ms. Extrayendo JSON..."
}
[2025-11-19T16:35:04.679Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570103575,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1099,
  "apiCallTimeMs": 1097,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:04.680Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "\\n\\r\\t\\b\\f",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:04.681Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Time: 1102ms, Response: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?"
[2025-11-19T16:35:04.682Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1102,
  "responseMessage": "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 1102ms. Respuesta: \"No he entendido bien. ¬øMe puede decir cu√°ntas pers...\""
}
[2025-11-19T16:35:04.682Z] [INFO] STATE_PERSIST {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, No he entendido bien. ¬øMe puede decir cu√°ntas pers..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:04.686Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1111,
  "geminiTimeMs": 1099,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1102,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:04.752Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:04.752Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:04.753Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Input: " 	
", Processing: false
[2025-11-19T16:35:04.754Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 16,
  "inputPreview": "\u0000\u0001\u0002\u0003\u0004\u0005\u0006\u0007\b\t\n\u000b\f\r\u000e\u000f",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: " 	
", Processing: false
[2025-11-19T16:35:04.755Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "\u0000\u0001\u0002\u0003\u0004\u0005\u0006\u0007\b\t\n\u000b\f\r\u000e\u000f",
  "inputLength": 16,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:04.756Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570104751,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "\u0000\u0001\u0002\u0003\u0004\u0005\u0006\u0007\b\t\n\u000b\f\r\u000e\u000f",
  "inputLength": 16,
  "context": {
    "step": "ask_people",
    "callSid": "CA_special_chars_1763570097493"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"\u0000\u0001\u0002\u0003\u0004\u0005\u0006\u0007\b\t\n\u000b\f\r\u000e\u000f\""
}
[2025-11-19T16:35:04.756Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570104751,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:04.757Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570104751,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8389,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8389 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:05.794Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570104751,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1037,
  "reasoning": "Respuesta recibida de Gemini en 1037ms. Extrayendo JSON..."
}
[2025-11-19T16:35:05.795Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_special_chars_1763570097493",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570104751,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1039,
  "apiCallTimeMs": 1037,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:05.795Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "\u0000\u0001\u0002\u0003\u0004\u0005\u0006\u0007\b\t\n\u000b\f\r\u000e\u000f",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:05.796Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_special_chars_1763570097493, Step: ask_people, Time: 1042ms, Response: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor."
[2025-11-19T16:35:05.797Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1042,
  "responseMessage": "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor.",
  "reasoning": "Paso procesado en 1042ms. Respuesta: \"¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...\""
}
[2025-11-19T16:35:05.798Z] [INFO] STATE_PERSIST {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:05.801Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_special_chars_1763570097493",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1050,
  "geminiTimeMs": 1039,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1042,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:05][0m PASSED: Extremo - Bombardeo de Caracteres Especiales (8366ms)
[36müß™ [16:35:05][0m üî• EXTREME: Extremo - Input Muy Largo (10K chars)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:05.861Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:05.862Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:06.426Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_extreme_long_1763570105861, Step: greeting, Input: "Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante m", Processing: false
[2025-11-19T16:35:06.428Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 7538,
  "inputPreview": "Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante m",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante m", Processing: false
[2025-11-19T16:35:06.429Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante ma√±ana a las 8",
  "inputLength": 7538,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:06.430Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:06.430Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:06.431Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_extreme_long_1763570105861",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570105861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante muy importante ma√±ana a las 8",
  "inputLength": 7538,
  "context": {
    "step": "greeting",
    "callSid": "CA_extreme_long_1763570105861"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante m\""
}
[2025-11-19T16:35:06.431Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_extreme_long_1763570105861",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570105861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:06.432Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_extreme_long_1763570105861",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570105861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 15911,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (15911 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:07.521Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_extreme_long_1763570105861",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570105861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1088,
  "reasoning": "Respuesta recibida de Gemini en 1088ms. Extrayendo JSON..."
}
[2025-11-19T16:35:07.522Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_extreme_long_1763570105861",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570105861,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1091,
  "apiCallTimeMs": 1088,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:07.522Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:07.523Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:07.523Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas muy importante muy importante muy importante muy importante muy importante m",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:07.524Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:07.525Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:07.525Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:07.526Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:07.526Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:07.527Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:07.527Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:07.528Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1100
}
[AFTER_PROCESS_STEP] CallSid: CA_extreme_long_1763570105861, Step: ask_name, Time: 1100ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:07.529Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1100,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1100ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:07.531Z] [INFO] STATE_PERSIST {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:07.536Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_extreme_long_1763570105861",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1675,
  "geminiTimeMs": 1091,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1100,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:07][0m PASSED: Extremo - Input Muy Largo (10K chars) (1676ms)
[36müß™ [16:35:07][0m üî• EXTREME: Extremo - Inputs Null/Undefined
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:07.538Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:07.539Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_null_inputs_1763570107538",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": false
}
[2025-11-19T16:35:08.154Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_null_inputs_1763570107538",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_null_inputs_1763570107538, Step: greeting, Input: "empty", Processing: false
[2025-11-19T16:35:08.155Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_null_inputs_1763570107538",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": false,
  "inputLength": 0,
  "inputPreview": "empty",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "empty", Processing: false
[2025-11-19T16:35:08.156Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_null_inputs_1763570107538",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "(vac√≠o)",
  "inputLength": 0,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 0,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:08.157Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_null_inputs_1763570107538",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "(vac√≠o)",
  "reasoning": "Iniciando paso de saludo. Sin input, mostrando saludo est√°ndar."
}
‚úÖ Usando mensajes en es para tipo greeting
[2025-11-19T16:35:08.158Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_null_inputs_1763570107538",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_intention",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 2
}
[AFTER_PROCESS_STEP] CallSid: CA_null_inputs_1763570107538, Step: ask_intention, Time: 2ms, Response: "¬°Hola! ¬øC√≥mo est√°? ¬øEn qu√© le puedo ayudar?"
[2025-11-19T16:35:08.159Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_null_inputs_1763570107538",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "processStepTimeMs": 2,
  "responseMessage": "¬°Hola! ¬øC√≥mo est√°? ¬øEn qu√© le puedo ayudar?",
  "reasoning": "Paso procesado en 2ms. Respuesta: \"¬°Hola! ¬øC√≥mo est√°? ¬øEn qu√© le puedo ayudar?...\""
}
[2025-11-19T16:35:08.160Z] [INFO] STATE_PERSIST {
  "callSid": "CA_null_inputs_1763570107538",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Hola! ¬øC√≥mo est√°? ¬øEn qu√© le puedo ayudar?...", UseAlgieba: true, NaturalFlow: true, Step: ask_intention
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, ¬°Hola! ¬øC√≥mo est√°? ¬øEn qu√© le puedo ayudar?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:08.164Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_null_inputs_1763570107538",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "totalTimeMs": 626,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 2,
  "saveReservationTimeMs": 0,
  "hasInput": false
}
[32m‚úÖ [16:35:08][0m PASSED: Extremo - Inputs Null/Undefined (626ms)
[36müß™ [16:35:08][0m üî• EXTREME: Extremo - N√∫meros en Texto
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:08.166Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:08.168Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:08.731Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: greeting, Input: "Reserva para cuatro personas", Processing: false
[2025-11-19T16:35:08.732Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 28,
  "inputPreview": "Reserva para cuatro personas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para cuatro personas", Processing: false
[2025-11-19T16:35:08.733Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para cuatro personas",
  "inputLength": 28,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:08.734Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para cuatro personas",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:08.735Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para cuatro personas",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para cuatro personas\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:08.735Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570108166,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para cuatro personas",
  "inputLength": 28,
  "context": {
    "step": "greeting",
    "callSid": "CA_numeric_text_1763570108166"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para cuatro personas\""
}
[2025-11-19T16:35:08.736Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570108166,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:08.737Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570108166,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8401,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8401 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:09.854Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570108166,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 699,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_",
  "apiCallTimeMs": 1117,
  "reasoning": "Respuesta recibida de Gemini en 1117ms. Extrayendo JSON..."
}
[2025-11-19T16:35:09.855Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570108166,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1120,
  "apiCallTimeMs": 1117,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:09.855Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:09.856Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:09.857Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para cuatro personas",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:09.857Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:09.858Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:35:09.858Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "date",
    "time",
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4}. Faltan: date, time, name"
}
[2025-11-19T16:35:09.859Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "date",
    "time",
    "name"
  ],
  "missingCount": 3,
  "reasoning": "Se determinaron 3 campos faltantes: date, time, name"
}
[2025-11-19T16:35:09.859Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "date",
  "allMissing": [
    "date",
    "time",
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4
  },
  "reasoning": "Faltan 3 campos. Preguntando primero por: date. Campos restantes: time, name"
}
[2025-11-19T16:35:09.860Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1127
}
[AFTER_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: ask_date, Time: 1127ms, Response: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:35:09.861Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1127,
  "responseMessage": "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1127ms. Respuesta: \"Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...\""
}
[2025-11-19T16:35:09.862Z] [INFO] STATE_PERSIST {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean h..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:09.866Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1700,
  "geminiTimeMs": 1120,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1127,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:09.924Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:09.925Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:09.927Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: ask_date, Input: "Ma√±ana", Processing: false
[2025-11-19T16:35:09.928Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 6,
  "inputPreview": "Ma√±ana",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Ma√±ana", Processing: false
[2025-11-19T16:35:09.930Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Ma√±ana",
  "inputLength": 6,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:09.931Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:09.932Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570109923,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Ma√±ana",
  "inputLength": 6,
  "context": {
    "step": "ask_date",
    "callSid": "CA_numeric_text_1763570108166"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Ma√±ana\""
}
[2025-11-19T16:35:09.932Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570109923,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:09.933Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570109923,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8379,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8379 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:11.044Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570109923,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"ho",
  "apiCallTimeMs": 1110,
  "reasoning": "Respuesta recibida de Gemini en 1110ms. Extrayendo JSON..."
}
[2025-11-19T16:35:11.045Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570109923,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1113,
  "apiCallTimeMs": 1110,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:35:11.045Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "extractedValue": "2025-11-20",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (2025-11-20). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:35:11.046Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4
  },
  "currentLanguage": "es",
  "originalText": "Ma√±ana",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4}. An√°lisis contiene: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:35:11.046Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:11.047Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 4
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": true,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:35:11.048Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "ask_date",
  "to": "ask_time",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1120
}
[AFTER_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: ask_time, Time: 1120ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre. ¬øA qu√© hora les gustar√≠a venir?"
[2025-11-19T16:35:11.049Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 1120,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre. ¬øA qu√© hora les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1120ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:11.050Z] [INFO] STATE_PERSIST {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_time
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, Perfecto, mesa para 4 personas, el d√≠a 20 de noviembr..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:11.054Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "totalTimeMs": 1131,
  "geminiTimeMs": 1113,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1120,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:11.113Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:11.114Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:11.114Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: ask_time, Input: "A las ocho de la noche", Processing: false
[2025-11-19T16:35:11.115Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasInput": true,
  "inputLength": 22,
  "inputPreview": "A las ocho de la noche",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_time, Input: "A las ocho de la noche", Processing: false
[2025-11-19T16:35:11.117Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "currentStep": "ask_time",
  "userInput": "A las ocho de la noche",
  "inputLength": 22,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:11.119Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "hora"
}
[2025-11-19T16:35:11.120Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570111112,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las ocho de la noche",
  "inputLength": 22,
  "context": {
    "step": "ask_time",
    "callSid": "CA_numeric_text_1763570108166"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las ocho de la noche\""
}
[2025-11-19T16:35:11.120Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570111112,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:11.121Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570111112,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8395,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8395 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:12.119Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570111112,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 703,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"20:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\": null,\n  \"hor",
  "apiCallTimeMs": 998,
  "reasoning": "Respuesta recibida de Gemini en 998ms. Extrayendo JSON..."
}
[2025-11-19T16:35:12.120Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570111112,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1000,
  "apiCallTimeMs": 998,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "20:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 20:00, sin nombre"
}
[2025-11-19T16:35:12.120Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "extractedValue": "20:00",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (20:00). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:35:12.121Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "analysis": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "20:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "currentLanguage": "es",
  "originalText": "A las ocho de la noche",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\"}. An√°lisis contiene: sin personas, sin fecha, hora 20:00, sin nombre"
}
[2025-11-19T16:35:12.121Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hora": "20:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:12.122Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:12.123Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "ask_time",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 1007
}
[AFTER_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: ask_name, Time: 1007ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la noche. ¬øA nombre de qui√©n ser√°"
[2025-11-19T16:35:12.124Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1007,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la noche. ¬øA nombre de qui√©n ser√°",
  "reasoning": "Paso procesado en 1007ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:12.125Z] [INFO] STATE_PERSIST {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Aja, Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre,..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:12.129Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1017,
  "geminiTimeMs": 1000,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1007,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:12.192Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:12.192Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:12.193Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: ask_name, Input: "Mi nombre es Juan", Processing: false
[2025-11-19T16:35:12.194Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 17,
  "inputPreview": "Mi nombre es Juan",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Mi nombre es Juan", Processing: false
[2025-11-19T16:35:12.195Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Mi nombre es Juan",
  "inputLength": 17,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "20:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:12.196Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:35:12.196Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570112191,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Mi nombre es Juan",
  "inputLength": 17,
  "context": {
    "step": "ask_name",
    "callSid": "CA_numeric_text_1763570108166"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Mi nombre es Juan\""
}
[2025-11-19T16:35:12.197Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570112191,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:12.198Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570112191,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8390,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8390 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:13.185Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570112191,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 696,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 987,
  "reasoning": "Respuesta recibida de Gemini en 987ms. Extrayendo JSON..."
}
[2025-11-19T16:35:13.186Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_numeric_text_1763570108166",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570112191,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 990,
  "apiCallTimeMs": 987,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan"
}
[2025-11-19T16:35:13.187Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "extractedValue": "Juan",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (Juan). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:35:13.187Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "currentLanguage": "es",
  "originalText": "Mi nombre es Juan",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"20:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan"
}
[2025-11-19T16:35:13.188Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "nombre": "Juan",
  "credibilidad": "100%"
}
[2025-11-19T16:35:13.189Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00",
    "NomReserva": "Juan"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
‚úÖ Usando mensajes en es para tipo name
[2025-11-19T16:35:13.190Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "ask_name",
  "to": "confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 995
}
[AFTER_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: confirm, Time: 995ms, Response: "Muy bien, Juan. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 20:00, a nombre de Juan, tel√©fono"
[2025-11-19T16:35:13.191Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 995,
  "responseMessage": "Muy bien, Juan. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 20:00, a nombre de Juan, tel√©fono",
  "reasoning": "Paso procesado en 995ms. Respuesta: \"Muy bien, Juan. Perfecto, 4 personas, el d√≠a 20 de...\""
}
[2025-11-19T16:35:13.192Z] [INFO] STATE_PERSIST {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00",
    "NomReserva": "Juan"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Muy bien, Juan. Perfecto, 4 personas, el d√≠a 20 de...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, Muy bien, Juan. Perfecto, 4 personas, el d√≠a 20 ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:35:13.699Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 1508,
  "geminiTimeMs": 990,
  "stateSaveTimeMs": 501,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 995,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:13.757Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:13.757Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:13.758Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: confirm, Input: "Mi tel√©fono es seis seis seis uno dos tres cuatro cinco seis", Processing: false
[2025-11-19T16:35:13.759Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 60,
  "inputPreview": "Mi tel√©fono es seis seis seis uno dos tres cuatro cinco seis",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "Mi tel√©fono es seis seis seis uno dos tres cuatro cinco seis", Processing: false
[2025-11-19T16:35:13.760Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "Mi tel√©fono es seis seis seis uno dos tres cuatro cinco seis",
  "inputLength": 60,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "20:00",
    "nombre": "Juan",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Mi tel√©fono es seis seis seis uno dos tres cuatro cinco seis"
üîç [DEBUG] Texto en min√∫sculas: "mi tel√©fono es seis seis seis uno dos tres cuatro cinco seis"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_numeric_text_1763570108166, Step: confirm, Time: 30ms, Response: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi"
[2025-11-19T16:35:13.791Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 30,
  "responseMessage": "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi",
  "reasoning": "Paso procesado en 30ms. Respuesta: \"Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...\""
}
[2025-11-19T16:35:13.791Z] [INFO] STATE_PERSIST {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00",
    "NomReserva": "Juan"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar pers..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:35:14.304Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_numeric_text_1763570108166",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 548,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 509,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 30,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:14][0m PASSED: Extremo - N√∫meros en Texto (6190ms)
[35müìã [16:35:14][0m GRUPO 3: L√≠mites de Capacidad
[36müß™ [16:35:14][0m üî• EXTREME: L√≠mite - M√°ximo de Personas (100)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:14.359Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:14.360Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:14.918Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_max_people_1763570114358, Step: greeting, Input: "Reserva para 100 personas", Processing: false
[2025-11-19T16:35:14.919Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 25,
  "inputPreview": "Reserva para 100 personas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 100 personas", Processing: false
[2025-11-19T16:35:14.920Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 100 personas",
  "inputLength": 25,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:14.921Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 100 personas",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:14.921Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 100 personas",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 100 personas\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:14.922Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570114358,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 100 personas",
  "inputLength": 25,
  "context": {
    "step": "greeting",
    "callSid": "CA_max_people_1763570114358"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 100 personas\""
}
[2025-11-19T16:35:14.922Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570114358,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:14.923Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570114358,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8398,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8398 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:15.967Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570114358,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 712,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"100\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"false\",\n  \"comensales_error\": \"max_exceeded\",\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": n",
  "apiCallTimeMs": 1043,
  "reasoning": "Respuesta recibida de Gemini en 1043ms. Extrayendo JSON..."
}
[2025-11-19T16:35:15.968Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570114358,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1046,
  "apiCallTimeMs": 1043,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "100",
    "comensales_confidence": "100%",
    "comensales_validos": "false",
    "comensales_error": "max_exceeded",
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 100 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:15.969Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "100",
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:15.969Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:15.970Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "100",
    "comensales_confidence": "100%",
    "comensales_validos": "false",
    "comensales_error": "max_exceeded",
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 100 personas",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 100 personas, sin fecha, sin hora, sin nombre"
}
[AFTER_PROCESS_STEP] CallSid: CA_max_people_1763570114358, Step: greeting, Time: 1052ms, Response: "Lo siento mucho, tenemos un l√≠mite m√°ximo de 20 personas por reserva. ¬øCu√°ntas personas ser√≠an enton"
[2025-11-19T16:35:15.972Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1052,
  "responseMessage": "Lo siento mucho, tenemos un l√≠mite m√°ximo de 20 personas por reserva. ¬øCu√°ntas personas ser√≠an enton",
  "reasoning": "Paso procesado en 1052ms. Respuesta: \"Lo siento mucho, tenemos un l√≠mite m√°ximo de 20 pe...\""
}
[2025-11-19T16:35:15.973Z] [INFO] STATE_PERSIST {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento mucho, tenemos un l√≠mite m√°ximo de 20 pe...", UseAlgieba: true, NaturalFlow: true, Step: greeting
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Lo siento mucho, tenemos un l√≠mite m√°ximo de 20 personas por..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:15.976Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "totalTimeMs": 1618,
  "geminiTimeMs": 1046,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1052,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:16.036Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:16.036Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:16.037Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_max_people_1763570114358, Step: greeting, Input: "Ma√±ana a las 8", Processing: false
[2025-11-19T16:35:16.038Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 14,
  "inputPreview": "Ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Ma√±ana a las 8", Processing: false
[2025-11-19T16:35:16.039Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Ma√±ana a las 8",
  "inputLength": 14,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:16.040Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:16.041Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:16.041Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570116035,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Ma√±ana a las 8",
  "inputLength": 14,
  "context": {
    "step": "greeting",
    "callSid": "CA_max_people_1763570114358"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Ma√±ana a las 8\""
}
[2025-11-19T16:35:16.042Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570116035,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:16.042Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570116035,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8387,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8387 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:17.045Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570116035,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 713,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\": nu",
  "apiCallTimeMs": 1002,
  "reasoning": "Respuesta recibida de Gemini en 1002ms. Extrayendo JSON..."
}
[2025-11-19T16:35:17.046Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_max_people_1763570114358",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570116035,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1005,
  "apiCallTimeMs": 1002,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: sin personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:17.046Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:17.047Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:17.047Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:17.048Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:17.048Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:17.049Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:17.050Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "people",
    "name"
  ],
  "currentData": {
    "personas": null,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: people, name"
}
[2025-11-19T16:35:17.050Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "people",
    "name"
  ],
  "missingCount": 2,
  "reasoning": "Se determinaron 2 campos faltantes: people, name"
}
[2025-11-19T16:35:17.051Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "people",
  "allMissing": [
    "people",
    "name"
  ],
  "currentData": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 2 campos. Preguntando primero por: people. Campos restantes: name"
}
[2025-11-19T16:35:17.052Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1013
}
[AFTER_PROCESS_STEP] CallSid: CA_max_people_1763570114358, Step: ask_people, Time: 1013ms, Response: "Perfecto, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:35:17.053Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1013,
  "responseMessage": "Perfecto, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 1013ms. Respuesta: \"Perfecto, el d√≠a 20 de noviembre, a las 8 de la ma...\""
}
[2025-11-19T16:35:17.053Z] [INFO] STATE_PERSIST {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, el d√≠a 20 de noviembre, a las 8 de la ma...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, Perfecto, el d√≠a 20 de noviembre, a las 8 de la ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:17.058Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1023,
  "geminiTimeMs": 1005,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1013,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:17.120Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:17.121Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:17.121Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_max_people_1763570114358, Step: ask_people, Input: "Juan", Processing: false
[2025-11-19T16:35:17.123Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Juan",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Juan", Processing: false
[2025-11-19T16:35:17.124Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Juan",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:17.125Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570117120,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan",
  "inputLength": 4,
  "context": {
    "step": "ask_people",
    "callSid": "CA_max_people_1763570114358"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan\""
}
[2025-11-19T16:35:17.125Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570117120,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:17.126Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570117120,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8377,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8377 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:18.110Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570117120,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 696,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 984,
  "reasoning": "Respuesta recibida de Gemini en 984ms. Extrayendo JSON..."
}
[2025-11-19T16:35:18.111Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570117120,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 986,
  "apiCallTimeMs": 984,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan"
}
[2025-11-19T16:35:18.112Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "currentLanguage": "es",
  "originalText": "Juan",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan"
}
[2025-11-19T16:35:18.112Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "Juan",
  "credibilidad": "100%"
}
[2025-11-19T16:35:18.113Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "stateAfter": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_max_people_1763570114358, Step: ask_people, Time: 991ms, Response: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:35:18.114Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 991,
  "responseMessage": "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 991ms. Respuesta: \"Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...\""
}
[2025-11-19T16:35:18.115Z] [INFO] STATE_PERSIST {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "FechaReserva",
    "HoraReserva",
    "NomReserva"
  ],
  "dataValues": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°nta..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:18.118Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 998,
  "geminiTimeMs": 986,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 991,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:18.176Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:18.178Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:18.179Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "FechaReserva",
    "HoraReserva",
    "NomReserva"
  ],
  "dataValues": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_max_people_1763570114358, Step: ask_people, Input: "666123456", Processing: false
[2025-11-19T16:35:18.180Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "666123456", Processing: false
[2025-11-19T16:35:18.182Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "666123456",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": "Juan",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:18.182Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570118175,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "666123456",
  "inputLength": 9,
  "context": {
    "step": "ask_people",
    "callSid": "CA_max_people_1763570114358"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"666123456\""
}
[2025-11-19T16:35:18.183Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570118175,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:18.184Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570118175,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8382,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8382 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:19.266Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570118175,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1082,
  "reasoning": "Respuesta recibida de Gemini en 1082ms. Extrayendo JSON..."
}
[2025-11-19T16:35:19.267Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_max_people_1763570114358",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570118175,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1085,
  "apiCallTimeMs": 1082,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:19.268Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  },
  "currentLanguage": "es",
  "originalText": "666123456",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\",\"NomReserva\":\"Juan\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:19.269Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  },
  "stateAfter": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_max_people_1763570114358, Step: ask_people, Time: 1088ms, Response: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?"
[2025-11-19T16:35:19.270Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1088,
  "responseMessage": "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?",
  "reasoning": "Paso procesado en 1088ms. Respuesta: \"Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...\""
}
[2025-11-19T16:35:19.271Z] [INFO] STATE_PERSIST {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "FechaReserva",
    "HoraReserva",
    "NomReserva"
  ],
  "dataValues": {
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:19.274Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_max_people_1763570114358",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1099,
  "geminiTimeMs": 1085,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1088,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:19][0m PASSED: L√≠mite - M√°ximo de Personas (100) (4978ms)
[36müß™ [16:35:19][0m üî• EXTREME: L√≠mite - M√≠nimo de Personas (0)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:19.340Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:19.341Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:19.902Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_min_people_1763570119338, Step: greeting, Input: "Reserva para 0 personas ma√±ana", Processing: false
[2025-11-19T16:35:19.904Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 30,
  "inputPreview": "Reserva para 0 personas ma√±ana",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 0 personas ma√±ana", Processing: false
[2025-11-19T16:35:19.905Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 0 personas ma√±ana",
  "inputLength": 30,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:19.906Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 0 personas ma√±ana",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:19.906Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 0 personas ma√±ana",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 0 personas ma√±ana\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:19.907Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_min_people_1763570119338",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570119338,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 0 personas ma√±ana",
  "inputLength": 30,
  "context": {
    "step": "greeting",
    "callSid": "CA_min_people_1763570119338"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 0 personas ma√±ana\""
}
[2025-11-19T16:35:19.907Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_min_people_1763570119338",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570119338,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:19.908Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_min_people_1763570119338",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570119338,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8403,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8403 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:21.037Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_min_people_1763570119338",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570119338,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 719,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"0\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"false\",\n  \"comensales_error\": \"min_not_met\",\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_er",
  "apiCallTimeMs": 1128,
  "reasoning": "Respuesta recibida de Gemini en 1128ms. Extrayendo JSON..."
}
[2025-11-19T16:35:21.038Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_min_people_1763570119338",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570119338,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1131,
  "apiCallTimeMs": 1128,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "0",
    "comensales_confidence": "100%",
    "comensales_validos": "false",
    "comensales_error": "min_not_met",
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 0 personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:35:21.038Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "0",
    "fecha": "2025-11-20",
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:21.039Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:21.040Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "0",
    "comensales_confidence": "100%",
    "comensales_validos": "false",
    "comensales_error": "min_not_met",
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 0 personas ma√±ana",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 0 personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:35:21.041Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "time",
    "name"
  ],
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {}. Faltan: time, name"
}
[2025-11-19T16:35:21.041Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "time",
    "name"
  ],
  "missingCount": 2,
  "reasoning": "Se determinaron 2 campos faltantes: time, name"
}
[2025-11-19T16:35:21.042Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "time",
  "allMissing": [
    "time",
    "name"
  ],
  "currentData": {},
  "reasoning": "Faltan 2 campos. Preguntando primero por: time. Campos restantes: name"
}
[2025-11-19T16:35:21.042Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_time",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1138
}
[AFTER_PROCESS_STEP] CallSid: CA_min_people_1763570119338, Step: ask_time, Time: 1138ms, Response: "Perfecto. ¬øA qu√© hora les gustar√≠a venir?"
[2025-11-19T16:35:21.044Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 1138,
  "responseMessage": "Perfecto. ¬øA qu√© hora les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1138ms. Respuesta: \"Perfecto. ¬øA qu√© hora les gustar√≠a venir?...\""
}
[2025-11-19T16:35:21.044Z] [INFO] STATE_PERSIST {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto. ¬øA qu√© hora les gustar√≠a venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_time
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto. ¬øA qu√© hora les gustar√≠a venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:21.049Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_min_people_1763570119338",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "totalTimeMs": 1711,
  "geminiTimeMs": 1131,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1138,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:21][0m PASSED: L√≠mite - M√≠nimo de Personas (0) (1711ms)
[36müß™ [16:35:21][0m üî• EXTREME: L√≠mite - N√∫meros Negativos
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:21.051Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:21.052Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:21.647Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_negative_1763570121051, Step: greeting, Input: "Reserva para -5 personas", Processing: false
[2025-11-19T16:35:21.648Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 24,
  "inputPreview": "Reserva para -5 personas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para -5 personas", Processing: false
[2025-11-19T16:35:21.649Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para -5 personas",
  "inputLength": 24,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:21.650Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para -5 personas",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:21.650Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para -5 personas",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para -5 personas\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:21.651Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_negative_1763570121051",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570121051,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para -5 personas",
  "inputLength": 24,
  "context": {
    "step": "greeting",
    "callSid": "CA_negative_1763570121051"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para -5 personas\""
}
[2025-11-19T16:35:21.652Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_negative_1763570121051",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570121051,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:21.652Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_negative_1763570121051",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570121051,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8397,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8397 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:22.600Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_negative_1763570121051",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570121051,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 710,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"-5\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"false\",\n  \"comensales_error\": \"min_not_met\",\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": nul",
  "apiCallTimeMs": 947,
  "reasoning": "Respuesta recibida de Gemini en 947ms. Extrayendo JSON..."
}
[2025-11-19T16:35:22.601Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_negative_1763570121051",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570121051,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 950,
  "apiCallTimeMs": 947,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "-5",
    "comensales_confidence": "100%",
    "comensales_validos": "false",
    "comensales_error": "min_not_met",
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: -5 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:22.602Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "-5",
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:22.603Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:22.603Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "-5",
    "comensales_confidence": "100%",
    "comensales_validos": "false",
    "comensales_error": "min_not_met",
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para -5 personas",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: -5 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:22.605Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "date",
    "time",
    "name"
  ],
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {}. Faltan: date, time, name"
}
[2025-11-19T16:35:22.605Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "date",
    "time",
    "name"
  ],
  "missingCount": 3,
  "reasoning": "Se determinaron 3 campos faltantes: date, time, name"
}
[2025-11-19T16:35:22.606Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "date",
  "allMissing": [
    "date",
    "time",
    "name"
  ],
  "currentData": {},
  "reasoning": "Faltan 3 campos. Preguntando primero por: date. Campos restantes: time, name"
}
[2025-11-19T16:35:22.606Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 957
}
[AFTER_PROCESS_STEP] CallSid: CA_negative_1763570121051, Step: ask_date, Time: 957ms, Response: "Perfecto. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:35:22.607Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 957,
  "responseMessage": "Perfecto. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 957ms. Respuesta: \"Perfecto. ¬øPara qu√© d√≠a desean hacer la reserva?...\""
}
[2025-11-19T16:35:22.608Z] [INFO] STATE_PERSIST {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto. ¬øPara qu√© d√≠a desean hacer la reserva?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, Perfecto. ¬øPara qu√© d√≠a desean hacer la rese..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:22.612Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1561,
  "geminiTimeMs": 950,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 957,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:22.671Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:22.671Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:22.672Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_negative_1763570121051, Step: ask_date, Input: "Ma√±ana", Processing: false
[2025-11-19T16:35:22.673Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 6,
  "inputPreview": "Ma√±ana",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Ma√±ana", Processing: false
[2025-11-19T16:35:22.674Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Ma√±ana",
  "inputLength": 6,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:22.675Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:22.675Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "extractedValue": "2025-11-20",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (2025-11-20). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:35:22.676Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Ma√±ana",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:35:22.677Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:22.677Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {},
  "stateAfter": {
    "FechaReserva": "2025-11-20"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": true,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:35:22.678Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "ask_date",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 5
}
[AFTER_PROCESS_STEP] CallSid: CA_negative_1763570121051, Step: ask_people, Time: 5ms, Response: "Perfecto, el d√≠a 20 de noviembre. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:35:22.680Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 5,
  "responseMessage": "Perfecto, el d√≠a 20 de noviembre. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 5ms. Respuesta: \"Perfecto, el d√≠a 20 de noviembre. ¬øPara cu√°ntas pe...\""
}
[2025-11-19T16:35:22.681Z] [INFO] STATE_PERSIST {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "FechaReserva"
  ],
  "dataValues": {
    "FechaReserva": "2025-11-20"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, el d√≠a 20 de noviembre. ¬øPara cu√°ntas pe...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, Perfecto, el d√≠a 20 de noviembre. ¬øPara cu√°ntas pe..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:22.686Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 15,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 5,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:22.749Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:22.750Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:22.750Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "FechaReserva"
  ],
  "dataValues": {
    "FechaReserva": "2025-11-20"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_negative_1763570121051, Step: ask_people, Input: "A las -8", Processing: false
[2025-11-19T16:35:22.751Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "A las -8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "A las -8", Processing: false
[2025-11-19T16:35:22.753Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "A las -8",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": "2025-11-20",
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:22.753Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_negative_1763570121051",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570122748,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las -8",
  "inputLength": 8,
  "context": {
    "step": "ask_people",
    "callSid": "CA_negative_1763570121051"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las -8\""
}
[2025-11-19T16:35:22.754Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_negative_1763570121051",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570122748,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:22.755Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_negative_1763570121051",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570122748,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:23.738Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_negative_1763570121051",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570122748,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 699,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\": null,\n  \"hora_po",
  "apiCallTimeMs": 983,
  "reasoning": "Respuesta recibida de Gemini en 983ms. Extrayendo JSON..."
}
[2025-11-19T16:35:23.739Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_negative_1763570121051",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570122748,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 986,
  "apiCallTimeMs": 983,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 08:00, sin nombre"
}
[2025-11-19T16:35:23.740Z] [INFO] PEOPLE_EXTRACTED_ANY_NUMBER {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 8
}
[2025-11-19T16:35:23.740Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "8",
    "comensales_confidence": "90%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "FechaReserva": "2025-11-20"
  },
  "currentLanguage": "es",
  "originalText": "A las -8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"FechaReserva\":\"2025-11-20\"}. An√°lisis contiene: 8 personas, sin fecha, hora 08:00, sin nombre"
}
[2025-11-19T16:35:23.741Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 8,
  "credibilidad": "90%"
}
[2025-11-19T16:35:23.742Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:23.743Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "FechaReserva": "2025-11-20"
  },
  "stateAfter": {
    "NumeroReserva": 8,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:23.743Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 991
}
[AFTER_PROCESS_STEP] CallSid: CA_negative_1763570121051, Step: ask_name, Time: 991ms, Response: "Perfecto, mesa para 8 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:23.746Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 991,
  "responseMessage": "Perfecto, mesa para 8 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 991ms. Respuesta: \"Perfecto, mesa para 8 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:23.746Z] [INFO] STATE_PERSIST {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "FechaReserva",
    "NumeroReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 8,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 8 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, Perfecto, mesa para 8 personas, el d√≠a 20 de noviembre..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:23.751Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_negative_1763570121051",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1003,
  "geminiTimeMs": 986,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 991,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:23][0m PASSED: L√≠mite - N√∫meros Negativos (2759ms)
[36müß™ [16:35:23][0m üî• EXTREME: L√≠mite - Fecha Muy Futura (2099)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:23.811Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:23.811Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:24.410Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_far_future_1763570123810, Step: greeting, Input: "Reserva para 4 personas el 31 de diciembre de 2099 a las 8", Processing: false
[2025-11-19T16:35:24.411Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 58,
  "inputPreview": "Reserva para 4 personas el 31 de diciembre de 2099 a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas el 31 de diciembre de 2099 a las 8", Processing: false
[2025-11-19T16:35:24.412Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas el 31 de diciembre de 2099 a las 8",
  "inputLength": 58,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:24.413Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas el 31 de diciembre de 2099 a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:24.414Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas el 31 de diciembre de 2099 a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas el 31 de diciembre de 2099 a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:24.414Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_far_future_1763570123810",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570123810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas el 31 de diciembre de 2099 a las 8",
  "inputLength": 58,
  "context": {
    "step": "greeting",
    "callSid": "CA_far_future_1763570123810"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas el 31 de diciembre de 2099 a las 8\""
}
[2025-11-19T16:35:24.415Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_far_future_1763570123810",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570123810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:24.416Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_far_future_1763570123810",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570123810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8431,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8431 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:25.366Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_far_future_1763570123810",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570123810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2099-12-31\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 950,
  "reasoning": "Respuesta recibida de Gemini en 950ms. Extrayendo JSON..."
}
[2025-11-19T16:35:25.367Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_far_future_1763570123810",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570123810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 953,
  "apiCallTimeMs": 950,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2099-12-31",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2099-12-31, hora 08:00, sin nombre"
}
[2025-11-19T16:35:25.367Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2099-12-31",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:25.368Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:25.369Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2099-12-31",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas el 31 de diciembre de 2099 a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2099-12-31, hora 08:00, sin nombre"
}
[2025-11-19T16:35:25.369Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:25.370Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2099-12-31",
  "credibilidad": "100%"
}
[2025-11-19T16:35:25.370Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:25.371Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2099-12-31",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:25.372Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2099-12-31",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2099-12-31\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:25.372Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:25.373Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2099-12-31",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:25.373Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 961
}
[AFTER_PROCESS_STEP] CallSid: CA_far_future_1763570123810, Step: ask_name, Time: 961ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 31 de diciembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:25.374Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 961,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 31 de diciembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 961ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 31 de dicie...\""
}
[2025-11-19T16:35:25.376Z] [INFO] STATE_PERSIST {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2099-12-31",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 31 de dicie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas, el d√≠a 31 de diciembre, a la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:25.380Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_far_future_1763570123810",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1570,
  "geminiTimeMs": 953,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 961,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:25][0m PASSED: L√≠mite - Fecha Muy Futura (2099) (1570ms)
[36müß™ [16:35:25][0m üî• EXTREME: L√≠mite - Fecha Muy Pasada (1900)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:25.384Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:25.385Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:25.953Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_old_date_1763570125382, Step: greeting, Input: "Reserva para 4 personas el 1 de enero de 1900 a las 8", Processing: false
[2025-11-19T16:35:25.955Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 53,
  "inputPreview": "Reserva para 4 personas el 1 de enero de 1900 a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas el 1 de enero de 1900 a las 8", Processing: false
[2025-11-19T16:35:25.956Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas el 1 de enero de 1900 a las 8",
  "inputLength": 53,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:25.957Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas el 1 de enero de 1900 a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:25.957Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas el 1 de enero de 1900 a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas el 1 de enero de 1900 a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:25.958Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_old_date_1763570125382",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570125382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas el 1 de enero de 1900 a las 8",
  "inputLength": 53,
  "context": {
    "step": "greeting",
    "callSid": "CA_old_date_1763570125382"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas el 1 de enero de 1900 a las 8\""
}
[2025-11-19T16:35:25.960Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_old_date_1763570125382",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570125382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:25.961Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_old_date_1763570125382",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570125382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8426,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8426 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:26.984Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_old_date_1763570125382",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570125382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"1900-01-01\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1023,
  "reasoning": "Respuesta recibida de Gemini en 1023ms. Extrayendo JSON..."
}
[2025-11-19T16:35:26.985Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_old_date_1763570125382",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570125382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1027,
  "apiCallTimeMs": 1023,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "1900-01-01",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 1900-01-01, hora 08:00, sin nombre"
}
[2025-11-19T16:35:26.985Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "1900-01-01",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:26.986Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:26.986Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "1900-01-01",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas el 1 de enero de 1900 a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 1900-01-01, hora 08:00, sin nombre"
}
[2025-11-19T16:35:26.987Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:26.987Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "1900-01-01",
  "credibilidad": "100%"
}
[2025-11-19T16:35:26.988Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:26.989Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "1900-01-01",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:26.989Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "1900-01-01",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"1900-01-01\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:26.990Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:26.990Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "1900-01-01",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:26.991Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1035
}
[AFTER_PROCESS_STEP] CallSid: CA_old_date_1763570125382, Step: ask_name, Time: 1035ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 1 de enero, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser√° la "
[2025-11-19T16:35:26.992Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1035,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 1 de enero, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser√° la ",
  "reasoning": "Paso procesado en 1035ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 1 de enero,...\""
}
[2025-11-19T16:35:26.993Z] [INFO] STATE_PERSIST {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "1900-01-01",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 1 de enero,...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, Perfecto, mesa para 4 personas, el d√≠a 1 de enero, a ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:26.997Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_old_date_1763570125382",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1615,
  "geminiTimeMs": 1027,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1035,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:26][0m PASSED: L√≠mite - Fecha Muy Pasada (1900) (1616ms)
[35müìã [16:35:26][0m GRUPO 4: Casos de Estr√©s y Carga
[36müß™ [16:35:26][0m üî• EXTREME: Estr√©s - Requests R√°pidos (11 simult√°neos)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.000Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.001Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.003Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.004Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.005Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.006Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.007Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.008Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.009Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.009Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.012Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.013Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.014Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.015Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.016Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.016Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.017Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.018Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.021Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.022Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:27.023Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:27.024Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:27.600Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "P√©rez", Processing: false
[2025-11-19T16:35:27.601Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 5,
  "inputPreview": "P√©rez",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "P√©rez", Processing: false
[2025-11-19T16:35:27.603Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "P√©rez",
  "inputLength": 5,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.603Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "P√©rez",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.604Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "P√©rez",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"P√©rez\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.604Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "P√©rez",
  "inputLength": 5,
  "context": {
    "step": "greeting",
    "callSid": "CA_rapid_fire_1763570127000"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"P√©rez\""
}
[2025-11-19T16:35:27.605Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:27.605Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8378,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8378 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:27.608Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "Reserva", Processing: false
[2025-11-19T16:35:27.610Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva", Processing: false
[2025-11-19T16:35:27.612Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.612Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.613Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.613Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva",
  "inputLength": 7,
  "context": {
    "step": "greeting",
    "callSid": "CA_rapid_fire_1763570127000"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva\""
}
[2025-11-19T16:35:27.614Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:27.615Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:27.619Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "8", Processing: false
[2025-11-19T16:35:27.621Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 1,
  "inputPreview": "8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "8", Processing: false
[2025-11-19T16:35:27.622Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "8",
  "inputLength": 1,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.622Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.623Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.624Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "8",
  "inputLength": 1,
  "context": {
    "step": "greeting",
    "callSid": "CA_rapid_fire_1763570127000"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"8\""
}
[2025-11-19T16:35:27.624Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:27.625Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8374,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8374 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:27.627Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "Juan", Processing: false
[2025-11-19T16:35:27.628Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Juan",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Juan", Processing: false
[2025-11-19T16:35:27.630Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Juan",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.631Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Juan",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.631Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Juan",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Juan\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.632Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": "Juan"
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:27.633Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:27.634Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 5
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 5ms, Response: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:35:27.637Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 5,
  "responseMessage": "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 5ms. Respuesta: \"¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?...\""
}
[2025-11-19T16:35:27.638Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:27.641Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 641,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 14,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 5,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:27.642Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "456", Processing: false
[2025-11-19T16:35:27.644Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 3,
  "inputPreview": "456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "456", Processing: false
[2025-11-19T16:35:27.647Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "456",
  "inputLength": 3,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.647Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "456",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.650Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "456",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"456\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.651Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 22,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "456",
  "inputLength": 3,
  "context": {
    "step": "greeting",
    "callSid": "CA_rapid_fire_1763570127000"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"456\""
}
[2025-11-19T16:35:27.651Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 22,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:27.652Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 22,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8376,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8376 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:27.653Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "ma√±ana", Processing: false
[2025-11-19T16:35:27.655Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 6,
  "inputPreview": "ma√±ana",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "ma√±ana", Processing: false
[2025-11-19T16:35:27.656Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "ma√±ana",
  "inputLength": 6,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.656Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "ma√±ana",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.657Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "ma√±ana",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"ma√±ana\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.658Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": "2025-11-20",
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:27.660Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:27.662Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 7
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 7ms, Response: "¬°Claro! ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:35:27.663Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 7,
  "responseMessage": "¬°Claro! ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 7ms. Respuesta: \"¬°Claro! ¬øCu√°ntas personas ser√°n?...\""
}
[2025-11-19T16:35:27.663Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Claro! ¬øCu√°ntas personas ser√°n?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, ¬°Claro! ¬øCu√°ntas personas ser√°n?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:27.669Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 669,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 6,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 7,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:27.670Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "4", Processing: false
[2025-11-19T16:35:27.671Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 1,
  "inputPreview": "4",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "4", Processing: false
[2025-11-19T16:35:27.672Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "4",
  "inputLength": 1,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.672Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "4",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.683Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "4",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"4\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.684Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "4",
  "inputLength": 1,
  "context": {
    "step": "greeting",
    "callSid": "CA_rapid_fire_1763570127000"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"4\""
}
[2025-11-19T16:35:27.685Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:27.685Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8374,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8374 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:27.689Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "personas", Processing: false
[2025-11-19T16:35:27.692Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "personas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "personas", Processing: false
[2025-11-19T16:35:27.693Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "personas",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.694Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "personas",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.696Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "personas",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"personas\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.697Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 5,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "personas",
  "inputLength": 8,
  "context": {
    "step": "greeting",
    "callSid": "CA_rapid_fire_1763570127000"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"personas\""
}
[2025-11-19T16:35:27.697Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 5,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:27.698Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 5,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:27.701Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "PM", Processing: false
[2025-11-19T16:35:27.704Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 2,
  "inputPreview": "PM",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "PM", Processing: false
[2025-11-19T16:35:27.706Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "PM",
  "inputLength": 2,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.706Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "PM",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.707Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "PM",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"PM\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.707Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "PM",
  "inputLength": 2,
  "context": {
    "step": "greeting",
    "callSid": "CA_rapid_fire_1763570127000"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"PM\""
}
[2025-11-19T16:35:27.708Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:27.709Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8375,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8375 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:27.711Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "666", Processing: false
[2025-11-19T16:35:27.712Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 3,
  "inputPreview": "666",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "666", Processing: false
[2025-11-19T16:35:27.714Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "666",
  "inputLength": 3,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.714Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "666",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.715Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "666",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"666\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.715Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 17,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "666",
  "inputLength": 3,
  "context": {
    "step": "greeting",
    "callSid": "CA_rapid_fire_1763570127000"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"666\""
}
[2025-11-19T16:35:27.716Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 17,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:27.716Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 17,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8376,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8376 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:27.718Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: greeting, Input: "123", Processing: false
[2025-11-19T16:35:27.719Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 3,
  "inputPreview": "123",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "123", Processing: false
[2025-11-19T16:35:27.722Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "123",
  "inputLength": 3,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:27.722Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "123",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:27.723Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "123",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"123\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:27.723Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 20,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "123",
  "inputLength": 3,
  "context": {
    "step": "greeting",
    "callSid": "CA_rapid_fire_1763570127000"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"123\""
}
[2025-11-19T16:35:27.724Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 20,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:27.725Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 20,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8376,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8376 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:28.603Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 697,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 997,
  "reasoning": "Respuesta recibida de Gemini en 997ms. Extrayendo JSON..."
}
[2025-11-19T16:35:28.604Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1000,
  "apiCallTimeMs": 997,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "P√©rez",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre P√©rez"
}
[2025-11-19T16:35:28.605Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": "P√©rez"
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:28.605Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:28.607Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1005
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 1005ms, Response: "¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas personas?"
[2025-11-19T16:35:28.608Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1005,
  "responseMessage": "¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas personas?",
  "reasoning": "Paso procesado en 1005ms. Respuesta: \"¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas pers...\""
}
[2025-11-19T16:35:28.609Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, ¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas personas..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:28.613Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1613,
  "geminiTimeMs": 1000,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 15,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1005,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:29.178Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 20,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1453,
  "reasoning": "Respuesta recibida de Gemini en 1453ms. Extrayendo JSON..."
}
[2025-11-19T16:35:29.179Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 20,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1456,
  "apiCallTimeMs": 1453,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:29.180Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:29.180Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:29.183Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1461
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 1461ms, Response: "¬°Genial! ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:35:29.184Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1461,
  "responseMessage": "¬°Genial! ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 1461ms. Respuesta: \"¬°Genial! ¬øCu√°ntas personas van a venir?...\""
}
[2025-11-19T16:35:29.184Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Genial! ¬øCu√°ntas personas van a venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Aja, ¬°Genial! ¬øCu√°ntas personas van a venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:29.189Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 2189,
  "geminiTimeMs": 1456,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 20,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1461,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:29.191Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1576,
  "reasoning": "Respuesta recibida de Gemini en 1576ms. Extrayendo JSON..."
}
[2025-11-19T16:35:29.192Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1579,
  "apiCallTimeMs": 1576,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:29.193Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:29.193Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:29.196Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1585
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 1585ms, Response: "¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?"
[2025-11-19T16:35:29.198Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1585,
  "responseMessage": "¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?",
  "reasoning": "Paso procesado en 1585ms. Respuesta: \"¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?...\""
}
[2025-11-19T16:35:29.199Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, ¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:29.204Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 2204,
  "geminiTimeMs": 1579,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1585,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:29.314Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 17,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1597,
  "reasoning": "Respuesta recibida de Gemini en 1597ms. Extrayendo JSON..."
}
[2025-11-19T16:35:29.315Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 17,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1600,
  "apiCallTimeMs": 1597,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:29.316Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:29.317Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:29.318Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1605
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 1605ms, Response: "¬°Perfecto! ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:35:29.320Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1605,
  "responseMessage": "¬°Perfecto! ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 1605ms. Respuesta: \"¬°Perfecto! ¬øCu√°ntas personas van a venir?...\""
}
[2025-11-19T16:35:29.320Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Perfecto! ¬øCu√°ntas personas van a venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, ¬°Perfecto! ¬øCu√°ntas personas van a venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:29.325Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 2325,
  "geminiTimeMs": 1600,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 17,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1605,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:29.326Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 5,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1628,
  "reasoning": "Respuesta recibida de Gemini en 1628ms. Extrayendo JSON..."
}
[2025-11-19T16:35:29.327Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 5,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1630,
  "apiCallTimeMs": 1628,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:29.327Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:29.328Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:29.331Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1638
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 1638ms, Response: "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:35:29.332Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1638,
  "responseMessage": "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 1638ms. Respuesta: \"¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu...\""
}
[2025-11-19T16:35:29.333Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, ¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:29.337Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 2337,
  "geminiTimeMs": 1630,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 5,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1638,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:29.343Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1634,
  "reasoning": "Respuesta recibida de Gemini en 1634ms. Extrayendo JSON..."
}
[2025-11-19T16:35:29.344Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1637,
  "apiCallTimeMs": 1634,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:29.344Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:29.345Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:29.348Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1643
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 1643ms, Response: "¬°Genial! ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:35:29.349Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1643,
  "responseMessage": "¬°Genial! ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 1643ms. Respuesta: \"¬°Genial! ¬øPara cu√°ntas personas ser√°?...\""
}
[2025-11-19T16:35:29.350Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Genial! ¬øPara cu√°ntas personas ser√°?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, ¬°Genial! ¬øPara cu√°ntas personas ser√°?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:29.355Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 2355,
  "geminiTimeMs": 1637,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 10,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1643,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:29.390Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1704,
  "reasoning": "Respuesta recibida de Gemini en 1704ms. Extrayendo JSON..."
}
[2025-11-19T16:35:29.391Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1707,
  "apiCallTimeMs": 1704,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:29.392Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:29.393Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:29.395Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1724
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 1724ms, Response: "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:35:29.397Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1724,
  "responseMessage": "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 1724ms. Respuesta: \"¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu...\""
}
[2025-11-19T16:35:29.397Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°ntas pers..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:29.402Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 2402,
  "geminiTimeMs": 1707,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1724,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:29.417Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 22,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1765,
  "reasoning": "Respuesta recibida de Gemini en 1765ms. Extrayendo JSON..."
}
[2025-11-19T16:35:29.418Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 22,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1767,
  "apiCallTimeMs": 1765,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:29.418Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:29.419Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:29.420Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1774
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: ask_people, Time: 1774ms, Response: "¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?"
[2025-11-19T16:35:29.422Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1774,
  "responseMessage": "¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?",
  "reasoning": "Paso procesado en 1774ms. Respuesta: \"¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?...\""
}
[2025-11-19T16:35:29.422Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, ¬°Vale! Por supuesto. ¬øPara cu√°ntas personas?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:29.426Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 2426,
  "geminiTimeMs": 1767,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 22,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1774,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:29.429Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 812,
  "responsePreview": "```json\n{\n  \"intencion\": \"order\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcentaj",
  "apiCallTimeMs": 1804,
  "reasoning": "Respuesta recibida de Gemini en 1804ms. Extrayendo JSON..."
}
[2025-11-19T16:35:29.429Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_rapid_fire_1763570127000",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570127000,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1805,
  "apiCallTimeMs": 1804,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "order",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 1
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: order, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:29.430Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "order",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: order, Idioma: es. Procesando..."
}
[2025-11-19T16:35:29.430Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "order",
  "reasoning": "Intenci√≥n detectada: order. Procesando como pedido..."
}
[2025-11-19T16:35:29.431Z] [INFO] ORDER_INTENT_AT_GREETING {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting"
}
[2025-11-19T16:35:29.434Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "greeting",
  "to": "order_ask_address",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1813
}
[AFTER_PROCESS_STEP] CallSid: CA_rapid_fire_1763570127000, Step: order_ask_address, Time: 1813ms, Response: "Vale, de momento tengo: 1 8 (por confirmar) - 0 euros. ¬øCu√°l es la direcci√≥n de entrega?"
[2025-11-19T16:35:29.435Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "processStepTimeMs": 1813,
  "responseMessage": "Vale, de momento tengo: 1 8 (por confirmar) - 0 euros. ¬øCu√°l es la direcci√≥n de entrega?",
  "reasoning": "Paso procesado en 1813ms. Respuesta: \"Vale, de momento tengo: 1 8 (por confirmar) - 0 eu...\""
}
[2025-11-19T16:35:29.436Z] [INFO] STATE_PERSIST {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Vale, de momento tengo: 1 8 (por confirmar) - 0 eu...", UseAlgieba: true, NaturalFlow: true, Step: order_ask_address
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, Vale, de momento tengo: 1 8 (por confirmar) - 0 euros...."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:29.941Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_rapid_fire_1763570127000",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "totalTimeMs": 2941,
  "geminiTimeMs": 1805,
  "stateSaveTimeMs": 500,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 8,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1813,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:29][0m PASSED: Estr√©s - Requests R√°pidos (11 simult√°neos) (2941ms)
[36müß™ [16:35:29][0m üî• EXTREME: Estr√©s - Conversaciones Concurrentes (10)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.943Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.944Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.945Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.945Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.948Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.948Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.949Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.950Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.952Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.953Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.955Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.955Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.957Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.957Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.958Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.959Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.960Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.960Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:29.962Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:29.964Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:30.525Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_2, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.526Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.527Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.528Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.528Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.529Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_2",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 3,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_2"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.530Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_2",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 3,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.530Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_2",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 3,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:30.532Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_4, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.533Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.536Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.536Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.537Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.537Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_4",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_4"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.538Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_4",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.538Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_4",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:30.540Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_5, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.541Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.542Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.544Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.545Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.545Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_5",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_5"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.546Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_5",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.547Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_5",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:30.548Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_1, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.549Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.550Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.552Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.553Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.554Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_1",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_1"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.554Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_1",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.555Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_1",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:30.556Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_7, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.557Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.558Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.560Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.561Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.562Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_7",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_7"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.562Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_7",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.563Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_7",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:30.566Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_0, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.569Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.570Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.571Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.571Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.572Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_0",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_0"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.572Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_0",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.573Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_0",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:30.574Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_9, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.575Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.578Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.579Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.579Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.580Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_9",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 18,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_9"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.580Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_9",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 18,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.581Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_9",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 18,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:30.582Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_3, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.583Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.586Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.587Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.588Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.588Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_3",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 6,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_3"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.589Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_3",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 6,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.590Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_3",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 6,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:30.591Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_8, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.592Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.595Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.595Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.596Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.596Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_8",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 16,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_8"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.597Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_8",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 16,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.598Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_8",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 16,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:30.599Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_6, Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.600Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:35:30.603Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:30.604Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:30.604Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:30.605Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_concurrent_1763570129943_6",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 13,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_concurrent_1763570129943_6"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:35:30.605Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_concurrent_1763570129943_6",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 13,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:30.606Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_concurrent_1763570129943_6",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 13,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:31.619Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_7",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1056,
  "reasoning": "Respuesta recibida de Gemini en 1056ms. Extrayendo JSON..."
}
[2025-11-19T16:35:31.620Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_7",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 15,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1058,
  "apiCallTimeMs": 1056,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.620Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:31.621Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:31.621Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.622Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.623Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.623Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.624Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:31.625Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:31.625Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:31.626Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:31.626Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1068
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_7, Step: ask_name, Time: 1068ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:31.629Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1068,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1068ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:31.630Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:31.633Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_7",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1690,
  "geminiTimeMs": 1058,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 15,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1068,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:31.636Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_1",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1081,
  "reasoning": "Respuesta recibida de Gemini en 1081ms. Extrayendo JSON..."
}
[2025-11-19T16:35:31.637Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_1",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1083,
  "apiCallTimeMs": 1081,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.637Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:31.638Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:31.639Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.639Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.640Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.640Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.641Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:31.642Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:31.642Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:31.643Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:31.645Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1095
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_1, Step: ask_name, Time: 1095ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:31.646Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1095,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1095ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:31.647Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:31.650Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_1",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1707,
  "geminiTimeMs": 1083,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1095,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:31.654Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_0",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1081,
  "reasoning": "Respuesta recibida de Gemini en 1081ms. Extrayendo JSON..."
}
[2025-11-19T16:35:31.655Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_0",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1083,
  "apiCallTimeMs": 1081,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.655Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:31.656Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:31.656Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.657Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.658Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.658Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.659Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:31.661Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:31.662Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:31.662Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:31.663Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1094
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_0, Step: ask_name, Time: 1094ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:31.664Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1094,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1094ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:31.665Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, Perfecto, mesa para 4 personas, el d√≠a 20 de..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 5ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:35:31.670Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_0",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1727,
  "geminiTimeMs": 1083,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1094,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:31.673Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_2",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 3,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1142,
  "reasoning": "Respuesta recibida de Gemini en 1142ms. Extrayendo JSON..."
}
[2025-11-19T16:35:31.674Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_2",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 3,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1145,
  "apiCallTimeMs": 1142,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.675Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:31.675Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:31.678Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.678Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.679Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.679Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.680Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:31.681Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:31.681Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:31.682Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:31.683Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1156
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_2, Step: ask_name, Time: 1156ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:31.684Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1156,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1156ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:31.686Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, Perfecto, mesa para 4 personas, el d√≠a 20 de..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:35:31.690Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_2",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1747,
  "geminiTimeMs": 1145,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 3,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1156,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:31.691Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_8",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 16,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1093,
  "reasoning": "Respuesta recibida de Gemini en 1093ms. Extrayendo JSON..."
}
[2025-11-19T16:35:31.691Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_8",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 16,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1095,
  "apiCallTimeMs": 1093,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.692Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:31.695Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:31.695Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.696Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.696Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.697Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.697Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:31.698Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:31.699Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:31.699Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:31.700Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1106
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_8, Step: ask_name, Time: 1106ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:31.703Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1106,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1106ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:31.703Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Aja, Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre,..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:31.707Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_8",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1764,
  "geminiTimeMs": 1095,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 16,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1106,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:31.708Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_5",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1161,
  "reasoning": "Respuesta recibida de Gemini en 1161ms. Extrayendo JSON..."
}
[2025-11-19T16:35:31.709Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_5",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 10,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1164,
  "apiCallTimeMs": 1161,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.711Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:31.712Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:31.712Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.713Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.714Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.714Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.715Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:31.715Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:31.716Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:31.716Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:31.717Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1176
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_5, Step: ask_name, Time: 1176ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:31.720Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1176,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1176ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:31.720Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:31.725Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_5",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1782,
  "geminiTimeMs": 1164,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 10,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1176,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:31.735Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_3",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 6,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1145,
  "reasoning": "Respuesta recibida de Gemini en 1145ms. Extrayendo JSON..."
}
[2025-11-19T16:35:31.736Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_3",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 6,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1148,
  "apiCallTimeMs": 1145,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.737Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:31.737Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:31.738Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.738Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.739Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.740Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.740Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:31.741Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:31.741Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:31.742Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:31.742Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1156
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_3, Step: ask_name, Time: 1156ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:31.745Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1156,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1156ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:31.746Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, Perfecto, mesa para 4 personas, el d√≠a 20 de nov..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:35:31.749Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_3",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1806,
  "geminiTimeMs": 1148,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 6,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1156,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:31.752Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_4",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1213,
  "reasoning": "Respuesta recibida de Gemini en 1213ms. Extrayendo JSON..."
}
[2025-11-19T16:35:31.753Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_4",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 8,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1216,
  "apiCallTimeMs": 1213,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.754Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:31.754Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:31.755Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.755Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.756Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.756Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.757Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:31.758Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:31.758Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:31.759Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:31.760Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1225
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_4, Step: ask_name, Time: 1225ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:31.762Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1225,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1225ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:31.763Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:31.766Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_4",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1823,
  "geminiTimeMs": 1216,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 8,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1225,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:31.857Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_9",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 18,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1276,
  "reasoning": "Respuesta recibida de Gemini en 1276ms. Extrayendo JSON..."
}
[2025-11-19T16:35:31.858Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_9",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 18,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1278,
  "apiCallTimeMs": 1276,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.858Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:31.859Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:31.860Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:31.860Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.861Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.861Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:31.862Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:31.863Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:31.863Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:31.864Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:31.865Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1288
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_9, Step: ask_name, Time: 1288ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:31.866Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1288,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1288ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:31.868Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, Perfecto, mesa para 4 personas, el d√≠a 20 de novie..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:35:31.871Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_9",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1928,
  "geminiTimeMs": 1278,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 18,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1288,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:35:32.256Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_concurrent_1763570129943_6",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 13,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1649,
  "reasoning": "Respuesta recibida de Gemini en 1649ms. Extrayendo JSON..."
}
[2025-11-19T16:35:32.256Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_concurrent_1763570129943_6",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570129943,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 13,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1651,
  "apiCallTimeMs": 1649,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:32.257Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:35:32.258Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:35:32.258Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:35:32.259Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:35:32.259Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:35:32.260Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:35:32.260Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:35:32.261Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:35:32.262Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:35:32.262Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:35:32.263Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1661
}
[AFTER_PROCESS_STEP] CallSid: CA_concurrent_1763570129943_6, Step: ask_name, Time: 1661ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:35:32.264Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1661,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1661ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:35:32.265Z] [INFO] STATE_PERSIST {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:32.271Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_concurrent_1763570129943_6",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 2328,
  "geminiTimeMs": 1651,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 13,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1661,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:35:32][0m PASSED: Estr√©s - Conversaciones Concurrentes (10) (2329ms)
[36müß™ [16:35:32][0m üî• EXTREME: Estr√©s - 50 Pasos Sin Pausa
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:32.273Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:32.274Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:32.867Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: greeting, Input: "Input n√∫mero 1 para probar el sistema", Processing: false
[2025-11-19T16:35:32.868Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Input n√∫mero 1 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Input n√∫mero 1 para probar el sistema", Processing: false
[2025-11-19T16:35:32.869Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Input n√∫mero 1 para probar el sistema",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:32.870Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Input n√∫mero 1 para probar el sistema",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:35:32.870Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Input n√∫mero 1 para probar el sistema",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Input n√∫mero 1 para probar el sistema\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:35:32.871Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570132273,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 1 para probar el sistema",
  "inputLength": 37,
  "context": {
    "step": "greeting",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 1 para probar el sistema\""
}
[2025-11-19T16:35:32.872Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570132273,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:32.872Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570132273,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:33.935Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570132273,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 729,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1062,
  "reasoning": "Respuesta recibida de Gemini en 1062ms. Extrayendo JSON..."
}
[2025-11-19T16:35:33.936Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570132273,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1065,
  "apiCallTimeMs": 1062,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Input n√∫mero 1 para probar el sistema",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Input n√∫mero 1 para probar el sistema"
}
[2025-11-19T16:35:33.936Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 1 para probar el sistema"
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:35:33.937Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:35:33.939Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1070
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_people, Time: 1070ms, Response: "¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas personas?"
[2025-11-19T16:35:33.940Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1070,
  "responseMessage": "¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas personas?",
  "reasoning": "Paso procesado en 1070ms. Respuesta: \"¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas pers...\""
}
[2025-11-19T16:35:33.940Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, ¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas personas?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:33.944Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1671,
  "geminiTimeMs": 1065,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1070,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:33.946Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:33.946Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:33.947Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_people, Input: "Input n√∫mero 2 para probar el sistema", Processing: false
[2025-11-19T16:35:33.948Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Input n√∫mero 2 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Input n√∫mero 2 para probar el sistema", Processing: false
[2025-11-19T16:35:33.949Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Input n√∫mero 2 para probar el sistema",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:33.950Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570133945,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 2 para probar el sistema",
  "inputLength": 37,
  "context": {
    "step": "ask_people",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 2 para probar el sistema\""
}
[2025-11-19T16:35:33.951Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570133945,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:33.951Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570133945,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:35.002Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570133945,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1049,
  "reasoning": "Respuesta recibida de Gemini en 1049ms. Extrayendo JSON..."
}
[2025-11-19T16:35:35.003Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570133945,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1053,
  "apiCallTimeMs": 1049,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:35.004Z] [INFO] PEOPLE_EXTRACTED_ANY_NUMBER {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 2
}
[2025-11-19T16:35:35.004Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "2",
    "comensales_confidence": "90%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 2 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 2 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:35.005Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 2,
  "credibilidad": "90%"
}
[2025-11-19T16:35:35.005Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:35:35.006Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1057
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1057ms, Response: "Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:35:35.007Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1057,
  "responseMessage": "Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1057ms. Respuesta: \"Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a dese...\""
}
[2025-11-19T16:35:35.008Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a dese...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, Perfecto, mesa para 2 personas. ¬øPara qu√© d√≠a desean ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:35.012Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1067,
  "geminiTimeMs": 1053,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1057,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:35.013Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:35.014Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:35.015Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 3 para probar el sistema", Processing: false
[2025-11-19T16:35:35.016Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Input n√∫mero 3 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 3 para probar el sistema", Processing: false
[2025-11-19T16:35:35.017Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 3 para probar el sistema",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:35.017Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:35.018Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570135013,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 3 para probar el sistema",
  "inputLength": 37,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 3 para probar el sistema\""
}
[2025-11-19T16:35:35.019Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570135013,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:35.021Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570135013,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:35.975Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570135013,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 953,
  "reasoning": "Respuesta recibida de Gemini en 953ms. Extrayendo JSON..."
}
[2025-11-19T16:35:35.975Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570135013,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 957,
  "apiCallTimeMs": 953,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 3 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 3 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:36.062Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 3 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:36.063Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1048ms, Response: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico."
[2025-11-19T16:35:36.064Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1048,
  "responseMessage": "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico.",
  "reasoning": "Paso procesado en 1048ms. Respuesta: \"¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...\""
}
[2025-11-19T16:35:36.065Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, ¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana,..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:36.069Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1056,
  "geminiTimeMs": 957,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1048,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:36.073Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:36.073Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:36.074Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 4 para probar el sistema", Processing: false
[2025-11-19T16:35:36.075Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Input n√∫mero 4 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 4 para probar el sistema", Processing: false
[2025-11-19T16:35:36.076Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 4 para probar el sistema",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:36.077Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:36.077Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570136072,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 4 para probar el sistema",
  "inputLength": 37,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 4 para probar el sistema\""
}
[2025-11-19T16:35:36.078Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570136072,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:36.079Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570136072,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:37.049Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570136072,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 970,
  "reasoning": "Respuesta recibida de Gemini en 970ms. Extrayendo JSON..."
}
[2025-11-19T16:35:37.050Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570136072,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 973,
  "apiCallTimeMs": 970,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 4 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 4 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:37.066Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 4 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:37.067Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 991ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:35:37.068Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 991,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 991ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:35:37.069Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les co..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:37.073Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1001,
  "geminiTimeMs": 973,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 991,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:37.074Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:37.075Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:37.075Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 5 para probar el sistema", Processing: false
[2025-11-19T16:35:37.076Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Input n√∫mero 5 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 5 para probar el sistema", Processing: false
[2025-11-19T16:35:37.077Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 5 para probar el sistema",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:37.080Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:37.080Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570137073,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 5 para probar el sistema",
  "inputLength": 37,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 5 para probar el sistema\""
}
[2025-11-19T16:35:37.081Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570137073,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:37.082Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570137073,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:38.560Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570137073,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 847,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1478,
  "reasoning": "Respuesta recibida de Gemini en 1478ms. Extrayendo JSON..."
}
[2025-11-19T16:35:38.560Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570137073,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1480,
  "apiCallTimeMs": 1478,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 1
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 5 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 5 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:38.567Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 5 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:38.567Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1491ms, Response: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:35:38.568Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1491,
  "responseMessage": "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1491ms. Respuesta: \"Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...\""
}
[2025-11-19T16:35:38.570Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gusta..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:38.573Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1500,
  "geminiTimeMs": 1480,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1491,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:38.574Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:38.575Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:38.575Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 6 para probar el sistema", Processing: false
[2025-11-19T16:35:38.577Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Input n√∫mero 6 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 6 para probar el sistema", Processing: false
[2025-11-19T16:35:38.578Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 6 para probar el sistema",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:38.579Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:38.581Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570138574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 6 para probar el sistema",
  "inputLength": 37,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 6 para probar el sistema\""
}
[2025-11-19T16:35:38.581Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570138574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:38.582Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570138574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:39.698Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570138574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 827,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1116,
  "reasoning": "Respuesta recibida de Gemini en 1116ms. Extrayendo JSON..."
}
[2025-11-19T16:35:39.699Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570138574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1118,
  "apiCallTimeMs": 1116,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 1
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 6 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 6 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:39.705Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 6 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:39.706Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1129ms, Response: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:35:39.708Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1129,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1129ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...\""
}
[2025-11-19T16:35:39.709Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a des..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:39.712Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1138,
  "geminiTimeMs": 1118,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1129,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:39.713Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:39.714Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:39.715Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 7 para probar el sistema", Processing: false
[2025-11-19T16:35:39.716Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Input n√∫mero 7 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 7 para probar el sistema", Processing: false
[2025-11-19T16:35:39.717Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 7 para probar el sistema",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:39.718Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:39.718Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570139713,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 7 para probar el sistema",
  "inputLength": 37,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 7 para probar el sistema\""
}
[2025-11-19T16:35:39.719Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570139713,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:39.719Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570139713,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:40.734Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570139713,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1014,
  "reasoning": "Respuesta recibida de Gemini en 1014ms. Extrayendo JSON..."
}
[2025-11-19T16:35:40.735Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570139713,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1017,
  "apiCallTimeMs": 1014,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 7 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 7 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:40.741Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 7 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:40.741Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1026ms, Response: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:35:40.742Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1026,
  "responseMessage": "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1026ms. Respuesta: \"¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:35:40.744Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, ¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean l..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:40.749Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1036,
  "geminiTimeMs": 1017,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1026,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:40.751Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:40.751Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:40.752Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 8 para probar el sistema", Processing: false
[2025-11-19T16:35:40.753Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Input n√∫mero 8 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 8 para probar el sistema", Processing: false
[2025-11-19T16:35:40.755Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 8 para probar el sistema",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:40.756Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:40.757Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570140750,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 8 para probar el sistema",
  "inputLength": 37,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 8 para probar el sistema\""
}
[2025-11-19T16:35:40.758Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570140750,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:40.758Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570140750,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:41.797Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570140750,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 827,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1038,
  "reasoning": "Respuesta recibida de Gemini en 1038ms. Extrayendo JSON..."
}
[2025-11-19T16:35:41.798Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570140750,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1041,
  "apiCallTimeMs": 1038,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 1
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 8 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 8 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:41.804Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 8 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:41.804Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1051ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:35:41.805Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1051,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 1051ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:35:41.807Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:41.810Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1060,
  "geminiTimeMs": 1041,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1051,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:41.812Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:41.812Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:41.813Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 9 para probar el sistema", Processing: false
[2025-11-19T16:35:41.815Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Input n√∫mero 9 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 9 para probar el sistema", Processing: false
[2025-11-19T16:35:41.817Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 9 para probar el sistema",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:41.817Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:41.818Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570141811,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 9 para probar el sistema",
  "inputLength": 37,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 9 para probar el sistema\""
}
[2025-11-19T16:35:41.818Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570141811,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:41.819Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570141811,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:42.944Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570141811,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1124,
  "reasoning": "Respuesta recibida de Gemini en 1124ms. Extrayendo JSON..."
}
[2025-11-19T16:35:42.945Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570141811,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1127,
  "apiCallTimeMs": 1124,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 9 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 9 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:42.951Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 9 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:42.952Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1136ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:35:42.954Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1136,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 1136ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:35:42.954Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:42.958Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1147,
  "geminiTimeMs": 1127,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1136,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:42.961Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:42.961Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:42.962Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 18
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 10 para probar el sistema", Processing: false
[2025-11-19T16:35:42.963Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 10 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 10 para probar el sistema", Processing: false
[2025-11-19T16:35:42.964Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 10 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 19,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:42.965Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:42.966Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570142960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 10 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 10 para probar el sistema\""
}
[2025-11-19T16:35:42.966Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570142960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:42.969Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570142960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:43.925Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570142960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 956,
  "reasoning": "Respuesta recibida de Gemini en 956ms. Extrayendo JSON..."
}
[2025-11-19T16:35:43.926Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570142960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 960,
  "apiCallTimeMs": 956,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 10 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 10 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:43.932Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 10 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:43.933Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 969ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:35:43.935Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 969,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 969ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:35:43.936Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:43.941Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 981,
  "geminiTimeMs": 960,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 969,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:43.942Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:43.942Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:43.943Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 20
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 11 para probar el sistema", Processing: false
[2025-11-19T16:35:43.944Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 11 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 11 para probar el sistema", Processing: false
[2025-11-19T16:35:43.945Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 11 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 21,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:43.946Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:43.948Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570143941,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 11 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 11 para probar el sistema\""
}
[2025-11-19T16:35:43.949Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570143941,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:43.950Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570143941,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:45.038Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570143941,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1088,
  "reasoning": "Respuesta recibida de Gemini en 1088ms. Extrayendo JSON..."
}
[2025-11-19T16:35:45.038Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570143941,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1090,
  "apiCallTimeMs": 1088,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 11 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 11 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:45.067Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 11 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:45.068Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1124ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:35:45.069Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1124,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1124ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:35:45.070Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 6ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:45.076Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1135,
  "geminiTimeMs": 1090,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1124,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:45.077Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:45.078Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:45.079Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 22
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 12 para probar el sistema", Processing: false
[2025-11-19T16:35:45.080Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 12 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 12 para probar el sistema", Processing: false
[2025-11-19T16:35:45.082Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 12 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 23,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:45.083Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:45.084Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570145077,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 12 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 12 para probar el sistema\""
}
[2025-11-19T16:35:45.084Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570145077,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:45.085Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570145077,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:46.037Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570145077,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 951,
  "reasoning": "Respuesta recibida de Gemini en 951ms. Extrayendo JSON..."
}
[2025-11-19T16:35:46.038Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570145077,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 954,
  "apiCallTimeMs": 951,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 12 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 12 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:46.055Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 12 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:46.055Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 976ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:35:46.056Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 976,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 976ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:35:46.057Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:46.062Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 985,
  "geminiTimeMs": 954,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 976,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:46.063Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:46.064Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:46.064Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 24
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 13 para probar el sistema", Processing: false
[2025-11-19T16:35:46.066Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 13 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 13 para probar el sistema", Processing: false
[2025-11-19T16:35:46.067Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 13 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 25,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:46.067Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:46.068Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570146063,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 13 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 13 para probar el sistema\""
}
[2025-11-19T16:35:46.069Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570146063,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:46.071Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570146063,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:47.051Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570146063,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 980,
  "reasoning": "Respuesta recibida de Gemini en 980ms. Extrayendo JSON..."
}
[2025-11-19T16:35:47.051Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570146063,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 983,
  "apiCallTimeMs": 980,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 13 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 13 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:47.057Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 13 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:47.058Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 992ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:35:47.059Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 992,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 992ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:35:47.061Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:47.064Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1001,
  "geminiTimeMs": 983,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 992,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:47.065Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:47.066Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:47.067Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 26
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 14 para probar el sistema", Processing: false
[2025-11-19T16:35:47.068Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 14 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 14 para probar el sistema", Processing: false
[2025-11-19T16:35:47.069Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 14 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 27,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:47.070Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:47.070Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570147064,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 14 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 14 para probar el sistema\""
}
[2025-11-19T16:35:47.071Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570147064,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:47.071Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570147064,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:48.079Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570147064,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 696,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1007,
  "reasoning": "Respuesta recibida de Gemini en 1007ms. Extrayendo JSON..."
}
[2025-11-19T16:35:48.080Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570147064,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1010,
  "apiCallTimeMs": 1007,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 14 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 14 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:48.087Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 14 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:48.087Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1020ms, Response: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:35:48.088Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1020,
  "responseMessage": "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1020ms. Respuesta: \"Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...\""
}
[2025-11-19T16:35:48.090Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:48.093Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1029,
  "geminiTimeMs": 1010,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1020,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:48.094Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:48.097Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:48.097Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2
  },
  "conversationHistoryLength": 28
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 15 para probar el sistema", Processing: false
[2025-11-19T16:35:48.099Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 15 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 15 para probar el sistema", Processing: false
[2025-11-19T16:35:48.100Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 15 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 29,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:48.100Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:48.101Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570148094,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 15 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 15 para probar el sistema\""
}
[2025-11-19T16:35:48.101Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570148094,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:48.102Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570148094,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:49.173Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570148094,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 730,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1070,
  "reasoning": "Respuesta recibida de Gemini en 1070ms. Extrayendo JSON..."
}
[2025-11-19T16:35:49.174Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570148094,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1073,
  "apiCallTimeMs": 1070,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Input n√∫mero 15 para probar el sistema"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 15 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 15 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:49.180Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 15 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Input n√∫mero 15 para probar el sistema"
}
[2025-11-19T16:35:49.181Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "nombre": "Input n√∫mero 15 para probar el sistema",
  "credibilidad": "100%"
}
[2025-11-19T16:35:49.182Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2
  },
  "stateAfter": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1084ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:35:49.184Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1084,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 1084ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:35:49.184Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefier..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:49.188Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1094,
  "geminiTimeMs": 1073,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1084,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:49.189Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:49.190Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:49.190Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 30
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 16 para probar el sistema", Processing: false
[2025-11-19T16:35:49.193Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 16 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 16 para probar el sistema", Processing: false
[2025-11-19T16:35:49.194Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 16 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 31,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:49.195Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:49.195Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570149188,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 16 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 16 para probar el sistema\""
}
[2025-11-19T16:35:49.196Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570149188,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:49.197Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570149188,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:50.179Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570149188,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 982,
  "reasoning": "Respuesta recibida de Gemini en 982ms. Extrayendo JSON..."
}
[2025-11-19T16:35:50.180Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570149188,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 985,
  "apiCallTimeMs": 982,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 16 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 16 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:50.187Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 16 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:50.187Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 994ms, Response: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:35:50.189Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 994,
  "responseMessage": "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 994ms. Respuesta: \"¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:35:50.190Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, ¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a des..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:50.195Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1007,
  "geminiTimeMs": 985,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 994,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:50.196Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:50.197Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:50.197Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 32
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 17 para probar el sistema", Processing: false
[2025-11-19T16:35:50.198Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 17 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 17 para probar el sistema", Processing: false
[2025-11-19T16:35:50.201Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 17 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 33,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:50.202Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:50.203Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570150196,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 17 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 17 para probar el sistema\""
}
[2025-11-19T16:35:50.203Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570150196,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:50.204Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570150196,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:51.188Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570150196,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 984,
  "reasoning": "Respuesta recibida de Gemini en 984ms. Extrayendo JSON..."
}
[2025-11-19T16:35:51.189Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570150196,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 986,
  "apiCallTimeMs": 984,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 17 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 17 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:51.195Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 17 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:51.196Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 997ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:35:51.197Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 997,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 997ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:35:51.199Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:51.202Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1006,
  "geminiTimeMs": 986,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 997,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:51.203Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:51.204Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:51.205Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 34
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 18 para probar el sistema", Processing: false
[2025-11-19T16:35:51.207Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 18 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 18 para probar el sistema", Processing: false
[2025-11-19T16:35:51.209Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 18 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 35,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:51.209Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:51.210Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570151202,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 18 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 18 para probar el sistema\""
}
[2025-11-19T16:35:51.210Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570151202,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:51.211Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570151202,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:52.233Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570151202,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1022,
  "reasoning": "Respuesta recibida de Gemini en 1022ms. Extrayendo JSON..."
}
[2025-11-19T16:35:52.234Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570151202,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1024,
  "apiCallTimeMs": 1022,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 18 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 18 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:52.241Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 18 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:52.241Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1034ms, Response: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:35:52.242Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1034,
  "responseMessage": "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1034ms. Respuesta: \"Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...\""
}
[2025-11-19T16:35:52.244Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:52.247Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1045,
  "geminiTimeMs": 1024,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1034,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:52.248Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:52.249Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:52.250Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 36
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 19 para probar el sistema", Processing: false
[2025-11-19T16:35:52.253Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 19 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 19 para probar el sistema", Processing: false
[2025-11-19T16:35:52.254Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 19 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 37,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:52.254Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:52.255Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570152248,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 19 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 19 para probar el sistema\""
}
[2025-11-19T16:35:52.256Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570152248,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:52.256Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570152248,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:53.259Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570152248,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1002,
  "reasoning": "Respuesta recibida de Gemini en 1002ms. Extrayendo JSON..."
}
[2025-11-19T16:35:53.260Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570152248,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1005,
  "apiCallTimeMs": 1002,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 19 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 19 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:53.266Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 19 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:53.267Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1015ms, Response: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:35:53.269Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1015,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1015ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...\""
}
[2025-11-19T16:35:53.270Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:53.273Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1025,
  "geminiTimeMs": 1005,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1015,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:53.274Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:53.275Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:53.276Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 38
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 20 para probar el sistema", Processing: false
[2025-11-19T16:35:53.278Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 20 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 20 para probar el sistema", Processing: false
[2025-11-19T16:35:53.280Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 20 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 39,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:53.280Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:53.281Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570153274,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 20 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 20 para probar el sistema\""
}
[2025-11-19T16:35:53.281Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570153274,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:53.282Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570153274,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:54.441Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570153274,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 694,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": 20,\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porce",
  "apiCallTimeMs": 1159,
  "reasoning": "Respuesta recibida de Gemini en 1159ms. Extrayendo JSON..."
}
[2025-11-19T16:35:54.442Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570153274,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1161,
  "apiCallTimeMs": 1159,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": 20,
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: 20 personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 20 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 20 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:54.448Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": 20,
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 20 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: 20 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:54.449Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "peopleCount": 20,
  "peopleAnterior": 2,
  "credibilidad": "100%"
}
[2025-11-19T16:35:54.450Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 2,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1172ms, Response: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:35:54.452Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1172,
  "responseMessage": "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1172ms. Respuesta: \"Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...\""
}
[2025-11-19T16:35:54.452Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:54.456Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1182,
  "geminiTimeMs": 1161,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1172,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:54.457Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:54.458Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:54.458Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 40
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 21 para probar el sistema", Processing: false
[2025-11-19T16:35:54.459Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 21 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 21 para probar el sistema", Processing: false
[2025-11-19T16:35:54.462Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 21 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 41,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:54.463Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:54.463Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570154456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 21 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 21 para probar el sistema\""
}
[2025-11-19T16:35:54.464Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570154456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:54.465Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570154456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:55.473Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570154456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1008,
  "reasoning": "Respuesta recibida de Gemini en 1008ms. Extrayendo JSON..."
}
[2025-11-19T16:35:55.474Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570154456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1011,
  "apiCallTimeMs": 1008,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 21 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 21 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:55.480Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 21 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:55.481Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1020ms, Response: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:35:55.482Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1020,
  "responseMessage": "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1020ms. Respuesta: \"¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:35:55.483Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reser..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:55.488Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1032,
  "geminiTimeMs": 1011,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1020,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:55.489Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:55.490Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:55.491Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 42
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 22 para probar el sistema", Processing: false
[2025-11-19T16:35:55.492Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 22 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 22 para probar el sistema", Processing: false
[2025-11-19T16:35:55.493Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 22 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 43,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:55.495Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:55.496Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570155489,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 22 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 22 para probar el sistema\""
}
[2025-11-19T16:35:55.496Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570155489,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:55.497Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570155489,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:56.559Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570155489,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1062,
  "reasoning": "Respuesta recibida de Gemini en 1062ms. Extrayendo JSON..."
}
[2025-11-19T16:35:56.560Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570155489,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1064,
  "apiCallTimeMs": 1062,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 22 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 22 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:56.566Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 22 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:56.567Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1076ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:35:56.569Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1076,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 1076ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:35:56.570Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:56.573Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1084,
  "geminiTimeMs": 1064,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1076,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:56.574Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:56.575Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:56.576Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 44
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 23 para probar el sistema", Processing: false
[2025-11-19T16:35:56.577Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 23 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 23 para probar el sistema", Processing: false
[2025-11-19T16:35:56.580Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 23 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 45,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:56.580Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:56.581Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570156574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 23 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 23 para probar el sistema\""
}
[2025-11-19T16:35:56.581Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570156574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:56.582Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570156574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:57.573Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570156574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 990,
  "reasoning": "Respuesta recibida de Gemini en 990ms. Extrayendo JSON..."
}
[2025-11-19T16:35:57.574Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570156574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 993,
  "apiCallTimeMs": 990,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 23 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 23 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:57.581Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 23 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:57.581Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1003ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:35:57.582Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1003,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 1003ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:35:57.584Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les co..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:57.589Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1015,
  "geminiTimeMs": 993,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1003,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:57.590Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:57.591Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:57.591Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 46
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 24 para probar el sistema", Processing: false
[2025-11-19T16:35:57.592Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 24 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 24 para probar el sistema", Processing: false
[2025-11-19T16:35:57.594Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 24 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 47,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:57.596Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:57.596Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570157590,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 24 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 24 para probar el sistema\""
}
[2025-11-19T16:35:57.597Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570157590,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:57.597Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570157590,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:58.683Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570157590,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1085,
  "reasoning": "Respuesta recibida de Gemini en 1085ms. Extrayendo JSON..."
}
[2025-11-19T16:35:58.684Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570157590,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1088,
  "apiCallTimeMs": 1085,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 24 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 24 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:58.690Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 24 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:58.691Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1098ms, Response: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico."
[2025-11-19T16:35:58.692Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1098,
  "responseMessage": "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico.",
  "reasoning": "Paso procesado en 1098ms. Respuesta: \"¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...\""
}
[2025-11-19T16:35:58.693Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, ¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:58.699Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1109,
  "geminiTimeMs": 1088,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1098,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:58.700Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:58.700Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:58.701Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 48
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 25 para probar el sistema", Processing: false
[2025-11-19T16:35:58.702Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 25 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 25 para probar el sistema", Processing: false
[2025-11-19T16:35:58.703Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 25 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 49,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:58.704Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:58.704Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570158699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 25 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 25 para probar el sistema\""
}
[2025-11-19T16:35:58.705Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570158699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:58.705Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570158699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:35:59.662Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570158699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 956,
  "reasoning": "Respuesta recibida de Gemini en 956ms. Extrayendo JSON..."
}
[2025-11-19T16:35:59.663Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570158699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 959,
  "apiCallTimeMs": 956,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 25 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 25 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:35:59.670Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 25 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:35:59.670Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 968ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:35:59.673Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 968,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 968ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:35:59.673Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les c..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:35:59.677Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 978,
  "geminiTimeMs": 959,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 968,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:35:59.679Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:35:59.680Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:35:59.681Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 50
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 26 para probar el sistema", Processing: false
[2025-11-19T16:35:59.682Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 26 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 26 para probar el sistema", Processing: false
[2025-11-19T16:35:59.683Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 26 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 51,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:35:59.684Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:35:59.684Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570159677,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 26 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 26 para probar el sistema\""
}
[2025-11-19T16:35:59.685Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570159677,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:35:59.685Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570159677,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:00.726Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570159677,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1040,
  "reasoning": "Respuesta recibida de Gemini en 1040ms. Extrayendo JSON..."
}
[2025-11-19T16:36:00.727Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570159677,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1043,
  "apiCallTimeMs": 1040,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 26 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 26 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:00.734Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 26 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:00.734Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1053ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:36:00.737Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1053,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 1053ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:36:00.737Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:00.741Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1064,
  "geminiTimeMs": 1043,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1053,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:00.742Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:00.742Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:00.743Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 52
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 27 para probar el sistema", Processing: false
[2025-11-19T16:36:00.744Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 27 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 27 para probar el sistema", Processing: false
[2025-11-19T16:36:00.747Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 27 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 53,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:00.748Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:00.748Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570160741,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 27 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 27 para probar el sistema\""
}
[2025-11-19T16:36:00.749Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570160741,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:00.749Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570160741,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:01.672Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570160741,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 922,
  "reasoning": "Respuesta recibida de Gemini en 922ms. Extrayendo JSON..."
}
[2025-11-19T16:36:01.673Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570160741,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 925,
  "apiCallTimeMs": 922,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 27 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 27 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:01.680Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 27 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:01.680Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 936ms, Response: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico."
[2025-11-19T16:36:01.683Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 936,
  "responseMessage": "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico.",
  "reasoning": "Paso procesado en 936ms. Respuesta: \"¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...\""
}
[2025-11-19T16:36:01.683Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, ¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:01.687Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 946,
  "geminiTimeMs": 925,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 936,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:01.688Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:01.689Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:01.691Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 54
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 28 para probar el sistema", Processing: false
[2025-11-19T16:36:01.692Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 28 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 28 para probar el sistema", Processing: false
[2025-11-19T16:36:01.693Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 28 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 55,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:01.694Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:01.695Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570161688,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 28 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 28 para probar el sistema\""
}
[2025-11-19T16:36:01.695Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570161688,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:01.696Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570161688,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:02.696Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570161688,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 999,
  "reasoning": "Respuesta recibida de Gemini en 999ms. Extrayendo JSON..."
}
[2025-11-19T16:36:02.697Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570161688,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1002,
  "apiCallTimeMs": 999,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 28 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 28 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:02.704Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 28 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:02.705Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1012ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:36:02.707Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1012,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 1012ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:36:02.707Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:02.711Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1023,
  "geminiTimeMs": 1002,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1012,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:02.712Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:02.714Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:02.715Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 56
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 29 para probar el sistema", Processing: false
[2025-11-19T16:36:02.716Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 29 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 29 para probar el sistema", Processing: false
[2025-11-19T16:36:02.717Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 29 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 57,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:02.718Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:02.718Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570162712,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 29 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 29 para probar el sistema\""
}
[2025-11-19T16:36:02.719Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570162712,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:02.720Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570162712,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:03.777Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570162712,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 728,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1056,
  "reasoning": "Respuesta recibida de Gemini en 1056ms. Extrayendo JSON..."
}
[2025-11-19T16:36:03.778Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570162712,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1060,
  "apiCallTimeMs": 1056,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 29 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 29 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:03.786Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 29 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:03.786Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1070ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:36:03.787Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1070,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 1070ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:36:03.798Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:03.802Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1090,
  "geminiTimeMs": 1060,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1070,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:03.803Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:03.804Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:03.804Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 58
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 30 para probar el sistema", Processing: false
[2025-11-19T16:36:03.807Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 30 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 30 para probar el sistema", Processing: false
[2025-11-19T16:36:03.808Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 30 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 59,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:03.809Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:03.809Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570163803,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 30 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 30 para probar el sistema\""
}
[2025-11-19T16:36:03.810Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570163803,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:03.810Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570163803,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:04.819Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570163803,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1008,
  "reasoning": "Respuesta recibida de Gemini en 1008ms. Extrayendo JSON..."
}
[2025-11-19T16:36:04.820Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570163803,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1011,
  "apiCallTimeMs": 1008,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 30 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 30 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:04.826Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 30 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:04.827Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1020ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:36:04.828Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1020,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 1020ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:36:04.829Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefi..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:04.833Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1030,
  "geminiTimeMs": 1011,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1020,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:04.834Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:04.834Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:04.835Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 60
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 31 para probar el sistema", Processing: false
[2025-11-19T16:36:04.837Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 31 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 31 para probar el sistema", Processing: false
[2025-11-19T16:36:04.839Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 31 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 61,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:04.840Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:04.840Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570164833,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 31 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 31 para probar el sistema\""
}
[2025-11-19T16:36:04.841Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570164833,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:04.841Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570164833,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:05.841Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570164833,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 999,
  "reasoning": "Respuesta recibida de Gemini en 999ms. Extrayendo JSON..."
}
[2025-11-19T16:36:05.842Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570164833,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1002,
  "apiCallTimeMs": 999,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 31 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 31 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:05.848Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 31 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:05.848Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1011ms, Response: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:36:05.849Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1011,
  "responseMessage": "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1011ms. Respuesta: \"Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...\""
}
[2025-11-19T16:36:05.851Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:05.854Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1021,
  "geminiTimeMs": 1002,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1011,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:05.856Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:05.858Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:05.858Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "conversationHistoryLength": 62
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 32 para probar el sistema", Processing: false
[2025-11-19T16:36:05.859Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 32 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 32 para probar el sistema", Processing: false
[2025-11-19T16:36:05.861Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 32 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 15 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 63,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:05.861Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:05.862Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570165855,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 32 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 32 para probar el sistema\""
}
[2025-11-19T16:36:05.862Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570165855,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:05.863Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570165855,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:07.027Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570165855,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 730,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1164,
  "reasoning": "Respuesta recibida de Gemini en 1164ms. Extrayendo JSON..."
}
[2025-11-19T16:36:07.028Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570165855,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1166,
  "apiCallTimeMs": 1164,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Input n√∫mero 32 para probar el sistema"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 32 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 32 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:07.034Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 32 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 15 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Input n√∫mero 32 para probar el sistema"
}
[2025-11-19T16:36:07.034Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "nombre": "Input n√∫mero 32 para probar el sistema",
  "nombreAnterior": "Input n√∫mero 15 para probar el sistema",
  "credibilidad": "100%"
}
[2025-11-19T16:36:07.035Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 15 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1176ms, Response: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:36:07.037Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1176,
  "responseMessage": "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1176ms. Respuesta: \"No he entendido bien. ¬øMe puede decir para qu√© d√≠a...\""
}
[2025-11-19T16:36:07.038Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gusta..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:07.041Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1186,
  "geminiTimeMs": 1166,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1176,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:07.042Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:07.043Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:07.043Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 64
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 33 para probar el sistema", Processing: false
[2025-11-19T16:36:07.045Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 33 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 33 para probar el sistema", Processing: false
[2025-11-19T16:36:07.046Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 33 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 65,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:07.046Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:07.047Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570167042,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 33 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 33 para probar el sistema\""
}
[2025-11-19T16:36:07.047Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570167042,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:07.050Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570167042,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:08.009Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570167042,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 959,
  "reasoning": "Respuesta recibida de Gemini en 959ms. Extrayendo JSON..."
}
[2025-11-19T16:36:08.010Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570167042,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 963,
  "apiCallTimeMs": 959,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 33 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 33 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:08.016Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 33 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:08.017Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 972ms, Response: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:36:08.019Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 972,
  "responseMessage": "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 972ms. Respuesta: \"Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...\""
}
[2025-11-19T16:36:08.020Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:08.023Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 981,
  "geminiTimeMs": 963,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 972,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:08.024Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:08.025Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:08.025Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 66
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 34 para probar el sistema", Processing: false
[2025-11-19T16:36:08.026Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 34 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 34 para probar el sistema", Processing: false
[2025-11-19T16:36:08.028Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 34 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 67,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:08.028Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:08.031Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570168024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 34 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 34 para probar el sistema\""
}
[2025-11-19T16:36:08.031Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570168024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:08.032Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570168024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:09.066Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570168024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1034,
  "reasoning": "Respuesta recibida de Gemini en 1034ms. Extrayendo JSON..."
}
[2025-11-19T16:36:09.067Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570168024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1036,
  "apiCallTimeMs": 1034,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 34 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 34 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:09.074Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 34 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:09.074Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1048ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:36:09.075Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1048,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1048ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:36:09.077Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:09.080Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1056,
  "geminiTimeMs": 1036,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1048,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:09.082Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:09.084Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:09.084Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 68
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 35 para probar el sistema", Processing: false
[2025-11-19T16:36:09.086Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 35 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 35 para probar el sistema", Processing: false
[2025-11-19T16:36:09.087Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 35 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 69,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:09.087Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:09.088Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570169081,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 35 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 35 para probar el sistema\""
}
[2025-11-19T16:36:09.088Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570169081,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:09.089Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570169081,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:10.112Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570169081,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1022,
  "reasoning": "Respuesta recibida de Gemini en 1022ms. Extrayendo JSON..."
}
[2025-11-19T16:36:10.112Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570169081,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1024,
  "apiCallTimeMs": 1022,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 35 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 35 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:10.119Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 35 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:10.119Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1034ms, Response: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:36:10.120Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1034,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1034ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...\""
}
[2025-11-19T16:36:10.122Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 5ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:10.127Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1046,
  "geminiTimeMs": 1024,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1034,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:10.129Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:10.129Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:10.130Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 70
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 36 para probar el sistema", Processing: false
[2025-11-19T16:36:10.131Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 36 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 36 para probar el sistema", Processing: false
[2025-11-19T16:36:10.133Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 36 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 71,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:10.135Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:10.135Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570170128,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 36 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 36 para probar el sistema\""
}
[2025-11-19T16:36:10.136Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570170128,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:10.136Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570170128,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:11.078Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570170128,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 941,
  "reasoning": "Respuesta recibida de Gemini en 941ms. Extrayendo JSON..."
}
[2025-11-19T16:36:11.079Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570170128,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 944,
  "apiCallTimeMs": 941,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 36 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 36 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:11.085Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 36 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:11.086Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 955ms, Response: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:36:11.087Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 955,
  "responseMessage": "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 955ms. Respuesta: \"No he entendido bien. ¬øMe puede decir para qu√© d√≠a...\""
}
[2025-11-19T16:36:11.089Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gusta..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 5ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:11.094Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 966,
  "geminiTimeMs": 944,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 955,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:11.095Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:11.096Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:11.097Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 72
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 37 para probar el sistema", Processing: false
[2025-11-19T16:36:11.098Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 37 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 37 para probar el sistema", Processing: false
[2025-11-19T16:36:11.101Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 37 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 73,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:11.101Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:11.102Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570171095,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 37 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 37 para probar el sistema\""
}
[2025-11-19T16:36:11.102Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570171095,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:11.103Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570171095,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:12.170Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570171095,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 728,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1066,
  "reasoning": "Respuesta recibida de Gemini en 1066ms. Extrayendo JSON..."
}
[2025-11-19T16:36:12.171Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570171095,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1069,
  "apiCallTimeMs": 1066,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 37 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 37 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:12.177Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 37 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:12.178Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1080ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:36:12.179Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1080,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 1080ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:36:12.181Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:12.184Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1089,
  "geminiTimeMs": 1069,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1080,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:12.185Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:12.186Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:12.186Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 74
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 38 para probar el sistema", Processing: false
[2025-11-19T16:36:12.187Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 38 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 38 para probar el sistema", Processing: false
[2025-11-19T16:36:12.188Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 38 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 75,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:12.189Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:12.189Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570172184,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 38 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 38 para probar el sistema\""
}
[2025-11-19T16:36:12.190Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570172184,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:12.191Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570172184,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:13.137Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570172184,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 944,
  "reasoning": "Respuesta recibida de Gemini en 944ms. Extrayendo JSON..."
}
[2025-11-19T16:36:13.137Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570172184,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 948,
  "apiCallTimeMs": 944,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 38 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 38 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:13.144Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 38 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:13.145Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 957ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:36:13.147Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 957,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 957ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:36:13.147Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 5ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:13.153Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 969,
  "geminiTimeMs": 948,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 957,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:13.155Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:13.155Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:13.156Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 76
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 39 para probar el sistema", Processing: false
[2025-11-19T16:36:13.157Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 39 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 39 para probar el sistema", Processing: false
[2025-11-19T16:36:13.159Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 39 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 77,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:13.160Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:13.161Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570173154,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 39 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 39 para probar el sistema\""
}
[2025-11-19T16:36:13.161Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570173154,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:13.162Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570173154,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:14.134Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570173154,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 972,
  "reasoning": "Respuesta recibida de Gemini en 972ms. Extrayendo JSON..."
}
[2025-11-19T16:36:14.135Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570173154,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 974,
  "apiCallTimeMs": 972,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 39 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 39 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:14.141Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 39 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:14.142Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 984ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:36:14.143Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 984,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 984ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:36:14.145Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:14.148Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 994,
  "geminiTimeMs": 974,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 984,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:14.149Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:14.150Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:14.152Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 78
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 40 para probar el sistema", Processing: false
[2025-11-19T16:36:14.153Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 40 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 40 para probar el sistema", Processing: false
[2025-11-19T16:36:14.155Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 40 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 79,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:14.155Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:14.156Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570174149,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 40 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 40 para probar el sistema\""
}
[2025-11-19T16:36:14.156Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570174149,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:14.157Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570174149,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:15.411Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570174149,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1254,
  "reasoning": "Respuesta recibida de Gemini en 1254ms. Extrayendo JSON..."
}
[2025-11-19T16:36:15.411Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570174149,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1255,
  "apiCallTimeMs": 1254,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 40 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 40 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:15.418Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 40 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:15.418Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1265ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:36:15.419Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1265,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1265ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:36:15.421Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:15.424Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1275,
  "geminiTimeMs": 1255,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1265,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:15.425Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:15.426Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:15.427Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 80
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 41 para probar el sistema", Processing: false
[2025-11-19T16:36:15.428Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 41 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 41 para probar el sistema", Processing: false
[2025-11-19T16:36:15.431Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 41 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 81,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:15.431Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:15.432Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570175425,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 41 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 41 para probar el sistema\""
}
[2025-11-19T16:36:15.432Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570175425,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:15.433Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570175425,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:16.404Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570175425,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 971,
  "reasoning": "Respuesta recibida de Gemini en 971ms. Extrayendo JSON..."
}
[2025-11-19T16:36:16.405Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570175425,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 973,
  "apiCallTimeMs": 971,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 41 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 41 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:16.412Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 41 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:16.412Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 985ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:36:16.415Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 985,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 985ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:36:16.415Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:16.421Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 996,
  "geminiTimeMs": 973,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 985,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:16.422Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:16.422Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:16.423Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "conversationHistoryLength": 82
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 42 para probar el sistema", Processing: false
[2025-11-19T16:36:16.424Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 42 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 42 para probar el sistema", Processing: false
[2025-11-19T16:36:16.426Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 42 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 32 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 83,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:16.428Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:16.428Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570176421,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 42 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 42 para probar el sistema\""
}
[2025-11-19T16:36:16.429Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570176421,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:16.429Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570176421,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:17.414Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570176421,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 730,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 984,
  "reasoning": "Respuesta recibida de Gemini en 984ms. Extrayendo JSON..."
}
[2025-11-19T16:36:17.415Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570176421,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 987,
  "apiCallTimeMs": 984,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Input n√∫mero 42 para probar el sistema"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 42 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 42 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:17.422Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 42 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 32 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Input n√∫mero 42 para probar el sistema"
}
[2025-11-19T16:36:17.422Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "nombre": "Input n√∫mero 42 para probar el sistema",
  "nombreAnterior": "Input n√∫mero 32 para probar el sistema",
  "credibilidad": "100%"
}
[2025-11-19T16:36:17.423Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 32 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1000ms, Response: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:36:17.425Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1000,
  "responseMessage": "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1000ms. Respuesta: \"No he entendido bien. ¬øMe puede decir para qu√© d√≠a...\""
}
[2025-11-19T16:36:17.426Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gusta..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:17.429Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1008,
  "geminiTimeMs": 987,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1000,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:17.430Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:17.431Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:17.431Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "conversationHistoryLength": 84
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 43 para probar el sistema", Processing: false
[2025-11-19T16:36:17.433Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 43 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 43 para probar el sistema", Processing: false
[2025-11-19T16:36:17.434Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 43 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 85,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:17.434Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:17.438Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570177430,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 43 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 43 para probar el sistema\""
}
[2025-11-19T16:36:17.438Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570177430,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:17.439Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570177430,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:18.498Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570177430,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1058,
  "reasoning": "Respuesta recibida de Gemini en 1058ms. Extrayendo JSON..."
}
[2025-11-19T16:36:18.499Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570177430,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1061,
  "apiCallTimeMs": 1058,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 43 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 43 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:18.505Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 43 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 42 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:18.506Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1073ms, Response: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:36:18.507Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1073,
  "responseMessage": "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1073ms. Respuesta: \"No he entendido bien. ¬øMe puede decir para qu√© d√≠a...\""
}
[2025-11-19T16:36:18.509Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, No he entendido bien. ¬øMe puede decir para qu√© d√≠a les..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:18.512Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1082,
  "geminiTimeMs": 1061,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1073,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:18.513Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:18.515Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:18.516Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "conversationHistoryLength": 86
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 44 para probar el sistema", Processing: false
[2025-11-19T16:36:18.517Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 44 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 44 para probar el sistema", Processing: false
[2025-11-19T16:36:18.518Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 44 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 87,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:18.519Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:18.520Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570178513,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 44 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 44 para probar el sistema\""
}
[2025-11-19T16:36:18.520Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570178513,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:18.521Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570178513,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:19.517Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570178513,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 996,
  "reasoning": "Respuesta recibida de Gemini en 996ms. Extrayendo JSON..."
}
[2025-11-19T16:36:19.518Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570178513,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 998,
  "apiCallTimeMs": 996,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 44 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 44 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:19.524Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 44 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 42 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:19.524Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1007ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:36:19.525Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1007,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1007ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:36:19.527Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:19.530Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1017,
  "geminiTimeMs": 998,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1007,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:19.531Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:19.532Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:19.533Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "conversationHistoryLength": 88
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 45 para probar el sistema", Processing: false
[2025-11-19T16:36:19.534Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 45 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 45 para probar el sistema", Processing: false
[2025-11-19T16:36:19.535Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 45 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 89,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:19.536Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:19.538Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570179531,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 45 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 45 para probar el sistema\""
}
[2025-11-19T16:36:19.538Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570179531,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:19.539Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570179531,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:20.576Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570179531,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1037,
  "reasoning": "Respuesta recibida de Gemini en 1037ms. Extrayendo JSON..."
}
[2025-11-19T16:36:20.577Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570179531,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1039,
  "apiCallTimeMs": 1037,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 45 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 45 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:20.583Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 45 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 42 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:20.584Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1050ms, Response: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:36:20.585Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1050,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1050ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...\""
}
[2025-11-19T16:36:20.586Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:20.592Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1061,
  "geminiTimeMs": 1039,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1050,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:20.593Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:20.593Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:20.594Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "conversationHistoryLength": 90
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 46 para probar el sistema", Processing: false
[2025-11-19T16:36:20.595Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 46 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 46 para probar el sistema", Processing: false
[2025-11-19T16:36:20.596Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 46 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 91,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:20.597Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:20.598Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570180592,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 46 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 46 para probar el sistema\""
}
[2025-11-19T16:36:20.600Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570180592,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:20.601Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570180592,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:21.631Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570180592,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1030,
  "reasoning": "Respuesta recibida de Gemini en 1030ms. Extrayendo JSON..."
}
[2025-11-19T16:36:21.632Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570180592,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1034,
  "apiCallTimeMs": 1030,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 46 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 46 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:21.639Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 46 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 42 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:21.639Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1044ms, Response: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico."
[2025-11-19T16:36:21.640Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1044,
  "responseMessage": "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico.",
  "reasoning": "Paso procesado en 1044ms. Respuesta: \"¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...\""
}
[2025-11-19T16:36:21.642Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Aja, ¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:21.645Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1053,
  "geminiTimeMs": 1034,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1044,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:21.646Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:21.647Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:21.648Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "conversationHistoryLength": 92
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 47 para probar el sistema", Processing: false
[2025-11-19T16:36:21.651Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 47 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 47 para probar el sistema", Processing: false
[2025-11-19T16:36:21.652Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 47 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 93,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:21.652Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:21.653Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570181646,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 47 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 47 para probar el sistema\""
}
[2025-11-19T16:36:21.653Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570181646,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:21.654Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570181646,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:22.713Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570181646,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1059,
  "reasoning": "Respuesta recibida de Gemini en 1059ms. Extrayendo JSON..."
}
[2025-11-19T16:36:22.714Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570181646,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1061,
  "apiCallTimeMs": 1059,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 47 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 47 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:22.722Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 47 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 42 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:22.722Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1073ms, Response: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:36:22.724Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1073,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 1073ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...\""
}
[2025-11-19T16:36:22.725Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a ...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, Disculpe, ¬øpodr√≠a repetir la fecha? ¬øPara qu√© d√≠a dese..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:22.730Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1084,
  "geminiTimeMs": 1061,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1073,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:22.732Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:22.732Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:22.733Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "conversationHistoryLength": 94
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 48 para probar el sistema", Processing: false
[2025-11-19T16:36:22.734Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 48 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 48 para probar el sistema", Processing: false
[2025-11-19T16:36:22.735Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 48 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 95,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:22.736Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:22.736Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570182731,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 48 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 48 para probar el sistema\""
}
[2025-11-19T16:36:22.739Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570182731,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 1,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:22.739Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570182731,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:23.800Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570182731,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1060,
  "reasoning": "Respuesta recibida de Gemini en 1060ms. Extrayendo JSON..."
}
[2025-11-19T16:36:23.801Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570182731,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1065,
  "apiCallTimeMs": 1060,
  "dataLoadTimeMs": 1,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 48 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 48 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:23.808Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 48 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 42 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:23.808Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1074ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:36:23.809Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1074,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1074ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:36:23.811Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:23.816Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1085,
  "geminiTimeMs": 1065,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 1,
  "dbTimeMs": 0,
  "processStepTimeMs": 1074,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:23.817Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:23.818Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:23.819Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "conversationHistoryLength": 96
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 49 para probar el sistema", Processing: false
[2025-11-19T16:36:23.820Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 49 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 49 para probar el sistema", Processing: false
[2025-11-19T16:36:23.823Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 49 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 97,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:23.824Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:23.824Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570183817,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 49 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 49 para probar el sistema\""
}
[2025-11-19T16:36:23.825Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570183817,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:23.863Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570183817,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:24.841Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570183817,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 977,
  "reasoning": "Respuesta recibida de Gemini en 977ms. Extrayendo JSON..."
}
[2025-11-19T16:36:24.842Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570183817,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1018,
  "apiCallTimeMs": 977,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 49 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 49 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:24.848Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 49 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 42 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:24.849Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1029ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:36:24.851Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1029,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 1029ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:36:24.852Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefi..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:24.857Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1040,
  "geminiTimeMs": 1018,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1029,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:24.858Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:24.859Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:24.860Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "conversationHistoryLength": 98
}
[BEFORE_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Input: "Input n√∫mero 50 para probar el sistema", Processing: false
[2025-11-19T16:36:24.861Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Input n√∫mero 50 para probar el sistema",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input n√∫mero 50 para probar el sistema", Processing: false
[2025-11-19T16:36:24.862Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input n√∫mero 50 para probar el sistema",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 20,
    "fecha": null,
    "hora": null,
    "nombre": "Input n√∫mero 42 para probar el sistema",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 99,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:24.865Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:24.865Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570184858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input n√∫mero 50 para probar el sistema",
  "inputLength": 38,
  "context": {
    "step": "ask_date",
    "callSid": "CA_stress_1763570132272"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input n√∫mero 50 para probar el sistema\""
}
[2025-11-19T16:36:24.866Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570184858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:24.867Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570184858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:25.939Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570184858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1072,
  "reasoning": "Respuesta recibida de Gemini en 1072ms. Extrayendo JSON..."
}
[2025-11-19T16:36:25.940Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_stress_1763570132272",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570184858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1075,
  "apiCallTimeMs": 1072,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input n√∫mero 50 para probar el sistema"
üîç [DEBUG] Texto en min√∫sculas: "input n√∫mero 50 para probar el sistema"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:25.946Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "currentLanguage": "es",
  "originalText": "Input n√∫mero 50 para probar el sistema",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":20,\"NomReserva\":\"Input n√∫mero 42 para probar el sistema\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:25.947Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "stateAfter": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_stress_1763570132272, Step: ask_date, Time: 1086ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:36:25.949Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1086,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1086ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:36:25.950Z] [INFO] STATE_PERSIST {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva",
    "NomReserva"
  ],
  "dataValues": {
    "NumeroReserva": 20,
    "NomReserva": "Input n√∫mero 42 para probar el sistema"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:25.953Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_stress_1763570132272",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1095,
  "geminiTimeMs": 1075,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1086,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[31m‚ùå [16:36:25][0m FAILED: Estr√©s - 50 Pasos Sin Pausa (53682ms)
[33m‚ö†Ô∏è [16:36:25][0m   Too slow: 53682ms > 10000ms
[35müìã [16:36:25][0m GRUPO 5: Validaci√≥n de Integridad
[36müß™ [16:36:25][0m üî• EXTREME: Integridad - Persistencia de Datos
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:25.959Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:25.959Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:26.529Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: greeting, Input: "Reserva para 4 personas", Processing: false
[2025-11-19T16:36:26.531Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 23,
  "inputPreview": "Reserva para 4 personas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas", Processing: false
[2025-11-19T16:36:26.532Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas",
  "inputLength": 23,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:26.533Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:26.533Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:26.534Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_persistence_1763570185958",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570185958,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas",
  "inputLength": 23,
  "context": {
    "step": "greeting",
    "callSid": "CA_persistence_1763570185958"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas\""
}
[2025-11-19T16:36:26.534Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_persistence_1763570185958",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570185958,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:26.535Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_persistence_1763570185958",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570185958,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8396,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8396 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:27.618Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_persistence_1763570185958",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570185958,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 699,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_",
  "apiCallTimeMs": 1082,
  "reasoning": "Respuesta recibida de Gemini en 1082ms. Extrayendo JSON..."
}
[2025-11-19T16:36:27.619Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_persistence_1763570185958",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570185958,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1085,
  "apiCallTimeMs": 1082,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:27.619Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:36:27.620Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:36:27.621Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:27.622Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:36:27.622Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:36:27.623Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "date",
    "time",
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4}. Faltan: date, time, name"
}
[2025-11-19T16:36:27.624Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "date",
    "time",
    "name"
  ],
  "missingCount": 3,
  "reasoning": "Se determinaron 3 campos faltantes: date, time, name"
}
[2025-11-19T16:36:27.624Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "date",
  "allMissing": [
    "date",
    "time",
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4
  },
  "reasoning": "Faltan 3 campos. Preguntando primero por: date. Campos restantes: time, name"
}
[2025-11-19T16:36:27.625Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1093
}
[AFTER_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: ask_date, Time: 1093ms, Response: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:36:27.626Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1093,
  "responseMessage": "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1093ms. Respuesta: \"Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...\""
}
[2025-11-19T16:36:27.626Z] [INFO] STATE_PERSIST {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer l..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:27.633Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1675,
  "geminiTimeMs": 1085,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1093,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:27.700Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:27.700Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:27.701Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: ask_date, Input: "Ma√±ana", Processing: false
[2025-11-19T16:36:27.704Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 6,
  "inputPreview": "Ma√±ana",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Ma√±ana", Processing: false
[2025-11-19T16:36:27.706Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Ma√±ana",
  "inputLength": 6,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:27.707Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:27.708Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570187699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Ma√±ana",
  "inputLength": 6,
  "context": {
    "step": "ask_date",
    "callSid": "CA_persistence_1763570185958"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Ma√±ana\""
}
[2025-11-19T16:36:27.709Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570187699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:27.710Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570187699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8379,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8379 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:28.814Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570187699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"ho",
  "apiCallTimeMs": 1104,
  "reasoning": "Respuesta recibida de Gemini en 1104ms. Extrayendo JSON..."
}
[2025-11-19T16:36:28.815Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570187699,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1107,
  "apiCallTimeMs": 1104,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:36:28.816Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "extractedValue": "2025-11-20",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (2025-11-20). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:36:28.816Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4
  },
  "currentLanguage": "es",
  "originalText": "Ma√±ana",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4}. An√°lisis contiene: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:36:28.817Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:36:28.818Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 4
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": true,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:36:28.818Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "ask_date",
  "to": "ask_time",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1113
}
[AFTER_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: ask_time, Time: 1113ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre. ¬øA qu√© hora les gustar√≠a venir?"
[2025-11-19T16:36:28.819Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 1113,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre. ¬øA qu√© hora les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1113ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:36:28.820Z] [INFO] STATE_PERSIST {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_time
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, Perfecto, mesa para 4 personas, el d√≠a 20 de nov..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:28.823Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "totalTimeMs": 1124,
  "geminiTimeMs": 1107,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1113,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:28.885Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:28.886Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:28.886Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: ask_time, Input: "A las 8", Processing: false
[2025-11-19T16:36:28.888Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "A las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_time, Input: "A las 8", Processing: false
[2025-11-19T16:36:28.889Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "currentStep": "ask_time",
  "userInput": "A las 8",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:28.889Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "hora"
}
[2025-11-19T16:36:28.890Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570188885,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 8",
  "inputLength": 7,
  "context": {
    "step": "ask_time",
    "callSid": "CA_persistence_1763570185958"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 8\""
}
[2025-11-19T16:36:28.890Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570188885,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:28.891Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570188885,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:29.895Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570188885,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 699,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\": null,\n  \"hora_po",
  "apiCallTimeMs": 1004,
  "reasoning": "Respuesta recibida de Gemini en 1004ms. Extrayendo JSON..."
}
[2025-11-19T16:36:29.895Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570188885,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1005,
  "apiCallTimeMs": 1004,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 08:00, sin nombre"
}
[2025-11-19T16:36:29.896Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "extractedValue": "08:00",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (08:00). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:36:29.897Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "currentLanguage": "es",
  "originalText": "A las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\"}. An√°lisis contiene: sin personas, sin fecha, hora 08:00, sin nombre"
}
[2025-11-19T16:36:29.897Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:36:29.898Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:36:29.898Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "ask_time",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 1010
}
[AFTER_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: ask_name, Time: 1010ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:36:29.899Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1010,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1010ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:36:29.900Z] [INFO] STATE_PERSIST {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:29.903Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1018,
  "geminiTimeMs": 1005,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1010,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:29.965Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:29.966Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:29.967Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: ask_name, Input: "Juan P√©rez", Processing: false
[2025-11-19T16:36:29.969Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "Juan P√©rez",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Juan P√©rez", Processing: false
[2025-11-19T16:36:29.971Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Juan P√©rez",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:29.971Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:36:29.972Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570189964,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan P√©rez",
  "inputLength": 10,
  "context": {
    "step": "ask_name",
    "callSid": "CA_persistence_1763570185958"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan P√©rez\""
}
[2025-11-19T16:36:29.972Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570189964,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:29.973Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570189964,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:31.062Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570189964,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1087,
  "reasoning": "Respuesta recibida de Gemini en 1087ms. Extrayendo JSON..."
}
[2025-11-19T16:36:31.062Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_persistence_1763570185958",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570189964,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1090,
  "apiCallTimeMs": 1087,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan P√©rez",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan P√©rez"
}
[2025-11-19T16:36:31.063Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "extractedValue": "Juan P√©rez",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (Juan P√©rez). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:36:31.064Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan P√©rez",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "currentLanguage": "es",
  "originalText": "Juan P√©rez",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan P√©rez"
}
[2025-11-19T16:36:31.064Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "nombre": "Juan P√©rez",
  "credibilidad": "100%"
}
[2025-11-19T16:36:31.065Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
‚úÖ Usando mensajes en es para tipo name
[2025-11-19T16:36:31.066Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "ask_name",
  "to": "confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1096
}
[AFTER_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: confirm, Time: 1096ms, Response: "Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 08:00, a nombre de Juan P√©r"
[2025-11-19T16:36:31.067Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 1096,
  "responseMessage": "Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 08:00, a nombre de Juan P√©r",
  "reasoning": "Paso procesado en 1096ms. Respuesta: \"Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a...\""
}
[2025-11-19T16:36:31.068Z] [INFO] STATE_PERSIST {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a 20 ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:36:31.575Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 1611,
  "geminiTimeMs": 1090,
  "stateSaveTimeMs": 502,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1096,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:31.634Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:31.635Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:31.635Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: confirm, Input: "666123456", Processing: false
[2025-11-19T16:36:31.636Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "666123456", Processing: false
[2025-11-19T16:36:31.637Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "666123456",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": "Juan P√©rez",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "666123456"
üîç [DEBUG] Texto en min√∫sculas: "666123456"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_persistence_1763570185958, Step: confirm, Time: 8ms, Response: "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi"
[2025-11-19T16:36:31.646Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 8,
  "responseMessage": "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi",
  "reasoning": "Paso procesado en 8ms. Respuesta: \"¬øEs correcto? Puede decir s√≠ para confirmar, no pa...\""
}
[2025-11-19T16:36:31.646Z] [INFO] STATE_PERSIST {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øEs correcto? Puede decir s√≠ para confirmar, no pa...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, ¬øEs correcto? Puede decir s√≠ para confirmar, no para c..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:32.151Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_persistence_1763570185958",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 518,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 500,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 8,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[31m‚ùå [16:36:32][0m FAILED: Integridad - Persistencia de Datos (6244ms)
[33m‚ö†Ô∏è [16:36:32][0m   Expected to contain: "states"
[36müß™ [16:36:32][0m üî• EXTREME: Integridad - Aislamiento de Estado
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:32.204Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:32.205Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:32.206Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:32.206Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:32.787Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_isolate_1_1763570192204, Step: greeting, Input: "Reserva para 4 personas", Processing: false
[2025-11-19T16:36:32.788Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 23,
  "inputPreview": "Reserva para 4 personas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas", Processing: false
[2025-11-19T16:36:32.789Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas",
  "inputLength": 23,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:32.790Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:32.790Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:32.791Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:36:32.791Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:36:32.792Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:32.793Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:36:32.793Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:36:32.794Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "date",
    "time",
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4}. Faltan: date, time, name"
}
[2025-11-19T16:36:32.794Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "date",
    "time",
    "name"
  ],
  "missingCount": 3,
  "reasoning": "Se determinaron 3 campos faltantes: date, time, name"
}
[2025-11-19T16:36:32.795Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "date",
  "allMissing": [
    "date",
    "time",
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4
  },
  "reasoning": "Faltan 3 campos. Preguntando primero por: date. Campos restantes: time, name"
}
[2025-11-19T16:36:32.797Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 9
}
[AFTER_PROCESS_STEP] CallSid: CA_isolate_1_1763570192204, Step: ask_date, Time: 9ms, Response: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:36:32.798Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 9,
  "responseMessage": "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...\""
}
[2025-11-19T16:36:32.798Z] [INFO] STATE_PERSIST {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer l..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:32.802Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_isolate_1_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 598,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[2025-11-19T16:36:32.803Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_isolate_2_1763570192204, Step: greeting, Input: "Cancelar reserva", Processing: false
[2025-11-19T16:36:32.804Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 16,
  "inputPreview": "Cancelar reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Cancelar reserva", Processing: false
[2025-11-19T16:36:32.806Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Cancelar reserva",
  "inputLength": 16,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:32.806Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Cancelar reserva",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:32.807Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Cancelar reserva",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Cancelar reserva\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:32.809Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_isolate_2_1763570192204",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570192204,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Cancelar reserva",
  "inputLength": 16,
  "context": {
    "step": "greeting",
    "callSid": "CA_isolate_2_1763570192204"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Cancelar reserva\""
}
[2025-11-19T16:36:32.810Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_isolate_2_1763570192204",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570192204,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:32.810Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_isolate_2_1763570192204",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570192204,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8389,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8389 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:33.822Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_isolate_2_1763570192204",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570192204,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 691,
  "responsePreview": "```json\n{\n  \"intencion\": \"cancel\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcenta",
  "apiCallTimeMs": 1011,
  "reasoning": "Respuesta recibida de Gemini en 1011ms. Extrayendo JSON..."
}
[2025-11-19T16:36:33.823Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_isolate_2_1763570192204",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570192204,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1014,
  "apiCallTimeMs": 1011,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "cancel",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: cancel, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:33.824Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "cancel",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: cancel, Idioma: es. Procesando..."
}
[2025-11-19T16:36:33.824Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "cancel",
  "reasoning": "Intenci√≥n detectada: cancel. Procesando como cancelaci√≥n..."
}
[2025-11-19T16:36:33.825Z] [INFO] CANCELLATION_INTENT_AT_GREETING {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting"
}
üö´ [CANCELACI√ìN] Iniciando proceso de cancelaci√≥n de reserva existente
üö´ [DEBUG] Usando tel√©fono de la llamada: +34600123456
üîç [DEBUG] Buscando reservas para el tel√©fono: "+34600123456" (versi√≥n actualizada)
üîç [DEBUG] Tipo de dato del tel√©fono: string
üîç [DEBUG] Longitud del tel√©fono: 12
üîç [DEBUG] Tel√©fono normalizado (solo d√≠gitos): "34600123456"
üîç [DEBUG] Patr√≥n de b√∫squeda 1 (completo): "%34600123456%"
üîç [DEBUG] Patr√≥n de b√∫squeda 2 (√∫ltimos 8 d√≠gitos): "%00123456%"
üîç [DEBUG] Ejecutando consulta SQL: 
          SELECT id_reserva, data_reserva, num_persones, nom_persona_reserva, observacions, telefon
          FROM RESERVA 
          WHERE (telefon LIKE ? OR telefon LIKE ?)
          AND data_reserva >= NOW() 
          AND observacions NOT LIKE '%CANCELADA%'
          ORDER BY data_reserva ASC
        
üîç [DEBUG] Par√°metros: [ '%34600123456%', '%00123456%' ]
üìã [DEBUG] Resultado de la consulta: []
üìã [DEBUG] N√∫mero de filas encontradas: 0
üîç [DEBUG] TODAS las reservas (incluyendo pasadas): [
  {
    id_reserva: 18,
    data_reserva: 2025-10-09T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 19,
    data_reserva: 2025-10-10T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 98678,
    data_reserva: 2025-11-19T19:00:00.000Z,
    num_persones: 6,
    nom_persona_reserva: 'gerard',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959466,
    data_reserva: 2025-11-11T09:39:49.000Z,
    num_persones: 5,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959467,
    data_reserva: 2025-11-13T11:46:20.000Z,
    num_persones: 6,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959490,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959491,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  }
]
‚úÖ Usando mensajes en es para tipo cancel_no_reservations
[2025-11-19T16:36:34.689Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "greeting",
  "to": "cancel_no_reservations",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1884
}
[AFTER_PROCESS_STEP] CallSid: CA_isolate_2_1763570192204, Step: cancel_no_reservations, Time: 1884ms, Response: "No encontr√© reservas con ese tel√©fono. ¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:36:34.690Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 1884,
  "responseMessage": "No encontr√© reservas con ese tel√©fono. ¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 1884ms. Respuesta: \"No encontr√© reservas con ese tel√©fono. ¬øQuiere hac...\""
}
[2025-11-19T16:36:34.690Z] [INFO] STATE_PERSIST {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No encontr√© reservas con ese tel√©fono. ¬øQuiere hac...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, No encontr√© reservas con ese tel√©fono. ¬øQuie..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:34.694Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_isolate_2_1763570192204",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 2490,
  "geminiTimeMs": 1014,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1884,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[31m‚ùå [16:36:34][0m FAILED: Integridad - Aislamiento de Estado (2491ms)
[33m‚ö†Ô∏è [16:36:34][0m   Expected to contain: "isolated"
[36müß™ [16:36:34][0m üî• EXTREME: Integridad - Formatos de CallSid Inv√°lidos
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:34.698Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:34.698Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:35.290Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_fallback, Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:35.292Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Hola",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:35.293Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Hola",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:35.293Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:35.294Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Hola\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:35.294Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_fallback",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570194697,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Hola",
  "inputLength": 4,
  "context": {
    "step": "greeting",
    "callSid": "CA_fallback"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Hola\""
}
[2025-11-19T16:36:35.295Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_fallback",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570194697,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:35.296Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_fallback",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570194697,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8377,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8377 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:36.199Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_fallback",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570194697,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 903,
  "reasoning": "Respuesta recibida de Gemini en 903ms. Extrayendo JSON..."
}
[2025-11-19T16:36:36.199Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_fallback",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570194697,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 905,
  "apiCallTimeMs": 903,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:36.200Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:36:36.201Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:36:36.202Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 910
}
[AFTER_PROCESS_STEP] CallSid: CA_fallback, Step: ask_people, Time: 910ms, Response: "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:36:36.203Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 910,
  "responseMessage": "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 910ms. Respuesta: \"¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu...\""
}
[2025-11-19T16:36:36.204Z] [INFO] STATE_PERSIST {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, ¬°Perfecto! Por supuesto, con mucho gusto. ¬øPara cu√°nta..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:36.207Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_fallback",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1510,
  "geminiTimeMs": 905,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 910,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:36.210Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Hola! Bienvenido a nuestro restaurante. ¬øEn qu√© p...", UseAlgieba: true, NaturalFlow: true, Step: greeting
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "¬°Hola! Bienvenido a nuestro restaurante. ¬øEn qu√© puedo ayuda..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:36.221Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Hola! Bienvenido a nuestro restaurante. ¬øEn qu√© p...", UseAlgieba: true, NaturalFlow: true, Step: greeting
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "¬°Hola! Bienvenido a nuestro restaurante. ¬øEn qu√© puedo ayuda..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 1ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:36.228Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:36.230Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:36.802Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid:    , Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:36.803Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Hola",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:36.804Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Hola",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:36.805Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:36.805Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Hola\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:36.806Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:36:36.806Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:36:36.808Z] [INFO] STEP_TRANSITION {
  "callSid": "   ",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 5
}
[AFTER_PROCESS_STEP] CallSid:    , Step: ask_people, Time: 5ms, Response: "¬°Genial! ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:36:36.809Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 5,
  "responseMessage": "¬°Genial! ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 5ms. Respuesta: \"¬°Genial! ¬øPara cu√°ntas personas ser√°?...\""
}
[2025-11-19T16:36:36.810Z] [INFO] STATE_PERSIST {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Genial! ¬øPara cu√°ntas personas ser√°?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, ¬°Genial! ¬øPara cu√°ntas personas ser√°?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:36.814Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "   ",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 587,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 5,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:36.816Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:36.816Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:37.381Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_invalid, Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:37.383Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Hola",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:37.384Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Hola",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:37.385Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:37.385Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Hola\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:37.386Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:36:37.386Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:36:37.388Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 5
}
[AFTER_PROCESS_STEP] CallSid: CA_invalid, Step: ask_people, Time: 5ms, Response: "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?"
[2025-11-19T16:36:37.389Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 5,
  "responseMessage": "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?",
  "reasoning": "Paso procesado en 5ms. Respuesta: \"¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?...\""
}
[2025-11-19T16:36:37.390Z] [INFO] STATE_PERSIST {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "¬°Vale! Por supuesto. ¬øPara cu√°ntos comensales?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:37.394Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_invalid",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 579,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 5,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:37.395Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:37.396Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:37.965Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: 1234567890, Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:37.967Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Hola",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:37.968Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Hola",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:37.968Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:37.969Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Hola\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:37.969Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:36:37.970Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:36:37.972Z] [INFO] STEP_TRANSITION {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 5
}
[AFTER_PROCESS_STEP] CallSid: 1234567890, Step: ask_people, Time: 5ms, Response: "¬°Perfecto! ¬øPara cu√°ntas personas necesita la mesa?"
[2025-11-19T16:36:37.973Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 5,
  "responseMessage": "¬°Perfecto! ¬øPara cu√°ntas personas necesita la mesa?",
  "reasoning": "Paso procesado en 5ms. Respuesta: \"¬°Perfecto! ¬øPara cu√°ntas personas necesita la mesa...\""
}
[2025-11-19T16:36:37.973Z] [INFO] STATE_PERSIST {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Perfecto! ¬øPara cu√°ntas personas necesita la mesa...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, ¬°Perfecto! ¬øPara cu√°ntas personas necesita la mesa?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 5ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:37.981Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "1234567890",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 586,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 5,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:37.982Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:37.983Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:38.543Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_with_special_chars_!@#$%, Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:38.544Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Hola",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:38.545Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Hola",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:38.546Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:38.546Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Hola\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:38.547Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:36:38.547Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:36:38.549Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 4
}
[AFTER_PROCESS_STEP] CallSid: CA_with_special_chars_!@#$%, Step: ask_people, Time: 4ms, Response: "¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas personas?"
[2025-11-19T16:36:38.550Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 4,
  "responseMessage": "¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas personas?",
  "reasoning": "Paso procesado en 4ms. Respuesta: \"¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas pers...\""
}
[2025-11-19T16:36:38.551Z] [INFO] STATE_PERSIST {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, ¬°Por supuesto! Con mucho gusto. ¬øPara cu√°ntas persona..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 5ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:38.557Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_with_special_chars_!@#$%",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 575,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 4,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:38.558Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:38.559Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:39.135Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa, Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:39.137Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Hola",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Hola", Processing: false
[2025-11-19T16:36:39.138Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Hola",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:39.139Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:39.139Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Hola",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Hola\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:39.140Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:36:39.141Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:36:39.142Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 5
}
[AFTER_PROCESS_STEP] CallSid: CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa, Step: ask_people, Time: 5ms, Response: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:36:39.144Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 5,
  "responseMessage": "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 5ms. Respuesta: \"¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?...\""
}
[2025-11-19T16:36:39.144Z] [INFO] STATE_PERSIST {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, ¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:39.149Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 591,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 5,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[31m‚ùå [16:36:39][0m FAILED: Integridad - Formatos de CallSid Inv√°lidos (4452ms)
[33m‚ö†Ô∏è [16:36:39][0m   Expected status: 200, got: undefined
[35müìã [16:36:39][0m GRUPO 6: Casos de Borde Extremos
[36müß™ [16:36:39][0m üî• EXTREME: Borde - Variaciones de String Vac√≠o
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:39.154Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:39.155Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": false
}
[2025-11-19T16:36:39.744Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: greeting, Input: "empty", Processing: false
[2025-11-19T16:36:39.745Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": false,
  "inputLength": 0,
  "inputPreview": "empty",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "empty", Processing: false
[2025-11-19T16:36:39.746Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "(vac√≠o)",
  "inputLength": 0,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 0,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:39.747Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "(vac√≠o)",
  "reasoning": "Iniciando paso de saludo. Sin input, mostrando saludo est√°ndar."
}
‚úÖ Usando mensajes en es para tipo greeting
[2025-11-19T16:36:39.748Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_intention",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 2
}
[AFTER_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Time: 2ms, Response: "¬°Hola! Gracias por llamar. ¬øEn qu√© le puedo ayudar?"
[2025-11-19T16:36:39.749Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "processStepTimeMs": 2,
  "responseMessage": "¬°Hola! Gracias por llamar. ¬øEn qu√© le puedo ayudar?",
  "reasoning": "Paso procesado en 2ms. Respuesta: \"¬°Hola! Gracias por llamar. ¬øEn qu√© le puedo ayudar...\""
}
[2025-11-19T16:36:39.750Z] [INFO] STATE_PERSIST {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Hola! Gracias por llamar. ¬øEn qu√© le puedo ayudar...", UseAlgieba: true, NaturalFlow: true, Step: ask_intention
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, ¬°Hola! Gracias por llamar. ¬øEn qu√© le puedo ayudar..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:39.754Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "totalTimeMs": 600,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 2,
  "saveReservationTimeMs": 0,
  "hasInput": false
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:39.814Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:39.815Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:39.816Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 1
}
[BEFORE_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Input: "   ", Processing: false
[2025-11-19T16:36:39.817Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasInput": true,
  "inputLength": 3,
  "inputPreview": "   ",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_intention, Input: "   ", Processing: false
[2025-11-19T16:36:39.818Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "currentStep": "ask_intention",
  "userInput": "   ",
  "inputLength": 3,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
‚úÖ Usando mensajes en es para tipo ask_intention
[AFTER_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Time: 2ms, Response: "¬øQu√© desea hacer? ¬øReservar mesa, modificar reserva, cancelar o pedir a domicilio?"
[2025-11-19T16:36:39.820Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "processStepTimeMs": 2,
  "responseMessage": "¬øQu√© desea hacer? ¬øReservar mesa, modificar reserva, cancelar o pedir a domicilio?",
  "reasoning": "Paso procesado en 2ms. Respuesta: \"¬øQu√© desea hacer? ¬øReservar mesa, modificar reserv...\""
}
[2025-11-19T16:36:39.820Z] [INFO] STATE_PERSIST {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øQu√© desea hacer? ¬øReservar mesa, modificar reserv...", UseAlgieba: true, NaturalFlow: true, Step: ask_intention
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øQu√© desea hacer? ¬øReservar mesa, modificar reserva, cancela..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:39.825Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "totalTimeMs": 11,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 2,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:39.891Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:39.892Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:39.892Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Input: "
", Processing: false
[2025-11-19T16:36:39.894Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasInput": true,
  "inputLength": 1,
  "inputPreview": "\n",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_intention, Input: "
", Processing: false
[2025-11-19T16:36:39.895Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "currentStep": "ask_intention",
  "userInput": "\n",
  "inputLength": 1,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 2,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
‚úÖ Usando mensajes en es para tipo ask_intention
[AFTER_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Time: 2ms, Response: "¬øC√≥mo puedo ayudarle? ¬øReserva, modificar, cancelar o pedido a domicilio?"
[2025-11-19T16:36:39.896Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "processStepTimeMs": 2,
  "responseMessage": "¬øC√≥mo puedo ayudarle? ¬øReserva, modificar, cancelar o pedido a domicilio?",
  "reasoning": "Paso procesado en 2ms. Respuesta: \"¬øC√≥mo puedo ayudarle? ¬øReserva, modificar, cancela...\""
}
[2025-11-19T16:36:39.897Z] [INFO] STATE_PERSIST {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øC√≥mo puedo ayudarle? ¬øReserva, modificar, cancela...", UseAlgieba: true, NaturalFlow: true, Step: ask_intention
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øC√≥mo puedo ayudarle? ¬øReserva, modificar, cancelar o pedido..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:39.901Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "totalTimeMs": 10,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 2,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:39.954Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:39.955Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:39.956Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 3
}
[BEFORE_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Input: "	", Processing: false
[2025-11-19T16:36:39.958Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasInput": true,
  "inputLength": 1,
  "inputPreview": "\t",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_intention, Input: "	", Processing: false
[2025-11-19T16:36:39.959Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "currentStep": "ask_intention",
  "userInput": "\t",
  "inputLength": 1,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
‚úÖ Usando mensajes en es para tipo ask_intention
[AFTER_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Time: 1ms, Response: "¬øQu√© necesita? ¬øUna reserva, modificar una reserva, cancelar o un pedido?"
[2025-11-19T16:36:39.961Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "processStepTimeMs": 1,
  "responseMessage": "¬øQu√© necesita? ¬øUna reserva, modificar una reserva, cancelar o un pedido?",
  "reasoning": "Paso procesado en 1ms. Respuesta: \"¬øQu√© necesita? ¬øUna reserva, modificar una reserva...\""
}
[2025-11-19T16:36:39.962Z] [INFO] STATE_PERSIST {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øQu√© necesita? ¬øUna reserva, modificar una reserva...", UseAlgieba: true, NaturalFlow: true, Step: ask_intention
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, ¬øQu√© necesita? ¬øUna reserva, modificar una reserva, ca..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:39.965Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "totalTimeMs": 12,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:40.017Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:40.017Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:40.018Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Input: "
", Processing: false
[2025-11-19T16:36:40.019Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasInput": true,
  "inputLength": 2,
  "inputPreview": "\r\n",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_intention, Input: "
", Processing: false
[2025-11-19T16:36:40.020Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "currentStep": "ask_intention",
  "userInput": "\r\n",
  "inputLength": 2,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 4,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
‚úÖ Usando mensajes en es para tipo ask_intention
[AFTER_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Time: 1ms, Response: "D√≠game, ¬øqu√© necesita? ¬øReserva, modificar, cancelar o pedido?"
[2025-11-19T16:36:40.022Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "processStepTimeMs": 1,
  "responseMessage": "D√≠game, ¬øqu√© necesita? ¬øReserva, modificar, cancelar o pedido?",
  "reasoning": "Paso procesado en 1ms. Respuesta: \"D√≠game, ¬øqu√© necesita? ¬øReserva, modificar, cancel...\""
}
[2025-11-19T16:36:40.022Z] [INFO] STATE_PERSIST {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "D√≠game, ¬øqu√© necesita? ¬øReserva, modificar, cancel...", UseAlgieba: true, NaturalFlow: true, Step: ask_intention
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, D√≠game, ¬øqu√© necesita? ¬øReserva, modificar, cancelar o..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:40.027Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "totalTimeMs": 11,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:40.081Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:40.082Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:40.082Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 5
}
[BEFORE_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_intention, Input: "null", Processing: false
[2025-11-19T16:36:40.083Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "null",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_intention, Input: "null", Processing: false
[2025-11-19T16:36:40.085Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "currentStep": "ask_intention",
  "userInput": "null",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 6,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:40.085Z] [INFO] üß† ANALYZING_INTENTION_WITH_GEMINI {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "userInput": "null",
  "reasoning": "Analizando intenci√≥n del usuario con Gemini de forma s√≠ncrona: \"null\""
}
[2025-11-19T16:36:40.086Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_intention",
  "performanceMetrics": {
    "requestStart": 1763570200080,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "null",
  "inputLength": 4,
  "context": {
    "step": "ask_intention",
    "callSid": "CA_empty_variations_1763570199154"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"null\""
}
[2025-11-19T16:36:40.086Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_intention",
  "performanceMetrics": {
    "requestStart": 1763570200080,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:40.087Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_intention",
  "performanceMetrics": {
    "requestStart": 1763570200080,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8377,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8377 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:41.121Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_intention",
  "performanceMetrics": {
    "requestStart": 1763570200080,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 687,
  "responsePreview": "```json\n{\n  \"intencion\": null,\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcentaje_c",
  "apiCallTimeMs": 1033,
  "reasoning": "Respuesta recibida de Gemini en 1033ms. Extrayendo JSON..."
}
[2025-11-19T16:36:41.122Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_intention",
  "performanceMetrics": {
    "requestStart": 1763570200080,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1036,
  "apiCallTimeMs": 1033,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": null,
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: null, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:41.122Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "analysis": {
    "intencion": null,
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "null",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:41.123Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:36:41.123Z] [INFO] üìä MISSING_FIELDS_DETERMINED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "missing": [
    "people",
    "date",
    "time",
    "name"
  ],
  "missingCount": 4
}
[2025-11-19T16:36:41.124Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "ask_intention",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_intention",
  "processStepTimeMs": 1040
}
[AFTER_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_people, Time: 1040ms, Response: "Perfecto. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:36:41.125Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1040,
  "responseMessage": "Perfecto. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 1040ms. Respuesta: \"Perfecto. ¬øPara cu√°ntas personas ser√° la reserva?...\""
}
[2025-11-19T16:36:41.126Z] [INFO] STATE_PERSIST {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto. ¬øPara cu√°ntas personas ser√° la reserva?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto. ¬øPara cu√°ntas personas ser√° la reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:41.129Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1049,
  "geminiTimeMs": 1036,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1040,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:41.183Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:41.184Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:41.184Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 7
}
[BEFORE_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_people, Input: "undefined", Processing: false
[2025-11-19T16:36:41.186Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "undefined",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "undefined", Processing: false
[2025-11-19T16:36:41.187Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "undefined",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 8,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:41.188Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570201182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "undefined",
  "inputLength": 9,
  "context": {
    "step": "ask_people",
    "callSid": "CA_empty_variations_1763570199154"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"undefined\""
}
[2025-11-19T16:36:41.188Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570201182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:41.189Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570201182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8382,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8382 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:42.105Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570201182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 916,
  "reasoning": "Respuesta recibida de Gemini en 916ms. Extrayendo JSON..."
}
[2025-11-19T16:36:42.106Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570201182,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 919,
  "apiCallTimeMs": 916,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:42.108Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "undefined",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:42.108Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_people, Time: 923ms, Response: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:36:42.110Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 923,
  "responseMessage": "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 923ms. Respuesta: \"Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...\""
}
[2025-11-19T16:36:42.110Z] [INFO] STATE_PERSIST {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas perso..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:42.113Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 931,
  "geminiTimeMs": 919,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 923,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:42.165Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:42.166Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:42.167Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 9
}
[BEFORE_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_people, Input: "NaN", Processing: false
[2025-11-19T16:36:42.168Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 3,
  "inputPreview": "NaN",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "NaN", Processing: false
[2025-11-19T16:36:42.169Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "NaN",
  "inputLength": 3,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 10,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:42.171Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570202164,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "NaN",
  "inputLength": 3,
  "context": {
    "step": "ask_people",
    "callSid": "CA_empty_variations_1763570199154"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"NaN\""
}
[2025-11-19T16:36:42.172Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570202164,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:42.172Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570202164,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8376,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8376 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:43.108Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570202164,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 935,
  "reasoning": "Respuesta recibida de Gemini en 935ms. Extrayendo JSON..."
}
[2025-11-19T16:36:43.109Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_empty_variations_1763570199154",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570202164,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 938,
  "apiCallTimeMs": 935,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:43.111Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "NaN",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:43.112Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_empty_variations_1763570199154, Step: ask_people, Time: 943ms, Response: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:36:43.113Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 943,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 943ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...\""
}
[2025-11-19T16:36:43.113Z] [INFO] STATE_PERSIST {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:43.117Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_empty_variations_1763570199154",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 953,
  "geminiTimeMs": 938,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 943,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:36:43][0m PASSED: Borde - Variaciones de String Vac√≠o (4024ms)
[36müß™ [16:36:43][0m üî• EXTREME: Borde - Unicode y Emojis
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:43.179Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:43.180Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:43.749Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: greeting, Input: "Reserva para 4 personas üòä", Processing: false
[2025-11-19T16:36:43.750Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 26,
  "inputPreview": "Reserva para 4 personas üòä",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 personas üòä", Processing: false
[2025-11-19T16:36:43.752Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 personas üòä",
  "inputLength": 26,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:43.752Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas üòä",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:43.753Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 personas üòä",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 personas üòä\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:43.753Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_unicode_1763570203179",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570203179,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 personas üòä",
  "inputLength": 26,
  "context": {
    "step": "greeting",
    "callSid": "CA_unicode_1763570203179"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 personas üòä\""
}
[2025-11-19T16:36:43.754Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_unicode_1763570203179",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570203179,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:43.754Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_unicode_1763570203179",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570203179,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8399,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8399 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:44.765Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_unicode_1763570203179",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570203179,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 703,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_",
  "apiCallTimeMs": 1010,
  "reasoning": "Respuesta recibida de Gemini en 1010ms. Extrayendo JSON..."
}
[2025-11-19T16:36:44.766Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_unicode_1763570203179",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570203179,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1013,
  "apiCallTimeMs": 1010,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:44.766Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:36:44.768Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:36:44.770Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 4 personas üòä",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:36:44.770Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:36:44.771Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:36:44.771Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "date",
    "time",
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4}. Faltan: date, time, name"
}
[2025-11-19T16:36:44.772Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "date",
    "time",
    "name"
  ],
  "missingCount": 3,
  "reasoning": "Se determinaron 3 campos faltantes: date, time, name"
}
[2025-11-19T16:36:44.772Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "date",
  "allMissing": [
    "date",
    "time",
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4
  },
  "reasoning": "Faltan 3 campos. Preguntando primero por: date. Campos restantes: time, name"
}
[2025-11-19T16:36:44.773Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1022
}
[AFTER_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: ask_date, Time: 1022ms, Response: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:36:44.775Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1022,
  "responseMessage": "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1022ms. Respuesta: \"Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...\""
}
[2025-11-19T16:36:44.775Z] [INFO] STATE_PERSIST {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a dese...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas. ¬øPara qu√© d√≠a desean hacer l..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:44.780Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1601,
  "geminiTimeMs": 1013,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1022,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:44.831Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:44.832Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:44.832Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4
  },
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: ask_date, Input: "Ma√±ana üåû", Processing: false
[2025-11-19T16:36:44.834Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "Ma√±ana üåû",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Ma√±ana üåû", Processing: false
[2025-11-19T16:36:44.835Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Ma√±ana üåû",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:44.836Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:36:44.836Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570204830,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Ma√±ana üåû",
  "inputLength": 9,
  "context": {
    "step": "ask_date",
    "callSid": "CA_unicode_1763570203179"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Ma√±ana üåû\""
}
[2025-11-19T16:36:44.837Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570204830,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:44.837Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570204830,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8382,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8382 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:45.969Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570204830,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"ho",
  "apiCallTimeMs": 1131,
  "reasoning": "Respuesta recibida de Gemini en 1131ms. Extrayendo JSON..."
}
[2025-11-19T16:36:45.970Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570204830,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1134,
  "apiCallTimeMs": 1131,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:36:45.971Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "extractedValue": "2025-11-20",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (2025-11-20). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:36:45.971Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4
  },
  "currentLanguage": "es",
  "originalText": "Ma√±ana üåû",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4}. An√°lisis contiene: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:36:45.972Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:36:45.972Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 4
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": true,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:36:45.973Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "ask_date",
  "to": "ask_time",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1139
}
[AFTER_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: ask_time, Time: 1139ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre. ¬øA qu√© hora les gustar√≠a venir?"
[2025-11-19T16:36:45.974Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 1139,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre. ¬øA qu√© hora les gustar√≠a venir?",
  "reasoning": "Paso procesado en 1139ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:36:45.975Z] [INFO] STATE_PERSIST {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_time
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre. ¬øA q..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:45.979Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "totalTimeMs": 1149,
  "geminiTimeMs": 1134,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1139,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:46.035Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:46.035Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:46.036Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: ask_time, Input: "A las 8 üïó", Processing: false
[2025-11-19T16:36:46.037Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "A las 8 üïó",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_time, Input: "A las 8 üïó", Processing: false
[2025-11-19T16:36:46.038Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "currentStep": "ask_time",
  "userInput": "A las 8 üïó",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:46.039Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "hora"
}
[2025-11-19T16:36:46.039Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570206034,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 8 üïó",
  "inputLength": 10,
  "context": {
    "step": "ask_time",
    "callSid": "CA_unicode_1763570203179"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 8 üïó\""
}
[2025-11-19T16:36:46.040Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570206034,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:46.041Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570206034,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:46.960Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570206034,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 699,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\": null,\n  \"hora_po",
  "apiCallTimeMs": 919,
  "reasoning": "Respuesta recibida de Gemini en 919ms. Extrayendo JSON..."
}
[2025-11-19T16:36:46.961Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_time",
  "performanceMetrics": {
    "requestStart": 1763570206034,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 922,
  "apiCallTimeMs": 919,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 08:00, sin nombre"
}
[2025-11-19T16:36:46.962Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "extractedValue": "08:00",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (08:00). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:36:46.963Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "currentLanguage": "es",
  "originalText": "A las 8 üïó",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\"}. An√°lisis contiene: sin personas, sin fecha, hora 08:00, sin nombre"
}
[2025-11-19T16:36:46.963Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:36:46.964Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:36:46.964Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "ask_time",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_time",
  "processStepTimeMs": 927
}
[AFTER_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: ask_name, Time: 927ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:36:46.965Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 927,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 927ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:36:46.966Z] [INFO] STATE_PERSIST {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:46.970Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 936,
  "geminiTimeMs": 922,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 927,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:47.032Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:47.033Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:47.034Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: ask_name, Input: "Mi nombre es Jos√© üéâ", Processing: false
[2025-11-19T16:36:47.035Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 20,
  "inputPreview": "Mi nombre es Jos√© üéâ",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Mi nombre es Jos√© üéâ", Processing: false
[2025-11-19T16:36:47.036Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Mi nombre es Jos√© üéâ",
  "inputLength": 20,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:47.036Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:36:47.037Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570207032,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Mi nombre es Jos√© üéâ",
  "inputLength": 20,
  "context": {
    "step": "ask_name",
    "callSid": "CA_unicode_1763570203179"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Mi nombre es Jos√© üéâ\""
}
[2025-11-19T16:36:47.038Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570207032,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:47.038Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570207032,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8393,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8393 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:48.009Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570207032,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 696,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 970,
  "reasoning": "Respuesta recibida de Gemini en 970ms. Extrayendo JSON..."
}
[2025-11-19T16:36:48.010Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_unicode_1763570203179",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570207032,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 973,
  "apiCallTimeMs": 970,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Jos√©",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Jos√©"
}
[2025-11-19T16:36:48.010Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "extractedValue": "Jos√©",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (Jos√©). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:36:48.011Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Jos√©",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "currentLanguage": "es",
  "originalText": "Mi nombre es Jos√© üéâ",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Jos√©"
}
[2025-11-19T16:36:48.012Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "nombre": "Jos√©",
  "credibilidad": "100%"
}
[2025-11-19T16:36:48.012Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Jos√©"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
‚úÖ Usando mensajes en es para tipo name
[2025-11-19T16:36:48.014Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "ask_name",
  "to": "confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 979
}
[AFTER_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: confirm, Time: 979ms, Response: "Muy bien, Jos√©. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 08:00, a nombre de Jos√©, tel√©fono"
[2025-11-19T16:36:48.015Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 979,
  "responseMessage": "Muy bien, Jos√©. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 08:00, a nombre de Jos√©, tel√©fono",
  "reasoning": "Paso procesado en 979ms. Respuesta: \"Muy bien, Jos√©. Perfecto, 4 personas, el d√≠a 20 de...\""
}
[2025-11-19T16:36:48.015Z] [INFO] STATE_PERSIST {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Jos√©"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Muy bien, Jos√©. Perfecto, 4 personas, el d√≠a 20 de...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, Muy bien, Jos√©. Perfecto, 4 personas, el d√≠a 20 de no..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:36:48.525Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 1493,
  "geminiTimeMs": 973,
  "stateSaveTimeMs": 505,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 979,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:48.584Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:48.585Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:48.585Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Jos√©",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: confirm, Input: "Tel√©fono: 666123456 üì±", Processing: false
[2025-11-19T16:36:48.587Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 22,
  "inputPreview": "Tel√©fono: 666123456 üì±",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "Tel√©fono: 666123456 üì±", Processing: false
[2025-11-19T16:36:48.588Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "Tel√©fono: 666123456 üì±",
  "inputLength": 22,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": "Jos√©",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Tel√©fono: 666123456 üì±"
üîç [DEBUG] Texto en min√∫sculas: "tel√©fono: 666123456 üì±"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_unicode_1763570203179, Step: confirm, Time: 43ms, Response: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi"
[2025-11-19T16:36:48.631Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 43,
  "responseMessage": "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar personas, cambiar fecha, cambiar hora, cambi",
  "reasoning": "Paso procesado en 43ms. Respuesta: \"Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...\""
}
[2025-11-19T16:36:48.632Z] [INFO] STATE_PERSIST {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Jos√©"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir ca...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Entiendo. ¬øQu√© le gustar√≠a cambiar? Puede decir cambiar pers..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:36:49.149Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_unicode_1763570203179",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 565,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 513,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 43,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:36:49][0m PASSED: Borde - Unicode y Emojis (6028ms)
[36müß™ [16:36:49][0m üî• EXTREME: Borde - Idiomas Mezclados
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:49.211Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:49.212Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:49.782Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_mixed_lang_1763570209210, Step: greeting, Input: "Reserva para 4 people ma√±ana at 8 PM", Processing: false
[2025-11-19T16:36:49.783Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 36,
  "inputPreview": "Reserva para 4 people ma√±ana at 8 PM",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 4 people ma√±ana at 8 PM", Processing: false
[2025-11-19T16:36:49.784Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 4 people ma√±ana at 8 PM",
  "inputLength": 36,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:49.785Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 people ma√±ana at 8 PM",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:49.786Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 4 people ma√±ana at 8 PM",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 4 people ma√±ana at 8 PM\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:49.787Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570209210,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 4 people ma√±ana at 8 PM",
  "inputLength": 36,
  "context": {
    "step": "greeting",
    "callSid": "CA_mixed_lang_1763570209210"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 4 people ma√±ana at 8 PM\""
}
[2025-11-19T16:36:49.787Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570209210,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:49.788Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570209210,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8409,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8409 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:50.933Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570209210,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"20:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1145,
  "reasoning": "Respuesta recibida de Gemini en 1145ms. Extrayendo JSON..."
}
[2025-11-19T16:36:50.934Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570209210,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1147,
  "apiCallTimeMs": 1145,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "20:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "en",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: en. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 20:00, sin nombre"
}
[2025-11-19T16:36:50.935Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "en",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-20",
    "hora": "20:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: en. Procesando..."
}
[2025-11-19T16:36:50.935Z] [INFO] üåê LANGUAGE_UPDATED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "oldLanguage": "es",
  "newLanguage": "en",
  "reasoning": "Idioma detectado por Gemini: en. Actualizando estado del idioma ANTES de generar respuestas."
}
[2025-11-19T16:36:50.936Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:36:50.936Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "20:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "en"
  },
  "stateBefore": {},
  "currentLanguage": "en",
  "originalText": "Reserva para 4 people ma√±ana at 8 PM",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: en. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 20:00, sin nombre"
}
[2025-11-19T16:36:50.937Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:36:50.938Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:36:50.938Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "20:00",
  "credibilidad": "100%"
}
[2025-11-19T16:36:50.939Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:36:50.939Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "20:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"20:00\"}. Faltan: name"
}
[2025-11-19T16:36:50.940Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:36:50.940Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:36:50.941Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1157
}
[AFTER_PROCESS_STEP] CallSid: CA_mixed_lang_1763570209210, Step: ask_name, Time: 1157ms, Response: "Perfect, table for 4 people, on November 20, at 8 PM. Under whose name will the reservation be?"
[2025-11-19T16:36:50.942Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1157,
  "responseMessage": "Perfect, table for 4 people, on November 20, at 8 PM. Under whose name will the reservation be?",
  "reasoning": "Paso procesado en 1157ms. Respuesta: \"Perfect, table for 4 people, on November 20, at 8 ...\""
}
[2025-11-19T16:36:50.944Z] [INFO] STATE_PERSIST {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: en, Mensaje: "Perfect, table for 4 people, on November 20, at 8 ...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfect, table for 4 people, on November 20, at 8 PM. Under ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 5ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:50.950Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1740,
  "geminiTimeMs": 1147,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1157,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:51.011Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:51.012Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:51.012Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_mixed_lang_1763570209210, Step: ask_name, Input: "Quiero hacer una reservation para tomorrow", Processing: false
[2025-11-19T16:36:51.014Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 42,
  "inputPreview": "Quiero hacer una reservation para tomorrow",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Quiero hacer una reservation para tomorrow", Processing: false
[2025-11-19T16:36:51.015Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Quiero hacer una reservation para tomorrow",
  "inputLength": 42,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "20:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:51.015Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:36:51.016Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570211010,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Quiero hacer una reservation para tomorrow",
  "inputLength": 42,
  "context": {
    "step": "ask_name",
    "callSid": "CA_mixed_lang_1763570209210"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Quiero hacer una reservation para tomorrow\""
}
[2025-11-19T16:36:51.016Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570211010,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:51.017Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570211010,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8415,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8415 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:52.046Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570211010,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 706,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n ",
  "apiCallTimeMs": 1028,
  "reasoning": "Respuesta recibida de Gemini en 1028ms. Extrayendo JSON..."
}
[2025-11-19T16:36:52.047Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570211010,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1031,
  "apiCallTimeMs": 1028,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "en",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: en. Extra√≠dos: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Quiero hacer una reservation para tomorrow"
üîç [DEBUG] Texto en min√∫sculas: "quiero hacer una reservation para tomorrow"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:36:52.067Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "analysis": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "en"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "currentLanguage": "en",
  "originalText": "Quiero hacer una reservation para tomorrow",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: en. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"20:00\"}. An√°lisis contiene: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:36:52.068Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "fecha": "2025-11-20",
  "fechaAnterior": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:36:52.068Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_mixed_lang_1763570209210, Step: ask_name, Time: 1055ms, Response: "Your name? Please tell me slowly."
[2025-11-19T16:36:52.070Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "processStepTimeMs": 1055,
  "responseMessage": "Your name? Please tell me slowly.",
  "reasoning": "Paso procesado en 1055ms. Respuesta: \"Your name? Please tell me slowly....\""
}
[2025-11-19T16:36:52.070Z] [INFO] STATE_PERSIST {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: en, Mensaje: "Your name? Please tell me slowly....", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Your name? Please tell me slowly...."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:52.075Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "totalTimeMs": 1065,
  "geminiTimeMs": 1031,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1055,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:52.130Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:52.131Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:52.132Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_mixed_lang_1763570209210, Step: ask_name, Input: "Mi nombre es John y mi tel√©fono es 666123456", Processing: false
[2025-11-19T16:36:52.133Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 44,
  "inputPreview": "Mi nombre es John y mi tel√©fono es 666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Mi nombre es John y mi tel√©fono es 666123456", Processing: false
[2025-11-19T16:36:52.134Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Mi nombre es John y mi tel√©fono es 666123456",
  "inputLength": 44,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "20:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:52.134Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:36:52.135Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570212130,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Mi nombre es John y mi tel√©fono es 666123456",
  "inputLength": 44,
  "context": {
    "step": "ask_name",
    "callSid": "CA_mixed_lang_1763570209210"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Mi nombre es John y mi tel√©fono es 666123456\""
}
[2025-11-19T16:36:52.136Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570212130,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 1,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:52.136Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570212130,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8417,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8417 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:53.140Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570212130,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 705,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1003,
  "reasoning": "Respuesta recibida de Gemini en 1003ms. Extrayendo JSON..."
}
[2025-11-19T16:36:53.141Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_mixed_lang_1763570209210",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570212130,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1006,
  "apiCallTimeMs": 1003,
  "dataLoadTimeMs": 1,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "John",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre John"
}
[2025-11-19T16:36:53.141Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "extractedValue": "John",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (John). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:36:53.142Z] [INFO] üåê LANGUAGE_UPDATED_IN_APPLY {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "oldLanguage": "en",
  "newLanguage": "es",
  "reasoning": "Idioma detectado por Gemini en applyGeminiAnalysisToState: es. Actualizando estado."
}
[2025-11-19T16:36:53.142Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "John",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "currentLanguage": "es",
  "originalText": "Mi nombre es John y mi tel√©fono es 666123456",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"20:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre John"
}
[2025-11-19T16:36:53.143Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "nombre": "John",
  "credibilidad": "100%"
}
[2025-11-19T16:36:53.144Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00",
    "NomReserva": "John"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
‚úÖ Usando mensajes en es para tipo name
[2025-11-19T16:36:53.145Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "ask_name",
  "to": "confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "ask_name",
  "processStepTimeMs": 1012
}
[AFTER_PROCESS_STEP] CallSid: CA_mixed_lang_1763570209210, Step: confirm, Time: 1012ms, Response: "Genial, John. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 20:00, a nombre de John, tel√©fono t"
[2025-11-19T16:36:53.146Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "confirm",
  "processStepTimeMs": 1012,
  "responseMessage": "Genial, John. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 20:00, a nombre de John, tel√©fono t",
  "reasoning": "Paso procesado en 1012ms. Respuesta: \"Genial, John. Perfecto, 4 personas, el d√≠a 20 de n...\""
}
[2025-11-19T16:36:53.146Z] [INFO] STATE_PERSIST {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00",
    "NomReserva": "John"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Genial, John. Perfecto, 4 personas, el d√≠a 20 de n...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Genial, John. Perfecto, 4 personas, el d√≠a 20 de noviembre a..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:36:53.661Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "en",
  "step": "confirm",
  "totalTimeMs": 1531,
  "geminiTimeMs": 1006,
  "stateSaveTimeMs": 510,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 1,
  "dbTimeMs": 0,
  "processStepTimeMs": 1012,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:53.717Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:53.717Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:53.718Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00",
    "NomReserva": "John",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_mixed_lang_1763570209210, Step: confirm, Input: "Reservar una mesa reservation para 4 personas people", Processing: false
[2025-11-19T16:36:53.719Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 52,
  "inputPreview": "Reservar una mesa reservation para 4 personas people",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "Reservar una mesa reservation para 4 personas people", Processing: false
[2025-11-19T16:36:53.720Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "Reservar una mesa reservation para 4 personas people",
  "inputLength": 52,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "20:00",
    "nombre": "John",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:53.721Z] [INFO] ‚úÖ CRITICAL_CONFIRMATION_DETECTED {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "action": "modify",
  "reasoning": "Confirmaci√≥n v√°lida detectada. Saltando verificaci√≥n de cancelaci√≥n."
}
[2025-11-19T16:36:53.722Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "confirm",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 3
}
[AFTER_PROCESS_STEP] CallSid: CA_mixed_lang_1763570209210, Step: ask_people, Time: 3ms, Response: "Perfecto. ¬øPara cu√°ntas personas?"
[2025-11-19T16:36:53.723Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 3,
  "responseMessage": "Perfecto. ¬øPara cu√°ntas personas?",
  "reasoning": "Paso procesado en 3ms. Respuesta: \"Perfecto. ¬øPara cu√°ntas personas?...\""
}
[2025-11-19T16:36:53.723Z] [INFO] STATE_PERSIST {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "20:00",
    "NomReserva": "John"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto. ¬øPara cu√°ntas personas?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto. ¬øPara cu√°ntas personas?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 1ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:53.728Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_mixed_lang_1763570209210",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 12,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 3,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:36:53][0m PASSED: Borde - Idiomas Mezclados (4572ms)
[36müß™ [16:36:53][0m üî• EXTREME: Borde - Casos de Hora Extremos
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:53.784Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:53.784Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:54.355Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: greeting, Input: "A las 00:00", Processing: false
[2025-11-19T16:36:54.356Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "A las 00:00",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "A las 00:00", Processing: false
[2025-11-19T16:36:54.357Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "A las 00:00",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:54.358Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "A las 00:00",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:36:54.358Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "A las 00:00",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"A las 00:00\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:36:54.359Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570213783,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 00:00",
  "inputLength": 11,
  "context": {
    "step": "greeting",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 00:00\""
}
[2025-11-19T16:36:54.360Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570213783,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:54.360Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570213783,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:55.401Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570213783,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 711,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"00:00\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_horario\"",
  "apiCallTimeMs": 1040,
  "reasoning": "Respuesta recibida de Gemini en 1040ms. Extrayendo JSON..."
}
[2025-11-19T16:36:55.402Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570213783,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1043,
  "apiCallTimeMs": 1040,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "00:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 00:00, sin nombre"
}
[2025-11-19T16:36:55.402Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": "00:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:36:55.403Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:36:55.405Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1048
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Time: 1048ms, Response: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:36:55.406Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1048,
  "responseMessage": "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 1048ms. Respuesta: \"¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?...\""
}
[2025-11-19T16:36:55.406Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:55.410Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1627,
  "geminiTimeMs": 1043,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1048,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:55.471Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:55.471Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:55.472Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Input: "A las 23:59", Processing: false
[2025-11-19T16:36:55.474Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "A las 23:59",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "A las 23:59", Processing: false
[2025-11-19T16:36:55.475Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "A las 23:59",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:55.476Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570215469,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 23:59",
  "inputLength": 11,
  "context": {
    "step": "ask_people",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 23:59\""
}
[2025-11-19T16:36:55.476Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570215469,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:55.477Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570215469,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:56.468Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570215469,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 711,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"23:59\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_horario\"",
  "apiCallTimeMs": 991,
  "reasoning": "Respuesta recibida de Gemini en 991ms. Extrayendo JSON..."
}
[2025-11-19T16:36:56.469Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570215469,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 993,
  "apiCallTimeMs": 991,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "23:59",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 23:59, sin nombre"
}
[2025-11-19T16:36:56.470Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "23:59",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "A las 23:59",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, hora 23:59, sin nombre"
}
[2025-11-19T16:36:56.471Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hora": "23:59",
  "error": "fuera_horario"
}
[2025-11-19T16:36:56.472Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "HoraReserva": "23:59"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Time: 997ms, Response: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:36:56.473Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 997,
  "responseMessage": "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 997ms. Respuesta: \"Disculpe, no he entendido bien. ¬øCu√°ntas personas ...\""
}
[2025-11-19T16:36:56.474Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "23:59"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:56.477Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1008,
  "geminiTimeMs": 993,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 997,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:56.533Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:56.534Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:56.534Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "23:59"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Input: "A las 24:00", Processing: false
[2025-11-19T16:36:56.535Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "A las 24:00",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "A las 24:00", Processing: false
[2025-11-19T16:36:56.537Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "A las 24:00",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": "23:59",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:56.538Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570216532,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 24:00",
  "inputLength": 11,
  "context": {
    "step": "ask_people",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 24:00\""
}
[2025-11-19T16:36:56.540Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570216532,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:56.540Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570216532,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:57.487Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570216532,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 715,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"00:00\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_hora",
  "apiCallTimeMs": 946,
  "reasoning": "Respuesta recibida de Gemini en 946ms. Extrayendo JSON..."
}
[2025-11-19T16:36:57.488Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570216532,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 950,
  "apiCallTimeMs": 946,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "00:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 00:00, sin nombre"
}
[2025-11-19T16:36:57.489Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "00:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "HoraReserva": "23:59"
  },
  "currentLanguage": "es",
  "originalText": "A las 24:00",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"HoraReserva\":\"23:59\"}. An√°lisis contiene: sin personas, sin fecha, hora 00:00, sin nombre"
}
[2025-11-19T16:36:57.490Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hora": "00:00",
  "error": "fuera_horario"
}
[2025-11-19T16:36:57.490Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "HoraReserva": "23:59"
  },
  "stateAfter": {
    "HoraReserva": "00:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Time: 955ms, Response: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:36:57.492Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 955,
  "responseMessage": "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 955ms. Respuesta: \"Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas v...\""
}
[2025-11-19T16:36:57.492Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "00:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas v...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:57.496Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 964,
  "geminiTimeMs": 950,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 955,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:57.562Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:57.562Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:57.563Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "00:00"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Input: "A las 25:00", Processing: false
[2025-11-19T16:36:57.564Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "A las 25:00",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "A las 25:00", Processing: false
[2025-11-19T16:36:57.565Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "A las 25:00",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": "00:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:57.566Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570217561,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 25:00",
  "inputLength": 11,
  "context": {
    "step": "ask_people",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 25:00\""
}
[2025-11-19T16:36:57.566Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570217561,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:57.567Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570217561,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:58.540Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570217561,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 711,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"25:00\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_horario\"",
  "apiCallTimeMs": 972,
  "reasoning": "Respuesta recibida de Gemini en 972ms. Extrayendo JSON..."
}
[2025-11-19T16:36:58.541Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570217561,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 975,
  "apiCallTimeMs": 972,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "25:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 25:00, sin nombre"
}
[2025-11-19T16:36:58.541Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "25:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "HoraReserva": "00:00"
  },
  "currentLanguage": "es",
  "originalText": "A las 25:00",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"HoraReserva\":\"00:00\"}. An√°lisis contiene: sin personas, sin fecha, hora 25:00, sin nombre"
}
[2025-11-19T16:36:58.543Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hora": "25:00",
  "error": "fuera_horario"
}
[2025-11-19T16:36:58.543Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "HoraReserva": "00:00"
  },
  "stateAfter": {
    "HoraReserva": "25:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Time: 979ms, Response: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:36:58.544Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 979,
  "responseMessage": "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 979ms. Respuesta: \"Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas v...\""
}
[2025-11-19T16:36:58.545Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "25:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas v...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:58.548Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 987,
  "geminiTimeMs": 975,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 979,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:58.607Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:58.607Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:58.608Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "25:00"
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Input: "A medianoche", Processing: false
[2025-11-19T16:36:58.610Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 12,
  "inputPreview": "A medianoche",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "A medianoche", Processing: false
[2025-11-19T16:36:58.611Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "A medianoche",
  "inputLength": 12,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": "25:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:58.611Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570218606,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A medianoche",
  "inputLength": 12,
  "context": {
    "step": "ask_people",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A medianoche\""
}
[2025-11-19T16:36:58.612Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570218606,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:58.613Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570218606,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8385,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8385 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:36:59.690Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570218606,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 711,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"00:00\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_horario\"",
  "apiCallTimeMs": 1077,
  "reasoning": "Respuesta recibida de Gemini en 1077ms. Extrayendo JSON..."
}
[2025-11-19T16:36:59.692Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570218606,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1081,
  "apiCallTimeMs": 1077,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "00:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 00:00, sin nombre"
}
[2025-11-19T16:36:59.694Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "00:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "HoraReserva": "25:00"
  },
  "currentLanguage": "es",
  "originalText": "A medianoche",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"HoraReserva\":\"25:00\"}. An√°lisis contiene: sin personas, sin fecha, hora 00:00, sin nombre"
}
[2025-11-19T16:36:59.695Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hora": "00:00",
  "error": "fuera_horario"
}
[2025-11-19T16:36:59.696Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "HoraReserva": "25:00"
  },
  "stateAfter": {
    "HoraReserva": "00:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Time: 1086ms, Response: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:36:59.697Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1086,
  "responseMessage": "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 1086ms. Respuesta: \"Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...\""
}
[2025-11-19T16:36:59.697Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "00:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas perso..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:36:59.702Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1096,
  "geminiTimeMs": 1081,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1086,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:36:59.760Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:36:59.761Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:36:59.761Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "00:00"
  },
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Input: "A mediod√≠a", Processing: false
[2025-11-19T16:36:59.763Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "A mediod√≠a",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "A mediod√≠a", Processing: false
[2025-11-19T16:36:59.764Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "A mediod√≠a",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": "00:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:36:59.764Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570219760,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A mediod√≠a",
  "inputLength": 10,
  "context": {
    "step": "ask_people",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A mediod√≠a\""
}
[2025-11-19T16:36:59.765Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570219760,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:36:59.765Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570219760,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:00.770Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570219760,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 711,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"12:00\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_horario\"",
  "apiCallTimeMs": 1004,
  "reasoning": "Respuesta recibida de Gemini en 1004ms. Extrayendo JSON..."
}
[2025-11-19T16:37:00.771Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570219760,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1007,
  "apiCallTimeMs": 1004,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "12:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 12:00, sin nombre"
}
[2025-11-19T16:37:00.772Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "12:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "HoraReserva": "00:00"
  },
  "currentLanguage": "es",
  "originalText": "A mediod√≠a",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"HoraReserva\":\"00:00\"}. An√°lisis contiene: sin personas, sin fecha, hora 12:00, sin nombre"
}
[2025-11-19T16:37:00.774Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hora": "12:00",
  "error": "fuera_horario"
}
[2025-11-19T16:37:00.774Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "HoraReserva": "00:00"
  },
  "stateAfter": {
    "HoraReserva": "12:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Time: 1012ms, Response: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:37:00.775Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1012,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 1012ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...\""
}
[2025-11-19T16:37:00.776Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "12:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Aja, Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:00.781Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1021,
  "geminiTimeMs": 1007,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1012,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:00.839Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:00.840Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:00.840Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "HoraReserva",
    "horaError"
  ],
  "dataValues": {
    "HoraReserva": "12:00"
  },
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_people, Input: "A las 12 PM", Processing: false
[2025-11-19T16:37:00.841Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "A las 12 PM",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "A las 12 PM", Processing: false
[2025-11-19T16:37:00.843Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "A las 12 PM",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": "12:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:00.843Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570220837,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 12 PM",
  "inputLength": 11,
  "context": {
    "step": "ask_people",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 12 PM\""
}
[2025-11-19T16:37:00.844Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570220837,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:00.844Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570220837,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:01.903Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570220837,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 711,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"12:00\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_horario\"",
  "apiCallTimeMs": 1058,
  "reasoning": "Respuesta recibida de Gemini en 1058ms. Extrayendo JSON..."
}
[2025-11-19T16:37:01.904Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570220837,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1061,
  "apiCallTimeMs": 1058,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "12:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 12:00, sin nombre"
}
[2025-11-19T16:37:01.905Z] [INFO] PEOPLE_EXTRACTED_ANY_NUMBER {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 12
}
[2025-11-19T16:37:01.905Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "12",
    "comensales_confidence": "90%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "12:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "HoraReserva": "12:00"
  },
  "currentLanguage": "es",
  "originalText": "A las 12 PM",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"HoraReserva\":\"12:00\"}. An√°lisis contiene: 12 personas, sin fecha, hora 12:00, sin nombre"
}
[2025-11-19T16:37:01.906Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 12,
  "credibilidad": "90%"
}
[2025-11-19T16:37:01.907Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hora": "12:00",
  "error": "fuera_horario"
}
[2025-11-19T16:37:01.907Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "HoraReserva": "12:00"
  },
  "stateAfter": {
    "NumeroReserva": 12,
    "HoraReserva": "12:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:37:01.908Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1066
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_date, Time: 1066ms, Response: "Perfecto, mesa para 12 personas, a las 12 de la ma√±ana. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:37:01.909Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1066,
  "responseMessage": "Perfecto, mesa para 12 personas, a las 12 de la ma√±ana. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1066ms. Respuesta: \"Perfecto, mesa para 12 personas, a las 12 de la ma...\""
}
[2025-11-19T16:37:01.910Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "HoraReserva",
    "horaError",
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 12,
    "HoraReserva": "12:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 12 personas, a las 12 de la ma...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, Perfecto, mesa para 12 personas, a las 12 de..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:01.914Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1077,
  "geminiTimeMs": 1061,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1066,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:01.972Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:01.972Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:01.973Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "HoraReserva",
    "horaError",
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 12,
    "HoraReserva": "12:00"
  },
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_date, Input: "A las 12 AM", Processing: false
[2025-11-19T16:37:01.974Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "A las 12 AM",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "A las 12 AM", Processing: false
[2025-11-19T16:37:01.975Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "A las 12 AM",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 12,
    "fecha": null,
    "hora": "12:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:01.976Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:01.976Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570221971,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 12 AM",
  "inputLength": 11,
  "context": {
    "step": "ask_date",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 12 AM\""
}
[2025-11-19T16:37:01.977Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570221971,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:01.978Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570221971,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:02.929Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570221971,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 711,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"00:00\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_horario\"",
  "apiCallTimeMs": 951,
  "reasoning": "Respuesta recibida de Gemini en 951ms. Extrayendo JSON..."
}
[2025-11-19T16:37:02.930Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570221971,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 954,
  "apiCallTimeMs": 951,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "00:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 00:00, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "A las 12 AM"
üîç [DEBUG] Texto en min√∫sculas: "a las 12 am"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:02.957Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "00:00",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 12,
    "HoraReserva": "12:00"
  },
  "currentLanguage": "es",
  "originalText": "A las 12 AM",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":12,\"HoraReserva\":\"12:00\"}. An√°lisis contiene: sin personas, sin fecha, hora 00:00, sin nombre"
}
[2025-11-19T16:37:02.958Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hora": "00:00",
  "error": "fuera_horario"
}
[2025-11-19T16:37:02.959Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 12,
    "HoraReserva": "12:00"
  },
  "stateAfter": {
    "NumeroReserva": 12,
    "HoraReserva": "00:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_date, Time: 984ms, Response: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:37:02.960Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 984,
  "responseMessage": "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 984ms. Respuesta: \"Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...\""
}
[2025-11-19T16:37:02.960Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "HoraReserva",
    "horaError",
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 12,
    "HoraReserva": "00:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:02.965Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 994,
  "geminiTimeMs": 954,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 984,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:03.028Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:03.029Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:03.029Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "HoraReserva",
    "horaError",
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 12,
    "HoraReserva": "00:00"
  },
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_date, Input: "A las 13:00 PM", Processing: false
[2025-11-19T16:37:03.030Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 14,
  "inputPreview": "A las 13:00 PM",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "A las 13:00 PM", Processing: false
[2025-11-19T16:37:03.032Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "A las 13:00 PM",
  "inputLength": 14,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 12,
    "fecha": null,
    "hora": "00:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": "fuera_horario",
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:03.032Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:03.033Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570223027,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 13:00 PM",
  "inputLength": 14,
  "context": {
    "step": "ask_date",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 13:00 PM\""
}
[2025-11-19T16:37:03.033Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570223027,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:03.034Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570223027,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8387,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8387 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:04.144Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570223027,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 703,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"13:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\": null,\n  \"hor",
  "apiCallTimeMs": 1110,
  "reasoning": "Respuesta recibida de Gemini en 1110ms. Extrayendo JSON..."
}
[2025-11-19T16:37:04.145Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570223027,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1112,
  "apiCallTimeMs": 1110,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "13:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 13:00, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "A las 13:00 PM"
üîç [DEBUG] Texto en min√∫sculas: "a las 13:00 pm"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:04.171Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "reservation",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "13:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 12,
    "HoraReserva": "00:00"
  },
  "currentLanguage": "es",
  "originalText": "A las 13:00 PM",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":12,\"HoraReserva\":\"00:00\"}. An√°lisis contiene: sin personas, sin fecha, hora 13:00, sin nombre"
}
[2025-11-19T16:37:04.172Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hora": "13:00",
  "horaAnterior": "00:00",
  "credibilidad": "100%"
}
[2025-11-19T16:37:04.173Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 12,
    "HoraReserva": "00:00"
  },
  "stateAfter": {
    "NumeroReserva": 12,
    "HoraReserva": "13:00"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_date, Time: 1142ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:37:04.174Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1142,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 1142ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:37:04.174Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "HoraReserva",
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 12,
    "HoraReserva": "13:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les co..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:04.179Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1152,
  "geminiTimeMs": 1112,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1142,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:04.231Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:04.232Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:04.232Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "HoraReserva",
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 12,
    "HoraReserva": "13:00"
  },
  "conversationHistoryLength": 18
}
[BEFORE_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_date, Input: "A las 8:99", Processing: false
[2025-11-19T16:37:04.234Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "A las 8:99",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "A las 8:99", Processing: false
[2025-11-19T16:37:04.235Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "A las 8:99",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 12,
    "fecha": null,
    "hora": "13:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 19,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:04.235Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:04.236Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570224231,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "A las 8:99",
  "inputLength": 10,
  "context": {
    "step": "ask_date",
    "callSid": "CA_timezone_1763570213783"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"A las 8:99\""
}
[2025-11-19T16:37:04.236Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570224231,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:04.237Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570224231,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:05.278Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570224231,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 711,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": \"08:99\",\n  \"hora_disponible\": \"false\",\n  \"hora_error\": \"fuera_horario\"",
  "apiCallTimeMs": 1041,
  "reasoning": "Respuesta recibida de Gemini en 1041ms. Extrayendo JSON..."
}
[2025-11-19T16:37:05.279Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_timezone_1763570213783",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570224231,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1043,
  "apiCallTimeMs": 1041,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "08:99",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, hora 08:99, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "A las 8:99"
üîç [DEBUG] Texto en min√∫sculas: "a las 8:99"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:05.285Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": "08:99",
    "hora_confidence": "100%",
    "hora_disponible": "false",
    "hora_error": "fuera_horario",
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 12,
    "HoraReserva": "13:00"
  },
  "currentLanguage": "es",
  "originalText": "A las 8:99",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":12,\"HoraReserva\":\"13:00\"}. An√°lisis contiene: sin personas, sin fecha, hora 08:99, sin nombre"
}
[2025-11-19T16:37:05.286Z] [RESERVATION] TIME_WITH_ERROR {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hora": "08:99",
  "error": "fuera_horario"
}
[2025-11-19T16:37:05.287Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 12,
    "HoraReserva": "13:00"
  },
  "stateAfter": {
    "NumeroReserva": 12,
    "HoraReserva": "08:99"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_timezone_1763570213783, Step: ask_date, Time: 1054ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:37:05.289Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1054,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 1054ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:37:05.289Z] [INFO] STATE_PERSIST {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "HoraReserva",
    "NumeroReserva",
    "horaError"
  ],
  "dataValues": {
    "NumeroReserva": 12,
    "HoraReserva": "08:99"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les co..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:05.293Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_timezone_1763570213783",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1062,
  "geminiTimeMs": 1043,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1054,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:37:05][0m PASSED: Borde - Casos de Hora Extremos (11563ms)
[36müß™ [16:37:05][0m üî• EXTREME: Borde - Casos de Fecha Extremos
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:05.348Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:05.348Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:05.941Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: greeting, Input: "El d√≠a 32 de enero", Processing: false
[2025-11-19T16:37:05.942Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 18,
  "inputPreview": "El d√≠a 32 de enero",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "El d√≠a 32 de enero", Processing: false
[2025-11-19T16:37:05.943Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "El d√≠a 32 de enero",
  "inputLength": 18,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:05.944Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "El d√≠a 32 de enero",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:37:05.944Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "El d√≠a 32 de enero",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"El d√≠a 32 de enero\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:37:05.945Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_date_edges_1763570225347",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570225347,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "El d√≠a 32 de enero",
  "inputLength": 18,
  "context": {
    "step": "greeting",
    "callSid": "CA_date_edges_1763570225347"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"El d√≠a 32 de enero\""
}
[2025-11-19T16:37:05.946Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570225347,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:05.946Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_date_edges_1763570225347",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570225347,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8391,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8391 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:07.071Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570225347,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1124,
  "reasoning": "Respuesta recibida de Gemini en 1124ms. Extrayendo JSON..."
}
[2025-11-19T16:37:07.072Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570225347,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1127,
  "apiCallTimeMs": 1124,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:07.073Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:37:07.074Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:37:07.076Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1133
}
[AFTER_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Time: 1133ms, Response: "¬°Genial! ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:37:07.077Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1133,
  "responseMessage": "¬°Genial! ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 1133ms. Respuesta: \"¬°Genial! ¬øCu√°ntas personas van a venir?...\""
}
[2025-11-19T16:37:07.077Z] [INFO] STATE_PERSIST {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Genial! ¬øCu√°ntas personas van a venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, ¬°Genial! ¬øCu√°ntas personas van a venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:07.082Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1735,
  "geminiTimeMs": 1127,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1133,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:07.137Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:07.137Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:07.138Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Input: "El 30 de febrero", Processing: false
[2025-11-19T16:37:07.139Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 16,
  "inputPreview": "El 30 de febrero",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "El 30 de febrero", Processing: false
[2025-11-19T16:37:07.140Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "El 30 de febrero",
  "inputLength": 16,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:07.141Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570227136,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "El 30 de febrero",
  "inputLength": 16,
  "context": {
    "step": "ask_people",
    "callSid": "CA_date_edges_1763570225347"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"El 30 de febrero\""
}
[2025-11-19T16:37:07.142Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570227136,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:07.142Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570227136,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8389,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8389 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:08.129Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570227136,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 986,
  "reasoning": "Respuesta recibida de Gemini en 986ms. Extrayendo JSON..."
}
[2025-11-19T16:37:08.130Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570227136,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 989,
  "apiCallTimeMs": 986,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:08.130Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "El 30 de febrero",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:08.131Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Time: 991ms, Response: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:37:08.132Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 991,
  "responseMessage": "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 991ms. Respuesta: \"Disculpe, no he entendido bien. ¬øCu√°ntas personas ...\""
}
[2025-11-19T16:37:08.132Z] [INFO] STATE_PERSIST {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:08.136Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1000,
  "geminiTimeMs": 989,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 991,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:08.199Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:08.200Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:08.202Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Input: "El 29 de febrero de 2023", Processing: false
[2025-11-19T16:37:08.203Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 24,
  "inputPreview": "El 29 de febrero de 2023",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "El 29 de febrero de 2023", Processing: false
[2025-11-19T16:37:08.204Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "El 29 de febrero de 2023",
  "inputLength": 24,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:08.205Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570228198,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "El 29 de febrero de 2023",
  "inputLength": 24,
  "context": {
    "step": "ask_people",
    "callSid": "CA_date_edges_1763570225347"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"El 29 de febrero de 2023\""
}
[2025-11-19T16:37:08.205Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570228198,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:08.206Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570228198,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8397,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8397 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:09.178Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570228198,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2023-02-29\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"ho",
  "apiCallTimeMs": 970,
  "reasoning": "Respuesta recibida de Gemini en 970ms. Extrayendo JSON..."
}
[2025-11-19T16:37:09.178Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570228198,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 973,
  "apiCallTimeMs": 970,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2023-02-29",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, fecha 2023-02-29, sin hora, sin nombre"
}
[2025-11-19T16:37:09.179Z] [INFO] PEOPLE_EXTRACTED_REGEX2 {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 2023
}
[2025-11-19T16:37:09.179Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "2023",
    "comensales_confidence": "100%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2023-02-29",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "El 29 de febrero de 2023",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 2023 personas, fecha 2023-02-29, sin hora, sin nombre"
}
[AFTER_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Time: 978ms, Response: "Perd√≥n, el m√°ximo de personas que podemos aceptar por reserva es 20. ¬øCu√°ntas personas ser√≠an?"
[2025-11-19T16:37:09.181Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 978,
  "responseMessage": "Perd√≥n, el m√°ximo de personas que podemos aceptar por reserva es 20. ¬øCu√°ntas personas ser√≠an?",
  "reasoning": "Paso procesado en 978ms. Respuesta: \"Perd√≥n, el m√°ximo de personas que podemos aceptar ...\""
}
[2025-11-19T16:37:09.182Z] [INFO] STATE_PERSIST {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, el m√°ximo de personas que podemos aceptar ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, Perd√≥n, el m√°ximo de personas que podemos ac..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:09.185Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 987,
  "geminiTimeMs": 973,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 978,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:09.242Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:09.243Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:09.243Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Input: "El 29 de febrero de 2024", Processing: false
[2025-11-19T16:37:09.244Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 24,
  "inputPreview": "El 29 de febrero de 2024",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "El 29 de febrero de 2024", Processing: false
[2025-11-19T16:37:09.245Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "El 29 de febrero de 2024",
  "inputLength": 24,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:09.246Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570229241,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "El 29 de febrero de 2024",
  "inputLength": 24,
  "context": {
    "step": "ask_people",
    "callSid": "CA_date_edges_1763570225347"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"El 29 de febrero de 2024\""
}
[2025-11-19T16:37:09.247Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570229241,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:09.247Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570229241,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8397,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8397 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:10.324Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570229241,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2024-02-29\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"ho",
  "apiCallTimeMs": 1076,
  "reasoning": "Respuesta recibida de Gemini en 1076ms. Extrayendo JSON..."
}
[2025-11-19T16:37:10.325Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570229241,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1079,
  "apiCallTimeMs": 1076,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2024-02-29",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, fecha 2024-02-29, sin hora, sin nombre"
}
[2025-11-19T16:37:10.326Z] [INFO] PEOPLE_EXTRACTED_REGEX2 {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 2024
}
[2025-11-19T16:37:10.326Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "2024",
    "comensales_confidence": "100%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2024-02-29",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "El 29 de febrero de 2024",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 2024 personas, fecha 2024-02-29, sin hora, sin nombre"
}
[AFTER_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Time: 1082ms, Response: "El m√°ximo que podemos aceptar es 20 personas por mesa. ¬øPara cu√°ntas personas desean hacer la reserv"
[2025-11-19T16:37:10.328Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1082,
  "responseMessage": "El m√°ximo que podemos aceptar es 20 personas por mesa. ¬øPara cu√°ntas personas desean hacer la reserv",
  "reasoning": "Paso procesado en 1082ms. Respuesta: \"El m√°ximo que podemos aceptar es 20 personas por m...\""
}
[2025-11-19T16:37:10.328Z] [INFO] STATE_PERSIST {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "El m√°ximo que podemos aceptar es 20 personas por m...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, El m√°ximo que podemos aceptar es 20 personas por..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:10.332Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1090,
  "geminiTimeMs": 1079,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1082,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:10.389Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:10.389Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:10.390Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Input: "El d√≠a 0 de enero", Processing: false
[2025-11-19T16:37:10.391Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 17,
  "inputPreview": "El d√≠a 0 de enero",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "El d√≠a 0 de enero", Processing: false
[2025-11-19T16:37:10.392Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "El d√≠a 0 de enero",
  "inputLength": 17,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:10.393Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570230388,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "El d√≠a 0 de enero",
  "inputLength": 17,
  "context": {
    "step": "ask_people",
    "callSid": "CA_date_edges_1763570225347"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"El d√≠a 0 de enero\""
}
[2025-11-19T16:37:10.393Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570230388,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:10.394Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570230388,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8390,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8390 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:11.375Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570230388,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 981,
  "reasoning": "Respuesta recibida de Gemini en 981ms. Extrayendo JSON..."
}
[2025-11-19T16:37:11.376Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570230388,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 983,
  "apiCallTimeMs": 981,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:11.376Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "El d√≠a 0 de enero",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:11.377Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Time: 985ms, Response: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor."
[2025-11-19T16:37:11.378Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 985,
  "responseMessage": "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor.",
  "reasoning": "Paso procesado en 985ms. Respuesta: \"¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...\""
}
[2025-11-19T16:37:11.379Z] [INFO] STATE_PERSIST {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Aja, ¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mer..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:11.382Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 994,
  "geminiTimeMs": 983,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 985,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:11.433Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:11.433Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:11.434Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_people, Input: "El d√≠a -1 de enero", Processing: false
[2025-11-19T16:37:11.435Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 18,
  "inputPreview": "El d√≠a -1 de enero",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "El d√≠a -1 de enero", Processing: false
[2025-11-19T16:37:11.436Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "El d√≠a -1 de enero",
  "inputLength": 18,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:11.437Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570231432,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "El d√≠a -1 de enero",
  "inputLength": 18,
  "context": {
    "step": "ask_people",
    "callSid": "CA_date_edges_1763570225347"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"El d√≠a -1 de enero\""
}
[2025-11-19T16:37:11.437Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570231432,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:11.438Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570231432,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8391,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8391 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:12.457Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570231432,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1019,
  "reasoning": "Respuesta recibida de Gemini en 1019ms. Extrayendo JSON..."
}
[2025-11-19T16:37:12.458Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570231432,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1021,
  "apiCallTimeMs": 1019,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:12.458Z] [INFO] PEOPLE_EXTRACTED_ANY_NUMBER {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 1
}
[2025-11-19T16:37:12.459Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "1",
    "comensales_confidence": "90%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "El d√≠a -1 de enero",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 1 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:12.460Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 1,
  "credibilidad": "90%"
}
[2025-11-19T16:37:12.460Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:37:12.461Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1025
}
[AFTER_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_date, Time: 1025ms, Response: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:37:12.462Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1025,
  "responseMessage": "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1025ms. Respuesta: \"Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:37:12.462Z] [INFO] STATE_PERSIST {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:12.466Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1034,
  "geminiTimeMs": 1021,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1025,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:12.527Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:12.527Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:12.528Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_date, Input: "El 31 de abril", Processing: false
[2025-11-19T16:37:12.529Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 14,
  "inputPreview": "El 31 de abril",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "El 31 de abril", Processing: false
[2025-11-19T16:37:12.531Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "El 31 de abril",
  "inputLength": 14,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:12.531Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:12.532Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570232526,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "El 31 de abril",
  "inputLength": 14,
  "context": {
    "step": "ask_date",
    "callSid": "CA_date_edges_1763570225347"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"El 31 de abril\""
}
[2025-11-19T16:37:12.532Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570232526,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:12.533Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570232526,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8387,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8387 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:13.463Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570232526,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 930,
  "reasoning": "Respuesta recibida de Gemini en 930ms. Extrayendo JSON..."
}
[2025-11-19T16:37:13.464Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570232526,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 932,
  "apiCallTimeMs": 930,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "El 31 de abril"
üîç [DEBUG] Texto en min√∫sculas: "el 31 de abril"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:13.471Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "El 31 de abril",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:13.471Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_date, Time: 942ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:37:13.473Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 942,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 942ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:37:13.474Z] [INFO] STATE_PERSIST {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:13.478Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 952,
  "geminiTimeMs": 932,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 942,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:13.534Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:13.535Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:13.536Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_date, Input: "El 31 de junio", Processing: false
[2025-11-19T16:37:13.537Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 14,
  "inputPreview": "El 31 de junio",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "El 31 de junio", Processing: false
[2025-11-19T16:37:13.538Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "El 31 de junio",
  "inputLength": 14,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:13.538Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:13.539Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570233534,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "El 31 de junio",
  "inputLength": 14,
  "context": {
    "step": "ask_date",
    "callSid": "CA_date_edges_1763570225347"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"El 31 de junio\""
}
[2025-11-19T16:37:13.540Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570233534,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:13.540Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570233534,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8387,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8387 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:14.632Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570233534,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1091,
  "reasoning": "Respuesta recibida de Gemini en 1091ms. Extrayendo JSON..."
}
[2025-11-19T16:37:14.651Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570233534,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1112,
  "apiCallTimeMs": 1091,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "El 31 de junio"
üîç [DEBUG] Texto en min√∫sculas: "el 31 de junio"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:14.658Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "El 31 de junio",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:14.658Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_date, Time: 1123ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:37:14.660Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1123,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 1123ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:37:14.661Z] [INFO] STATE_PERSIST {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefi..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:14.664Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1130,
  "geminiTimeMs": 1112,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1123,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:14.732Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:14.733Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:14.734Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_date, Input: "El 32 de diciembre", Processing: false
[2025-11-19T16:37:14.735Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 18,
  "inputPreview": "El 32 de diciembre",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "El 32 de diciembre", Processing: false
[2025-11-19T16:37:14.736Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "El 32 de diciembre",
  "inputLength": 18,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:14.736Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:14.737Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570234732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "El 32 de diciembre",
  "inputLength": 18,
  "context": {
    "step": "ask_date",
    "callSid": "CA_date_edges_1763570225347"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"El 32 de diciembre\""
}
[2025-11-19T16:37:14.738Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570234732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:14.738Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570234732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8391,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8391 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:15.862Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570234732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1123,
  "reasoning": "Respuesta recibida de Gemini en 1123ms. Extrayendo JSON..."
}
[2025-11-19T16:37:15.863Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_date_edges_1763570225347",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570234732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1126,
  "apiCallTimeMs": 1123,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "El 32 de diciembre"
üîç [DEBUG] Texto en min√∫sculas: "el 32 de diciembre"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:15.869Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "El 32 de diciembre",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:15.870Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_date_edges_1763570225347, Step: ask_date, Time: 1135ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:37:15.871Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1135,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 1135ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:37:15.872Z] [INFO] STATE_PERSIST {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:15.876Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_date_edges_1763570225347",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1144,
  "geminiTimeMs": 1126,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1135,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:37:15][0m PASSED: Borde - Casos de Fecha Extremos (10594ms)
[35müìã [16:37:15][0m GRUPO 7: Casos de Flujo Complejo
[36müß™ [16:37:15][0m üî• EXTREME: Complejo - Reserva ‚Üí Modificar ‚Üí Cancelar
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:15.944Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:15.945Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:16.518Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: greeting, Input: "Quiero hacer una reserva", Processing: false
[2025-11-19T16:37:16.519Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 24,
  "inputPreview": "Quiero hacer una reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Quiero hacer una reserva", Processing: false
[2025-11-19T16:37:16.521Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Quiero hacer una reserva",
  "inputLength": 24,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:16.521Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Quiero hacer una reserva",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:37:16.522Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Quiero hacer una reserva",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Quiero hacer una reserva\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:37:16.522Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570235944,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Quiero hacer una reserva",
  "inputLength": 24,
  "context": {
    "step": "greeting",
    "callSid": "CA_res_mod_cancel_1763570235944"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Quiero hacer una reserva\""
}
[2025-11-19T16:37:16.523Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570235944,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:16.524Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570235944,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8397,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8397 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:17.465Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570235944,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 941,
  "reasoning": "Respuesta recibida de Gemini en 941ms. Extrayendo JSON..."
}
[2025-11-19T16:37:17.466Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570235944,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 944,
  "apiCallTimeMs": 941,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:17.467Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:37:17.467Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:37:17.470Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 950
}
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: ask_people, Time: 950ms, Response: "¬°Genial! ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:37:17.471Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 950,
  "responseMessage": "¬°Genial! ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 950ms. Respuesta: \"¬°Genial! ¬øCu√°ntas personas van a venir?...\""
}
[2025-11-19T16:37:17.472Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Genial! ¬øCu√°ntas personas van a venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, ¬°Genial! ¬øCu√°ntas personas van a venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:17.475Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1531,
  "geminiTimeMs": 944,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 950,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:17.530Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:17.531Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:17.532Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: ask_people, Input: "Para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:37:17.533Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 30,
  "inputPreview": "Para 4 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Para 4 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:37:17.534Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Para 4 personas ma√±ana a las 8",
  "inputLength": 30,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:17.534Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570237530,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Para 4 personas ma√±ana a las 8",
  "inputLength": 30,
  "context": {
    "step": "ask_people",
    "callSid": "CA_res_mod_cancel_1763570235944"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Para 4 personas ma√±ana a las 8\""
}
[2025-11-19T16:37:17.535Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570237530,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:17.536Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570237530,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8403,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8403 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:18.629Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570237530,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1093,
  "reasoning": "Respuesta recibida de Gemini en 1093ms. Extrayendo JSON..."
}
[2025-11-19T16:37:18.630Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570237530,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1096,
  "apiCallTimeMs": 1093,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:37:18.630Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Para 4 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:37:18.631Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:37:18.631Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:37:18.632Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:37:18.633Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:37:18.633Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1100
}
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: ask_name, Time: 1100ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:37:18.634Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1100,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1100ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:37:18.635Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 4 personas, el d√≠a 20 de noviembre, a la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:18.639Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1109,
  "geminiTimeMs": 1096,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1100,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:18.692Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:18.692Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:18.693Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: ask_name, Input: "Juan P√©rez", Processing: false
[2025-11-19T16:37:18.694Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "Juan P√©rez",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Juan P√©rez", Processing: false
[2025-11-19T16:37:18.695Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Juan P√©rez",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:18.696Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:37:18.696Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570238691,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan P√©rez",
  "inputLength": 10,
  "context": {
    "step": "ask_name",
    "callSid": "CA_res_mod_cancel_1763570235944"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan P√©rez\""
}
[2025-11-19T16:37:18.697Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570238691,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:18.697Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570238691,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:19.780Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570238691,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1082,
  "reasoning": "Respuesta recibida de Gemini en 1082ms. Extrayendo JSON..."
}
[2025-11-19T16:37:19.781Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570238691,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1085,
  "apiCallTimeMs": 1082,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan P√©rez",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan P√©rez"
}
[2025-11-19T16:37:19.781Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "extractedValue": "Juan P√©rez",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (Juan P√©rez). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:37:19.782Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan P√©rez",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "currentLanguage": "es",
  "originalText": "Juan P√©rez",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan P√©rez"
}
[2025-11-19T16:37:19.782Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "nombre": "Juan P√©rez",
  "credibilidad": "100%"
}
[2025-11-19T16:37:19.783Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
‚úÖ Usando mensajes en es para tipo name
[2025-11-19T16:37:19.784Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "ask_name",
  "to": "confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1090
}
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: confirm, Time: 1090ms, Response: "Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 08:00, a nombre de Juan P√©r"
[2025-11-19T16:37:19.786Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 1090,
  "responseMessage": "Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a 20 de noviembre a las 08:00, a nombre de Juan P√©r",
  "reasoning": "Paso procesado en 1090ms. Respuesta: \"Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a...\""
}
[2025-11-19T16:37:19.786Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, Muy bien, Juan P√©rez. Perfecto, 4 personas, el d√≠a 20 ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:37:20.300Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 1609,
  "geminiTimeMs": 1085,
  "stateSaveTimeMs": 510,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1090,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:20.359Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:20.360Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:20.360Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: confirm, Input: "666123456", Processing: false
[2025-11-19T16:37:20.361Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "666123456", Processing: false
[2025-11-19T16:37:20.363Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "666123456",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": "Juan P√©rez",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "666123456"
üîç [DEBUG] Texto en min√∫sculas: "666123456"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: confirm, Time: 9ms, Response: "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi"
[2025-11-19T16:37:20.372Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 9,
  "responseMessage": "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"¬øEs correcto? Puede decir s√≠ para confirmar, no pa...\""
}
[2025-11-19T16:37:20.373Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øEs correcto? Puede decir s√≠ para confirmar, no pa...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:20.891Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 533,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 514,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:20.944Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:20.944Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:20.945Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: confirm, Input: "Confirmar", Processing: false
[2025-11-19T16:37:20.946Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "Confirmar",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "Confirmar", Processing: false
[2025-11-19T16:37:20.947Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "Confirmar",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": "Juan P√©rez",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:20.948Z] [INFO] ‚úÖ CRITICAL_CONFIRMATION_DETECTED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "action": "confirm",
  "reasoning": "Confirmaci√≥n v√°lida detectada. Saltando verificaci√≥n de cancelaci√≥n."
}
[2025-11-19T16:37:20.949Z] [INFO] üîç CHECKING_AVAILABILITY_BEFORE_CONFIRM {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 4,
  "fecha": "2025-11-20",
  "hora": "08:00",
  "reasoning": "Usuario confirm√≥ la reserva. Verificando disponibilidad antes de finalizar..."
}
[2025-11-19T16:37:20.950Z] [CAPACITY] üîç AVAILABILITY_CHECK_START {
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 4,
  "cacheKey": "2025-11-20 08:00:00:4",
  "reasoning": "Iniciando verificaci√≥n de disponibilidad para 4 personas el 2025-11-20 08:00:00"
}
[2025-11-19T16:37:20.950Z] [CAPACITY] üîÑ AVAILABILITY_CHECKING_DB {
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 4,
  "reasoning": "No hay resultado en cache. Consultando base de datos para verificar disponibilidad..."
}
[2025-11-19T16:37:21.523Z] [CAPACITY] Verificando disponibilidad {
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 4,
  "personasOcupadas": 0,
  "capacidadMaxima": 100,
  "capacidadDisponible": 100,
  "capacidadConBuffer": 90
}
[2025-11-19T16:37:21.524Z] [CAPACITY] ‚úÖ AVAILABILITY_CHECKED {
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 4,
  "disponible": true,
  "capacidadDisponible": null,
  "capacidadTotal": null,
  "reservasExistentes": null,
  "timeMs": 574,
  "reasoning": "Verificaci√≥n completada en 574ms. Disponible: true. Capacidad disponible: N/A"
}
‚úÖ Usando mensajes en es para tipo confirm
[2025-11-19T16:37:21.525Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "confirm",
  "to": "complete",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 578
}
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: complete, Time: 578ms, Response: "¬°Vale! Reserva confirmada. Estaremos encantados de recibirles. ¬°Que disfruten el d√≠a!"
[2025-11-19T16:37:21.526Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "processStepTimeMs": 578,
  "responseMessage": "¬°Vale! Reserva confirmada. Estaremos encantados de recibirles. ¬°Que disfruten el d√≠a!",
  "reasoning": "Paso procesado en 578ms. Respuesta: \"¬°Vale! Reserva confirmada. Estaremos encantados de...\""
}
[2025-11-19T16:37:21.527Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez"
  }
}
[2025-11-19T16:37:22.043Z] [RESERVATION] Guardando reserva en base de datos... {
  "data": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez",
    "TelefonReserva": "+34600123456"
  }
}
[2025-11-19T16:37:22.044Z] [RESERVATION] üîç VALIDATION_START {
  "data": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n de datos de la reserva antes de guardar en base de datos"
}
[2025-11-19T16:37:22.045Z] [RESERVATION] ‚úÖ BASIC_VALIDATION_PASSED {
  "data": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Validaci√≥n b√°sica pas√≥. Procediendo con validaci√≥n completa..."
}
[2025-11-19T16:37:22.045Z] [RESERVATION] üîç FULL_VALIDATION_START {
  "data": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan P√©rez",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n completa (horarios, antelaci√≥n, disponibilidad, etc.)"
}
[2025-11-19T16:37:22.047Z] [RESERVATION] ‚úÖ FULL_VALIDATION_COMPLETED {
  "validationTimeMs": 3,
  "errores": [
    "El restaurante est√° abierto de 13:00 a 23:00"
  ],
  "advertencias": [],
  "reasoning": "Validaci√≥n completa completada en 3ms. V√°lida: undefined"
}
[2025-11-19T16:37:22.048Z] [INFO] RESERVATION_SAVE_COMPLETED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "saved": false,
  "timeMs": 5
}
[2025-11-19T16:37:22.636Z] [INFO] RESERVATION_COMPLETED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete"
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Vale! Reserva confirmada. Estaremos encantados de...", UseAlgieba: true, NaturalFlow: true, Step: complete
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬°Vale! Reserva confirmada. Estaremos encantados de recibirle..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
[2025-11-19T16:37:22.640Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "totalTimeMs": 1696,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 514,
  "availabilityTimeMs": 574,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 578,
  "saveReservationTimeMs": 5,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:22.695Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:22.696Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:23.276Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: greeting, Input: "Espera, quiero modificar la reserva", Processing: false
[2025-11-19T16:37:23.277Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 35,
  "inputPreview": "Espera, quiero modificar la reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Espera, quiero modificar la reserva", Processing: false
[2025-11-19T16:37:23.278Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Espera, quiero modificar la reserva",
  "inputLength": 35,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:23.279Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Espera, quiero modificar la reserva",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:37:23.279Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Espera, quiero modificar la reserva",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Espera, quiero modificar la reserva\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:37:23.280Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570242694,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Espera, quiero modificar la reserva",
  "inputLength": 35,
  "context": {
    "step": "greeting",
    "callSid": "CA_res_mod_cancel_1763570235944"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Espera, quiero modificar la reserva\""
}
[2025-11-19T16:37:23.280Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570242694,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:23.281Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570242694,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8408,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8408 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:24.191Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570242694,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 691,
  "responsePreview": "```json\n{\n  \"intencion\": \"modify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcenta",
  "apiCallTimeMs": 909,
  "reasoning": "Respuesta recibida de Gemini en 909ms. Extrayendo JSON..."
}
[2025-11-19T16:37:24.192Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570242694,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 912,
  "apiCallTimeMs": 909,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "modify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: modify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:24.192Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "modify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: modify, Idioma: es. Procesando..."
}
[2025-11-19T16:37:24.193Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "modify",
  "reasoning": "Intenci√≥n detectada: modify. Procesando como modificaci√≥n..."
}
[2025-11-19T16:37:24.193Z] [INFO] MODIFICATION_INTENT_AT_GREETING {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting"
}
‚úèÔ∏è [MODIFICACI√ìN] Iniciando proceso de modificaci√≥n de reserva existente
‚úèÔ∏è [DEBUG] Input del usuario: "Espera, quiero modificar la reserva"
‚úèÔ∏è [DEBUG] Estado actual: step=greeting, language=es
‚úèÔ∏è [DEBUG] Usando tel√©fono de la llamada: +34600123456
üîç [DEBUG] Buscando reservas para el tel√©fono: "+34600123456" (versi√≥n actualizada)
üîç [DEBUG] Tipo de dato del tel√©fono: string
üîç [DEBUG] Longitud del tel√©fono: 12
üîç [DEBUG] Tel√©fono normalizado (solo d√≠gitos): "34600123456"
üîç [DEBUG] Patr√≥n de b√∫squeda 1 (completo): "%34600123456%"
üîç [DEBUG] Patr√≥n de b√∫squeda 2 (√∫ltimos 8 d√≠gitos): "%00123456%"
üîç [DEBUG] Ejecutando consulta SQL: 
          SELECT id_reserva, data_reserva, num_persones, nom_persona_reserva, observacions, telefon
          FROM RESERVA 
          WHERE (telefon LIKE ? OR telefon LIKE ?)
          AND data_reserva >= NOW() 
          AND observacions NOT LIKE '%CANCELADA%'
          ORDER BY data_reserva ASC
        
üîç [DEBUG] Par√°metros: [ '%34600123456%', '%00123456%' ]
üìã [DEBUG] Resultado de la consulta: []
üìã [DEBUG] N√∫mero de filas encontradas: 0
üîç [DEBUG] TODAS las reservas (incluyendo pasadas): [
  {
    id_reserva: 18,
    data_reserva: 2025-10-09T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 19,
    data_reserva: 2025-10-10T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 98678,
    data_reserva: 2025-11-19T19:00:00.000Z,
    num_persones: 6,
    nom_persona_reserva: 'gerard',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959466,
    data_reserva: 2025-11-11T09:39:49.000Z,
    num_persones: 5,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959467,
    data_reserva: 2025-11-13T11:46:20.000Z,
    num_persones: 6,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959490,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959491,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  }
]
‚úÖ Usando mensajes en es para tipo modify_no_reservations
[2025-11-19T16:37:25.072Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "greeting",
  "to": "modify_no_reservations",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1795
}
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Time: 1795ms, Response: "No encontr√© reservas con ese tel√©fono. ¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:37:25.074Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "processStepTimeMs": 1795,
  "responseMessage": "No encontr√© reservas con ese tel√©fono. ¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 1795ms. Respuesta: \"No encontr√© reservas con ese tel√©fono. ¬øQuiere hac...\""
}
[2025-11-19T16:37:25.074Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No encontr√© reservas con ese tel√©fono. ¬øQuiere hac...", UseAlgieba: true, NaturalFlow: true, Step: modify_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "No encontr√© reservas con ese tel√©fono. ¬øQuiere hacer una nue..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:25.077Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "totalTimeMs": 2383,
  "geminiTimeMs": 912,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1795,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:25.132Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:25.133Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:25.134Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Input: "666123456", Processing: false
[2025-11-19T16:37:25.135Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: modify_no_reservations, Input: "666123456", Processing: false
[2025-11-19T16:37:25.136Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "currentStep": "modify_no_reservations",
  "userInput": "666123456",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "666123456"
üîç [DEBUG] Texto en min√∫sculas: "666123456"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [MODIFICACI√ìN] No hay reservas para modificar
‚úÖ Usando mensajes en es para tipo modify_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Time: 10ms, Response: "¬øLe gustar√≠a hacer una reserva?"
[2025-11-19T16:37:25.145Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "processStepTimeMs": 10,
  "responseMessage": "¬øLe gustar√≠a hacer una reserva?",
  "reasoning": "Paso procesado en 10ms. Respuesta: \"¬øLe gustar√≠a hacer una reserva?...\""
}
[2025-11-19T16:37:25.146Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øLe gustar√≠a hacer una reserva?...", UseAlgieba: true, NaturalFlow: true, Step: modify_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, ¬øLe gustar√≠a hacer una reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:25.151Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "totalTimeMs": 20,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 10,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:25.210Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:25.211Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:25.212Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Input: "Cambiar la hora", Processing: false
[2025-11-19T16:37:25.213Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasInput": true,
  "inputLength": 15,
  "inputPreview": "Cambiar la hora",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: modify_no_reservations, Input: "Cambiar la hora", Processing: false
[2025-11-19T16:37:25.214Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "currentStep": "modify_no_reservations",
  "userInput": "Cambiar la hora",
  "inputLength": 15,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Cambiar la hora"
üîç [DEBUG] Texto en min√∫sculas: "cambiar la hora"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [MODIFICACI√ìN] No hay reservas para modificar
‚úÖ Usando mensajes en es para tipo modify_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Time: 10ms, Response: "¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:37:25.223Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "processStepTimeMs": 10,
  "responseMessage": "¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 10ms. Respuesta: \"¬øQuiere hacer una nueva reserva?...\""
}
[2025-11-19T16:37:25.224Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øQuiere hacer una nueva reserva?...", UseAlgieba: true, NaturalFlow: true, Step: modify_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, ¬øQuiere hacer una nueva reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:25.227Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "totalTimeMs": 17,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 10,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:25.289Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:25.290Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:25.307Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Input: "A las 9", Processing: false
[2025-11-19T16:37:25.308Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "A las 9",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: modify_no_reservations, Input: "A las 9", Processing: false
[2025-11-19T16:37:25.309Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "currentStep": "modify_no_reservations",
  "userInput": "A las 9",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "A las 9"
üîç [DEBUG] Texto en min√∫sculas: "a las 9"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [MODIFICACI√ìN] No hay reservas para modificar
‚úÖ Usando mensajes en es para tipo modify_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Time: 8ms, Response: "¬øLe gustar√≠a hacer una nueva reserva en su lugar?"
[2025-11-19T16:37:25.318Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "processStepTimeMs": 8,
  "responseMessage": "¬øLe gustar√≠a hacer una nueva reserva en su lugar?",
  "reasoning": "Paso procesado en 8ms. Respuesta: \"¬øLe gustar√≠a hacer una nueva reserva en su lugar?...\""
}
[2025-11-19T16:37:25.318Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øLe gustar√≠a hacer una nueva reserva en su lugar?...", UseAlgieba: true, NaturalFlow: true, Step: modify_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Aja, ¬øLe gustar√≠a hacer una nueva reserva en su lugar?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:25.322Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "totalTimeMs": 34,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 8,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:25.379Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:25.379Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:25.380Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Input: "Confirmar", Processing: false
[2025-11-19T16:37:25.381Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "Confirmar",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: modify_no_reservations, Input: "Confirmar", Processing: false
[2025-11-19T16:37:25.382Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "currentStep": "modify_no_reservations",
  "userInput": "Confirmar",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Confirmar"
üîç [DEBUG] Texto en min√∫sculas: "confirmar"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [MODIFICACI√ìN] No hay reservas para modificar
‚úÖ Usando mensajes en es para tipo modify_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Time: 8ms, Response: "¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:37:25.391Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "processStepTimeMs": 8,
  "responseMessage": "¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 8ms. Respuesta: \"¬øQuiere hacer una nueva reserva?...\""
}
[2025-11-19T16:37:25.391Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øQuiere hacer una nueva reserva?...", UseAlgieba: true, NaturalFlow: true, Step: modify_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, ¬øQuiere hacer una nueva reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:25.396Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "totalTimeMs": 18,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 8,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:25.456Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:25.457Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:25.457Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: modify_no_reservations, Input: "Mejor cancelo la reserva", Processing: false
[2025-11-19T16:37:25.459Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "hasInput": true,
  "inputLength": 24,
  "inputPreview": "Mejor cancelo la reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: modify_no_reservations, Input: "Mejor cancelo la reserva", Processing: false
[2025-11-19T16:37:25.460Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "currentStep": "modify_no_reservations",
  "userInput": "Mejor cancelo la reserva",
  "inputLength": 24,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Mejor cancelo la reserva"
üîç [DEBUG] Texto en min√∫sculas: "mejor cancelo la reserva"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: true
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: true
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: true
üîç [DEBUG] Resultado final isCancellationRequest: true
üîç [DEBUG] - Palabras: true
üîç [DEBUG] - Patrones simples: true
üîç [DEBUG] - Patrones complejos: true
[2025-11-19T16:37:25.467Z] [INFO] üö´ CANCELLATION_REQUEST_DETECTED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "userInput": "Mejor cancelo la reserva",
  "currentStep": "modify_no_reservations",
  "reasoning": "El usuario expres√≥ intenci√≥n de cancelar. Input: \"Mejor cancelo la reserva\""
}
[2025-11-19T16:37:25.467Z] [INFO] üö´ STARTING_CANCELLATION_PROCESS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "reasoning": "Iniciando proceso de cancelaci√≥n de reserva."
}
üö´ [CANCELACI√ìN] Iniciando proceso de cancelaci√≥n de reserva existente
üö´ [DEBUG] Usando tel√©fono de la llamada: +34600123456
üîç [DEBUG] Buscando reservas para el tel√©fono: "+34600123456" (versi√≥n actualizada)
üîç [DEBUG] Tipo de dato del tel√©fono: string
üîç [DEBUG] Longitud del tel√©fono: 12
üîç [DEBUG] Tel√©fono normalizado (solo d√≠gitos): "34600123456"
üîç [DEBUG] Patr√≥n de b√∫squeda 1 (completo): "%34600123456%"
üîç [DEBUG] Patr√≥n de b√∫squeda 2 (√∫ltimos 8 d√≠gitos): "%00123456%"
üîç [DEBUG] Ejecutando consulta SQL: 
          SELECT id_reserva, data_reserva, num_persones, nom_persona_reserva, observacions, telefon
          FROM RESERVA 
          WHERE (telefon LIKE ? OR telefon LIKE ?)
          AND data_reserva >= NOW() 
          AND observacions NOT LIKE '%CANCELADA%'
          ORDER BY data_reserva ASC
        
üîç [DEBUG] Par√°metros: [ '%34600123456%', '%00123456%' ]
üìã [DEBUG] Resultado de la consulta: []
üìã [DEBUG] N√∫mero de filas encontradas: 0
üîç [DEBUG] TODAS las reservas (incluyendo pasadas): [
  {
    id_reserva: 18,
    data_reserva: 2025-10-09T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 19,
    data_reserva: 2025-10-10T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 98678,
    data_reserva: 2025-11-19T19:00:00.000Z,
    num_persones: 6,
    nom_persona_reserva: 'gerard',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959466,
    data_reserva: 2025-11-11T09:39:49.000Z,
    num_persones: 5,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959467,
    data_reserva: 2025-11-13T11:46:20.000Z,
    num_persones: 6,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959490,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959491,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  }
]
‚úÖ Usando mensajes en es para tipo cancel_no_reservations
[2025-11-19T16:37:26.280Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "modify_no_reservations",
  "to": "cancel_no_reservations",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "modify_no_reservations",
  "processStepTimeMs": 821
}
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: cancel_no_reservations, Time: 821ms, Response: "No he encontrado ninguna reserva activa con ese n√∫mero. ¬øLe gustar√≠a hacer una nueva reserva?"
[2025-11-19T16:37:26.281Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 821,
  "responseMessage": "No he encontrado ninguna reserva activa con ese n√∫mero. ¬øLe gustar√≠a hacer una nueva reserva?",
  "reasoning": "Paso procesado en 821ms. Respuesta: \"No he encontrado ninguna reserva activa con ese n√∫...\""
}
[2025-11-19T16:37:26.281Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he encontrado ninguna reserva activa con ese n√∫...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, No he encontrado ninguna reserva activa con ese n√∫mero..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:26.285Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 830,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 821,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:26.349Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:26.350Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:26.350Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: cancel_no_reservations, Input: "666123456", Processing: false
[2025-11-19T16:37:26.351Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "666123456", Processing: false
[2025-11-19T16:37:26.353Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "666123456",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "666123456"
üîç [DEBUG] Texto en min√∫sculas: "666123456"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [CANCELACI√ìN] No hay reservas - ofreciendo nueva reserva
‚úÖ Usando mensajes en es para tipo cancel_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: cancel_no_reservations, Time: 9ms, Response: "¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:37:26.362Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 9,
  "responseMessage": "¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"¬øQuiere hacer una nueva reserva?...\""
}
[2025-11-19T16:37:26.364Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øQuiere hacer una nueva reserva?...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, ¬øQuiere hacer una nueva reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:26.367Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 19,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:26.426Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:26.427Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:26.427Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: cancel_no_reservations, Input: "La primera", Processing: false
[2025-11-19T16:37:26.428Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "La primera",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "La primera", Processing: false
[2025-11-19T16:37:26.430Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "La primera",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "La primera"
üîç [DEBUG] Texto en min√∫sculas: "la primera"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚ùå [CANCELACI√ìN] No hay reservas - ofreciendo nueva reserva
‚úÖ Usando mensajes en es para tipo cancel_offer_new
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: cancel_no_reservations, Time: 9ms, Response: "¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:37:26.440Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 9,
  "responseMessage": "¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"¬øQuiere hacer una nueva reserva?...\""
}
[2025-11-19T16:37:26.441Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øQuiere hacer una nueva reserva?...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øQuiere hacer una nueva reserva?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:26.445Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 20,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:26.506Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:26.507Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:26.507Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: cancel_no_reservations, Input: "S√≠, cancelar", Processing: false
[2025-11-19T16:37:26.508Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "hasInput": true,
  "inputLength": 12,
  "inputPreview": "S√≠, cancelar",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: cancel_no_reservations, Input: "S√≠, cancelar", Processing: false
[2025-11-19T16:37:26.509Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "currentStep": "cancel_no_reservations",
  "userInput": "S√≠, cancelar",
  "inputLength": 12,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "S√≠, cancelar"
üîç [DEBUG] Texto en min√∫sculas: "s√≠, cancelar"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: true
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: true
üîç [DEBUG] - Palabras: true
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:26.517Z] [INFO] üö´ CANCELLATION_REQUEST_DETECTED {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "userInput": "S√≠, cancelar",
  "currentStep": "cancel_no_reservations",
  "reasoning": "El usuario expres√≥ intenci√≥n de cancelar. Input: \"S√≠, cancelar\""
}
[2025-11-19T16:37:26.518Z] [INFO] üö´ STARTING_CANCELLATION_PROCESS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "reasoning": "Iniciando proceso de cancelaci√≥n de reserva."
}
üö´ [CANCELACI√ìN] Iniciando proceso de cancelaci√≥n de reserva existente
üö´ [DEBUG] Usando tel√©fono de la llamada: +34600123456
üîç [DEBUG] Buscando reservas para el tel√©fono: "+34600123456" (versi√≥n actualizada)
üîç [DEBUG] Tipo de dato del tel√©fono: string
üîç [DEBUG] Longitud del tel√©fono: 12
üîç [DEBUG] Tel√©fono normalizado (solo d√≠gitos): "34600123456"
üîç [DEBUG] Patr√≥n de b√∫squeda 1 (completo): "%34600123456%"
üîç [DEBUG] Patr√≥n de b√∫squeda 2 (√∫ltimos 8 d√≠gitos): "%00123456%"
üîç [DEBUG] Ejecutando consulta SQL: 
          SELECT id_reserva, data_reserva, num_persones, nom_persona_reserva, observacions, telefon
          FROM RESERVA 
          WHERE (telefon LIKE ? OR telefon LIKE ?)
          AND data_reserva >= NOW() 
          AND observacions NOT LIKE '%CANCELADA%'
          ORDER BY data_reserva ASC
        
üîç [DEBUG] Par√°metros: [ '%34600123456%', '%00123456%' ]
üìã [DEBUG] Resultado de la consulta: []
üìã [DEBUG] N√∫mero de filas encontradas: 0
üîç [DEBUG] TODAS las reservas (incluyendo pasadas): [
  {
    id_reserva: 18,
    data_reserva: 2025-10-09T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 19,
    data_reserva: 2025-10-10T18:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: 'Reserva realizada por tel√©fono (Twilio)',
    telefon: '+34600123456'
  },
  {
    id_reserva: 98678,
    data_reserva: 2025-11-19T19:00:00.000Z,
    num_persones: 6,
    nom_persona_reserva: 'gerard',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959466,
    data_reserva: 2025-11-11T09:39:49.000Z,
    num_persones: 5,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959467,
    data_reserva: 2025-11-13T11:46:20.000Z,
    num_persones: 6,
    nom_persona_reserva: 'Juan Garc√≠a',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959490,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  },
  {
    id_reserva: 959491,
    data_reserva: 2025-11-20T19:00:00.000Z,
    num_persones: 4,
    nom_persona_reserva: 'Juan P√©rez',
    observacions: null,
    telefon: '+34600123456'
  }
]
‚úÖ Usando mensajes en es para tipo cancel_no_reservations
[AFTER_PROCESS_STEP] CallSid: CA_res_mod_cancel_1763570235944, Step: cancel_no_reservations, Time: 809ms, Response: "No hay reservas registradas para ese n√∫mero. ¬øQuiere hacer una nueva reserva?"
[2025-11-19T16:37:27.318Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "processStepTimeMs": 809,
  "responseMessage": "No hay reservas registradas para ese n√∫mero. ¬øQuiere hacer una nueva reserva?",
  "reasoning": "Paso procesado en 809ms. Respuesta: \"No hay reservas registradas para ese n√∫mero. ¬øQuie...\""
}
[2025-11-19T16:37:27.319Z] [INFO] STATE_PERSIST {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No hay reservas registradas para ese n√∫mero. ¬øQuie...", UseAlgieba: true, NaturalFlow: true, Step: cancel_no_reservations
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, No hay reservas registradas para ese n√∫mero. ¬øQu..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:27.323Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_res_mod_cancel_1763570235944",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "cancel_no_reservations",
  "totalTimeMs": 818,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 809,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:37:27][0m PASSED: Complejo - Reserva ‚Üí Modificar ‚Üí Cancelar (11429ms)
[36müß™ [16:37:27][0m üî• EXTREME: Complejo - Pedido ‚Üí Reserva
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:27.376Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:27.376Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:27.976Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: greeting, Input: "Quiero hacer un pedido", Processing: false
[2025-11-19T16:37:27.977Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 22,
  "inputPreview": "Quiero hacer un pedido",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Quiero hacer un pedido", Processing: false
[2025-11-19T16:37:27.978Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Quiero hacer un pedido",
  "inputLength": 22,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:27.979Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Quiero hacer un pedido",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:37:27.980Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Quiero hacer un pedido",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Quiero hacer un pedido\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:37:27.980Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_order_res_1763570247375",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570247375,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Quiero hacer un pedido",
  "inputLength": 22,
  "context": {
    "step": "greeting",
    "callSid": "CA_order_res_1763570247375"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Quiero hacer un pedido\""
}
[2025-11-19T16:37:27.981Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_order_res_1763570247375",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570247375,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:27.981Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_order_res_1763570247375",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570247375,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8395,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8395 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:29.062Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_order_res_1763570247375",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570247375,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 690,
  "responsePreview": "```json\n{\n  \"intencion\": \"order\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcentaj",
  "apiCallTimeMs": 1080,
  "reasoning": "Respuesta recibida de Gemini en 1080ms. Extrayendo JSON..."
}
[2025-11-19T16:37:29.063Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_order_res_1763570247375",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570247375,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1083,
  "apiCallTimeMs": 1080,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "order",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: order, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:29.064Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "order",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: order, Idioma: es. Procesando..."
}
[2025-11-19T16:37:29.065Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "order",
  "reasoning": "Intenci√≥n detectada: order. Procesando como pedido..."
}
[2025-11-19T16:37:29.065Z] [INFO] ORDER_INTENT_AT_GREETING {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting"
}
[2025-11-19T16:37:29.066Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "greeting",
  "to": "order_collect_items",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1088
}
[AFTER_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_collect_items, Time: 1088ms, Response: "Claro, dime qu√© te gustar√≠a pedir. Algunos platos disponibles son: Brownie de Chocolate, Ensalada C√©"
[2025-11-19T16:37:29.067Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_collect_items",
  "processStepTimeMs": 1088,
  "responseMessage": "Claro, dime qu√© te gustar√≠a pedir. Algunos platos disponibles son: Brownie de Chocolate, Ensalada C√©",
  "reasoning": "Paso procesado en 1088ms. Respuesta: \"Claro, dime qu√© te gustar√≠a pedir. Algunos platos ...\""
}
[2025-11-19T16:37:29.068Z] [INFO] STATE_PERSIST {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_collect_items",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Claro, dime qu√© te gustar√≠a pedir. Algunos platos ...", UseAlgieba: true, NaturalFlow: true, Step: order_collect_items
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, dime qu√© te gustar√≠a pedir. Algunos platos disponible..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:37:29.577Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_collect_items",
  "totalTimeMs": 2202,
  "geminiTimeMs": 1083,
  "stateSaveTimeMs": 505,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1088,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:29.636Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:29.636Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:29.637Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_collect_items",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_collect_items, Input: "Dos pizzas", Processing: false
[2025-11-19T16:37:29.638Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_collect_items",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "Dos pizzas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: order_collect_items, Input: "Dos pizzas", Processing: false
[2025-11-19T16:37:29.639Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_collect_items",
  "currentStep": "order_collect_items",
  "userInput": "Dos pizzas",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Dos pizzas"
üîç [DEBUG] Texto en min√∫sculas: "dos pizzas"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:29.648Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_collect_items",
  "performanceMetrics": {
    "requestStart": 1763570249635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Dos pizzas",
  "inputLength": 10,
  "context": {
    "step": "order_collect_items",
    "callSid": "CA_order_res_1763570247375"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Dos pizzas\""
}
[2025-11-19T16:37:29.649Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_collect_items",
  "performanceMetrics": {
    "requestStart": 1763570249635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:29.650Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_collect_items",
  "performanceMetrics": {
    "requestStart": 1763570249635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:30.792Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_collect_items",
  "performanceMetrics": {
    "requestStart": 1763570249635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 817,
  "responsePreview": "```json\n{\n  \"intencion\": \"order\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcentaj",
  "apiCallTimeMs": 1142,
  "reasoning": "Respuesta recibida de Gemini en 1142ms. Extrayendo JSON..."
}
[2025-11-19T16:37:30.792Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_collect_items",
  "performanceMetrics": {
    "requestStart": 1763570249635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1144,
  "apiCallTimeMs": 1142,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "order",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 1
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: order, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:30.794Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "order_collect_items",
  "to": "order_ask_address",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_collect_items",
  "processStepTimeMs": 1156
}
[AFTER_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_ask_address, Time: 1156ms, Response: "Vale, de momento tengo: 2 Pizza Margarita - 20 con 40 euros. ¬øCu√°l es la direcci√≥n de entrega?"
[2025-11-19T16:37:30.795Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "processStepTimeMs": 1156,
  "responseMessage": "Vale, de momento tengo: 2 Pizza Margarita - 20 con 40 euros. ¬øCu√°l es la direcci√≥n de entrega?",
  "reasoning": "Paso procesado en 1156ms. Respuesta: \"Vale, de momento tengo: 2 Pizza Margarita - 20 con...\""
}
[2025-11-19T16:37:30.796Z] [INFO] STATE_PERSIST {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Vale, de momento tengo: 2 Pizza Margarita - 20 con...", UseAlgieba: true, NaturalFlow: true, Step: order_ask_address
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, Vale, de momento tengo: 2 Pizza Margarita - 20 con 40 ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:31.302Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "totalTimeMs": 1667,
  "geminiTimeMs": 1144,
  "stateSaveTimeMs": 502,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1156,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:31.360Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:31.360Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:31.361Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_ask_address, Input: "Espera, mejor quiero hacer una reserva", Processing: false
[2025-11-19T16:37:31.362Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Espera, mejor quiero hacer una reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: order_ask_address, Input: "Espera, mejor quiero hacer una reserva", Processing: false
[2025-11-19T16:37:31.364Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "currentStep": "order_ask_address",
  "userInput": "Espera, mejor quiero hacer una reserva",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Espera, mejor quiero hacer una reserva"
üîç [DEBUG] Texto en min√∫sculas: "espera, mejor quiero hacer una reserva"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:31.372Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "order_ask_address",
  "to": "order_ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_address",
  "processStepTimeMs": 9
}
[AFTER_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_ask_name, Time: 9ms, Response: "¬øA nombre de qui√©n ser√° el pedido?"
[2025-11-19T16:37:31.373Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_name",
  "processStepTimeMs": 9,
  "responseMessage": "¬øA nombre de qui√©n ser√° el pedido?",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"¬øA nombre de qui√©n ser√° el pedido?...\""
}
[2025-11-19T16:37:31.373Z] [INFO] STATE_PERSIST {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_name",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øA nombre de qui√©n ser√° el pedido?...", UseAlgieba: true, NaturalFlow: true, Step: order_ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, ¬øA nombre de qui√©n ser√° el pedido?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:31.883Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_name",
  "totalTimeMs": 524,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 505,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:31.942Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:31.942Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:31.943Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_name",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_ask_name, Input: "Para 4 personas", Processing: false
[2025-11-19T16:37:31.944Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_name",
  "hasInput": true,
  "inputLength": 15,
  "inputPreview": "Para 4 personas",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: order_ask_name, Input: "Para 4 personas", Processing: false
[2025-11-19T16:37:31.946Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_name",
  "currentStep": "order_ask_name",
  "userInput": "Para 4 personas",
  "inputLength": 15,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Para 4 personas"
üîç [DEBUG] Texto en min√∫sculas: "para 4 personas"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:31.953Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "order_ask_name",
  "to": "order_ask_notes",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_name",
  "processStepTimeMs": 8
}
[AFTER_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_ask_notes, Time: 8ms, Response: "Vale, tengo tu pedido: 2 Pizza Margarita - 20 con 40 euros. ¬øTienes alguna alergia, restricci√≥n alim"
[2025-11-19T16:37:31.954Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_notes",
  "processStepTimeMs": 8,
  "responseMessage": "Vale, tengo tu pedido: 2 Pizza Margarita - 20 con 40 euros. ¬øTienes alguna alergia, restricci√≥n alim",
  "reasoning": "Paso procesado en 8ms. Respuesta: \"Vale, tengo tu pedido: 2 Pizza Margarita - 20 con ...\""
}
[2025-11-19T16:37:31.956Z] [INFO] STATE_PERSIST {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_notes",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Vale, tengo tu pedido: 2 Pizza Margarita - 20 con ...", UseAlgieba: true, NaturalFlow: true, Step: order_ask_notes
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, tengo tu pedido: 2 Pizza Margarita - 20 con 40 euros. ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:37:32.474Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_notes",
  "totalTimeMs": 533,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 513,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 8,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:32.525Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:32.526Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:32.527Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_notes",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_ask_notes, Input: "Ma√±ana", Processing: false
[2025-11-19T16:37:32.528Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_notes",
  "hasInput": true,
  "inputLength": 6,
  "inputPreview": "Ma√±ana",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: order_ask_notes, Input: "Ma√±ana", Processing: false
[2025-11-19T16:37:32.529Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_notes",
  "currentStep": "order_ask_notes",
  "userInput": "Ma√±ana",
  "inputLength": 6,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Ma√±ana"
üîç [DEBUG] Texto en min√∫sculas: "ma√±ana"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:32.537Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_ask_notes",
  "performanceMetrics": null,
  "module": "gemini",
  "userInput": "Ma√±ana",
  "inputLength": 6,
  "context": {
    "step": "order_ask_notes",
    "callSid": "CA_order_res_1763570247375"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Ma√±ana\""
}
[2025-11-19T16:37:32.537Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_ask_notes",
  "performanceMetrics": null,
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:32.538Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_ask_notes",
  "performanceMetrics": null,
  "module": "gemini",
  "promptLength": 8379,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8379 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:33.633Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_ask_notes",
  "performanceMetrics": null,
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"ho",
  "apiCallTimeMs": 1094,
  "reasoning": "Respuesta recibida de Gemini en 1094ms. Extrayendo JSON..."
}
[2025-11-19T16:37:33.634Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_order_res_1763570247375",
  "step": "order_ask_notes",
  "performanceMetrics": null,
  "module": "gemini",
  "totalTimeMs": 1097,
  "apiCallTimeMs": 1094,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, fecha 2025-11-20, sin hora, sin nombre"
}
[2025-11-19T16:37:33.634Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "order_ask_notes",
  "to": "order_confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_ask_notes",
  "processStepTimeMs": 1106
}
[AFTER_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_confirm, Time: 1106ms, Response: "Resumen del pedido: 2 Pizza Margarita - 20 con 40 euros. Total: 20 con 40 euros. ¬øConfirmamos para p"
[2025-11-19T16:37:33.636Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_confirm",
  "processStepTimeMs": 1106,
  "responseMessage": "Resumen del pedido: 2 Pizza Margarita - 20 con 40 euros. Total: 20 con 40 euros. ¬øConfirmamos para p",
  "reasoning": "Paso procesado en 1106ms. Respuesta: \"Resumen del pedido: 2 Pizza Margarita - 20 con 40 ...\""
}
[2025-11-19T16:37:33.636Z] [INFO] STATE_PERSIST {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_confirm",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Resumen del pedido: 2 Pizza Margarita - 20 con 40 ...", UseAlgieba: true, NaturalFlow: true, Step: order_confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, Resumen del pedido: 2 Pizza Margarita - 20 con 40 ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:34.145Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_confirm",
  "totalTimeMs": 1621,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 504,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1106,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:34.204Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:34.204Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:34.205Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_confirm",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_confirm, Input: "A las 8", Processing: false
[2025-11-19T16:37:34.206Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_confirm",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "A las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: order_confirm, Input: "A las 8", Processing: false
[2025-11-19T16:37:34.207Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_confirm",
  "currentStep": "order_confirm",
  "userInput": "A las 8",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "A las 8"
üîç [DEBUG] Texto en min√∫sculas: "a las 8"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_order_res_1763570247375, Step: order_confirm, Time: 9ms, Response: "No lo he entendido. ¬øMe confirmas si el pedido est√° correcto?"
[2025-11-19T16:37:34.215Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_confirm",
  "processStepTimeMs": 9,
  "responseMessage": "No lo he entendido. ¬øMe confirmas si el pedido est√° correcto?",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"No lo he entendido. ¬øMe confirmas si el pedido est...\""
}
[2025-11-19T16:37:34.216Z] [INFO] STATE_PERSIST {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_confirm",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido. ¬øMe confirmas si el pedido est...", UseAlgieba: true, NaturalFlow: true, Step: order_confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Aja, No lo he entendido. ¬øMe confirmas si el pedido est√° cor..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:34.723Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_order_res_1763570247375",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "order_confirm",
  "totalTimeMs": 521,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 503,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:37:34][0m PASSED: Complejo - Pedido ‚Üí Reserva (7404ms)
[36müß™ [16:37:34][0m üî• EXTREME: Complejo - M√∫ltiples Reservas en Secuencia
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:34.781Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:34.782Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:35.371Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: greeting, Input: "Reserva para 2 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:37:35.372Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 38,
  "inputPreview": "Reserva para 2 personas ma√±ana a las 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva para 2 personas ma√±ana a las 8", Processing: false
[2025-11-19T16:37:35.373Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva para 2 personas ma√±ana a las 8",
  "inputLength": 38,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:35.374Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 2 personas ma√±ana a las 8",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:37:35.374Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva para 2 personas ma√±ana a las 8",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva para 2 personas ma√±ana a las 8\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:37:35.375Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570254781,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva para 2 personas ma√±ana a las 8",
  "inputLength": 38,
  "context": {
    "step": "greeting",
    "callSid": "CA_multi_res_seq_1763570254781"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva para 2 personas ma√±ana a las 8\""
}
[2025-11-19T16:37:35.376Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570254781,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:35.376Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570254781,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8411,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8411 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:36.500Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570254781,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"2\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-20\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"08:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1123,
  "reasoning": "Respuesta recibida de Gemini en 1123ms. Extrayendo JSON..."
}
[2025-11-19T16:37:36.501Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570254781,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1126,
  "apiCallTimeMs": 1123,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "2",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 2 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:37:36.501Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "2",
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:37:36.502Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:37:36.503Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "2",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-20",
    "fecha_confidence": "100%",
    "hora": "08:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Reserva para 2 personas ma√±ana a las 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 2 personas, fecha 2025-11-20, hora 08:00, sin nombre"
}
[2025-11-19T16:37:36.503Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 2,
  "credibilidad": "100%"
}
[2025-11-19T16:37:36.504Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-20",
  "credibilidad": "100%"
}
[2025-11-19T16:37:36.504Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "08:00",
  "credibilidad": "100%"
}
[2025-11-19T16:37:36.505Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:37:36.505Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 2,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":2,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. Faltan: name"
}
[2025-11-19T16:37:36.506Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:37:36.507Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:37:36.507Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1134
}
[AFTER_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: ask_name, Time: 1134ms, Response: "Perfecto, mesa para 2 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:37:36.508Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1134,
  "responseMessage": "Perfecto, mesa para 2 personas, el d√≠a 20 de noviembre, a las 8 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1134ms. Respuesta: \"Perfecto, mesa para 2 personas, el d√≠a 20 de novie...\""
}
[2025-11-19T16:37:36.509Z] [INFO] STATE_PERSIST {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 2 personas, el d√≠a 20 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, Perfecto, mesa para 2 personas, el d√≠a 20 de noviembre..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:36.513Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 1732,
  "geminiTimeMs": 1126,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1134,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:36.573Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:36.574Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:36.574Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: ask_name, Input: "Juan", Processing: false
[2025-11-19T16:37:36.575Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Juan",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Juan", Processing: false
[2025-11-19T16:37:36.577Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Juan",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:36.577Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:37:36.578Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570256572,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan",
  "inputLength": 4,
  "context": {
    "step": "ask_name",
    "callSid": "CA_multi_res_seq_1763570254781"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan\""
}
[2025-11-19T16:37:36.578Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570256572,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:36.579Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570256572,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8377,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8377 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:37.578Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570256572,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 696,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 999,
  "reasoning": "Respuesta recibida de Gemini en 999ms. Extrayendo JSON..."
}
[2025-11-19T16:37:37.579Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570256572,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1001,
  "apiCallTimeMs": 999,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan"
}
[2025-11-19T16:37:37.579Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "extractedValue": "Juan",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (Juan). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:37:37.580Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "currentLanguage": "es",
  "originalText": "Juan",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":2,\"FechaReserva\":\"2025-11-20\",\"HoraReserva\":\"08:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan"
}
[2025-11-19T16:37:37.580Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "nombre": "Juan",
  "credibilidad": "100%"
}
[2025-11-19T16:37:37.581Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00"
  },
  "stateAfter": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
‚úÖ Usando mensajes en es para tipo name
[2025-11-19T16:37:37.582Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "ask_name",
  "to": "confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1006
}
[AFTER_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: confirm, Time: 1006ms, Response: "Muy bien, Juan. Perfecto, 2 personas, el d√≠a 20 de noviembre a las 08:00, a nombre de Juan, tel√©fono"
[2025-11-19T16:37:37.583Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 1006,
  "responseMessage": "Muy bien, Juan. Perfecto, 2 personas, el d√≠a 20 de noviembre a las 08:00, a nombre de Juan, tel√©fono",
  "reasoning": "Paso procesado en 1006ms. Respuesta: \"Muy bien, Juan. Perfecto, 2 personas, el d√≠a 20 de...\""
}
[2025-11-19T16:37:37.584Z] [INFO] STATE_PERSIST {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Muy bien, Juan. Perfecto, 2 personas, el d√≠a 20 de...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Muy bien, Juan. Perfecto, 2 personas, el d√≠a 20 de noviembre..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:37:38.089Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 1517,
  "geminiTimeMs": 1001,
  "stateSaveTimeMs": 500,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1006,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:38.148Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:38.150Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:38.150Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: confirm, Input: "666111222", Processing: false
[2025-11-19T16:37:38.153Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666111222",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "666111222", Processing: false
[2025-11-19T16:37:38.154Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "666111222",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": "Juan",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "666111222"
üîç [DEBUG] Texto en min√∫sculas: "666111222"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: confirm, Time: 9ms, Response: "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi"
[2025-11-19T16:37:38.162Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 9,
  "responseMessage": "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"¬øEs correcto? Puede decir s√≠ para confirmar, no pa...\""
}
[2025-11-19T16:37:38.163Z] [INFO] STATE_PERSIST {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øEs correcto? Puede decir s√≠ para confirmar, no pa...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, ¬øEs correcto? Puede decir s√≠ para confirmar, no para c..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:38.671Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 523,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 503,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:38.729Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:38.730Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:38.730Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: confirm, Input: "Confirmar", Processing: false
[2025-11-19T16:37:38.731Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "Confirmar",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "Confirmar", Processing: false
[2025-11-19T16:37:38.732Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "Confirmar",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": "Juan",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:38.733Z] [INFO] ‚úÖ CRITICAL_CONFIRMATION_DETECTED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "action": "confirm",
  "reasoning": "Confirmaci√≥n v√°lida detectada. Saltando verificaci√≥n de cancelaci√≥n."
}
[2025-11-19T16:37:38.734Z] [INFO] üîç CHECKING_AVAILABILITY_BEFORE_CONFIRM {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 2,
  "fecha": "2025-11-20",
  "hora": "08:00",
  "reasoning": "Usuario confirm√≥ la reserva. Verificando disponibilidad antes de finalizar..."
}
[2025-11-19T16:37:38.735Z] [CAPACITY] üîç AVAILABILITY_CHECK_START {
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 2,
  "cacheKey": "2025-11-20 08:00:00:2",
  "reasoning": "Iniciando verificaci√≥n de disponibilidad para 2 personas el 2025-11-20 08:00:00"
}
[2025-11-19T16:37:38.735Z] [CAPACITY] üîÑ AVAILABILITY_CHECKING_DB {
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 2,
  "reasoning": "No hay resultado en cache. Consultando base de datos para verificar disponibilidad..."
}
[2025-11-19T16:37:39.302Z] [CAPACITY] Verificando disponibilidad {
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 2,
  "personasOcupadas": 0,
  "capacidadMaxima": 100,
  "capacidadDisponible": 100,
  "capacidadConBuffer": 90
}
[2025-11-19T16:37:39.303Z] [CAPACITY] ‚úÖ AVAILABILITY_CHECKED {
  "fechaHora": "2025-11-20 08:00:00",
  "numPersonas": 2,
  "disponible": true,
  "capacidadDisponible": null,
  "capacidadTotal": null,
  "reservasExistentes": null,
  "timeMs": 568,
  "reasoning": "Verificaci√≥n completada en 568ms. Disponible: true. Capacidad disponible: N/A"
}
‚úÖ Usando mensajes en es para tipo confirm
[2025-11-19T16:37:39.304Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "confirm",
  "to": "complete",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 572
}
[AFTER_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: complete, Time: 572ms, Response: "¬°Perfecto! Todo confirmado. Les esperamos con los brazos abiertos. ¬°Que disfruten mucho!"
[2025-11-19T16:37:39.305Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "processStepTimeMs": 572,
  "responseMessage": "¬°Perfecto! Todo confirmado. Les esperamos con los brazos abiertos. ¬°Que disfruten mucho!",
  "reasoning": "Paso procesado en 572ms. Respuesta: \"¬°Perfecto! Todo confirmado. Les esperamos con los ...\""
}
[2025-11-19T16:37:39.306Z] [INFO] STATE_PERSIST {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  }
}
[2025-11-19T16:37:39.814Z] [RESERVATION] Guardando reserva en base de datos... {
  "data": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  }
}
[2025-11-19T16:37:39.815Z] [RESERVATION] üîç VALIDATION_START {
  "data": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n de datos de la reserva antes de guardar en base de datos"
}
[2025-11-19T16:37:39.815Z] [RESERVATION] ‚úÖ BASIC_VALIDATION_PASSED {
  "data": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Validaci√≥n b√°sica pas√≥. Procediendo con validaci√≥n completa..."
}
[2025-11-19T16:37:39.816Z] [RESERVATION] üîç FULL_VALIDATION_START {
  "data": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n completa (horarios, antelaci√≥n, disponibilidad, etc.)"
}
[2025-11-19T16:37:39.817Z] [RESERVATION] ‚úÖ FULL_VALIDATION_COMPLETED {
  "validationTimeMs": 2,
  "errores": [
    "El restaurante est√° abierto de 13:00 a 23:00"
  ],
  "advertencias": [],
  "reasoning": "Validaci√≥n completa completada en 2ms. V√°lida: undefined"
}
[2025-11-19T16:37:39.818Z] [INFO] RESERVATION_SAVE_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "saved": false,
  "timeMs": 4
}
[2025-11-19T16:37:40.386Z] [INFO] RESERVATION_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete"
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Perfecto! Todo confirmado. Les esperamos con los ...", UseAlgieba: true, NaturalFlow: true, Step: complete
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬°Perfecto! Todo confirmado. Les esperamos con los brazos abi..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
[2025-11-19T16:37:40.389Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "totalTimeMs": 1661,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 507,
  "availabilityTimeMs": 568,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 572,
  "saveReservationTimeMs": 4,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:40.441Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:40.441Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:41.015Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: complete, Input: "Quiero hacer otra reserva", Processing: false
[2025-11-19T16:37:41.016Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "hasInput": true,
  "inputLength": 25,
  "inputPreview": "Quiero hacer otra reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: complete, Input: "Quiero hacer otra reserva", Processing: false
[2025-11-19T16:37:41.018Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "currentStep": "complete",
  "userInput": "Quiero hacer otra reserva",
  "inputLength": 25,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 2,
    "fecha": "2025-11-20",
    "hora": "08:00",
    "nombre": "Juan",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "Quiero hacer otra reserva"
üîç [DEBUG] Texto en min√∫sculas: "quiero hacer otra reserva"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
‚úÖ [COMPLETE] Reserva completada exitosamente
‚úÖ Usando mensajes en es para tipo complete
[AFTER_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: complete, Time: 9ms, Response: "¬°Excelente! Su reserva ha sido completada exitosamente. Gracias por elegir nuestro restaurante. ¬°Esp"
[2025-11-19T16:37:41.027Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "processStepTimeMs": 9,
  "responseMessage": "¬°Excelente! Su reserva ha sido completada exitosamente. Gracias por elegir nuestro restaurante. ¬°Esp",
  "reasoning": "Paso procesado en 9ms. Respuesta: \"¬°Excelente! Su reserva ha sido completada exitosam...\""
}
[2025-11-19T16:37:41.027Z] [INFO] STATE_PERSIST {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan"
  }
}
[2025-11-19T16:37:41.530Z] [RESERVATION] Guardando reserva en base de datos... {
  "data": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  }
}
[2025-11-19T16:37:41.531Z] [RESERVATION] üîç VALIDATION_START {
  "data": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n de datos de la reserva antes de guardar en base de datos"
}
[2025-11-19T16:37:41.532Z] [RESERVATION] ‚úÖ BASIC_VALIDATION_PASSED {
  "data": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Validaci√≥n b√°sica pas√≥. Procediendo con validaci√≥n completa..."
}
[2025-11-19T16:37:41.532Z] [RESERVATION] üîç FULL_VALIDATION_START {
  "data": {
    "NumeroReserva": 2,
    "FechaReserva": "2025-11-20",
    "HoraReserva": "08:00",
    "NomReserva": "Juan",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n completa (horarios, antelaci√≥n, disponibilidad, etc.)"
}
[2025-11-19T16:37:41.533Z] [RESERVATION] ‚úÖ FULL_VALIDATION_COMPLETED {
  "validationTimeMs": 1,
  "errores": [
    "El restaurante est√° abierto de 13:00 a 23:00"
  ],
  "advertencias": [],
  "reasoning": "Validaci√≥n completa completada en 1ms. V√°lida: undefined"
}
[2025-11-19T16:37:41.534Z] [INFO] RESERVATION_SAVE_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "saved": false,
  "timeMs": 4
}
[2025-11-19T16:37:42.126Z] [INFO] RESERVATION_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete"
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Excelente! Su reserva ha sido completada exitosam...", UseAlgieba: true, NaturalFlow: true, Step: complete
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Claro, ¬°Excelente! Su reserva ha sido completada exitosament..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
[2025-11-19T16:37:42.130Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "totalTimeMs": 1690,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 502,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 9,
  "saveReservationTimeMs": 4,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:42.187Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:42.188Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:42.786Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: greeting, Input: "Para 4 personas pasado ma√±ana a las 9", Processing: false
[2025-11-19T16:37:42.787Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 37,
  "inputPreview": "Para 4 personas pasado ma√±ana a las 9",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Para 4 personas pasado ma√±ana a las 9", Processing: false
[2025-11-19T16:37:42.789Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Para 4 personas pasado ma√±ana a las 9",
  "inputLength": 37,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:42.789Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Para 4 personas pasado ma√±ana a las 9",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:37:42.790Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Para 4 personas pasado ma√±ana a las 9",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Para 4 personas pasado ma√±ana a las 9\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:37:42.790Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570262186,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Para 4 personas pasado ma√±ana a las 9",
  "inputLength": 37,
  "context": {
    "step": "greeting",
    "callSid": "CA_multi_res_seq_1763570254781"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Para 4 personas pasado ma√±ana a las 9\""
}
[2025-11-19T16:37:42.791Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570262186,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:42.792Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570262186,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8410,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8410 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:44.565Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570262186,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"reservation\",\n  \"comensales\": \"4\",\n  \"comensales_porcentaje_credivilidad\": \"100%\",\n  \"comensales_validos\": \"true\",\n  \"comensales_error\": null,\n  \"fecha\": \"2025-11-21\",\n  \"fecha_porcentaje_credivilidad\": \"100%\",\n  \"hora\": \"09:00\",\n  \"hora_disponible\": \"true\",\n  \"hora_error\":",
  "apiCallTimeMs": 1773,
  "reasoning": "Respuesta recibida de Gemini en 1773ms. Extrayendo JSON..."
}
[2025-11-19T16:37:44.566Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570262186,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1776,
  "apiCallTimeMs": 1773,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-21",
    "fecha_confidence": "100%",
    "hora": "09:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: reservation, Idioma: es. Extra√≠dos: 4 personas, fecha 2025-11-21, hora 09:00, sin nombre"
}
[2025-11-19T16:37:44.566Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "reservation",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": "4",
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: reservation, Idioma: es. Procesando..."
}
[2025-11-19T16:37:44.567Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "reservation",
  "reasoning": "Intenci√≥n detectada: reservation. Procesando como nueva reserva..."
}
[2025-11-19T16:37:44.567Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "analysis": {
    "intencion": "reservation",
    "comensales": "4",
    "comensales_confidence": "100%",
    "comensales_validos": "true",
    "comensales_error": null,
    "fecha": "2025-11-21",
    "fecha_confidence": "100%",
    "hora": "09:00",
    "hora_confidence": "100%",
    "hora_disponible": "true",
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Para 4 personas pasado ma√±ana a las 9",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 4 personas, fecha 2025-11-21, hora 09:00, sin nombre"
}
[2025-11-19T16:37:44.568Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "peopleCount": 4,
  "credibilidad": "100%"
}
[2025-11-19T16:37:44.569Z] [RESERVATION] DATE_APPLIED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "fecha": "2025-11-21",
  "credibilidad": "100%"
}
[2025-11-19T16:37:44.569Z] [RESERVATION] TIME_APPLIED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hora": "09:00",
  "credibilidad": "100%"
}
[2025-11-19T16:37:44.570Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": true,
    "HoraReserva": true,
    "NomReserva": false
  }
}
[2025-11-19T16:37:44.570Z] [INFO] üîç CHECKING_MISSING_FIELDS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missingFields": [
    "name"
  ],
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": null,
    "telefono": "+34600123456"
  },
  "reasoning": "Verificando qu√© campos faltan. Campos actuales: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-21\",\"HoraReserva\":\"09:00\"}. Faltan: name"
}
[2025-11-19T16:37:44.571Z] [INFO] üìã MISSING_FIELDS_DETERMINED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "missing": [
    "name"
  ],
  "missingCount": 1,
  "reasoning": "Se determinaron 1 campos faltantes: name"
}
[2025-11-19T16:37:44.571Z] [INFO] ‚ùì ASKING_FOR_MISSING_FIELD {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "nextField": "name",
  "allMissing": [
    "name"
  ],
  "currentData": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  },
  "reasoning": "Faltan 1 campos. Preguntando primero por: name. Campos restantes: ninguno"
}
[2025-11-19T16:37:44.572Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_name",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1784
}
[AFTER_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: ask_name, Time: 1784ms, Response: "Perfecto, mesa para 4 personas, el d√≠a 21 de noviembre, a las 9 de la ma√±ana. ¬øA nombre de qui√©n ser"
[2025-11-19T16:37:44.573Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 1784,
  "responseMessage": "Perfecto, mesa para 4 personas, el d√≠a 21 de noviembre, a las 9 de la ma√±ana. ¬øA nombre de qui√©n ser",
  "reasoning": "Paso procesado en 1784ms. Respuesta: \"Perfecto, mesa para 4 personas, el d√≠a 21 de novie...\""
}
[2025-11-19T16:37:44.574Z] [INFO] STATE_PERSIST {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 4 personas, el d√≠a 21 de novie...", UseAlgieba: true, NaturalFlow: true, Step: ask_name
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, Perfecto, mesa para 4 personas, el d√≠a 21 de novie..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:37:44.580Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "totalTimeMs": 2394,
  "geminiTimeMs": 1776,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1784,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:44.636Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:44.637Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:44.637Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  },
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: ask_name, Input: "Mar√≠a", Processing: false
[2025-11-19T16:37:44.638Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "hasInput": true,
  "inputLength": 5,
  "inputPreview": "Mar√≠a",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_name, Input: "Mar√≠a", Processing: false
[2025-11-19T16:37:44.640Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "currentStep": "ask_name",
  "userInput": "Mar√≠a",
  "inputLength": 5,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:44.642Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "nombre"
}
[2025-11-19T16:37:44.643Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570264635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Mar√≠a",
  "inputLength": 5,
  "context": {
    "step": "ask_name",
    "callSid": "CA_multi_res_seq_1763570254781"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Mar√≠a\""
}
[2025-11-19T16:37:44.644Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570264635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:44.645Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570264635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8378,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8378 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:45.595Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570264635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 697,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 948,
  "reasoning": "Respuesta recibida de Gemini en 948ms. Extrayendo JSON..."
}
[2025-11-19T16:37:45.595Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "step": "ask_name",
  "performanceMetrics": {
    "requestStart": 1763570264635,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 952,
  "apiCallTimeMs": 948,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Mar√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Mar√≠a"
}
[2025-11-19T16:37:45.596Z] [INFO] ‚úÖ CRITICAL_DATA_DETECTED_SKIP_CANCEL_CHECK {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "extractedValue": "Mar√≠a",
  "confidence": "100%",
  "reasoning": "Dato v√°lido detectado (Mar√≠a). Saltando verificaci√≥n de cancelaci√≥n para evitar falsos positivos."
}
[2025-11-19T16:37:45.596Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Mar√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  },
  "currentLanguage": "es",
  "originalText": "Mar√≠a",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":4,\"FechaReserva\":\"2025-11-21\",\"HoraReserva\":\"09:00\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Mar√≠a"
}
[2025-11-19T16:37:45.597Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "nombre": "Mar√≠a",
  "credibilidad": "100%"
}
[2025-11-19T16:37:45.598Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "stateBefore": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00"
  },
  "stateAfter": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
‚úÖ Usando mensajes en es para tipo name
[2025-11-19T16:37:45.599Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "ask_name",
  "to": "confirm",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_name",
  "processStepTimeMs": 960
}
[AFTER_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: confirm, Time: 960ms, Response: "Muy bien, Mar√≠a. Perfecto, 4 personas, el d√≠a 21 de noviembre a las 09:00, a nombre de Mar√≠a, tel√©fo"
[2025-11-19T16:37:45.600Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 960,
  "responseMessage": "Muy bien, Mar√≠a. Perfecto, 4 personas, el d√≠a 21 de noviembre a las 09:00, a nombre de Mar√≠a, tel√©fo",
  "reasoning": "Paso procesado en 960ms. Respuesta: \"Muy bien, Mar√≠a. Perfecto, 4 personas, el d√≠a 21 d...\""
}
[2025-11-19T16:37:45.600Z] [INFO] STATE_PERSIST {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Muy bien, Mar√≠a. Perfecto, 4 personas, el d√≠a 21 d...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, vale, Muy bien, Mar√≠a. Perfecto, 4 personas, el d√≠..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 2 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 2 fragmento(s)
[2025-11-19T16:37:46.112Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 1477,
  "geminiTimeMs": 952,
  "stateSaveTimeMs": 507,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 960,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:46.171Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:46.172Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:46.173Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: confirm, Input: "666333444", Processing: false
[2025-11-19T16:37:46.174Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666333444",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "666333444", Processing: false
[2025-11-19T16:37:46.175Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "666333444",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": "Mar√≠a",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
üîç [DEBUG] isCancellationRequest - Analizando: "666333444"
üîç [DEBUG] Texto en min√∫sculas: "666333444"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[AFTER_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: confirm, Time: 8ms, Response: "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi"
[2025-11-19T16:37:46.183Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 8,
  "responseMessage": "¬øEs correcto? Puede decir s√≠ para confirmar, no para cambiar algo, o qu√© espec√≠ficamente quiere modi",
  "reasoning": "Paso procesado en 8ms. Respuesta: \"¬øEs correcto? Puede decir s√≠ para confirmar, no pa...\""
}
[2025-11-19T16:37:46.184Z] [INFO] STATE_PERSIST {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øEs correcto? Puede decir s√≠ para confirmar, no pa...", UseAlgieba: true, NaturalFlow: true, Step: confirm
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, ¬øEs correcto? Puede decir s√≠ para confirmar, no para c..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:46.692Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "totalTimeMs": 521,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 504,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 8,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:46.748Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:46.749Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:46.749Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a",
    "TelefonReserva": "+34600123456"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: confirm, Input: "Confirmar", Processing: false
[2025-11-19T16:37:46.750Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "Confirmar",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: confirm, Input: "Confirmar", Processing: false
[2025-11-19T16:37:46.751Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "currentStep": "confirm",
  "userInput": "Confirmar",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 4,
    "fecha": "2025-11-21",
    "hora": "09:00",
    "nombre": "Mar√≠a",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:46.752Z] [INFO] ‚úÖ CRITICAL_CONFIRMATION_DETECTED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "action": "confirm",
  "reasoning": "Confirmaci√≥n v√°lida detectada. Saltando verificaci√≥n de cancelaci√≥n."
}
[2025-11-19T16:37:46.753Z] [INFO] üîç CHECKING_AVAILABILITY_BEFORE_CONFIRM {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 4,
  "fecha": "2025-11-21",
  "hora": "09:00",
  "reasoning": "Usuario confirm√≥ la reserva. Verificando disponibilidad antes de finalizar..."
}
[2025-11-19T16:37:46.754Z] [CAPACITY] üîç AVAILABILITY_CHECK_START {
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 4,
  "cacheKey": "2025-11-21 09:00:00:4",
  "reasoning": "Iniciando verificaci√≥n de disponibilidad para 4 personas el 2025-11-21 09:00:00"
}
[2025-11-19T16:37:46.754Z] [CAPACITY] üîÑ AVAILABILITY_CHECKING_DB {
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 4,
  "reasoning": "No hay resultado en cache. Consultando base de datos para verificar disponibilidad..."
}
[2025-11-19T16:37:47.321Z] [CAPACITY] Verificando disponibilidad {
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 4,
  "personasOcupadas": 0,
  "capacidadMaxima": 100,
  "capacidadDisponible": 100,
  "capacidadConBuffer": 90
}
[2025-11-19T16:37:47.322Z] [CAPACITY] ‚úÖ AVAILABILITY_CHECKED {
  "fechaHora": "2025-11-21 09:00:00",
  "numPersonas": 4,
  "disponible": true,
  "capacidadDisponible": null,
  "capacidadTotal": null,
  "reservasExistentes": null,
  "timeMs": 568,
  "reasoning": "Verificaci√≥n completada en 568ms. Disponible: true. Capacidad disponible: N/A"
}
‚úÖ Usando mensajes en es para tipo confirm
[2025-11-19T16:37:47.323Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "confirm",
  "to": "complete",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "confirm",
  "processStepTimeMs": 572
}
[AFTER_PROCESS_STEP] CallSid: CA_multi_res_seq_1763570254781, Step: complete, Time: 572ms, Response: "¬°Vale! Reserva confirmada. Estaremos encantados de recibirles. ¬°Hasta muy pronto!"
[2025-11-19T16:37:47.325Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "processStepTimeMs": 572,
  "responseMessage": "¬°Vale! Reserva confirmada. Estaremos encantados de recibirles. ¬°Hasta muy pronto!",
  "reasoning": "Paso procesado en 572ms. Respuesta: \"¬°Vale! Reserva confirmada. Estaremos encantados de...\""
}
[2025-11-19T16:37:47.325Z] [INFO] STATE_PERSIST {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "dataKeys": [
    "NumeroReserva",
    "FechaReserva",
    "HoraReserva",
    "NomReserva",
    "TelefonReserva"
  ],
  "dataValues": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a"
  }
}
[2025-11-19T16:37:47.828Z] [RESERVATION] Guardando reserva en base de datos... {
  "data": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a",
    "TelefonReserva": "+34600123456"
  }
}
[2025-11-19T16:37:47.828Z] [RESERVATION] üîç VALIDATION_START {
  "data": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n de datos de la reserva antes de guardar en base de datos"
}
[2025-11-19T16:37:47.829Z] [RESERVATION] ‚úÖ BASIC_VALIDATION_PASSED {
  "data": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Validaci√≥n b√°sica pas√≥. Procediendo con validaci√≥n completa..."
}
[2025-11-19T16:37:47.830Z] [RESERVATION] üîç FULL_VALIDATION_START {
  "data": {
    "NumeroReserva": 4,
    "FechaReserva": "2025-11-21",
    "HoraReserva": "09:00",
    "NomReserva": "Mar√≠a",
    "TelefonReserva": "+34600123456"
  },
  "reasoning": "Iniciando validaci√≥n completa (horarios, antelaci√≥n, disponibilidad, etc.)"
}
[2025-11-19T16:37:47.831Z] [RESERVATION] ‚úÖ FULL_VALIDATION_COMPLETED {
  "validationTimeMs": 2,
  "errores": [
    "El restaurante est√° abierto de 13:00 a 23:00"
  ],
  "advertencias": [],
  "reasoning": "Validaci√≥n completa completada en 2ms. V√°lida: undefined"
}
[2025-11-19T16:37:47.832Z] [INFO] RESERVATION_SAVE_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "saved": false,
  "timeMs": 4
}
[2025-11-19T16:37:48.400Z] [INFO] RESERVATION_COMPLETED {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete"
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Vale! Reserva confirmada. Estaremos encantados de...", UseAlgieba: true, NaturalFlow: true, Step: complete
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, ¬°Vale! Reserva confirmada. Estaremos encantados ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
[2025-11-19T16:37:48.403Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_multi_res_seq_1763570254781",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "complete",
  "totalTimeMs": 1656,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 501,
  "availabilityTimeMs": 568,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 572,
  "saveReservationTimeMs": 4,
  "hasInput": true
}
[31m‚ùå [16:37:48][0m FAILED: Complejo - M√∫ltiples Reservas en Secuencia (13672ms)
[33m‚ö†Ô∏è [16:37:48][0m   Expected gather: true, got: false
[35müìã [16:37:48][0m GRUPO 8: Casos de Rendimiento
[36müß™ [16:37:48][0m üî• EXTREME: Rendimiento - Bajo Carga (20 iteraciones)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:48.457Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:48.457Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:49.016Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: greeting, Input: "Input 0", Processing: false
[2025-11-19T16:37:49.017Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 0",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Input 0", Processing: false
[2025-11-19T16:37:49.019Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Input 0",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:49.019Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Input 0",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:37:49.020Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Input 0",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Input 0\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:37:49.020Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570268456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 0",
  "inputLength": 7,
  "context": {
    "step": "greeting",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 0\""
}
[2025-11-19T16:37:49.021Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570268456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:49.021Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570268456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:50.072Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570268456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1050,
  "reasoning": "Respuesta recibida de Gemini en 1050ms. Extrayendo JSON..."
}
[2025-11-19T16:37:50.073Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570268456,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1053,
  "apiCallTimeMs": 1050,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:50.074Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:37:50.074Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:37:50.076Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1058
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_people, Time: 1058ms, Response: "¬°Genial! ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:37:50.077Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1058,
  "responseMessage": "¬°Genial! ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 1058ms. Respuesta: \"¬°Genial! ¬øPara cu√°ntas personas ser√°?...\""
}
[2025-11-19T16:37:50.078Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Genial! ¬øPara cu√°ntas personas ser√°?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, ¬°Genial! ¬øPara cu√°ntas personas ser√°?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:50.083Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1627,
  "geminiTimeMs": 1053,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1058,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:50.084Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:50.084Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:50.085Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_people, Input: "Input 1", Processing: false
[2025-11-19T16:37:50.086Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 1",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Input 1", Processing: false
[2025-11-19T16:37:50.087Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Input 1",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:50.088Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570270083,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 1",
  "inputLength": 7,
  "context": {
    "step": "ask_people",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 1\""
}
[2025-11-19T16:37:50.088Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570270083,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:50.089Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570270083,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:51.121Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570270083,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1030,
  "reasoning": "Respuesta recibida de Gemini en 1030ms. Extrayendo JSON..."
}
[2025-11-19T16:37:51.121Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570270083,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1033,
  "apiCallTimeMs": 1030,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:51.122Z] [INFO] PEOPLE_EXTRACTED_ANY_NUMBER {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 1
}
[2025-11-19T16:37:51.123Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "1",
    "comensales_confidence": "90%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Input 1",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 1 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:51.124Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 1,
  "credibilidad": "90%"
}
[2025-11-19T16:37:51.124Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:37:51.125Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1038
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1038ms, Response: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:37:51.126Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1038,
  "responseMessage": "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1038ms. Respuesta: \"Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:37:51.127Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:51.131Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1048,
  "geminiTimeMs": 1033,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1038,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:51.132Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:51.133Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:51.133Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 2", Processing: false
[2025-11-19T16:37:51.135Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 2",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 2", Processing: false
[2025-11-19T16:37:51.136Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 2",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:51.136Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:51.137Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570271132,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 2",
  "inputLength": 7,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 2\""
}
[2025-11-19T16:37:51.139Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570271132,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:51.140Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570271132,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:52.248Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570271132,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1108,
  "reasoning": "Respuesta recibida de Gemini en 1108ms. Extrayendo JSON..."
}
[2025-11-19T16:37:52.248Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570271132,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1111,
  "apiCallTimeMs": 1108,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 2"
üîç [DEBUG] Texto en min√∫sculas: "input 2"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:52.276Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 2",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:52.277Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1142ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:37:52.278Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1142,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 1142ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:37:52.279Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 5ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:52.284Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1152,
  "geminiTimeMs": 1111,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1142,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:52.285Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:52.286Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:52.287Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 3", Processing: false
[2025-11-19T16:37:52.288Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 3",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 3", Processing: false
[2025-11-19T16:37:52.290Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 3",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:52.291Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:52.292Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570272285,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 3",
  "inputLength": 7,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 3\""
}
[2025-11-19T16:37:52.292Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570272285,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:52.293Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570272285,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:53.394Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570272285,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1101,
  "reasoning": "Respuesta recibida de Gemini en 1101ms. Extrayendo JSON..."
}
[2025-11-19T16:37:53.395Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570272285,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1103,
  "apiCallTimeMs": 1101,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 3"
üîç [DEBUG] Texto en min√∫sculas: "input 3"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:53.411Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 3",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:53.411Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1124ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:37:53.412Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1124,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 1124ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:37:53.413Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:53.418Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1133,
  "geminiTimeMs": 1103,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1124,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:53.419Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:53.420Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:53.420Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 4", Processing: false
[2025-11-19T16:37:53.422Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 4",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 4", Processing: false
[2025-11-19T16:37:53.425Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 4",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:53.425Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:53.426Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570273419,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 4",
  "inputLength": 7,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 4\""
}
[2025-11-19T16:37:53.426Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570273419,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:53.427Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570273419,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:54.442Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570273419,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1015,
  "reasoning": "Respuesta recibida de Gemini en 1015ms. Extrayendo JSON..."
}
[2025-11-19T16:37:54.443Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570273419,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1017,
  "apiCallTimeMs": 1015,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 4"
üîç [DEBUG] Texto en min√∫sculas: "input 4"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:54.449Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 4",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:54.450Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1026ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:37:54.451Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1026,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 1026ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:37:54.452Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les co..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:54.456Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1037,
  "geminiTimeMs": 1017,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1026,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:54.459Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:54.459Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:54.460Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 5", Processing: false
[2025-11-19T16:37:54.461Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 5",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 5", Processing: false
[2025-11-19T16:37:54.462Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 5",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:54.463Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:54.463Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570274457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 5",
  "inputLength": 7,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 5\""
}
[2025-11-19T16:37:54.464Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570274457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:54.465Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570274457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:55.401Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570274457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 934,
  "reasoning": "Respuesta recibida de Gemini en 934ms. Extrayendo JSON..."
}
[2025-11-19T16:37:55.402Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570274457,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 939,
  "apiCallTimeMs": 934,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 5"
üîç [DEBUG] Texto en min√∫sculas: "input 5"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:55.408Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 5",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:55.409Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 947ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:37:55.410Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 947,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 947ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:37:55.412Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:55.415Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 958,
  "geminiTimeMs": 939,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 947,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:55.416Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:55.417Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:55.417Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 6", Processing: false
[2025-11-19T16:37:55.419Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 6",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 6", Processing: false
[2025-11-19T16:37:55.420Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 6",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:55.420Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:55.421Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570275416,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 6",
  "inputLength": 7,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 6\""
}
[2025-11-19T16:37:55.422Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570275416,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 1,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:55.422Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570275416,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:56.341Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570275416,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 917,
  "reasoning": "Respuesta recibida de Gemini en 917ms. Extrayendo JSON..."
}
[2025-11-19T16:37:56.342Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570275416,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 921,
  "apiCallTimeMs": 917,
  "dataLoadTimeMs": 1,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 6"
üîç [DEBUG] Texto en min√∫sculas: "input 6"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:56.348Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 6",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:56.349Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 930ms, Response: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:37:56.350Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 930,
  "responseMessage": "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 930ms. Respuesta: \"Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...\""
}
[2025-11-19T16:37:56.352Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, Lo siento, no he o√≠do bien la fecha. ¬øPara qu√© d√≠a les ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:56.355Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 939,
  "geminiTimeMs": 921,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 1,
  "dbTimeMs": 0,
  "processStepTimeMs": 930,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:56.358Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:56.358Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:56.359Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 7", Processing: false
[2025-11-19T16:37:56.360Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 7",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 7", Processing: false
[2025-11-19T16:37:56.361Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 7",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:56.362Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:56.363Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570276356,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 7",
  "inputLength": 7,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 7\""
}
[2025-11-19T16:37:56.363Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570276356,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:56.364Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570276356,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:57.521Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570276356,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1155,
  "reasoning": "Respuesta recibida de Gemini en 1155ms. Extrayendo JSON..."
}
[2025-11-19T16:37:57.522Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570276356,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1159,
  "apiCallTimeMs": 1155,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 7"
üîç [DEBUG] Texto en min√∫sculas: "input 7"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:57.528Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 7",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:57.529Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1169ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:37:57.530Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1169,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1169ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:37:57.532Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:57.535Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1179,
  "geminiTimeMs": 1159,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1169,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:57.536Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:57.537Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:57.537Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 8", Processing: false
[2025-11-19T16:37:57.538Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 8",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 8", Processing: false
[2025-11-19T16:37:57.541Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 8",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:57.542Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:57.543Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570277536,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 8",
  "inputLength": 7,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 8\""
}
[2025-11-19T16:37:57.543Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570277536,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:57.544Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570277536,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:58.559Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570277536,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 840,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1015,
  "reasoning": "Respuesta recibida de Gemini en 1015ms. Extrayendo JSON..."
}
[2025-11-19T16:37:58.560Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570277536,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1017,
  "apiCallTimeMs": 1015,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 1
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 8"
üîç [DEBUG] Texto en min√∫sculas: "input 8"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:58.566Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 8",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:58.567Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1029ms, Response: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico."
[2025-11-19T16:37:58.569Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1029,
  "responseMessage": "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico.",
  "reasoning": "Paso procesado en 1029ms. Respuesta: \"¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...\""
}
[2025-11-19T16:37:58.570Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, ¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:58.573Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1037,
  "geminiTimeMs": 1017,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1029,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:58.575Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:58.575Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:58.576Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 18
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 9", Processing: false
[2025-11-19T16:37:58.577Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Input 9",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 9", Processing: false
[2025-11-19T16:37:58.578Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 9",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 19,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:58.579Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:58.579Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570278574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 9",
  "inputLength": 7,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 9\""
}
[2025-11-19T16:37:58.580Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570278574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:58.580Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570278574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:37:59.724Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570278574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1143,
  "reasoning": "Respuesta recibida de Gemini en 1143ms. Extrayendo JSON..."
}
[2025-11-19T16:37:59.725Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570278574,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1146,
  "apiCallTimeMs": 1143,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 9"
üîç [DEBUG] Texto en min√∫sculas: "input 9"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:37:59.732Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 9",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:37:59.732Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1156ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:37:59.733Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1156,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 1156ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:37:59.735Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefi..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:37:59.738Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1164,
  "geminiTimeMs": 1146,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1156,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:37:59.739Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:37:59.740Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:37:59.740Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 20
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 10", Processing: false
[2025-11-19T16:37:59.743Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 10",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 10", Processing: false
[2025-11-19T16:37:59.744Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 10",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 21,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:37:59.745Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:37:59.745Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570279739,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 10",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 10\""
}
[2025-11-19T16:37:59.746Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570279739,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:37:59.747Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570279739,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:00.833Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570279739,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1086,
  "reasoning": "Respuesta recibida de Gemini en 1086ms. Extrayendo JSON..."
}
[2025-11-19T16:38:00.833Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570279739,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1088,
  "apiCallTimeMs": 1086,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 10"
üîç [DEBUG] Texto en min√∫sculas: "input 10"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:00.840Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 10",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:00.840Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1097ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:38:00.841Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1097,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 1097ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:38:00.843Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:00.846Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1107,
  "geminiTimeMs": 1088,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1097,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:00.848Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:00.848Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:00.849Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 22
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 11", Processing: false
[2025-11-19T16:38:00.850Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 11",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 11", Processing: false
[2025-11-19T16:38:00.853Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 11",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 23,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:00.853Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:00.854Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570280847,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 11",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 11\""
}
[2025-11-19T16:38:00.854Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570280847,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:00.855Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570280847,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:01.944Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570280847,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1088,
  "reasoning": "Respuesta recibida de Gemini en 1088ms. Extrayendo JSON..."
}
[2025-11-19T16:38:01.945Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570280847,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1091,
  "apiCallTimeMs": 1088,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 11"
üîç [DEBUG] Texto en min√∫sculas: "input 11"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:01.951Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 11",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:01.952Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1101ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:38:01.953Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1101,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1101ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:38:01.955Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:01.958Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1111,
  "geminiTimeMs": 1091,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1101,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:01.961Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:01.961Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:01.962Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 24
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 12", Processing: false
[2025-11-19T16:38:01.963Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 12",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 12", Processing: false
[2025-11-19T16:38:01.964Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 12",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 25,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:01.965Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:01.965Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570281960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 12",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 12\""
}
[2025-11-19T16:38:01.966Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570281960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:01.968Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570281960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:02.874Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570281960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 905,
  "reasoning": "Respuesta recibida de Gemini en 905ms. Extrayendo JSON..."
}
[2025-11-19T16:38:02.875Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570281960,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 910,
  "apiCallTimeMs": 905,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 12"
üîç [DEBUG] Texto en min√∫sculas: "input 12"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:02.882Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 12",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:02.882Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 919ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:38:02.884Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 919,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 919ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:38:02.885Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:02.888Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 928,
  "geminiTimeMs": 910,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 919,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:02.889Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:02.890Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:02.890Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 26
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 13", Processing: false
[2025-11-19T16:38:02.892Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 13",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 13", Processing: false
[2025-11-19T16:38:02.894Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 13",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 27,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:02.895Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:02.895Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570282889,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 13",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 13\""
}
[2025-11-19T16:38:02.896Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570282889,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:02.897Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570282889,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:03.844Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570282889,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 947,
  "reasoning": "Respuesta recibida de Gemini en 947ms. Extrayendo JSON..."
}
[2025-11-19T16:38:03.845Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570282889,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 950,
  "apiCallTimeMs": 947,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 13"
üîç [DEBUG] Texto en min√∫sculas: "input 13"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:03.851Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 13",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:03.852Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 958ms, Response: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?"
[2025-11-19T16:38:03.853Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 958,
  "responseMessage": "No he entendido bien. ¬øMe puede decir para qu√© d√≠a les gustar√≠a venir?",
  "reasoning": "Paso procesado en 958ms. Respuesta: \"No he entendido bien. ¬øMe puede decir para qu√© d√≠a...\""
}
[2025-11-19T16:38:03.854Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir para qu√© d√≠a...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, No he entendido bien. ¬øMe puede decir para qu√© d√≠a les ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:03.858Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 969,
  "geminiTimeMs": 950,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 958,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:03.859Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:03.860Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:03.861Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 28
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 14", Processing: false
[2025-11-19T16:38:03.863Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 14",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 14", Processing: false
[2025-11-19T16:38:03.864Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 14",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 29,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:03.865Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:03.866Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570283858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 14",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 14\""
}
[2025-11-19T16:38:03.866Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570283858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:03.867Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570283858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:04.907Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570283858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1040,
  "reasoning": "Respuesta recibida de Gemini en 1040ms. Extrayendo JSON..."
}
[2025-11-19T16:38:04.908Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570283858,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1042,
  "apiCallTimeMs": 1040,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 14"
üîç [DEBUG] Texto en min√∫sculas: "input 14"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:04.915Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 14",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:04.915Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1052ms, Response: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?"
[2025-11-19T16:38:04.917Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1052,
  "responseMessage": "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a les conviene m√°s?",
  "reasoning": "Paso procesado en 1052ms. Respuesta: \"Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...\""
}
[2025-11-19T16:38:04.918Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Disculpe, no he captado bien la fecha. ¬øQu√© d√≠a le..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:04.923Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1065,
  "geminiTimeMs": 1042,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1052,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:04.924Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:04.925Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:04.926Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 30
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 15", Processing: false
[2025-11-19T16:38:04.928Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 15",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 15", Processing: false
[2025-11-19T16:38:04.929Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 15",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 31,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:04.929Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:04.930Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570284924,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 15",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 15\""
}
[2025-11-19T16:38:04.930Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570284924,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:04.931Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570284924,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:05.934Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570284924,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1002,
  "reasoning": "Respuesta recibida de Gemini en 1002ms. Extrayendo JSON..."
}
[2025-11-19T16:38:05.935Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570284924,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1005,
  "apiCallTimeMs": 1002,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 15"
üîç [DEBUG] Texto en min√∫sculas: "input 15"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:05.941Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 15",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:05.942Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1015ms, Response: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?"
[2025-11-19T16:38:05.943Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1015,
  "responseMessage": "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?",
  "reasoning": "Paso procesado en 1015ms. Respuesta: \"No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...\""
}
[2025-11-19T16:38:05.945Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No lo he entendido bien. ¬øQu√© d√≠a quieren venir?...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, No lo he entendido bien. ¬øQu√© d√≠a quieren venir?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:05.948Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1024,
  "geminiTimeMs": 1005,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1015,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:05.949Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:05.950Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:05.950Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 32
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 16", Processing: false
[2025-11-19T16:38:05.952Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 16",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 16", Processing: false
[2025-11-19T16:38:05.953Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 16",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 33,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:05.955Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:05.955Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570285949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 16",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 16\""
}
[2025-11-19T16:38:05.956Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570285949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:05.957Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570285949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:06.884Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570285949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 927,
  "reasoning": "Respuesta recibida de Gemini en 927ms. Extrayendo JSON..."
}
[2025-11-19T16:38:06.884Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570285949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 929,
  "apiCallTimeMs": 927,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 16"
üîç [DEBUG] Texto en min√∫sculas: "input 16"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:06.891Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 16",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:06.891Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 940ms, Response: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?"
[2025-11-19T16:38:06.892Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 940,
  "responseMessage": "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reserva?",
  "reasoning": "Paso procesado en 940ms. Respuesta: \"¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:38:06.894Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øPodr√≠an repetirlo, por favor? ¬øPara qu√© d√≠a desean la reser..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:06.897Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 948,
  "geminiTimeMs": 929,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 940,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:06.899Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:06.899Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:06.900Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 34
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 17", Processing: false
[2025-11-19T16:38:06.901Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 17",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 17", Processing: false
[2025-11-19T16:38:06.904Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 17",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 35,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:06.905Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:06.905Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570286898,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 17",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 17\""
}
[2025-11-19T16:38:06.906Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570286898,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:06.907Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570286898,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:07.956Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570286898,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1049,
  "reasoning": "Respuesta recibida de Gemini en 1049ms. Extrayendo JSON..."
}
[2025-11-19T16:38:07.957Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570286898,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1052,
  "apiCallTimeMs": 1049,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 17"
üîç [DEBUG] Texto en min√∫sculas: "input 17"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:07.963Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 17",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:07.963Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1061ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:38:07.965Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1061,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 1061ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:38:07.966Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 13ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:07.980Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1082,
  "geminiTimeMs": 1052,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1061,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:07.981Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:07.982Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:07.983Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 36
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 18", Processing: false
[2025-11-19T16:38:07.984Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 18",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 18", Processing: false
[2025-11-19T16:38:07.987Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 18",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 37,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:07.987Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:07.988Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570287981,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 18",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 18\""
}
[2025-11-19T16:38:07.988Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570287981,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:07.989Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570287981,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:08.983Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570287981,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 994,
  "reasoning": "Respuesta recibida de Gemini en 994ms. Extrayendo JSON..."
}
[2025-11-19T16:38:08.984Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570287981,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 996,
  "apiCallTimeMs": 994,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 18"
üîç [DEBUG] Texto en min√∫sculas: "input 18"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:08.990Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 18",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:08.991Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 1005ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:38:08.992Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1005,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1005ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:38:08.993Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:08.999Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1018,
  "geminiTimeMs": 996,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1005,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:09.000Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:09.000Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:09.001Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 38
}
[BEFORE_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Input: "Input 19", Processing: false
[2025-11-19T16:38:09.002Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "Input 19",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "Input 19", Processing: false
[2025-11-19T16:38:09.006Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "Input 19",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 39,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:09.006Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:09.007Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570288999,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Input 19",
  "inputLength": 8,
  "context": {
    "step": "ask_date",
    "callSid": "CA_perf_1763570268456"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Input 19\""
}
[2025-11-19T16:38:09.007Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570288999,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:09.008Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570288999,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:09.986Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570288999,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 977,
  "reasoning": "Respuesta recibida de Gemini en 977ms. Extrayendo JSON..."
}
[2025-11-19T16:38:09.987Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_perf_1763570268456",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570288999,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 980,
  "apiCallTimeMs": 977,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "Input 19"
üîç [DEBUG] Texto en min√∫sculas: "input 19"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:09.993Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "Input 19",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:09.994Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_perf_1763570268456, Step: ask_date, Time: 992ms, Response: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico."
[2025-11-19T16:38:09.995Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 992,
  "responseMessage": "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana, pasado ma√±ana, o un d√≠a espec√≠fico.",
  "reasoning": "Paso procesado en 992ms. Respuesta: \"¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...\""
}
[2025-11-19T16:38:09.997Z] [INFO] STATE_PERSIST {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, ¬øPara qu√© d√≠a les gustar√≠a venir? Pueden decir ma√±ana,..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:10.000Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_perf_1763570268456",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1001,
  "geminiTimeMs": 980,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 992,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[31m‚ùå [16:38:10][0m FAILED: Rendimiento - Bajo Carga (20 iteraciones) (21545ms)
[33m‚ö†Ô∏è [16:38:10][0m   Expected to contain: "avg"
[35müìã [16:38:10][0m GRUPO 9: Casos de Errores Simulados
[36müß™ [16:38:10][0m üî• EXTREME: Error - Campos Requeridos Faltantes
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:10.005Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:10.006Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:10.572Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_missing_fields_1763570290005, Step: greeting, Input: "Reserva", Processing: false
[2025-11-19T16:38:10.573Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Reserva",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Reserva", Processing: false
[2025-11-19T16:38:10.574Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Reserva",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": null,
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:10.575Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:38:10.575Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "greeting",
  "userInput": "Reserva",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Reserva\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:38:10.576Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_missing_fields_1763570290005",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570290005,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Reserva",
  "inputLength": 7,
  "context": {
    "step": "greeting",
    "callSid": "CA_missing_fields_1763570290005"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Reserva\""
}
[2025-11-19T16:38:10.576Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_missing_fields_1763570290005",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570290005,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:10.577Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_missing_fields_1763570290005",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570290005,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:11.494Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_missing_fields_1763570290005",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570290005,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 916,
  "reasoning": "Respuesta recibida de Gemini en 916ms. Extrayendo JSON..."
}
[2025-11-19T16:38:11.495Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_missing_fields_1763570290005",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570290005,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 919,
  "apiCallTimeMs": 916,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:11.495Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:38:11.496Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:38:11.498Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 924
}
[AFTER_PROCESS_STEP] CallSid: CA_missing_fields_1763570290005, Step: ask_people, Time: 924ms, Response: "¬°Vale! ¬øPara cu√°ntas personas?"
[2025-11-19T16:38:11.499Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 924,
  "responseMessage": "¬°Vale! ¬øPara cu√°ntas personas?",
  "reasoning": "Paso procesado en 924ms. Respuesta: \"¬°Vale! ¬øPara cu√°ntas personas?...\""
}
[2025-11-19T16:38:11.499Z] [INFO] STATE_PERSIST {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Vale! ¬øPara cu√°ntas personas?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, ¬°Vale! ¬øPara cu√°ntas personas?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:11.502Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_missing_fields_1763570290005",
  "direction": "inbound",
  "accountSid": "AC_test_account",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1497,
  "geminiTimeMs": 919,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 924,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:38:11][0m PASSED: Error - Campos Requeridos Faltantes (1499ms)
[36müß™ [16:38:11][0m üî• EXTREME: Error - Estructura de Request Inv√°lida
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: undefined, HasBody: true, BodyType: object
[2025-11-19T16:38:11.506Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:11.506Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_invalid_struct_1763570291505",
  "hasSpeechResult": true
}
[2025-11-19T16:38:12.097Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_invalid_struct_1763570291505, Step: greeting, Input: "test", Processing: false
[2025-11-19T16:38:12.098Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "test",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "test", Processing: false
[2025-11-19T16:38:12.099Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "test",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": null,
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:12.100Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "greeting",
  "userInput": "test",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:38:12.100Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "greeting",
  "userInput": "test",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"test\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:38:12.101Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_invalid_struct_1763570291505",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570291505,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "test",
  "inputLength": 4,
  "context": {
    "step": "greeting",
    "callSid": "CA_invalid_struct_1763570291505"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"test\""
}
[2025-11-19T16:38:12.102Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_invalid_struct_1763570291505",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570291505,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:12.102Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_invalid_struct_1763570291505",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570291505,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8377,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8377 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:13.110Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_invalid_struct_1763570291505",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570291505,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1007,
  "reasoning": "Respuesta recibida de Gemini en 1007ms. Extrayendo JSON..."
}
[2025-11-19T16:38:13.110Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_invalid_struct_1763570291505",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570291505,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1009,
  "apiCallTimeMs": 1007,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:13.111Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:38:13.111Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:38:13.113Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_invalid_struct_1763570291505",
  "from": "greeting",
  "to": "ask_people",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 1014
}
[AFTER_PROCESS_STEP] CallSid: CA_invalid_struct_1763570291505, Step: ask_people, Time: 1014ms, Response: "¬°Genial! ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:38:13.114Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1014,
  "responseMessage": "¬°Genial! ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 1014ms. Respuesta: \"¬°Genial! ¬øPara cu√°ntas personas ser√°?...\""
}
[2025-11-19T16:38:13.115Z] [INFO] STATE_PERSIST {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Genial! ¬øPara cu√°ntas personas ser√°?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, ¬°Genial! ¬øPara cu√°ntas personas ser√°?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:13.118Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_invalid_struct_1763570291505",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1613,
  "geminiTimeMs": 1009,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1014,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:38:13][0m PASSED: Error - Estructura de Request Inv√°lida (1615ms)
[35müìã [16:38:13][0m GRUPO 10: Casos de Validaci√≥n Extrema
[36müß™ [16:38:13][0m üî• EXTREME: Validaci√≥n - Variaciones de Tel√©fono (14 formatos)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:13.122Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:13.123Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:13.706Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: greeting, Input: "666123456", Processing: false
[2025-11-19T16:38:13.707Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "666123456", Processing: false
[2025-11-19T16:38:13.708Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "666123456",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:13.709Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "666123456",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:38:13.710Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "666123456",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"666123456\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:38:13.710Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570293122,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "666123456",
  "inputLength": 9,
  "context": {
    "step": "greeting",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"666123456\""
}
[2025-11-19T16:38:13.711Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570293122,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:13.711Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570293122,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8382,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8382 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:14.695Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570293122,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 983,
  "reasoning": "Respuesta recibida de Gemini en 983ms. Extrayendo JSON..."
}
[2025-11-19T16:38:14.696Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570293122,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 986,
  "apiCallTimeMs": 983,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:14.696Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": null
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:38:14.697Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:38:14.699Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 991
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 991ms, Response: "¬°Genial! ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:38:14.700Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 991,
  "responseMessage": "¬°Genial! ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 991ms. Respuesta: \"¬°Genial! ¬øPara cu√°ntas personas ser√°?...\""
}
[2025-11-19T16:38:14.700Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Genial! ¬øPara cu√°ntas personas ser√°?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, ¬°Genial! ¬øPara cu√°ntas personas ser√°?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:14.704Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1582,
  "geminiTimeMs": 986,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 991,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:14.766Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:14.766Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:14.767Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "+34666123456", Processing: false
[2025-11-19T16:38:14.770Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 12,
  "inputPreview": "+34666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "+34666123456", Processing: false
[2025-11-19T16:38:14.771Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "+34666123456",
  "inputLength": 12,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:14.772Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570294765,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "+34666123456",
  "inputLength": 12,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"+34666123456\""
}
[2025-11-19T16:38:14.772Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570294765,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:14.773Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570294765,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8385,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8385 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:15.727Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570294765,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 954,
  "reasoning": "Respuesta recibida de Gemini en 954ms. Extrayendo JSON..."
}
[2025-11-19T16:38:15.728Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570294765,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 956,
  "apiCallTimeMs": 954,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:15.730Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "+34666123456",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:15.731Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 961ms, Response: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:38:15.732Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 961,
  "responseMessage": "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 961ms. Respuesta: \"Disculpe, no he entendido bien. ¬øCu√°ntas personas ...\""
}
[2025-11-19T16:38:15.732Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:15.736Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 971,
  "geminiTimeMs": 956,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 961,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:15.800Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:15.800Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:15.802Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "0034666123456", Processing: false
[2025-11-19T16:38:15.804Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 13,
  "inputPreview": "0034666123456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "0034666123456", Processing: false
[2025-11-19T16:38:15.805Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "0034666123456",
  "inputLength": 13,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:15.806Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570295799,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "0034666123456",
  "inputLength": 13,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"0034666123456\""
}
[2025-11-19T16:38:15.807Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570295799,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:15.807Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570295799,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8386,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8386 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:16.996Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570295799,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 703,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1188,
  "reasoning": "Respuesta recibida de Gemini en 1188ms. Extrayendo JSON..."
}
[2025-11-19T16:38:16.997Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570295799,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1191,
  "apiCallTimeMs": 1188,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:16.999Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "0034666123456",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:16.999Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 1195ms, Response: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?"
[2025-11-19T16:38:17.001Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1195,
  "responseMessage": "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?",
  "reasoning": "Paso procesado en 1195ms. Respuesta: \"Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...\""
}
[2025-11-19T16:38:17.001Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:17.005Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1206,
  "geminiTimeMs": 1191,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1195,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:17.061Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:17.062Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:17.062Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "666-123-456", Processing: false
[2025-11-19T16:38:17.063Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "666-123-456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "666-123-456", Processing: false
[2025-11-19T16:38:17.064Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "666-123-456",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:17.065Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570297060,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "666-123-456",
  "inputLength": 11,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"666-123-456\""
}
[2025-11-19T16:38:17.066Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570297060,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:17.066Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570297060,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:18.045Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570297060,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 978,
  "reasoning": "Respuesta recibida de Gemini en 978ms. Extrayendo JSON..."
}
[2025-11-19T16:38:18.045Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570297060,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 980,
  "apiCallTimeMs": 978,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:18.046Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "666-123-456",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:18.047Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 984ms, Response: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:38:18.048Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 984,
  "responseMessage": "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 984ms. Respuesta: \"Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...\""
}
[2025-11-19T16:38:18.049Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, Lo siento, no he captado bien el n√∫mero. ¬øPara c..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:18.052Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 992,
  "geminiTimeMs": 980,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 984,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:18.106Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:18.107Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:18.107Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "666 123 456", Processing: false
[2025-11-19T16:38:18.108Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "666 123 456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "666 123 456", Processing: false
[2025-11-19T16:38:18.110Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "666 123 456",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:18.110Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570298105,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "666 123 456",
  "inputLength": 11,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"666 123 456\""
}
[2025-11-19T16:38:18.111Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570298105,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:18.111Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570298105,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:19.039Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570298105,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 701,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 927,
  "reasoning": "Respuesta recibida de Gemini en 927ms. Extrayendo JSON..."
}
[2025-11-19T16:38:19.040Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570298105,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 930,
  "apiCallTimeMs": 927,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:19.041Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "666 123 456",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:19.042Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 933ms, Response: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?"
[2025-11-19T16:38:19.043Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 933,
  "responseMessage": "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 933ms. Respuesta: \"No he entendido bien. ¬øMe puede decir cu√°ntas pers...\""
}
[2025-11-19T16:38:19.044Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, No he entendido bien. ¬øMe puede decir cu√°ntas persona..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:19.047Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 942,
  "geminiTimeMs": 930,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 933,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:19.103Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:19.103Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:19.104Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "(666) 123-456", Processing: false
[2025-11-19T16:38:19.105Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 13,
  "inputPreview": "(666) 123-456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "(666) 123-456", Processing: false
[2025-11-19T16:38:19.106Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "(666) 123-456",
  "inputLength": 13,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:19.107Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570299102,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "(666) 123-456",
  "inputLength": 13,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"(666) 123-456\""
}
[2025-11-19T16:38:19.107Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570299102,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:19.108Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570299102,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8386,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8386 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:20.153Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570299102,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 703,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1044,
  "reasoning": "Respuesta recibida de Gemini en 1044ms. Extrayendo JSON..."
}
[2025-11-19T16:38:20.154Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570299102,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1047,
  "apiCallTimeMs": 1044,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:20.154Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "(666) 123-456",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:20.155Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 1049ms, Response: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:38:20.156Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1049,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 1049ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...\""
}
[2025-11-19T16:38:20.156Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bien, Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas se..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:20.160Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1058,
  "geminiTimeMs": 1047,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1049,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:20.226Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:20.226Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:20.227Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "666.123.456", Processing: false
[2025-11-19T16:38:20.229Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "666.123.456",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "666.123.456", Processing: false
[2025-11-19T16:38:20.230Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "666.123.456",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:20.230Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570300225,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "666.123.456",
  "inputLength": 11,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"666.123.456\""
}
[2025-11-19T16:38:20.231Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570300225,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:20.232Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570300225,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:21.315Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570300225,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 701,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1083,
  "reasoning": "Respuesta recibida de Gemini en 1083ms. Extrayendo JSON..."
}
[2025-11-19T16:38:21.316Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570300225,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1086,
  "apiCallTimeMs": 1083,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:21.316Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "666.123.456",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:21.317Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 1089ms, Response: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:38:21.318Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1089,
  "responseMessage": "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 1089ms. Respuesta: \"Disculpe, no he entendido bien. ¬øCu√°ntas personas ...\""
}
[2025-11-19T16:38:21.319Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:21.322Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1097,
  "geminiTimeMs": 1086,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1089,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:21.382Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:21.383Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:21.384Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "123", Processing: false
[2025-11-19T16:38:21.385Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 3,
  "inputPreview": "123",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "123", Processing: false
[2025-11-19T16:38:21.386Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "123",
  "inputLength": 3,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:21.386Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570301382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "123",
  "inputLength": 3,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"123\""
}
[2025-11-19T16:38:21.387Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570301382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:21.387Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570301382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8376,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8376 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:22.436Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570301382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1048,
  "reasoning": "Respuesta recibida de Gemini en 1048ms. Extrayendo JSON..."
}
[2025-11-19T16:38:22.437Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570301382,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1051,
  "apiCallTimeMs": 1048,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:22.438Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "123",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:22.438Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 1054ms, Response: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:38:22.440Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1054,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 1054ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...\""
}
[2025-11-19T16:38:22.440Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perfecto, Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:22.444Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1062,
  "geminiTimeMs": 1051,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1054,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:22.502Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:22.503Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:22.503Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "12345678901234567890", Processing: false
[2025-11-19T16:38:22.504Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 20,
  "inputPreview": "12345678901234567890",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "12345678901234567890", Processing: false
[2025-11-19T16:38:22.506Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "12345678901234567890",
  "inputLength": 20,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:22.506Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570302501,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "12345678901234567890",
  "inputLength": 20,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"12345678901234567890\""
}
[2025-11-19T16:38:22.507Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570302501,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:22.507Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570302501,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8393,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8393 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:23.500Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570302501,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 992,
  "reasoning": "Respuesta recibida de Gemini en 992ms. Extrayendo JSON..."
}
[2025-11-19T16:38:23.501Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570302501,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 995,
  "apiCallTimeMs": 992,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:23.502Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "12345678901234567890",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:23.503Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 998ms, Response: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?"
[2025-11-19T16:38:23.504Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 998,
  "responseMessage": "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?",
  "reasoning": "Paso procesado en 998ms. Respuesta: \"Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...\""
}
[2025-11-19T16:38:23.504Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Vale, Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:23.508Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1007,
  "geminiTimeMs": 995,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 998,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:23.564Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:23.565Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:23.566Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 18
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "abc123def", Processing: false
[2025-11-19T16:38:23.567Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 9,
  "inputPreview": "abc123def",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "abc123def", Processing: false
[2025-11-19T16:38:23.568Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "abc123def",
  "inputLength": 9,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 19,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:23.569Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570303564,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "abc123def",
  "inputLength": 9,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"abc123def\""
}
[2025-11-19T16:38:23.569Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570303564,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:23.570Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570303564,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8382,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8382 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:24.579Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570303564,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1008,
  "reasoning": "Respuesta recibida de Gemini en 1008ms. Extrayendo JSON..."
}
[2025-11-19T16:38:24.580Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570303564,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1011,
  "apiCallTimeMs": 1008,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:24.580Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "abc123def",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:24.581Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 1015ms, Response: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor."
[2025-11-19T16:38:24.582Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1015,
  "responseMessage": "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor.",
  "reasoning": "Paso procesado en 1015ms. Respuesta: \"¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...\""
}
[2025-11-19T16:38:24.583Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, ¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫me..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:24.586Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1022,
  "geminiTimeMs": 1011,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1015,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:24.645Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:24.645Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:24.646Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 20
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "666-123-456 ext 789", Processing: false
[2025-11-19T16:38:24.647Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 19,
  "inputPreview": "666-123-456 ext 789",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "666-123-456 ext 789", Processing: false
[2025-11-19T16:38:24.648Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "666-123-456 ext 789",
  "inputLength": 19,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 21,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:24.649Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570304644,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "666-123-456 ext 789",
  "inputLength": 19,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"666-123-456 ext 789\""
}
[2025-11-19T16:38:24.649Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570304644,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:24.650Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570304644,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8392,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8392 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:25.658Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570304644,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 709,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1008,
  "reasoning": "Respuesta recibida de Gemini en 1008ms. Extrayendo JSON..."
}
[2025-11-19T16:38:25.659Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570304644,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1010,
  "apiCallTimeMs": 1008,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:25.660Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "666-123-456 ext 789",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:25.661Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {},
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Time: 1014ms, Response: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:38:25.662Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1014,
  "responseMessage": "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 1014ms. Respuesta: \"Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...\""
}
[2025-11-19T16:38:25.662Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas perso..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:25.666Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1022,
  "geminiTimeMs": 1010,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1014,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:25.733Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:25.734Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:25.734Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 22
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_people, Input: "+1-555-123-4567", Processing: false
[2025-11-19T16:38:25.735Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 15,
  "inputPreview": "+1-555-123-4567",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "+1-555-123-4567", Processing: false
[2025-11-19T16:38:25.737Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "+1-555-123-4567",
  "inputLength": 15,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 23,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:25.737Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570305732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "+1-555-123-4567",
  "inputLength": 15,
  "context": {
    "step": "ask_people",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"+1-555-123-4567\""
}
[2025-11-19T16:38:25.738Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570305732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:25.738Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570305732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8388,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8388 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:26.866Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570305732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 705,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1127,
  "reasoning": "Respuesta recibida de Gemini en 1127ms. Extrayendo JSON..."
}
[2025-11-19T16:38:26.867Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570305732,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1130,
  "apiCallTimeMs": 1127,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:26.867Z] [INFO] PEOPLE_EXTRACTED_ANY_NUMBER {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "number": 1
}
[2025-11-19T16:38:26.869Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": "1",
    "comensales_confidence": "90%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "+1-555-123-4567",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: 1 personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:26.869Z] [RESERVATION] PEOPLE_APPLIED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "peopleCount": 1,
  "credibilidad": "90%"
}
[2025-11-19T16:38:26.870Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": true,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[2025-11-19T16:38:26.870Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "ask_people",
  "to": "ask_date",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1134
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_date, Time: 1134ms, Response: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?"
[2025-11-19T16:38:26.872Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1134,
  "responseMessage": "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean hacer la reserva?",
  "reasoning": "Paso procesado en 1134ms. Respuesta: \"Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...\""
}
[2025-11-19T16:38:26.872Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desea...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Vale, Perfecto, mesa para 1 persona. ¬øPara qu√© d√≠a desean ha..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:26.878Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1146,
  "geminiTimeMs": 1130,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1134,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:26.933Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:26.933Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:26.934Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 24
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_date, Input: "sin tel√©fono", Processing: false
[2025-11-19T16:38:26.937Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 12,
  "inputPreview": "sin tel√©fono",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "sin tel√©fono", Processing: false
[2025-11-19T16:38:26.939Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "sin tel√©fono",
  "inputLength": 12,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 25,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:26.941Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:26.941Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570306932,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "sin tel√©fono",
  "inputLength": 12,
  "context": {
    "step": "ask_date",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"sin tel√©fono\""
}
[2025-11-19T16:38:26.942Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570306932,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:26.943Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570306932,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8385,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8385 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:27.930Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570306932,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 987,
  "reasoning": "Respuesta recibida de Gemini en 987ms. Extrayendo JSON..."
}
[2025-11-19T16:38:27.931Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570306932,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 990,
  "apiCallTimeMs": 987,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "sin tel√©fono"
üîç [DEBUG] Texto en min√∫sculas: "sin tel√©fono"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:27.956Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "sin tel√©fono",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:27.957Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_date, Time: 1020ms, Response: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?"
[2025-11-19T16:38:27.958Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1020,
  "responseMessage": "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?",
  "reasoning": "Paso procesado en 1020ms. Respuesta: \"Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...\""
}
[2025-11-19T16:38:27.959Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Emm, Perd√≥n, no lo he captado. ¬øQu√© d√≠a les viene mejor?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 4ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:27.964Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1032,
  "geminiTimeMs": 990,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1020,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:28.019Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:28.019Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:28.020Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasData": true,
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  },
  "conversationHistoryLength": 26
}
[BEFORE_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_date, Input: "no tengo tel√©fono", Processing: false
[2025-11-19T16:38:28.021Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "hasInput": true,
  "inputLength": 17,
  "inputPreview": "no tengo tel√©fono",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_date, Input: "no tengo tel√©fono", Processing: false
[2025-11-19T16:38:28.022Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "currentStep": "ask_date",
  "userInput": "no tengo tel√©fono",
  "inputLength": 17,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": 1,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 27,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:28.023Z] [INFO] üìä CRITICAL_STEP_DETECTED {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "reasoning": "Paso cr√≠tico detectado. Usando Gemini para verificar si hay datos v√°lidos antes de buscar cancelaci√≥n",
  "expectedField": "fecha"
}
[2025-11-19T16:38:28.023Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570308018,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "no tengo tel√©fono",
  "inputLength": 17,
  "context": {
    "step": "ask_date",
    "callSid": "CA_phone_variations_1763570293122"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"no tengo tel√©fono\""
}
[2025-11-19T16:38:28.024Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570308018,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:28.024Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570308018,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8390,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8390 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:29.030Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570308018,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1005,
  "reasoning": "Respuesta recibida de Gemini en 1005ms. Extrayendo JSON..."
}
[2025-11-19T16:38:29.030Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_phone_variations_1763570293122",
  "step": "ask_date",
  "performanceMetrics": {
    "requestStart": 1763570308018,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1007,
  "apiCallTimeMs": 1005,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
üîç [DEBUG] isCancellationRequest - Analizando: "no tengo tel√©fono"
üîç [DEBUG] Texto en min√∫sculas: "no tengo tel√©fono"
üîç [DEBUG] Palabras de cancelaci√≥n encontradas: false
üîç [DEBUG] Patrones simples de cancelaci√≥n encontrados: false
üîç [DEBUG] Patrones de cancelaci√≥n encontrados: false
üîç [DEBUG] Resultado final isCancellationRequest: false
üîç [DEBUG] - Palabras: false
üîç [DEBUG] - Patrones simples: false
üîç [DEBUG] - Patrones complejos: false
[2025-11-19T16:38:29.046Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NumeroReserva": 1
  },
  "currentLanguage": "es",
  "originalText": "no tengo tel√©fono",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NumeroReserva\":1}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:29.047Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "stateBefore": {
    "NumeroReserva": 1
  },
  "stateAfter": {
    "NumeroReserva": 1
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_phone_variations_1763570293122, Step: ask_date, Time: 1025ms, Response: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?"
[2025-11-19T16:38:29.048Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "processStepTimeMs": 1025,
  "responseMessage": "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?",
  "reasoning": "Paso procesado en 1025ms. Respuesta: \"Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...\""
}
[2025-11-19T16:38:29.050Z] [INFO] STATE_PERSIST {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "dataKeys": [
    "NumeroReserva"
  ],
  "dataValues": {
    "NumeroReserva": 1
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a pr...", UseAlgieba: true, NaturalFlow: true, Step: ask_date
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no he entendido bien la fecha. ¬øQu√© d√≠a prefieren?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:29.053Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_phone_variations_1763570293122",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_date",
  "totalTimeMs": 1035,
  "geminiTimeMs": 1007,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1025,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[32m‚úÖ [16:38:29][0m PASSED: Validaci√≥n - Variaciones de Tel√©fono (14 formatos) (15986ms)
[36müß™ [16:38:29][0m üî• EXTREME: Validaci√≥n - Variaciones de Nombre (15 formatos)
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:29.110Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:29.111Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:29.674Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 0
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: greeting, Input: "Juan", Processing: false
[2025-11-19T16:38:29.675Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "hasInput": true,
  "inputLength": 4,
  "inputPreview": "Juan",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: greeting, Input: "Juan", Processing: false
[2025-11-19T16:38:29.677Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "currentStep": "greeting",
  "userInput": "Juan",
  "inputLength": 4,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 1,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:29.677Z] [INFO] üëã GREETING_STEP_START {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Juan",
  "reasoning": "Iniciando paso de saludo. Usuario ha proporcionado input, analizando con Gemini..."
}
[2025-11-19T16:38:29.678Z] [INFO] üß† ANALYZING_GREETING_INPUT_WITH_GEMINI {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "userInput": "Juan",
  "reasoning": "Usuario proporcion√≥ input en el saludo: \"Juan\". Usando Gemini para extraer toda la informaci√≥n posible (intenci√≥n, idioma, datos de reserva)."
}
[2025-11-19T16:38:29.678Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570309110,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan",
  "inputLength": 4,
  "context": {
    "step": "greeting",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan\""
}
[2025-11-19T16:38:29.679Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570309110,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:29.680Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570309110,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8377,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8377 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:30.635Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570309110,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 696,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 955,
  "reasoning": "Respuesta recibida de Gemini en 955ms. Extrayendo JSON..."
}
[2025-11-19T16:38:30.635Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "greeting",
  "performanceMetrics": {
    "requestStart": 1763570309110,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 957,
  "apiCallTimeMs": 955,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan"
}
[2025-11-19T16:38:30.636Z] [INFO] ‚úÖ GEMINI_ANALYSIS_RECEIVED_IN_GREETING {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intencion": "clarify",
  "idioma_detectado": "es",
  "datos_extraidos": {
    "comensales": null,
    "fecha": null,
    "hora": null,
    "nombre": "Juan"
  },
  "reasoning": "Gemini complet√≥ el an√°lisis. Intenci√≥n: clarify, Idioma: es. Procesando..."
}
[2025-11-19T16:38:30.637Z] [INFO] üéØ INTENTION_DETECTED_IN_GREETING {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "intention": "clarify",
  "reasoning": "Intenci√≥n detectada: clarify. Procesando como pedido..."
}
‚úÖ Usando mensajes en es para tipo reservation
[2025-11-19T16:38:30.639Z] [INFO] STEP_TRANSITION {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "greeting",
  "to": "ask_people",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "greeting",
  "processStepTimeMs": 963
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 963ms, Response: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:38:30.640Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 963,
  "responseMessage": "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 963ms. Respuesta: \"¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?...\""
}
[2025-11-19T16:38:30.640Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [],
  "dataValues": {}
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, ¬°Claro! Sin problema. ¬øCu√°ntas personas ser√°n?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:30.645Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1535,
  "geminiTimeMs": 957,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 963,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:30.701Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:30.702Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:30.702Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": false,
  "dataKeys": [],
  "dataValues": {},
  "conversationHistoryLength": 2
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "Juan Carlos", Processing: false
[2025-11-19T16:38:30.703Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 11,
  "inputPreview": "Juan Carlos",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Juan Carlos", Processing: false
[2025-11-19T16:38:30.705Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Juan Carlos",
  "inputLength": 11,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": null,
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 3,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:30.705Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570310700,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan Carlos",
  "inputLength": 11,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan Carlos\""
}
[2025-11-19T16:38:30.706Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570310700,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:30.706Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570310700,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8384,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8384 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:31.776Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570310700,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 703,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1069,
  "reasoning": "Respuesta recibida de Gemini en 1069ms. Extrayendo JSON..."
}
[2025-11-19T16:38:31.777Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570310700,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1072,
  "apiCallTimeMs": 1069,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan Carlos",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan Carlos"
}
[2025-11-19T16:38:31.777Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan Carlos",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {},
  "currentLanguage": "es",
  "originalText": "Juan Carlos",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan Carlos"
}
[2025-11-19T16:38:31.778Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "Juan Carlos",
  "credibilidad": "100%"
}
[2025-11-19T16:38:31.778Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {},
  "stateAfter": {
    "NomReserva": "Juan Carlos"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 1075ms, Response: "¬øPodr√≠a repetirlo, por favor? ¬øPara cu√°ntas personas?"
[2025-11-19T16:38:31.779Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1075,
  "responseMessage": "¬øPodr√≠a repetirlo, por favor? ¬øPara cu√°ntas personas?",
  "reasoning": "Paso procesado en 1075ms. Respuesta: \"¬øPodr√≠a repetirlo, por favor? ¬øPara cu√°ntas person...\""
}
[2025-11-19T16:38:31.780Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan Carlos"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPodr√≠a repetirlo, por favor? ¬øPara cu√°ntas person...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "¬øPodr√≠a repetirlo, por favor? ¬øPara cu√°ntas personas?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:31.783Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1083,
  "geminiTimeMs": 1072,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1075,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:31.839Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:31.839Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:31.840Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan Carlos"
  },
  "conversationHistoryLength": 4
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "Juan Carlos P√©rez Garc√≠a", Processing: false
[2025-11-19T16:38:31.841Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 24,
  "inputPreview": "Juan Carlos P√©rez Garc√≠a",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Juan Carlos P√©rez Garc√≠a", Processing: false
[2025-11-19T16:38:31.842Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Juan Carlos P√©rez Garc√≠a",
  "inputLength": 24,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "Juan Carlos",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 5,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:31.843Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570311838,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan Carlos P√©rez Garc√≠a",
  "inputLength": 24,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan Carlos P√©rez Garc√≠a\""
}
[2025-11-19T16:38:31.843Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570311838,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:31.844Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570311838,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8397,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8397 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:32.836Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570311838,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 716,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 992,
  "reasoning": "Respuesta recibida de Gemini en 992ms. Extrayendo JSON..."
}
[2025-11-19T16:38:32.837Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570311838,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 994,
  "apiCallTimeMs": 992,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan Carlos P√©rez Garc√≠a"
}
[2025-11-19T16:38:32.838Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "Juan Carlos"
  },
  "currentLanguage": "es",
  "originalText": "Juan Carlos P√©rez Garc√≠a",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"Juan Carlos\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan Carlos P√©rez Garc√≠a"
}
[2025-11-19T16:38:32.838Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "Juan Carlos P√©rez Garc√≠a",
  "nombreAnterior": "Juan Carlos",
  "credibilidad": "100%"
}
[2025-11-19T16:38:32.839Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "Juan Carlos"
  },
  "stateAfter": {
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 997ms, Response: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:38:32.840Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 997,
  "responseMessage": "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 997ms. Respuesta: \"Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas v...\""
}
[2025-11-19T16:38:32.840Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas v...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:32.844Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1006,
  "geminiTimeMs": 994,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 997,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:32.905Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:32.905Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:32.906Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  },
  "conversationHistoryLength": 6
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "Mar√≠a Jos√©", Processing: false
[2025-11-19T16:38:32.907Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "Mar√≠a Jos√©",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Mar√≠a Jos√©", Processing: false
[2025-11-19T16:38:32.908Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Mar√≠a Jos√©",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "Juan Carlos P√©rez Garc√≠a",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 7,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:32.909Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570312904,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Mar√≠a Jos√©",
  "inputLength": 10,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Mar√≠a Jos√©\""
}
[2025-11-19T16:38:32.909Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570312904,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:32.910Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570312904,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:33.877Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570312904,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 967,
  "reasoning": "Respuesta recibida de Gemini en 967ms. Extrayendo JSON..."
}
[2025-11-19T16:38:33.878Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570312904,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 969,
  "apiCallTimeMs": 967,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Mar√≠a Jos√©",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Mar√≠a Jos√©"
}
[2025-11-19T16:38:33.879Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Mar√≠a Jos√©",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  },
  "currentLanguage": "es",
  "originalText": "Mar√≠a Jos√©",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"Juan Carlos P√©rez Garc√≠a\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Mar√≠a Jos√©"
}
[2025-11-19T16:38:33.880Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "Mar√≠a Jos√©",
  "nombreAnterior": "Juan Carlos P√©rez Garc√≠a",
  "credibilidad": "100%"
}
[2025-11-19T16:38:33.880Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "Juan Carlos P√©rez Garc√≠a"
  },
  "stateAfter": {
    "NomReserva": "Mar√≠a Jos√©"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 973ms, Response: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?"
[2025-11-19T16:38:33.881Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 973,
  "responseMessage": "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 973ms. Respuesta: \"No he entendido bien. ¬øMe puede decir cu√°ntas pers...\""
}
[2025-11-19T16:38:33.882Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Mar√≠a Jos√©"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:33.885Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 981,
  "geminiTimeMs": 969,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 973,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:33.950Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:33.950Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:33.951Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Mar√≠a Jos√©"
  },
  "conversationHistoryLength": 8
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "Jos√©-Mar√≠a", Processing: false
[2025-11-19T16:38:33.952Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "Jos√©-Mar√≠a",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Jos√©-Mar√≠a", Processing: false
[2025-11-19T16:38:33.953Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Jos√©-Mar√≠a",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "Mar√≠a Jos√©",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 9,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:33.954Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570313949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Jos√©-Mar√≠a",
  "inputLength": 10,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Jos√©-Mar√≠a\""
}
[2025-11-19T16:38:33.954Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570313949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:33.955Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570313949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:34.950Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570313949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 995,
  "reasoning": "Respuesta recibida de Gemini en 995ms. Extrayendo JSON..."
}
[2025-11-19T16:38:34.951Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570313949,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 997,
  "apiCallTimeMs": 995,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Jos√©-Mar√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Jos√©-Mar√≠a"
}
[2025-11-19T16:38:34.952Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Jos√©-Mar√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "Mar√≠a Jos√©"
  },
  "currentLanguage": "es",
  "originalText": "Jos√©-Mar√≠a",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"Mar√≠a Jos√©\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Jos√©-Mar√≠a"
}
[2025-11-19T16:38:34.952Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "Jos√©-Mar√≠a",
  "nombreAnterior": "Mar√≠a Jos√©",
  "credibilidad": "100%"
}
[2025-11-19T16:38:34.953Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "Mar√≠a Jos√©"
  },
  "stateAfter": {
    "NomReserva": "Jos√©-Mar√≠a"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 1000ms, Response: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?"
[2025-11-19T16:38:34.954Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1000,
  "responseMessage": "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas personas ser√° la reserva?",
  "reasoning": "Paso procesado en 1000ms. Respuesta: \"Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...\""
}
[2025-11-19T16:38:34.954Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Jos√©-Mar√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "Bien, Lo siento, no he captado bien el n√∫mero. ¬øPara cu√°ntas..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:34.958Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1009,
  "geminiTimeMs": 997,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1000,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:35.025Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:35.025Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:35.026Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Jos√©-Mar√≠a"
  },
  "conversationHistoryLength": 10
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "O'Connor", Processing: false
[2025-11-19T16:38:35.027Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 8,
  "inputPreview": "O'Connor",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "O'Connor", Processing: false
[2025-11-19T16:38:35.028Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "O'Connor",
  "inputLength": 8,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "Jos√©-Mar√≠a",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 11,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:35.029Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570315024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "O'Connor",
  "inputLength": 8,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"O'Connor\""
}
[2025-11-19T16:38:35.029Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570315024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:35.030Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570315024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8381,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8381 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:36.009Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570315024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 700,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 979,
  "reasoning": "Respuesta recibida de Gemini en 979ms. Extrayendo JSON..."
}
[2025-11-19T16:38:36.010Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570315024,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 981,
  "apiCallTimeMs": 979,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "O'Connor",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre O'Connor"
}
[2025-11-19T16:38:36.010Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "O'Connor",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "Jos√©-Mar√≠a"
  },
  "currentLanguage": "es",
  "originalText": "O'Connor",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"Jos√©-Mar√≠a\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre O'Connor"
}
[2025-11-19T16:38:36.011Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "O'Connor",
  "nombreAnterior": "Jos√©-Mar√≠a",
  "credibilidad": "100%"
}
[2025-11-19T16:38:36.012Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "Jos√©-Mar√≠a"
  },
  "stateAfter": {
    "NomReserva": "O'Connor"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 985ms, Response: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor."
[2025-11-19T16:38:36.013Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 985,
  "responseMessage": "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor.",
  "reasoning": "Paso procesado en 985ms. Respuesta: \"¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...\""
}
[2025-11-19T16:38:36.013Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "O'Connor"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "De acuerdo, ¬øPara cu√°ntas personas ser√° la reserva? D√≠game u..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:36.017Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 993,
  "geminiTimeMs": 981,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 985,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:36.069Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:36.069Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:36.070Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "O'Connor"
  },
  "conversationHistoryLength": 12
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "Van der Berg", Processing: false
[2025-11-19T16:38:36.071Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 12,
  "inputPreview": "Van der Berg",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Van der Berg", Processing: false
[2025-11-19T16:38:36.072Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Van der Berg",
  "inputLength": 12,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "O'Connor",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 13,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:36.073Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570316068,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Van der Berg",
  "inputLength": 12,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Van der Berg\""
}
[2025-11-19T16:38:36.073Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570316068,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:36.074Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570316068,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8385,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8385 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:37.108Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570316068,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 704,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1033,
  "reasoning": "Respuesta recibida de Gemini en 1033ms. Extrayendo JSON..."
}
[2025-11-19T16:38:37.108Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570316068,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1035,
  "apiCallTimeMs": 1033,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Van der Berg",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Van der Berg"
}
[2025-11-19T16:38:37.109Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Van der Berg",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "O'Connor"
  },
  "currentLanguage": "es",
  "originalText": "Van der Berg",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"O'Connor\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Van der Berg"
}
[2025-11-19T16:38:37.110Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "Van der Berg",
  "nombreAnterior": "O'Connor",
  "credibilidad": "100%"
}
[2025-11-19T16:38:37.110Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "O'Connor"
  },
  "stateAfter": {
    "NomReserva": "Van der Berg"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 1039ms, Response: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor."
[2025-11-19T16:38:37.111Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1039,
  "responseMessage": "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del 1 al 20, por favor.",
  "reasoning": "Paso procesado en 1039ms. Respuesta: \"¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...\""
}
[2025-11-19T16:38:37.112Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Van der Berg"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: confirming, Mensaje procesado: "¬øPara cu√°ntas personas ser√° la reserva? D√≠game un n√∫mero del..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:37.116Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1048,
  "geminiTimeMs": 1035,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1039,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:37.175Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:37.175Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:37.176Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Van der Berg"
  },
  "conversationHistoryLength": 14
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "De la Rosa", Processing: false
[2025-11-19T16:38:37.177Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "De la Rosa",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "De la Rosa", Processing: false
[2025-11-19T16:38:37.178Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "De la Rosa",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "Van der Berg",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 15,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:37.179Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570317174,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "De la Rosa",
  "inputLength": 10,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"De la Rosa\""
}
[2025-11-19T16:38:37.180Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570317174,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 1,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:37.180Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570317174,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:38.370Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570317174,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1189,
  "reasoning": "Respuesta recibida de Gemini en 1189ms. Extrayendo JSON..."
}
[2025-11-19T16:38:38.371Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570317174,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 1,
    "menuLoadTime": 1,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1192,
  "apiCallTimeMs": 1189,
  "dataLoadTimeMs": 1,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "De la Rosa",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre De la Rosa"
}
[2025-11-19T16:38:38.372Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "De la Rosa",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "Van der Berg"
  },
  "currentLanguage": "es",
  "originalText": "De la Rosa",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"Van der Berg\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre De la Rosa"
}
[2025-11-19T16:38:38.373Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "De la Rosa",
  "nombreAnterior": "Van der Berg",
  "credibilidad": "100%"
}
[2025-11-19T16:38:38.373Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "Van der Berg"
  },
  "stateAfter": {
    "NomReserva": "De la Rosa"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 1196ms, Response: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?"
[2025-11-19T16:38:38.374Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1196,
  "responseMessage": "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?",
  "reasoning": "Paso procesado en 1196ms. Respuesta: \"Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...\""
}
[2025-11-19T16:38:38.375Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "De la Rosa"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, no he entendido. ¬øCu√°ntas personas ser√°n en total?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:38.378Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1204,
  "geminiTimeMs": 1192,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 1,
  "menuLoadTimeMs": 1,
  "dbTimeMs": 0,
  "processStepTimeMs": 1196,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:38.441Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:38.442Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:38.442Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "De la Rosa"
  },
  "conversationHistoryLength": 16
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "123", Processing: false
[2025-11-19T16:38:38.444Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 3,
  "inputPreview": "123",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "123", Processing: false
[2025-11-19T16:38:38.445Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "123",
  "inputLength": 3,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "De la Rosa",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 17,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:38.445Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "De la Rosa"
  },
  "currentLanguage": "es",
  "originalText": "123",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"De la Rosa\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:38.446Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "De la Rosa"
  },
  "stateAfter": {
    "NomReserva": "De la Rosa"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 3ms, Response: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?"
[2025-11-19T16:38:38.447Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 3,
  "responseMessage": "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 3ms. Respuesta: \"No he entendido bien. ¬øMe puede decir cu√°ntas pers...\""
}
[2025-11-19T16:38:38.448Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "De la Rosa"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Aja, No he entendido bien. ¬øMe puede decir cu√°ntas personas ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:38.452Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 12,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 3,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:38.517Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:38.518Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:38.519Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "De la Rosa"
  },
  "conversationHistoryLength": 18
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "A", Processing: false
[2025-11-19T16:38:38.520Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 1,
  "inputPreview": "A",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "A", Processing: false
[2025-11-19T16:38:38.521Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "A",
  "inputLength": 1,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "De la Rosa",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 19,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 2ms, Response: "Disculpe, no he captado bien. ¬øPara cu√°ntas personas?"
[2025-11-19T16:38:38.523Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 2,
  "responseMessage": "Disculpe, no he captado bien. ¬øPara cu√°ntas personas?",
  "reasoning": "Paso procesado en 2ms. Respuesta: \"Disculpe, no he captado bien. ¬øPara cu√°ntas person...\""
}
[2025-11-19T16:38:38.523Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "De la Rosa"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he captado bien. ¬øPara cu√°ntas person...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, Disculpe, no he captado bien. ¬øPara cu√°ntas personas?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:38.528Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 11,
  "geminiTimeMs": 0,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 2,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:38.580Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:38.581Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:38.582Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "De la Rosa"
  },
  "conversationHistoryLength": 20
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA", Processing: false
[2025-11-19T16:38:38.583Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 100,
  "inputPreview": "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA", Processing: false
[2025-11-19T16:38:38.584Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
  "inputLength": 100,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "De la Rosa",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 21,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:38.586Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570318579,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
  "inputLength": 100,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\""
}
[2025-11-19T16:38:38.587Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570318579,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:38.588Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570318579,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8473,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8473 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:39.565Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570318579,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 692,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 977,
  "reasoning": "Respuesta recibida de Gemini en 977ms. Extrayendo JSON..."
}
[2025-11-19T16:38:39.566Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570318579,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 980,
  "apiCallTimeMs": 977,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:39.567Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": null,
    "nombre_confidence": "0%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "De la Rosa"
  },
  "currentLanguage": "es",
  "originalText": "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"De la Rosa\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, sin nombre"
}
[2025-11-19T16:38:39.567Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "De la Rosa"
  },
  "stateAfter": {
    "NomReserva": "De la Rosa"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": false
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 984ms, Response: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?"
[2025-11-19T16:38:39.569Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 984,
  "responseMessage": "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?",
  "reasoning": "Paso procesado en 984ms. Respuesta: \"Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...\""
}
[2025-11-19T16:38:39.569Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "De la Rosa"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas persona...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Disculpe, ¬øpodr√≠a repetirlo? ¬øPara cu√°ntas personas ser√°?..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:39.573Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 994,
  "geminiTimeMs": 980,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 984,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:39.627Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:39.627Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:39.628Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "De la Rosa"
  },
  "conversationHistoryLength": 22
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "Juan123", Processing: false
[2025-11-19T16:38:39.629Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 7,
  "inputPreview": "Juan123",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Juan123", Processing: false
[2025-11-19T16:38:39.630Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Juan123",
  "inputLength": 7,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "De la Rosa",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 23,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:39.631Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570319626,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan123",
  "inputLength": 7,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan123\""
}
[2025-11-19T16:38:39.632Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570319626,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:39.632Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570319626,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8380,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8380 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:40.697Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570319626,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 699,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 1064,
  "reasoning": "Respuesta recibida de Gemini en 1064ms. Extrayendo JSON..."
}
[2025-11-19T16:38:40.697Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570319626,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 1066,
  "apiCallTimeMs": 1064,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan123",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan123"
}
[2025-11-19T16:38:40.698Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan123",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "De la Rosa"
  },
  "currentLanguage": "es",
  "originalText": "Juan123",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"De la Rosa\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan123"
}
[2025-11-19T16:38:40.699Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "Juan123",
  "nombreAnterior": "De la Rosa",
  "credibilidad": "100%"
}
[2025-11-19T16:38:40.699Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "De la Rosa"
  },
  "stateAfter": {
    "NomReserva": "Juan123"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 1070ms, Response: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?"
[2025-11-19T16:38:40.700Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 1070,
  "responseMessage": "Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 1070ms. Respuesta: \"Disculpe, no he entendido bien. ¬øCu√°ntas personas ...\""
}
[2025-11-19T16:38:40.701Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan123"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Disculpe, no he entendido bien. ¬øCu√°ntas personas ...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Aja, Disculpe, no he entendido bien. ¬øCu√°ntas personas ser√°n..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 3ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:40.704Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 1078,
  "geminiTimeMs": 1066,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 1070,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:40.768Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:40.770Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:40.771Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan123"
  },
  "conversationHistoryLength": 24
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "Juan@P√©rez", Processing: false
[2025-11-19T16:38:40.772Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 10,
  "inputPreview": "Juan@P√©rez",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Juan@P√©rez", Processing: false
[2025-11-19T16:38:40.774Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Juan@P√©rez",
  "inputLength": 10,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "Juan123",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 25,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:40.774Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570320767,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan@P√©rez",
  "inputLength": 10,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan@P√©rez\""
}
[2025-11-19T16:38:40.775Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570320767,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:40.775Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570320767,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8383,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8383 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:41.750Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570320767,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 702,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 974,
  "reasoning": "Respuesta recibida de Gemini en 974ms. Extrayendo JSON..."
}
[2025-11-19T16:38:41.751Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570320767,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 977,
  "apiCallTimeMs": 974,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan@P√©rez",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan@P√©rez"
}
[2025-11-19T16:38:41.752Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan@P√©rez",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "Juan123"
  },
  "currentLanguage": "es",
  "originalText": "Juan@P√©rez",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"Juan123\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan@P√©rez"
}
[2025-11-19T16:38:41.752Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "Juan@P√©rez",
  "nombreAnterior": "Juan123",
  "credibilidad": "100%"
}
[2025-11-19T16:38:41.753Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "Juan123"
  },
  "stateAfter": {
    "NomReserva": "Juan@P√©rez"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 980ms, Response: "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?"
[2025-11-19T16:38:41.754Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 980,
  "responseMessage": "No he entendido bien. ¬øMe puede decir cu√°ntas personas ser√°n?",
  "reasoning": "Paso procesado en 980ms. Respuesta: \"No he entendido bien. ¬øMe puede decir cu√°ntas pers...\""
}
[2025-11-19T16:38:41.754Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan@P√©rez"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "No he entendido bien. ¬øMe puede decir cu√°ntas pers...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Bueno, No he entendido bien. ¬øMe puede decir cu√°ntas persona..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:41.758Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 991,
  "geminiTimeMs": 977,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 980,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:41.810Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:41.811Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": true
}
[2025-11-19T16:38:41.812Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan@P√©rez"
  },
  "conversationHistoryLength": 26
}
[BEFORE_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Input: "Juan P√©rez y Mar√≠a Garc√≠a", Processing: false
[2025-11-19T16:38:41.813Z] [INFO] BEFORE_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasInput": true,
  "inputLength": 25,
  "inputPreview": "Juan P√©rez y Mar√≠a Garc√≠a",
  "isProcessing": false
}
[PROCESS_CONVERSATION_STEP_START] Step: ask_people, Input: "Juan P√©rez y Mar√≠a Garc√≠a", Processing: false
[2025-11-19T16:38:41.814Z] [INFO] ü§ñ BOT_STATE_OVERVIEW {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "currentStep": "ask_people",
  "userInput": "Juan P√©rez y Mar√≠a Garc√≠a",
  "inputLength": 25,
  "isProcessing": false,
  "hasPendingGeminiText": false,
  "currentData": {
    "personas": null,
    "fecha": null,
    "hora": null,
    "nombre": "Juan@P√©rez",
    "telefono": "+34600123456",
    "horaError": null,
    "comensalesError": null
  },
  "conversationHistoryLength": 27,
  "geminiAnalysisAvailable": false,
  "geminiProcessing": false
}
[2025-11-19T16:38:41.814Z] [INFO] üß† GEMINI_ANALYSIS_START {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570321810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "userInput": "Juan P√©rez y Mar√≠a Garc√≠a",
  "inputLength": 25,
  "context": {
    "step": "ask_people",
    "callSid": "CA_name_variations_1763570309110"
  },
  "reasoning": "Iniciando an√°lisis de Gemini para extraer informaci√≥n de: \"Juan P√©rez y Mar√≠a Garc√≠a\""
}
[2025-11-19T16:38:41.817Z] [INFO] üìä CONFIGURATION_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570321810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "dataLoadTimeMs": 0,
  "config": {
    "maxPersonas": 20,
    "minPersonas": 1,
    "horarios": {
      "horario1": "08:00-11:00",
      "horario2": "13:00-15:00",
      "horario3": "19:00-23:00"
    },
    "minAntelacionHoras": 2
  },
  "menuItemsCount": 8,
  "reasoning": "Configuraci√≥n del restaurante cargada. 8 items en el men√∫."
}
[2025-11-19T16:38:41.817Z] [INFO] üì§ GEMINI_REQUEST_SENT {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570321810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "promptLength": 8398,
  "promptPreview": "## MISI√ìN\nEres un experto analizador de texto especializado en extraer informaci√≥n de reservas de restaurante.\nTu objetivo es analizar UNA SOLA frase del cliente y extraer TODO lo que puedas de ella, ...",
  "reasoning": "Enviando prompt a Gemini (8398 caracteres) para analizar el input del usuario"
}
[2025-11-19T16:38:42.752Z] [INFO] üì• GEMINI_RAW_RESPONSE_RECEIVED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570321810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "responseLength": 717,
  "responsePreview": "```json\n{\n  \"intencion\": \"clarify\",\n  \"comensales\": null,\n  \"comensales_porcentaje_credivilidad\": \"0%\",\n  \"comensales_validos\": null,\n  \"comensales_error\": null,\n  \"fecha\": null,\n  \"fecha_porcentaje_credivilidad\": \"0%\",\n  \"hora\": null,\n  \"hora_disponible\": null,\n  \"hora_error\": null,\n  \"hora_porcent",
  "apiCallTimeMs": 934,
  "reasoning": "Respuesta recibida de Gemini en 934ms. Extrayendo JSON..."
}
[2025-11-19T16:38:42.753Z] [INFO] ‚úÖ GEMINI_ANALYSIS_COMPLETED {
  "callSid": "CA_name_variations_1763570309110",
  "step": "ask_people",
  "performanceMetrics": {
    "requestStart": 1763570321810,
    "geminiTime": 0,
    "stateSaveTime": 0,
    "availabilityTime": 0,
    "configLoadTime": 0,
    "menuLoadTime": 0,
    "dbTime": 0,
    "totalTime": 0
  },
  "module": "gemini",
  "totalTimeMs": 939,
  "apiCallTimeMs": 934,
  "dataLoadTimeMs": 0,
  "extractedData": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan P√©rez y Mar√≠a Garc√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es",
    "intolerancias": "false",
    "movilidad": "false",
    "pedido_items_count": 0
  },
  "reasoning": "An√°lisis completado. Intenci√≥n: clarify, Idioma: es. Extra√≠dos: sin personas, sin fecha, sin hora, nombre Juan P√©rez y Mar√≠a Garc√≠a"
}
[2025-11-19T16:38:42.754Z] [INFO] üîÑ APPLYING_GEMINI_ANALYSIS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "analysis": {
    "intencion": "clarify",
    "comensales": null,
    "comensales_confidence": "0%",
    "comensales_validos": null,
    "comensales_error": null,
    "fecha": null,
    "fecha_confidence": "0%",
    "hora": null,
    "hora_confidence": "0%",
    "hora_disponible": null,
    "hora_error": null,
    "nombre": "Juan P√©rez y Mar√≠a Garc√≠a",
    "nombre_confidence": "100%",
    "idioma_detectado": "es"
  },
  "stateBefore": {
    "NomReserva": "Juan@P√©rez"
  },
  "currentLanguage": "es",
  "originalText": "Juan P√©rez y Mar√≠a Garc√≠a",
  "reasoning": "Aplicando an√°lisis de Gemini al estado. Idioma actual: es. Estado actual: {\"NomReserva\":\"Juan@P√©rez\"}. An√°lisis contiene: sin personas, sin fecha, sin hora, nombre Juan P√©rez y Mar√≠a Garc√≠a"
}
[2025-11-19T16:38:42.754Z] [RESERVATION] NAME_APPLIED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "nombre": "Juan P√©rez y Mar√≠a Garc√≠a",
  "nombreAnterior": "Juan@P√©rez",
  "credibilidad": "100%"
}
[2025-11-19T16:38:42.755Z] [INFO] GEMINI_ANALYSIS_APPLY_COMPLETE {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "stateBefore": {
    "NomReserva": "Juan@P√©rez"
  },
  "stateAfter": {
    "NomReserva": "Juan P√©rez y Mar√≠a Garc√≠a"
  },
  "changes": {
    "NumeroReserva": false,
    "FechaReserva": false,
    "HoraReserva": false,
    "NomReserva": true
  }
}
[AFTER_PROCESS_STEP] CallSid: CA_name_variations_1763570309110, Step: ask_people, Time: 943ms, Response: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir?"
[2025-11-19T16:38:42.756Z] [INFO] AFTER_PROCESS_STEP {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "processStepTimeMs": 943,
  "responseMessage": "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van a venir?",
  "reasoning": "Paso procesado en 943ms. Respuesta: \"Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas v...\""
}
[2025-11-19T16:38:42.757Z] [INFO] STATE_PERSIST {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan P√©rez y Mar√≠a Garc√≠a"
  }
}
üé§ [TTS] generateTwiML INICIO - Idioma: es, Mensaje: "Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas v...", UseAlgieba: true, NaturalFlow: true, Step: ask_people
üé§ [NATURAL_FLOW] Contexto: normal, Mensaje procesado: "Claro, Perd√≥n, no lo he captado bien. ¬øCu√°ntas personas van ..."
üé§ [NATURAL_FLOW] Mensaje fragmentado en 1 partes
üé§ [TTS] URL generada en 0ms. Usando TTS Play (Algieba Flash) con fallback a Say si falla
üé§ [TTS] TwiML generado en 2ms - usando SOLO Play (Algieba Flash) con 1 fragmento(s)
[2025-11-19T16:38:42.760Z] [INFO] PERFORMANCE_METRICS {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "totalTimeMs": 950,
  "geminiTimeMs": 939,
  "stateSaveTimeMs": 0,
  "availabilityTimeMs": 0,
  "configLoadTimeMs": 0,
  "menuLoadTimeMs": 0,
  "dbTimeMs": 0,
  "processStepTimeMs": 943,
  "saveReservationTimeMs": 0,
  "hasInput": true
}
[TWILIO_WEBHOOK_RECEIVED] Method: POST, URL: /api/twilio-call-gemini, HasBody: true, BodyType: object
[2025-11-19T16:38:42.816Z] [INFO] TWILIO_WEBHOOK_RECEIVED {
  "method": "POST",
  "url": "/api/twilio-call-gemini",
  "hasBody": true,
  "bodyType": "object",
  "hasQuery": false
}
[2025-11-19T16:38:42.817Z] [INFO] TWILIO_WEBHOOK_PARSED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "callStatus": "in-progress",
  "apiVersion": "2010-04-01",
  "hasSpeechResult": false
}
[2025-11-19T16:38:42.818Z] [INFO] CONVERSATION_STATE_LOADED {
  "callSid": "CA_name_variations_1763570309110",
  "direction": "inbound",
  "from": "+34600123456",
  "to": "+34600999888",
  "accountSid": "AC_test_account",
  "phone": "+34600123456",
  "language": "es",
  "step": "ask_people",
  "hasData": true,
  "dataKeys": [
    "NomReserva"
  ],
  "dataValues": {
    "NomReserva": "Juan P√©rez y Mar√≠a Garc√≠a"
  },
  "conversationHistoryLength": 28
}
[32m‚úÖ [16:38:42][0m PASSED: Validaci√≥n - Variaciones de Nombre (15 formatos) (13764ms)

================================================================================
[1müìä RESUMEN DE TESTS EXTREMOS[0m
================================================================================
[36mTotal de tests:[0m 33
[35mTests extremos:[0m 33
[32mPasados:[0m 27
[31mFallidos:[0m 6
[31mErrores:[0m 0
[33mTiempo total:[0m 275.73s
[36mPromedio por test:[0m 8.36s
[1mTasa de √©xito:[0m 81.8%
[1mTests extremos:[0m 100.0%
================================================================================

